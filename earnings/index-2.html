<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio â€” Earnings</title>

  <style>
    :root {
      color-scheme: light;
      --bg:#f8fafc;
      --surface:#eef2f7;
      --card:#ffffff;
      --card-muted:#f1f5f9;
      --border:rgba(15,23,42,0.08);
      --text:#0f172a;
      --muted:#64748b;
      --muted-soft:#e2e8f0;
      --brand:#0ea5e9;
      --brand-soft:rgba(56,189,248,0.18);
      --accent:#7c3aed;
      --accent-soft:rgba(124,58,237,0.15);
      --danger:#ef4444;
      --danger-soft:rgba(248,113,113,0.16);
      --success:#16a34a;
      --success-soft:rgba(22,163,74,0.16);

      --shadow-soft:0 14px 38px rgba(15,23,42,0.18);
      --shadow-strong:0 26px 80px rgba(15,23,42,0.55);

      --chart-bg:linear-gradient(180deg,#ffffff,#eef2f7);
      --chart-border:rgba(148,163,184,0.5);

      --table-header:#f8fafc;
      --table-border:rgba(148,163,184,0.7);

      --tooltip-bg:#020617;
      --tooltip-text:#e5e7eb;

      --kpi-bg:rgba(15,23,42,0.02);
      --kpi-border:rgba(148,163,184,0.4);
      --lens-border:#475569;
    }

    html[data-theme="dark"] {
      color-scheme: dark;
      --bg:#020617;
      --surface:#020617;
      --card:#020617;
      --card-muted:#020617;
      --border:rgba(15,23,42,0.9);
      --text:#e2e8f0;
      --muted:#94a3b8;
      --muted-soft:#0f172a;
      --brand:#38bdf8;
      --brand-soft:rgba(56,189,248,0.10);
      --accent:#a855f7;
      --accent-soft:rgba(168,85,247,0.12);
      --danger:#f97373;
      --danger-soft:rgba(248,113,113,0.28);
      --success:#4ade80;
      --success-soft:rgba(74,222,128,0.18);

      --shadow-soft:0 18px 48px rgba(15,23,42,0.75);
      --shadow-strong:0 34px 90px rgba(15,23,42,0.85);

      --chart-bg:radial-gradient(circle at top,#0f172a,#020617);
      --chart-border:rgba(30,64,175,0.7);

      --table-header:#020617;
      --table-border:rgba(30,64,175,0.6);

      --tooltip-bg:#020617;
      --tooltip-text:#e5e7eb;

      --kpi-bg:rgba(15,23,42,0.65);
      --kpi-border:rgba(30,64,175,0.85);
      --lens-border:#e2e8f0;
    }

    * {
      box-sizing:border-box;
    }

    html,body {
      height:100%;
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(circle at top left,rgba(56,189,248,0.22),transparent 55%),
        radial-gradient(circle at bottom right,rgba(124,58,237,0.28),transparent 60%),
        var(--bg);
      transition:
        background-color .25s ease,
        color .25s ease;
    }

    body {
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding:24px;
    }

    .app {
      max-width:1200px;
      width:100%;
      background:
        radial-gradient(circle at top left,rgba(148,163,184,0.24),transparent 55%),
        radial-gradient(circle at bottom right,rgba(15,23,42,0.85),transparent 60%),
        var(--surface);
      border-radius:28px;
      padding:20px 22px 22px;
      box-shadow:var(--shadow-strong);
      border:1px solid rgba(148,163,184,0.35);
      display:flex;
      flex-direction:column;
      gap:16px;
      overflow:hidden;
    }

    header {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      padding:14px 18px;
      border-radius:22px;
      background:radial-gradient(circle at top left,rgba(56,189,248,0.35),transparent 60%),rgba(15,23,42,0.98);
      color:#e5e7eb;
      box-shadow:0 18px 58px rgba(15,23,42,0.85);
    }

    .title-block h1 {
      margin:0;
      font-size:22px;
      letter-spacing:-0.02em;
    }

    .subtitle {
      margin-top:4px;
      font-size:13px;
      color:#cbd5f5;
    }

    .badge-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    .pill {
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:3px 10px;
      border-radius:999px;
      background:rgba(15,23,42,0.85);
      border:1px solid rgba(148,163,184,0.5);
      color:#e5e7eb;
    }

    .pill span {
      opacity:.8;
    }

    .pill strong {
      font-weight:600;
      color:#facc15;
    }

    .current-date {
      margin-top:6px;
      font-size:12px;
      color:#cbd5f5;
    }

    .header-right {
      display:flex;
      align-items:center;
      gap:10px;
    }

    .user-pill {
      font-size:12px;
      color:#e5e7eb;
    }

    .user-pill strong {
      color:#38bdf8;
    }

    .theme-toggle {
      width:34px;
      height:34px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
      cursor:pointer;
      box-shadow:0 12px 32px rgba(15,23,42,0.8);
      transition:
        background-color .25s ease,
        border-color .25s ease,
        transform .15s ease,
        box-shadow .25s ease;
    }

    .theme-toggle:hover {
      transform:translateY(-1px);
      box-shadow:0 16px 40px rgba(15,23,42,0.9);
    }

    .main {
      display:flex;
      flex-direction:column;
      gap:14px;
      flex:1;
      overflow:hidden;
    }

    .kpis {
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:10px;
    }

    .kpi {
      background:var(--kpi-bg);
      border-radius:18px;
      padding:9px 11px;
      border:1px solid var(--kpi-border);
      box-shadow:0 12px 34px rgba(15,23,42,0.58);
      display:flex;
      flex-direction:column;
      gap:4px;
      cursor:pointer;
      transition:
        transform .18s ease,
        box-shadow .18s ease,
        border-color .18s ease,
        background-color .18s ease;
    }

    .kpi:hover {
      transform:translateY(-3px);
      box-shadow:0 18px 50px rgba(15,23,42,0.85);
    }

    .kpi-title {
      font-size:11px;
      color:var(--muted);
    }

    .kpi-value {
      font-size:18px;
      font-weight:600;
    }

    .kpi-caption {
      font-size:10px;
      color:var(--muted);
    }

    .grid {
      flex:1;
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      padding:2px 0 4px;
      overflow:auto;
    }

    .tile {
      position:relative;
      background:
        radial-gradient(circle at top left,rgba(56,189,248,0.11),transparent 55%),
        radial-gradient(circle at bottom right,rgba(124,58,237,0.18),transparent 60%),
        var(--card);
      border-radius:18px;
      padding:11px 12px;
      border:1px solid rgba(148,163,184,0.4);
      box-shadow:0 14px 42px rgba(15,23,42,0.55);
      display:flex;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      transition:
        transform .18s ease,
        box-shadow .18s ease,
        border-color .18s ease,
        background-color .18s ease;
    }

    .tile:hover {
      transform:translateY(-3px);
      box-shadow:0 18px 52px rgba(15,23,42,0.85);
      border-color:rgba(56,189,248,0.75);
      background:
        radial-gradient(circle at top left,rgba(56,189,248,0.18),transparent 55%),
        radial-gradient(circle at bottom right,rgba(124,58,237,0.25),transparent 60%),
        var(--card);
    }

    .tile-left {
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .loan-name {
      font-size:14px;
      font-weight:700;
    }

    .loan-sub {
      font-size:12px;
      color:var(--muted);
    }

    .loan-meta {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
    }

    .loan-meta div {
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.55);
      background:rgba(15,23,42,0.03);
    }

    .chart-wrap {
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      min-width:150px;
    }

    .mini-label {
      font-size:11px;
      color:var(--muted);
    }

    .mini-chart {
      width:170px;
      height:50px;
      border-radius:14px;
      overflow:hidden;
      background:linear-gradient(180deg,rgba(15,23,42,0.03),rgba(148,163,184,0.10));
      border:1px solid rgba(148,163,184,0.65);
      box-shadow:0 12px 32px rgba(15,23,42,0.45);
      position:relative;
    }

    .drawer-backdrop {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.44);
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease;
      z-index:50;
    }

    .drawer-backdrop.open {
      opacity:1;
      pointer-events:auto;
    }

    .drawer {
      position:fixed;
      top:0;
      right:0;
      height:100vh;
      width:780px;
      max-width:100%;
      background:
        radial-gradient(circle at top left,rgba(56,189,248,0.18),transparent 55%),
        radial-gradient(circle at bottom right,rgba(15,23,42,0.90),transparent 60%),
        var(--card);
      box-shadow:-36px 0 90px rgba(2,6,23,0.95);
      transform:translateX(16px);
      opacity:0;
      pointer-events:none;
      display:flex;
      flex-direction:column;
      transition:
        transform .26s cubic-bezier(0.25,0.8,0.25,1),
        opacity .26s ease;
      z-index:60;
      border-left:1px solid rgba(148,163,184,0.5);
    }

    .drawer.open {
      transform:translateX(0);
      opacity:1;
      pointer-events:auto;
    }

    .drawer-head {
      padding:14px 18px 10px;
      border-bottom:1px solid rgba(148,163,184,0.4);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    .drawer-head-left h2 {
      margin:0;
      font-size:18px;
    }

    .drawer-head-left .muted {
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }

    .drawer-head-actions {
      display:flex;
      gap:8px;
      align-items:center;
    }

    .btn {
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      padding:5px 10px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(15,23,42,0.02);
      color:var(--text);
      cursor:pointer;
      transition:
        background-color .18s ease,
        border-color .18s ease,
        transform .12s ease,
        box-shadow .18s ease;
    }

    .btn:hover {
      background:rgba(15,23,42,0.06);
      transform:translateY(-1px);
      box-shadow:0 10px 26px rgba(15,23,42,0.45);
    }

    .btn.primary {
      background:linear-gradient(120deg,#0ea5e9,#4f46e5);
      border:none;
      color:white;
      box-shadow:0 12px 30px rgba(37,99,235,0.8);
    }

    .drawer-body {
      flex:1;
      padding:14px 18px 16px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .drawer-metrics {
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }

    .info-card {
      border-radius:16px;
      padding:9px 11px;
      background:
        radial-gradient(circle at top left,rgba(56,189,248,0.18),transparent 55%),
        radial-gradient(circle at bottom right,rgba(129,140,248,0.20),transparent 55%),
        var(--card);
      border:1px solid rgba(148,163,184,0.6);
      box-shadow:0 12px 30px rgba(15,23,42,0.6);
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .info-card h4 {
      margin:0;
      font-size:11px;
      color:var(--muted);
    }

    .info-card .value {
      font-size:18px;
      font-weight:600;
    }

    .info-card .caption {
      font-size:10px;
      color:var(--muted);
    }

    .drawer-main {
      display:grid;
      grid-template-columns:3fr 2fr;
      gap:12px;
      align-items:flex-start;
    }

    .drawer-chart {
      border-radius:18px;
      padding:10px;
      background:var(--chart-bg);
      border:1px solid var(--chart-border);
      box-shadow:0 16px 40px rgba(15,23,42,0.65);
      position:relative;
    }

    .drawer-chart svg {
      display:block;
      width:100%;
      height:220px;
    }

    .drawer-table-card {
      border-radius:18px;
      padding:10px;
      background:var(--card);
      border:1px solid rgba(148,163,184,0.6);
      box-shadow:0 16px 40px rgba(15,23,42,0.55);
    }

    .drawer-table-card h3 {
      margin:0 0 6px;
      font-size:13px;
    }

    .drawer-table-wrap {
      max-height:200px;
      overflow:auto;
      border-radius:12px;
      border:1px solid var(--table-border);
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }

    thead th {
      position:sticky;
      top:0;
      background:var(--table-header);
      padding:6px 8px;
      text-align:left;
      border-bottom:1px solid var(--table-border);
      z-index:1;
    }

    tbody td {
      padding:5px 8px;
      border-bottom:1px solid rgba(148,163,184,0.35);
    }

    tbody tr:nth-child(2n) {
      background:rgba(15,23,42,0.03);
    }

    .drawer-footer {
      padding:9px 16px 12px;
      border-top:1px solid rgba(148,163,184,0.45);
      display:flex;
      justify-content:flex-end;
    }

    #tooltip {
      position:fixed;
      pointer-events:none;
      background:var(--tooltip-bg);
      color:var(--tooltip-text);
      padding:4px 7px;
      border-radius:6px;
      font-size:10px;
      box-shadow:0 10px 30px rgba(15,23,42,0.9);
      opacity:0;
      transform:translateY(3px);
      transition:opacity .15s ease,transform .15s ease;
      z-index:999;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-block">
        <h1>Loan Portfolio â€” Earnings</h1>
        <div class="subtitle">Cumulative principal, interest, fees, and net earnings by loan.</div>
        <div class="badge-row">
          <span class="pill"><span>Mode</span><strong>Earnings</strong></span>
          <span class="pill"><span>View</span><strong>Tiles + Drawer</strong></span>
        </div>
        <div class="current-date">
          Current Month: <strong id="currentMonthLabel">18</strong>
        </div>
      </div>
      <div class="header-right">
        <div class="user-pill">User: <strong>Jeff L Customer</strong></div>
        <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">ðŸŒ™</button>
      </div>
    </header>

    <main class="main">
      <section id="kpis" class="kpis" aria-label="Portfolio earnings KPIs"></section>
      <section id="loanGrid" class="grid" aria-label="Loans"></section>
    </main>
  </div>

  <div id="drawerBackdrop" class="drawer-backdrop"></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div class="drawer-head-left">
        <h2 id="drawerTitle">Loan Details</h2>
        <div id="drawerSub" class="muted"></div>
      </div>
      <div class="drawer-head-actions">
        <button id="downloadCsvBtn" class="btn">Download CSV</button>
        <button id="copyCsvBtn" class="btn">Copy CSV</button>
        <button id="printBtn" class="btn">Print</button>
        <button id="closeBtn" class="btn" aria-label="Close drawer">âœ•</button>
      </div>
    </div>
    <div class="drawer-body">
      <div class="drawer-metrics">
        <div class="info-card">
          <h4 id="drawerPrimaryTitle">Net Earnings To Date</h4>
          <div id="drawerPrimary" class="value">$0</div>
          <div class="caption">through current month</div>
        </div>
        <div class="info-card">
          <h4 id="drawerSecondaryTitle">Fees To Date</h4>
          <div id="drawerSecondary" class="value">$0</div>
          <div class="caption">upfront + sliding monthly fees</div>
        </div>
      </div>

      <div class="drawer-main" style="margin-top:10px;">
        <div class="drawer-chart" id="drawerChartArea"></div>
        <div class="drawer-table-card">
          <h3>ROI To Date</h3>
          <div class="drawer-table-wrap">
            <table id="drawerRoiTable">
              <thead>
                <tr><th>Loan</th><th>ROI to Date</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="drawer-table-card" style="margin-top:10px;">
        <h3>Earnings Schedule</h3>
        <div class="drawer-table-wrap" id="drawerScheduleWrap"></div>
      </div>
    </div>
    <div class="drawer-footer">
      <button id="printBtnFooter" class="btn">Print</button>
    </div>
  </aside>

  <div id="tooltip"></div>

<script>
    // --------------------------
    // Settings & base data
    // --------------------------
    const CURRENT_MONTH = 18; // keep in sync with ROI page if you want
    document.getElementById("currentMonthLabel").textContent = CURRENT_MONTH;
    const WORKER_URL = "https://loan-dashboard-api.jeff-263.workers.dev/loans";

    function clampNumber(v, fallback = 0) {
      v = Number(v);
      return Number.isFinite(v) ? v : fallback;
    }

    function normalizeLoan(raw, idx) {
      const id = clampNumber(raw.loanId ?? raw.id ?? (idx + 1));
      const purchasePrice = clampNumber(raw.purchasePrice ?? raw.principal ?? 0);
      const rate = clampNumber(raw.nominalRate ?? raw.rate ?? 0);
      const termYears = clampNumber(raw.termYears ?? raw.term ?? 0);
      const graceYears = clampNumber(raw.graceYears ?? raw.grace ?? 0);
      const upfrontFee = clampNumber(raw.upfrontFee ?? 150);
      const monthlyFeeStart = clampNumber(raw.monthlyFeeStart ?? 9);

      return {
        ...raw,
        id,
        loanId: id,
        loanName: raw.loanName || `Loan ${id}`,
        school: raw.school || "No school listed",
        purchaseDate: raw.purchaseDate || "2025-01-31",
        purchasePrice,
        principal: purchasePrice,
        nominalRate: rate,
        rate,
        termYears,
        graceYears,
        upfrontFee,
        monthlyFeeStart,
        // backwards compatibility for existing UI labels:
        feePerMonth: monthlyFeeStart
      };
    }

    let loans = [];

    async function loadLoansFromBackend() {
      try {
        const res = await fetch(WORKER_URL, { cache: "no-store" });
        const data = await res.json();
        const arr = Array.isArray(data) ? data : (data.loans || []);
        loans = arr.map(normalizeLoan);
      } catch (err) {
        console.error("Failed to load loans from backend", err);
        loans = [];
      }
    }

    let stackedBarGroupCounter = 0;

    function prepareStackedBar(bar, groupId, index, isPositive = true){
      bar.setAttribute("data-stack-group", groupId);
      bar.setAttribute("data-stack-index", index);
      bar.setAttribute("data-stack-sign", isPositive ? "pos" : "neg");
    }

    function layoutStackedBars(svg){
      const groups = {};
      svg.querySelectorAll("[data-stack-group]").forEach(rect => {
        const gid = rect.getAttribute("data-stack-group");
        if(!groups[gid]) groups[gid] = [];
        groups[gid].push(rect);
      });
      Object.values(groups).forEach(rects => {
        rects.sort((a,b) => {
          const ia = +a.getAttribute("data-stack-index");
          const ib = +b.getAttribute("data-stack-index");
          return ia - ib;
        });
        // positive bars from center up, negatives from center down
        const midline = +rects[0].getAttribute("data-midline") || 0;
        let accPos = 0;
        let accNeg = 0;
        rects.forEach(rect => {
          const sign = rect.getAttribute("data-stack-sign");
          const h = +rect.getAttribute("data-height-raw");
          if(sign === "pos"){
            const y = midline - accPos - h;
            rect.setAttribute("y", isNaN(y) ? midline : y);
            rect.setAttribute("height", h);
            accPos += h;
          } else {
            const y = midline + accNeg;
            rect.setAttribute("y", isNaN(y) ? midline : y);
            rect.setAttribute("height", h);
            accNeg += h;
          }
        });
      });
    }

    // --------------------------
    // Amortization
    // --------------------------
    function calcAmort(principal, annualRate, termYears, graceYears){
      const monthlyRate = annualRate / 12;
      const totalMonths = Math.round(termYears * 12);
      const graceMonths = Math.round(graceYears * 12);
      const repayMonths = Math.max(1, totalMonths - graceMonths);
      let balance = principal;
      const schedule = [];

      // grace period: interest only
      for(let m=1; m<=graceMonths; m++){
        const interest = +(balance * monthlyRate).toFixed(2);
        balance = +(balance + interest).toFixed(2);
        schedule.push({
          monthIndex:m,
          payment:0,
          principalPaid:0,
          interest,
          balance
        });
      }

      // repayment period
      const payment = monthlyRate === 0
        ? +(balance / repayMonths).toFixed(2)
        : +((balance * monthlyRate) / (1 - Math.pow(1+monthlyRate, -repayMonths))).toFixed(2);

      for(let m=1; m<=repayMonths; m++){
        const interest = +(balance * monthlyRate).toFixed(2);
        const principalPaid = +Math.min(balance, +(payment - interest).toFixed(2));
        balance = +(Math.max(0, balance - principalPaid).toFixed(2));
        schedule.push({
          monthIndex: graceMonths + m,
          payment:+payment.toFixed(2),
          principalPaid,
          interest,
          balance
        });
      }
      return { payment, schedule };
    }

    let loansWithEarnings = [];

    // earnings engine with upfront + sliding monthly fee
    function buildLoanEarnings(loan) {
      const amort = calcAmort(loan.purchasePrice, loan.nominalRate, loan.termYears, loan.graceYears);
      let cumPrincipal = 0;
      let cumInterest = 0;
      let cumFees = 0;

      const termMonths = Math.max(1, Math.round(loan.termYears * 12));
      const earningsSchedule = amort.schedule.map(row => {
        const m = row.monthIndex;

        const upfrontFee = (m === 1 ? loan.upfrontFee : 0);
        let monthlyFee = loan.monthlyFeeStart * (1 - (m / termMonths));
        if (!Number.isFinite(monthlyFee) || monthlyFee < 0) monthlyFee = 0;

        const feeThisMonth = upfrontFee + monthlyFee;
        cumFees = +(cumFees + feeThisMonth).toFixed(2);

        cumPrincipal = +(cumPrincipal + row.principalPaid).toFixed(2);
        cumInterest = +(cumInterest + row.interest).toFixed(2);

        const netEarnings = +(cumPrincipal + cumInterest - cumFees).toFixed(2);

        return {
          ...row,
          feeThisMonth,
          cumPrincipal,
          cumInterest,
          cumFees,
          netEarnings
        };
      });

      return {
        ...loan,
        amort,
        earningsSchedule
      };
    }

    function rebuildLoansWithEarnings() {
      loansWithEarnings = loans.map(buildLoanEarnings);
    }

    // --------------------------
    // KPI calculations
    // --------------------------
    function computeEarningsKPIs(list){
      let totalNetToDate = 0;
      let totalNetProjected = 0;
      let totalFeesToDate = 0;
      let totalPrincipal = 0;

      list.forEach(l => {
        const lastIdx = l.earningsSchedule.length - 1;
        const atCurrent = l.earningsSchedule[Math.min(CURRENT_MONTH-1, lastIdx)] || l.earningsSchedule[lastIdx];
        const atEnd = l.earningsSchedule[lastIdx];

        totalNetToDate += atCurrent.netEarnings;
        totalFeesToDate += atCurrent.cumFees;
        totalNetProjected += atEnd.netEarnings;
        totalPrincipal += l.purchasePrice;
      });

      const avgMonthlyEarnings = CURRENT_MONTH > 0 ? totalNetToDate / CURRENT_MONTH : 0;

      return {
        totalNetToDate,
        totalNetProjected,
        totalFeesToDate,
        avgMonthlyEarnings,
        totalPrincipal
      };
    }

    function formatMoney(v, decimals = 0){
      const sign = v < 0 ? "-" : "";
      const abs = Math.abs(v);
      return sign + "$" + abs.toLocaleString(undefined,{minimumFractionDigits:decimals,maximumFractionDigits:decimals});
    }

    const kpiContainer = document.getElementById("kpis");
    function renderKPIs(){
      const k = computeEarningsKPIs(loansWithEarnings);
      kpiContainer.innerHTML = `
        <div class="kpi" data-kpi="netToDate">
          <div class="kpi-title">Net Earnings to Date</div>
          <div class="kpi-value">${formatMoney(k.totalNetToDate)}</div>
          <div class="kpi-caption">Principal + interest â€“ fees</div>
        </div>
        <div class="kpi" data-kpi="projected">
          <div class="kpi-title">Projected Lifetime Earnings</div>
          <div class="kpi-value">${formatMoney(k.totalNetProjected)}</div>
          <div class="kpi-caption">if held to maturity</div>
        </div>
        <div class="kpi" data-kpi="avgMonthly">
          <div class="kpi-title">Avg Monthly Earnings</div>
          <div class="kpi-value">${formatMoney(k.avgMonthlyEarnings,2)}</div>
          <div class="kpi-caption">through month ${CURRENT_MONTH}</div>
        </div>
        <div class="kpi" data-kpi="fees">
          <div class="kpi-title">Fees to Date</div>
          <div class="kpi-value">${formatMoney(k.totalFeesToDate)}</div>
          <div class="kpi-caption">upfront + sliding monthly</div>
        </div>
      `;
    }

    // --------------------------
    // Loan tiles
    // --------------------------
    const grid = document.getElementById("loanGrid");
    const drawer = document.getElementById("drawer");
    const drawerBackdrop = document.getElementById("drawerBackdrop");
    const drawerTitle = document.getElementById("drawerTitle");
    const drawerSub = document.getElementById("drawerSub");
    const drawerPrimaryTitle = document.getElementById("drawerPrimaryTitle");
    const drawerPrimary = document.getElementById("drawerPrimary");
    const drawerSecondaryTitle = document.getElementById("drawerSecondaryTitle");
    const drawerSecondary = document.getElementById("drawerSecondary");
    const drawerChartArea = document.getElementById("drawerChartArea");
    const drawerRoiTableBody = document.querySelector("#drawerRoiTable tbody");
    const drawerScheduleWrap = document.getElementById("drawerScheduleWrap");

    let currentLoanForDrawer = null;
    let currentCsvData = "";

    function createMiniEarningsChart(container, schedule){
      const w = 170;
      const h = 50;
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS,"svg");
      svg.setAttribute("viewBox",`0 0 ${w} ${h}`);
      svg.setAttribute("preserveAspectRatio","none");
      container.innerHTML = "";
      container.appendChild(svg);

      if(!schedule.length) return;

      const slice = schedule.slice(0, Math.min(36, schedule.length));
      const maxAbs = slice.reduce((m,r) => Math.max(m, Math.abs(r.netEarnings)), 0) || 1;
      const barW = w / slice.length;

      slice.forEach((row,i) => {
        const val = row.netEarnings;
        const barH = (Math.abs(val)/maxAbs)*(h-4);
        const mid = h/2;
        const y = val >= 0 ? (mid - barH) : mid;
        const rect = document.createElementNS(svgNS,"rect");
        rect.setAttribute("x",(i*barW).toFixed(2));
        rect.setAttribute("y",isNaN(y)?mid.toFixed(2):y.toFixed(2));
        rect.setAttribute("width",Math.max(1,barW-1).toFixed(2));
        rect.setAttribute("height",isNaN(barH)?"0":barH.toFixed(2));
        rect.setAttribute("fill", val >= 0 ? "#22c55e" : "#ef4444");
        svg.appendChild(rect);
      });
    }

    function renderLoanTiles() {
      grid.innerHTML = "";
      loansWithEarnings.forEach(loan => {
        const lastIdx = loan.earningsSchedule.length - 1;
        const atCurrent = loan.earningsSchedule[Math.min(CURRENT_MONTH-1, lastIdx)] || loan.earningsSchedule[lastIdx];

        const tile = document.createElement("div");
        tile.className = "tile";
        tile.innerHTML = `
          <div class="tile-left">
            <div class="loan-name">${loan.loanName}</div>
            <div class="loan-sub">${loan.school || "No school listed"}</div>
            <div class="loan-meta">
              <div>Term: ${loan.termYears}y</div>
              <div>Grace: ${loan.graceYears}y</div>
              <div>Fee: $${loan.feePerMonth.toFixed(2)}/mo</div>
            </div>
          </div>
          <div class="chart-wrap">
            <div class="mini-label">
              Net M${CURRENT_MONTH}: ${formatMoney(atCurrent.netEarnings)}
            </div>
            <div class="mini-chart"></div>
          </div>
        `;
        tile.addEventListener("click", () => openLoanDrawer(loan));
        grid.appendChild(tile);
        const mini = tile.querySelector(".mini-chart");
        createMiniEarningsChart(mini, loan.earningsSchedule);
      });
    }

    // --------------------------
    // Drawer behavior
    // --------------------------
    function openDrawerBase(){
      drawer.classList.add("open");
      drawerBackdrop.classList.add("open");
      drawer.setAttribute("aria-hidden","false");
    }
    function closeDrawer(){
      drawer.classList.remove("open");
      drawerBackdrop.classList.remove("open");
      drawer.setAttribute("aria-hidden","true");
    }

    document.getElementById("closeBtn").addEventListener("click", closeDrawer);
    document.getElementById("printBtn").addEventListener("click", () => window.print());
    document.getElementById("printBtnFooter").addEventListener("click", () => window.print());
    document.getElementById("downloadCsvBtn").addEventListener("click", downloadCurrentDrawerCsv);
    document.getElementById("copyCsvBtn").addEventListener("click", copyCurrentDrawerCsv);
    drawerBackdrop.addEventListener("click", closeDrawer);

    document.addEventListener("keydown", e => {
      if(e.key === "Escape") closeDrawer();
    });
    document.addEventListener("click", e => {
      if(drawer.classList.contains("open")){
        const inside = drawer.contains(e.target);
        const tileClicked = e.target.closest(".tile");
        const kpiClicked = e.target.closest(".kpi");
        if(!inside && !tileClicked && !kpiClicked){
          closeDrawer();
        }
      }
    });

    // --------------------------
    // Drawer content
    // --------------------------
    function openLoanDrawer(loan){
      currentLoanForDrawer = loan;
      const sched = loan.earningsSchedule;
      const lastIdx = sched.length - 1;
      const atCurrent = sched[Math.min(CURRENT_MONTH-1, lastIdx)] || sched[lastIdx];

      drawerTitle.textContent = `${loan.loanName} â€” Earnings`;
      drawerSub.textContent = `${loan.school || "No school"} â€¢ Purchased ${loan.purchaseDate} â€¢ $${loan.purchasePrice.toLocaleString()}`;

      drawerPrimaryTitle.textContent = "Net Earnings To Date";
      drawerPrimary.textContent = formatMoney(atCurrent.netEarnings);
      drawerSecondaryTitle.textContent = "Fees To Date";
      drawerSecondary.textContent = formatMoney(atCurrent.cumFees);

      renderDrawerChart(loan);
      renderDrawerTables(loan);

      openDrawerBase();
    }

    function renderDrawerChart(loan){
      const sched = loan.earningsSchedule;
      drawerChartArea.innerHTML = "";

      const w = drawerChartArea.clientWidth || 600;
      const h = 220;
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS,"svg");
      svg.setAttribute("viewBox",`0 0 ${w} ${h}`);
      svg.setAttribute("preserveAspectRatio","none");
      drawerChartArea.appendChild(svg);

      if(!sched.length) return;
      const pad = 30;
      const innerW = w - pad*2;
      const innerH = h - pad*2;
      const midline = pad + innerH/2;

      let maxVal = 0;
      let minVal = 0;
      sched.forEach(r => {
        if(r.netEarnings > maxVal) maxVal = r.netEarnings;
        if(r.netEarnings < minVal) minVal = r.netEarnings;
      });
      if(maxVal === 0 && minVal === 0) maxVal = 1;
      const span = maxVal - minVal || 1;

      const barW = innerW / sched.length;
      const groupId = "earnings-"+(++stackedBarGroupCounter);

      for(let i=0; i<sched.length; i++){
        const r = sched[i];
        const x = pad + i*barW;
        const value = r.netEarnings;
        const norm = (value - minVal)/span;
        const yVal = pad + (1-norm)*innerH;
        const height = Math.abs(yVal - midline);
        const rect = document.createElementNS(svgNS,"rect");
        rect.setAttribute("x",x.toFixed(2));
        rect.setAttribute("data-midline", midline.toFixed(2));
        rect.setAttribute("data-height-raw", Math.max(0,height).toFixed(2));

        const isPositive = value >= 0;
        prepareStackedBar(rect, groupId, i, isPositive);

        rect.setAttribute("width",Math.max(1,barW-1).toFixed(2));
        rect.setAttribute("fill", isPositive ? "#22c55e" : "#ef4444");
        svg.appendChild(rect);
      }

      layoutStackedBars(svg);

      const axis = document.createElementNS(svgNS,"line");
      axis.setAttribute("x1",pad.toFixed(2));
      axis.setAttribute("x2",(w-pad).toFixed(2));
      axis.setAttribute("y1",midline.toFixed(2));
      axis.setAttribute("y2",midline.toFixed(2));
      axis.setAttribute("stroke","rgba(148,163,184,0.7)");
      axis.setAttribute("stroke-width","1");
      svg.appendChild(axis);
    }

    function renderDrawerTables(loan){
      const sched = loan.earningsSchedule;
      drawerRoiTableBody.innerHTML = "";
      const idx = Math.min(CURRENT_MONTH-1, sched.length-1);
      const atCurrent = sched[idx] || sched[sched.length-1];
      const roi = (atCurrent.netEarnings / loan.purchasePrice) || 0;

      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${loan.loanName}</td><td>${(roi*100).toFixed(2)}%</td>`;
      drawerRoiTableBody.appendChild(tr);

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = "<tr><th>Month</th><th>Cum Principal</th><th>Cum Interest</th><th>Cum Fees</th><th>Net Earnings</th></tr>";
      table.appendChild(thead);
      const tbody = document.createElement("tbody");

      const rows = [["Month","CumPrincipal","CumInterest","CumFees","NetEarnings"]];
      sched.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>M${row.monthIndex}</td>
          <td>${formatMoney(row.cumPrincipal,2)}</td>
          <td>${formatMoney(row.cumInterest,2)}</td>
          <td>${formatMoney(-row.cumFees,2)}</td>
          <td>${formatMoney(row.netEarnings,2)}</td>
        `;
        tbody.appendChild(tr);
        rows.push([
          row.monthIndex,
          row.cumPrincipal.toFixed(2),
          row.cumInterest.toFixed(2),
          row.cumFees.toFixed(2),
          row.netEarnings.toFixed(2)
        ]);
      });
      table.appendChild(tbody);
      drawerScheduleWrap.innerHTML = "";
      drawerScheduleWrap.appendChild(table);

      currentCsvData = rows.map(r => r.join(",")).join("\n");
    }

    // CSV helpers
    async function copyCurrentDrawerCsv() {
      if(!currentCsvData || !navigator.clipboard) return;
      try {
        await navigator.clipboard.writeText(currentCsvData);
      } catch (err) {
        console.error("Copy failed", err);
      }
    }

    function downloadCurrentDrawerCsv() {
      const blob = new Blob([currentCsvData || ""], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "drawer-data.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    // --------------------------
    // Theme toggle
    // --------------------------
    const themeToggle = document.getElementById("themeToggle");
    const rootEl = document.documentElement;
    function applyTheme(theme){
      rootEl.setAttribute("data-theme", theme);
      themeToggle.textContent = theme === "dark" ? "â˜€ï¸" : "ðŸŒ™";
    }
    const storedTheme = localStorage.getItem("loanTheme");
    if(storedTheme === "dark" || storedTheme === "light"){
      applyTheme(storedTheme);
    } else {
      applyTheme("light");
    }
    themeToggle.addEventListener("click", () => {
      const current = rootEl.getAttribute("data-theme") === "dark" ? "dark" : "light";
      const next = current === "dark" ? "light" : "dark";
      localStorage.setItem("loanTheme", next);
      applyTheme(next);
    });

    // --------------------------
    // Init
    // --------------------------
    async function initPage() {
      await loadLoansFromBackend();
      rebuildLoansWithEarnings();
      renderKPIs();
      renderLoanTiles();
    }

    initPage();
</script>
</body>
</html>
