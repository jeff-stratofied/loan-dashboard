<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio â€” Earnings</title>

  <style>
    :root {
      color-scheme: light;
      --bg:#f8fafc;
      --surface:#eef2f7;
      --card:#ffffff;
      --card-muted:#f1f5f9;
      --border:rgba(15,23,42,0.08);
      --text:#0f172a;
      --muted:#5b6472;
      --brand:#0ea5e9;
      --accent2:#7c3aed;
      --shadow:0 16px 40px rgba(15,23,42,0.08);
      --kpi-hover:translateY(-6px);
      --drawer-gradient:linear-gradient(180deg,#ffffff,#f8fafc);
      --tile-gradient:linear-gradient(180deg,#ffffff,#f8fafc);
      --chart-area:rgba(14,165,233,0.15);
      --chart-area-2:rgba(124,58,237,0.12);
      --table-header:rgba(241,245,249,0.95);
      --grid-strong:rgba(148,163,184,0.35);
      --grid-light:rgba(148,163,184,0.12);
    }

    html[data-theme="dark"] {
      color-scheme: dark;
      --bg:#0b1220;
      --surface:#0f172a;
      --card:#111827;
      --card-muted:#0b1324;
      --border:rgba(226,232,240,0.12);
      --text:#e2e8f0;
      --muted:#9aa6b2;
      --shadow:0 22px 50px rgba(0,0,0,0.45);
      --drawer-gradient:linear-gradient(180deg,#0f172a,#0b1220);
      --tile-gradient:linear-gradient(180deg,#111827,#0b1220);
      --chart-area:rgba(14,165,233,0.24);
      --chart-area-2:rgba(124,58,237,0.22);
      --table-header:rgba(30,41,59,0.95);
      --grid-strong:rgba(148,163,184,0.42);
      --grid-light:rgba(148,163,184,0.2);
    }

    html, body {
      background-color:var(--bg);
      color:var(--text);
      transition:background-color .35s ease, color .35s ease;
    }
    body {
      margin:0;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:linear-gradient(180deg,var(--surface) 0%, var(--card) 100%);
      -webkit-font-smoothing:antialiased;
      transition:background .35s ease, box-shadow .35s ease;
    }

    .app {
      max-width:1200px;
      margin:20px auto;
      padding:16px;
    }

    header {
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:12px;
    }
    .header-top {
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    h1 {
      font-size:20px;
      margin:0;
    }
    p.lead {
      margin:0;
      color:var(--muted);
      font-size:13px;
    }
    .current-date {
      font-size:13px;
      color:var(--muted);
      margin-top:4px;
    }

    .actions { display:flex; gap:8px; align-items:center }
    .btn{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--card);
      cursor:pointer;
      font-weight:600;
      color:var(--text);
      transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--brand),var(--accent2));
      color:white;
      border:none;
      box-shadow:var(--shadow);
    }
    .close-btn{
      background:var(--card-muted);
      border:1px solid var(--border);
      padding:8px;
      border-radius:8px;
      cursor:pointer;
      color:var(--text);
      transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
    }

    .kpis{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
      margin:14px 0 18px;
    }
    .kpi{
      background:var(--card);
      padding:14px;
      border-radius:12px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      cursor:pointer;
      transition:transform .18s ease, box-shadow .24s ease, background-color .24s ease, border-color .24s ease, color .24s ease;
      display:flex;
      flex-direction:column;
      justify-content:center;
    }
    .kpi h3{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }
    .kpi p{
      margin:8px 0 0;
      font-size:18px;
      font-weight:700;
    }
    .kpi:hover { transform:var(--kpi-hover); box-shadow:var(--shadow); }

    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
      height:calc(100vh - 320px);
      overflow:auto;
      padding-right:6px;
    }
    @media(max-width:900px){
      .grid{ grid-template-columns:1fr; height:auto; }
      .kpis{ grid-template-columns:repeat(2,1fr); }
    }

    .tile{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px;
      border-radius:12px;
      background:var(--tile-gradient);
      min-height:110px;
      cursor:pointer;
      overflow:hidden;
      transition:transform .18s ease, box-shadow .24s ease, background .28s ease, border-color .24s ease, color .24s ease;
      border:1px solid var(--border);
    }
    .tile:hover{ transform:var(--kpi-hover); box-shadow:var(--shadow); }
    .tile-left{ flex:1; padding-right:10px; }
    .loan-name{ font-weight:700; font-size:14px; }
    .loan-sub{ font-size:12px; color:var(--muted); margin-top:6px; }
    .loan-meta{ display:flex; gap:8px; font-size:12px; color:var(--muted); margin-top:8px; }

    .chart-wrap{
      width:170px;
      flex-shrink:0;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
    }
    .mini-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      text-align:right;
      width:100%;
    }

    /* Drawer */
.drawer{
  position:fixed;
  right:0;
  top:0;
  height:100vh;               /* exact viewport height */
  max-width:1000px;
  width:760px;
  background:var(--card);
  box-shadow:-28px 0 80px rgba(2,6,23,0.14);
  transform:translateX(110%);
  transition:transform .32s cubic-bezier(.2,.9,.3,1), opacity .24s ease, background-color .3s ease, color .3s ease, border-color .3s ease, box-shadow .3s ease;
  z-index:120;

  /* THE IMPORTANT FIXES */
  display:flex;               /* define vertical layout */
  flex-direction:column;      /* header â†’ content â†’ footer */
  padding:0;                  /* remove padding from the container */

  overflow:hidden;            /* scrolling happens inside content area */
  opacity:0;
}
.drawer-head{
  padding:20px;
  flex-shrink:0;      /* stays fixed at top */
  background:var(--card);
  transition:background-color .3s ease, color .3s ease, border-color .3s ease;
}

#drawerBody,
.drawer-body{
  flex:1 1 auto;      /* fill remaining space */
  overflow-y:auto;    /* THIS area scrolls */
  padding:20px;
}

.drawer-footer{
  padding:20px;
  flex-shrink:0;      /* stays at bottom */
  background:var(--card);
  transition:background-color .3s ease, color .3s ease, border-color .3s ease;
}



    .drawer.open{
      transform:translateX(0);
      opacity:1;
      animation:drawerIn .28s cubic-bezier(.2,.9,.3,1);
    }
    @keyframes drawerIn {
      from { transform:translateX(30%); opacity:0; }
      to   { transform:translateX(0);   opacity:1; }
    }

    .drawer-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      margin-bottom:12px;
    }
    .drawer-subtitle{
      color:var(--muted);
      font-size:13px;
      margin-top:4px;
    }
    .drawer-detail{
      color:var(--muted);
      font-size:12px;
      margin-top:4px;
    }
    .drawer-chart{
      width:100%;
      height:260px;
      background:var(--drawer-gradient);
      border-radius:8px;
      border:1px solid var(--border);
      margin-bottom:8px;
      padding:0;
      position:relative;
      display:block;
      transition:background .35s ease, border-color .3s ease, box-shadow .3s ease;
    }

    .drawer-info-row{
      display:flex;
      gap:12px;
      margin-bottom:8px;
      align-items:center;
    }
    .info-card{
      flex:1;
      background:var(--card);
      padding:12px;
      border-radius:8px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      min-height:56px;
      border:1px solid var(--border);
      transition:background-color .3s ease, border-color .3s ease, color .3s ease, box-shadow .3s ease;
    }
    .info-card.small{ width:160px; align-items:flex-end; }
    .muted-small{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    .main-val{ font-weight:800; font-size:18px; }
    .drawer-body{ display:flex; flex-direction:column; gap:12px; }
    #drawerBody,
.drawer-body {
  flex: 1 1 auto;
  overflow-y: auto;
  margin-top: 8px;
  padding-bottom: 80px;
}
.drawer,
#drawerBody,
.drawer-body {
  overflow-x: hidden !important;
}

    .drawer-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
    .drawer-actions .spacer{ flex:1; }

    .amort-wrap{
      border:1px solid var(--border);
      border-radius:8px;
      padding:8px;
      max-height:40vh;
      overflow:auto;
      background:var(--card);
      transition:background-color .3s ease, border-color .3s ease, color .3s ease;
    }

    table{ width:100%; border-collapse:collapse; font-size:13px; color:var(--text); transition:color .25s ease; }
    thead th{
      position:sticky;
      top:0;
      background:var(--table-header);
      padding:8px;
      text-align:left;
      color:var(--muted);
      font-weight:700;
      border-bottom:1px solid var(--border);
      transition:background-color .3s ease, color .3s ease, border-color .3s ease;
    }
    td{
      padding:8px;
      border-bottom:1px dashed var(--border);
      text-align:right;
      transition:color .25s ease, border-color .25s ease;
    }
    td:first-child, th:first-child{ text-align:left; }

    .small{ font-size:12px; color:var(--muted); }

    @media(max-width:760px){
      .drawer{ width:100%; min-width:0; }
    }

    /* Theme toggle */
    .theme-icon{
      background:var(--card);
      border:1px solid var(--border);
      font-size:18px;
      cursor:pointer;
      transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease, transform .2s ease;
      width:38px;
      height:38px;
      border-radius:10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow:var(--shadow);
    }
    .theme-icon:hover{ opacity:0.95; transform:translateY(-1px); }

    .lens-tooltip-html {
      position: fixed;
      z-index: 300;
      pointer-events: none;
      background: rgba(15,23,42,0.92);
      color: #fff;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid #0ea5e9;
      box-shadow: 0 10px 30px rgba(15,23,42,0.45);
      white-space: nowrap;
    }

  </style>
</head>
<body>
  <div class="app" role="main">
    <header>
      <div class="header-top">
        <div>
          <h1>Loan Portfolio â€” Earnings</h1>
          <p class="lead">Cumulative principal, interest, and fees, with stacked earnings visuals.</p>
          <div class="current-date">
            Current Date: <span id="currentDate"></span>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <div style="font-size:13px; color:var(--muted)">
            User: <strong style="color:var(--brand)">Jeff L Customer</strong>
          </div>
          <button id="themeToggle" class="theme-icon" title="Toggle dark mode">ðŸŒ™</button>
        </div>
      </div>
    </header>

    <section class="kpis" id="kpis"></section>
    <section class="grid" id="loanGrid" aria-live="polite"></section>
  </div>

  <!-- Drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="drawerTitle">Earnings Drawer</h2>
        <div class="muted-small" id="drawerSub">details</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
        <button class="close-btn" id="closeBtn" aria-label="Close drawer">âœ•</button>
      </div>
    </div>

    <div class="drawer-info-row">
      <div class="info-card" id="drawerPrimaryCard">
        <div class="muted-small" id="drawerPrimaryTitle">Net Earnings</div>
        <div id="drawerPrimary" class="main-val"></div>
      </div>
      <div class="info-card small" id="drawerSecondaryCard">
        <div class="muted-small" id="drawerSecondaryTitle">Total Fees</div>
        <div id="drawerSecondary" class="main-val small"></div>
      </div>
    </div>

    <div id="drawerBody">
      <div class="drawer-chart" id="drawerChartArea"></div>
      <div id="drawerExtra"></div>
    </div>
    <div class="drawer-footer">
  <div class="actions" style="padding-top:10px">
    <button class="btn" id="printBtn">Print</button>
    <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
  </div>
</div>
  </aside>

  <!-- KPI Drawers -->
  <aside id="kpiDrawer1" class="drawer kpi-drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="kpi1Title">KPI 1</h2>
        <div id="kpi1Sub" class="drawer-subtitle"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
        <button class="close-btn kpi-close" data-kpi-close="kpiDrawer1" aria-label="Close KPI drawer">âœ•</button>
      </div>
    </div>
    <div class="drawer-info-row">
      <div class="info-card">
        <div class="muted-small" id="kpi1PrimaryTitle"></div>
        <div id="kpi1Primary" class="main-val"></div>
      </div>
      <div class="info-card small">
        <div class="muted-small" id="kpi1SecondaryTitle"></div>
        <div id="kpi1Secondary" class="main-val small"></div>
      </div>
    </div>
    <div class="drawer-body">
      <div class="drawer-chart" id="kpi1Chart"></div>
      <div class="amort-wrap" id="kpi1Table"></div>
    </div>
    <div class="drawer-actions">
      <button class="btn" data-kpi-close="kpiDrawer1">Close</button>
      <div class="spacer"></div>
      <button class="btn primary">Export</button>
    </div>
    <div class="actions" style="padding-top:10px">
      <button class="btn" id="printBtn">Print</button>
      <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
    </div>
  </aside>

  <aside id="kpiDrawer2" class="drawer kpi-drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="kpi2Title">KPI 2</h2>
        <div id="kpi2Sub" class="drawer-subtitle"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
        <button class="close-btn kpi-close" data-kpi-close="kpiDrawer2" aria-label="Close KPI drawer">âœ•</button>
      </div>
    </div>
    <div class="drawer-info-row">
      <div class="info-card">
        <div class="muted-small" id="kpi2PrimaryTitle"></div>
        <div id="kpi2Primary" class="main-val"></div>
      </div>
      <div class="info-card small">
        <div class="muted-small" id="kpi2SecondaryTitle"></div>
        <div id="kpi2Secondary" class="main-val small"></div>
      </div>
    </div>
    <div class="drawer-body">
      <div class="drawer-chart" id="kpi2Chart"></div>
      <div class="amort-wrap" id="kpi2Table"></div>
    </div>
    <div class="drawer-actions">
      <button class="btn" data-kpi-close="kpiDrawer2">Close</button>
      <div class="spacer"></div>
      <button class="btn primary">Export</button>
    </div>
    <div class="actions" style="padding-top:10px">
      <button class="btn" id="printBtn">Print</button>
      <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
    </div>
  </aside>

  <aside id="kpiDrawer3" class="drawer kpi-drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="kpi3Title">KPI 3</h2>
        <div id="kpi3Sub" class="drawer-subtitle"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
        <button class="close-btn kpi-close" data-kpi-close="kpiDrawer3" aria-label="Close KPI drawer">âœ•</button>
      </div>
    </div>
    <div class="drawer-info-row">
      <div class="info-card">
        <div class="muted-small" id="kpi3PrimaryTitle"></div>
        <div id="kpi3Primary" class="main-val"></div>
      </div>
      <div class="info-card small">
        <div class="muted-small" id="kpi3SecondaryTitle"></div>
        <div id="kpi3Secondary" class="main-val small"></div>
      </div>
    </div>
    <div class="drawer-body">
      <div class="drawer-chart" id="kpi3Chart"></div>
      <div class="amort-wrap" id="kpi3Table"></div>
    </div>
    <div class="drawer-actions">
      <button class="btn" data-kpi-close="kpiDrawer3">Close</button>
      <div class="spacer"></div>
      <button class="btn primary">Export</button>
    </div>
    <div class="actions" style="padding-top:10px">
      <button class="btn" id="printBtn">Print</button>
      <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
    </div>
  </aside>

  <aside id="kpiDrawer4" class="drawer kpi-drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="kpi4Title">KPI 4</h2>
        <div id="kpi4Sub" class="drawer-subtitle"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
        <button class="close-btn kpi-close" data-kpi-close="kpiDrawer4" aria-label="Close KPI drawer">âœ•</button>
      </div>
    </div>
    <div class="drawer-info-row">
      <div class="info-card">
        <div class="muted-small" id="kpi4PrimaryTitle"></div>
        <div id="kpi4Primary" class="main-val"></div>
      </div>
      <div class="info-card small">
        <div class="muted-small" id="kpi4SecondaryTitle"></div>
        <div id="kpi4Secondary" class="main-val small"></div>
      </div>
    </div>
    <div class="drawer-body">
      <div class="drawer-chart" id="kpi4Chart"></div>
      <div class="amort-wrap" id="kpi4Table"></div>
    </div>
    <div class="drawer-actions">
      <button class="btn" data-kpi-close="kpiDrawer4">Close</button>
      <div class="spacer"></div>
      <button class="btn primary">Export</button>
    </div>
    <div class="actions" style="padding-top:10px">
      <button class="btn" id="printBtn">Print</button>
      <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
    </div>
  </aside>

  <script type="module">
    import {
      addMonths,
      monthDiff,
      formatDate,
      formatMonthYear,
      buildAmortSchedule,
      attachSchedules,
      buildPortfolioViews
    } from "../js/loanEngine.js";

    // --------------------------
    // Settings & base data
    // --------------------------
    function OLD_addMonths(date, months) {
      const d = new Date(date);
      d.setMonth(d.getMonth() + months);
      return d;
    }

    function OLD_monthDiff(d1, d2) {
      return (d2.getFullYear() - d1.getFullYear()) * 12 +
             (d2.getMonth() - d1.getMonth());
    }

    let loans = [];

    async function loadLoansFromBackend() {
      try {
        const res = await fetch("https://loan-dashboard-api.jeff-263.workers.dev/loans");
        const data = await res.json();
        const arr = data.loans || [];
        loans = arr.map(l => ({
          ...l,
          loanStartDate: l.loanStartDate || "",
        }));
      } catch (err) {
        console.error("Failed to load loans from backend", err);
        loans = [];
      }
    }

    document.getElementById("currentDate").textContent = formatDate(new Date());

    let stackedBarGroupCounter = 0;

    function prepareStackedBar(bar, groupId, index, isPositive = true){
      bar.setAttribute("data-stack-group", groupId);
      bar.setAttribute("data-stack-index", index);
    }

    // --------------------------
    // Amortization + earnings
    // --------------------------
    function calcAmort(principal, annualRate, termYears, graceYears){
      const monthlyRate = annualRate / 12;
      const totalMonths = Math.round(termYears * 12);
      const graceMonths = Math.round(graceYears * 12);
      const repayMonths = Math.max(1, totalMonths - graceMonths);

      let balance = principal;
      const schedule = [];

      // Grace period: interest-only, interest accrues on balance
      for (let m = 1; m <= graceMonths; m++) {
        const interest = +(balance * monthlyRate).toFixed(2);
        balance = +(balance + interest).toFixed(2);
        schedule.push({
          monthIndex: m,
          payment: 0,
          principalPaid: 0,
          interest,
          balance
        });
      }

      // Repayment period: standard amortization
      const payment = monthlyRate === 0
        ? +(balance / repayMonths).toFixed(2)
        : +((balance * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -repayMonths))).toFixed(2);

      for (let m = 1; m <= repayMonths; m++) {
        const interest = +(balance * monthlyRate).toFixed(2);
        const principalPaid = +Math.min(
          balance,
          +(payment - interest).toFixed(2)
        );
        balance = +(Math.max(0, balance - principalPaid).toFixed(2));

        schedule.push({
          monthIndex: graceMonths + m,
          payment: +payment.toFixed(2),
          principalPaid,
          interest,
          balance
        });
      }

      return { payment, schedule };
    }

    let loansWithEarnings = [];

    function rebuildLoansWithEarnings() {
      loansWithEarnings = loans.map((raw, idx) => {
        // Normalize fields from backend
        const id = raw.loanId ?? raw.id ?? (idx + 1);
        const purchasePrice = Number(raw.purchasePrice ?? raw.principal ?? 0);
        const nominalRate = Number(raw.nominalRate ?? raw.rate ?? 0);
        const termYears = Number(raw.termYears ?? 0);
        const graceYears = Number(raw.graceYears ?? 0);

        const upfrontFee = Number(raw.upfrontFee ?? 150);           // flat fee in month 1
        const monthlyFeeStart = Number(raw.monthlyFeeStart ??       // starting monthly fee
                                       raw.feePerMonth ?? 9);

        const normalizedLoan = {
          ...raw,
          loanId: id,
          id,
          loanName: raw.loanName ?? `Loan ${id}`,
          school: raw.school ?? "No school listed",
          loanStartDate: raw.loanStartDate || raw.purchaseDate || "",
          purchaseDate: raw.purchaseDate || "",
          purchasePrice,
          nominalRate,
          termYears,
          graceYears,
          upfrontFee,
          monthlyFeeStart
        };

        const amort = calcAmort(
          normalizedLoan.purchasePrice,
          normalizedLoan.nominalRate,
          normalizedLoan.termYears,
          normalizedLoan.graceYears
        );

        const loanStart = new Date(normalizedLoan.loanStartDate);
        const purchaseDt = new Date(normalizedLoan.purchaseDate);
        const monthsSinceStartRaw = monthDiff(loanStart, purchaseDt);
        const monthsSinceStart = Number.isFinite(monthsSinceStartRaw) ? monthsSinceStartRaw : 0;

        amort.schedule = amort.schedule.map(row => {
          const ownershipMonthIndex = row.monthIndex - monthsSinceStart;
          const loanDate = addMonths(loanStart, row.monthIndex - 1);
          const ownershipDate = ownershipMonthIndex >= 1
            ? addMonths(purchaseDt, ownershipMonthIndex - 1)
            : null;

          return {
            ...row,
            ownershipMonthIndex,
            isOwned: ownershipMonthIndex >= 1,
            loanDate,
            ownershipDate
          };
        });

        let cumPrincipal = 0;
        let cumInterest  = 0;
        let cumFees      = 0;

        const termMonths = Math.max(
          1,
          Math.round(normalizedLoan.termYears * 12)
        );

        const balanceAtPurchase = amort.schedule[Math.max(0, monthsSinceStart - 1)]?.balance || 0;

        const earningsSchedule = amort.schedule.map(row => {
          const m = row.monthIndex;

          // Upfront fee only at ownership month 1
          const upfront = (row.isOwned && row.ownershipMonthIndex === 1 ? normalizedLoan.upfrontFee : 0);

          // Sliding monthly fee from monthlyFeeStart â†’ 0 over the term
          let monthlyFee = normalizedLoan.monthlyFeeStart * (1 - m / termMonths);
          if (!Number.isFinite(monthlyFee) || monthlyFee < 0) monthlyFee = 0;

          const feeThisMonth = row.isOwned ? upfront + monthlyFee : 0;
          if (row.isOwned) {
            cumFees      = +(cumFees + feeThisMonth).toFixed(2);
            cumPrincipal = +(cumPrincipal + row.principalPaid).toFixed(2);
            cumInterest  = +(cumInterest + row.interest).toFixed(2);
          }

          // Net earnings = principal + interest â€“ fees
          const netEarnings = +(cumPrincipal + cumInterest - cumFees).toFixed(2);

          return {
            ...row,
            feeThisMonth,
            cumPrincipal,
            cumInterest,
            cumFees,
            netEarnings,
            interestPaid: row.interest,
            principalPaid: row.principalPaid,
            loanDate: row.loanDate,
            ownershipDate: row.ownershipDate
          };
        }).filter(r => r.isOwned);

        return {
          ...normalizedLoan,
          amort,
          earningsSchedule,
          balanceAtPurchase,
          monthsSinceStart
        };
      });
    }

    // --------------------------
    // KPI calculations
    // --------------------------
    function computeEarningsKPIs(list){
      let totalNetToDate = 0;
      let totalNetProjected = 0;
      let totalFeesToDate = 0;
      let totalPrincipal = 0;
      let monthsCounted = 1;

      const TODAY = new Date();

      list.forEach(l => {
        if (!l.earningsSchedule.length) return;

        const lastIdx = l.earningsSchedule.length - 1;
        const loanStart = new Date(l.loanStartDate);
        const diffMonthsFromStartRaw = monthDiff(loanStart, TODAY);
        const diffMonthsFromStart = Number.isFinite(diffMonthsFromStartRaw)
          ? Math.max(1, diffMonthsFromStartRaw)
          : 1;
        const currentIdx = Math.max(0, Math.min(diffMonthsFromStart - 1, lastIdx));
        const atCurrent = l.earningsSchedule[currentIdx] || l.earningsSchedule[lastIdx];
        const atEnd = l.earningsSchedule[lastIdx];

        totalNetToDate += atCurrent.netEarnings || 0;
        totalFeesToDate += atCurrent.cumFees || 0;
        totalNetProjected += atEnd.netEarnings || 0;
        totalPrincipal += l.purchasePrice;

        monthsCounted = Math.max(
          monthsCounted,
          Math.min(diffMonthsFromStart, l.earningsSchedule.length)
        );
      });

      const avgMonthlyEarnings = monthsCounted > 0 ? totalNetToDate / monthsCounted : 0;

      return {
        totalNetToDate,
        totalNetProjected,
        totalFeesToDate,
        avgMonthlyEarnings,
        monthsCounted
      };
    }

    function getCurrentEarningsRow(loan) {
      const fallbackRow = { netEarnings: 0, cumPrincipal: 0, cumInterest: 0, cumFees: 0 };
      const lastIdx = loan.earningsSchedule.length - 1;
      const loanStart = new Date(loan.loanStartDate);
      const diffMonthsFromStartRaw = monthDiff(loanStart, new Date());
      const diffMonthsFromStart = Number.isFinite(diffMonthsFromStartRaw)
        ? Math.max(1, diffMonthsFromStartRaw)
        : 1;
      const currentIdx = Math.max(0, Math.min(diffMonthsFromStart - 1, lastIdx));
      const row = lastIdx >= 0
        ? loan.earningsSchedule[currentIdx] || loan.earningsSchedule[lastIdx]
        : fallbackRow;

      return {
        row,
        monthsCounted: Math.min(diffMonthsFromStart, loan.earningsSchedule.length || 1)
      };
    }

    let kpis = computeEarningsKPIs(loansWithEarnings);
    let totalPrincipal = 0;

    let miniHtmlTooltip = null;
    function getMiniHtmlTooltip() {
      if (!miniHtmlTooltip) {
        miniHtmlTooltip = document.createElement("div");
        miniHtmlTooltip.className = "lens-tooltip-html";
        miniHtmlTooltip.style.display = "none";
        document.body.appendChild(miniHtmlTooltip);
      }
      return miniHtmlTooltip;
    }

    function setMiniTooltipContent(lines) {
      const el = getMiniHtmlTooltip();
      el.innerHTML = lines.join("<br>");
    }

    function positionMiniTooltip(clientX, clientY, radius) {
      const el = getMiniHtmlTooltip();
      const rect = el.getBoundingClientRect();
      const offsetX = radius * 0.3;
      const offsetY = radius * 1.1;
      let x = clientX + offsetX;
      let y = clientY - offsetY - rect.height;

      el.style.left = `${x}px`;
      el.style.top  = `${y}px`;
      el.style.display = "block";
    }

    function hideMiniTooltip() {
      if (miniHtmlTooltip) miniHtmlTooltip.style.display = "none";
    }

    // --------------------------
    // Mini stacked earnings chart (per tile)
    // --------------------------
    
    // --------------------------
    // Mini stacked earnings chart (per tile)
    // --------------------------
    function createMiniStackedEarningsSVG(containerEl, earningsSchedule, loan){
      containerEl.innerHTML = "";
      const svgNS = "http://www.w3.org/2000/svg";
      const w = 170;
      const h = 48;
      const padL = 4, padR = 4, padT = 4, padB = 4;

      const data = earningsSchedule;

      let maxAbs = 0;
      data.forEach(d => {
        const pos = d.cumPrincipal + d.cumInterest;
        const neg = -d.cumFees;
        maxAbs = Math.max(maxAbs, pos, Math.abs(neg));
      });
      if(maxAbs <= 0) maxAbs = 1;

      const yZero = h/2;
      const halfHeight = (h - padT - padB) / 2;
      const scale = halfHeight / maxAbs;

      const count = data.length;
      const barW = (w - padL - padR) / Math.max(1, count);

      const svg = document.createElementNS(svgNS,"svg");
      svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
      svg.setAttribute("width","100%");
      svg.setAttribute("height","48");

      const stackedGroupId = `stack-${stackedBarGroupCounter++}`;

      const axis = document.createElementNS(svgNS,"line");
      axis.setAttribute("x1",padL);
      axis.setAttribute("x2",w-padR);
      axis.setAttribute("y1",yZero);
      axis.setAttribute("y2",yZero);
      axis.setAttribute("stroke","#cbd5e1");
      axis.setAttribute("stroke-width","0.8");
      svg.appendChild(axis);

      data.forEach((d, i) => {
        const x = padL + i*barW;

        const principal = d.cumPrincipal;
        const interest = d.cumInterest;
        const negFees = -d.cumFees;

        const hPrin = principal * scale;
        const hInt  = interest  * scale;
        const hFees = Math.abs(negFees) * scale;

        const yInt  = yZero - hInt;
        const yPrin = yZero - hInt - hPrin;
        const yFee  = yZero;

        const barWidth = Math.max(1, barW-2);

        const rPrin = document.createElementNS(svgNS,"rect");
        rPrin.setAttribute("x", x+1);
        rPrin.setAttribute("y", yPrin);
        rPrin.setAttribute("width", barWidth);
        rPrin.setAttribute("height", hPrin);
        rPrin.setAttribute("fill", "#0ea5e9");
        rPrin.__value = principal;
        prepareStackedBar(rPrin, stackedGroupId, 0, true);

        const rInt = document.createElementNS(svgNS,"rect");
        rInt.setAttribute("x", x+1);
        rInt.setAttribute("y", yInt);
        rInt.setAttribute("width", barWidth);
        rInt.setAttribute("height", hInt);
        rInt.setAttribute("fill", "#22c55e");
        rInt.__value  = interest;
        prepareStackedBar(rInt, stackedGroupId, 1, true);

        const rFee = document.createElementNS(svgNS,"rect");
        rFee.setAttribute("x", x+1);
        rFee.setAttribute("y", yFee);
        rFee.setAttribute("width", barWidth);
        rFee.setAttribute("height", hFees);
        rFee.setAttribute("fill", "#ef4444");
        rFee.__value  = negFees;
        prepareStackedBar(rFee, stackedGroupId, 2, false);

        svg.appendChild(rPrin);
        svg.appendChild(rInt);
        svg.appendChild(rFee);
      });

      // ==== Correct Today line using ownership start ====
const TODAY = new Date();

const firstOwnDate = new Date(loan.purchaseDate);
const lastOwnDate  = new Date(data[data.length - 1].ownershipDate);

// Total owned months
let totalOwnedMonths = monthDiff(firstOwnDate, lastOwnDate);
if (!Number.isFinite(totalOwnedMonths) || totalOwnedMonths <= 0) {
  totalOwnedMonths = data.length - 1;
}

// Months from purchase to today
let ownedMonthsToToday = monthDiff(firstOwnDate, TODAY);
if (!Number.isFinite(ownedMonthsToToday)) ownedMonthsToToday = 0;

// Clamp
ownedMonthsToToday = Math.max(0, Math.min(ownedMonthsToToday, totalOwnedMonths));

// Convert to X position
const ratio = totalOwnedMonths > 0 ? (ownedMonthsToToday / totalOwnedMonths) : 0;
const currentX = padL + ratio * (w - padL - padR);

      const vline = document.createElementNS(svgNS, "line");
      vline.setAttribute("x1", currentX);
      vline.setAttribute("x2", currentX);
      vline.setAttribute("y1", 0);
      vline.setAttribute("y2", h);
      vline.setAttribute("stroke", "#64748b");
      vline.setAttribute("stroke-dasharray", "4,3");
      vline.setAttribute("stroke-width", "1");
      svg.appendChild(vline);

      containerEl.appendChild(svg);

      let lensInstance = null;
      const lensRadius = 20;
      const lensScale = 2;

      function handleMove(e){
        const rect = svg.getBoundingClientRect();
        const mouseX = ((e.clientX - rect.left) / rect.width) * w;
        const mouseY = ((e.clientY - rect.top) / rect.height) * h;
        const x = Math.max(lensRadius, Math.min(w - lensRadius, mouseX));
        const y = Math.max(lensRadius, Math.min(h - lensRadius, mouseY));

        if(!lensInstance){
          lensInstance = createLens(svg, lensRadius, lensScale);
          const barClones = Array.from(svg.querySelectorAll("rect"))
            .filter(r => r.__value !== undefined || r.getAttribute("fill"));
          barClones.forEach(r => lensInstance.content.appendChild(r.cloneNode(true)));
          svg.appendChild(lensInstance.group);
        }

        updateLens(lensInstance, x, y);

        const idx = Math.max(0, Math.min(data.length - 1, Math.floor((x - padL) / barW)));
        const row = data[idx];
        const loanStart = new Date(loan.loanStartDate);
        const tooltipDate = addMonths(loanStart, idx);
        const tooltipLines = [
          `Date: ${formatDate(tooltipDate)}`,
          `Principal: $${row.cumPrincipal.toFixed(2)}`,
          `Interest: $${row.cumInterest.toFixed(2)}`,
          `Fees: -$${row.cumFees.toFixed(2)}`,
          `Net: $${row.netEarnings.toFixed(2)}`
        ];

        setMiniTooltipContent(tooltipLines);
        positionMiniTooltip(e.clientX, e.clientY, lensRadius);
      }

      function handleLeave(){
        removeLens(svg, lensInstance);
        lensInstance = null;
        hideMiniTooltip();
      }

      svg.addEventListener("mousemove", handleMove);
      svg.addEventListener("mouseleave", handleLeave);
    }



    // --------------------------
    // Drawer stacked chart (larger)
    // --------------------------
    
    // --------------------------
    // Drawer stacked chart (larger)
    // --------------------------
    function createDrawerStackedChart(containerEl, earningsSchedule, loan){
      containerEl.innerHTML = "";
      const svgNS = "http://www.w3.org/2000/svg";
      const rect = containerEl.getBoundingClientRect();
      const w = Math.max(360, rect.width || 700);
      const h = 260;
      const padL = 50, padR = 20, padT = 20, padB = 16;

      const data = earningsSchedule;

      let maxValue = 0;
      let minValue = 0;
      data.forEach(d => {
        const pos = d.cumPrincipal + d.cumInterest;
        const neg = -d.cumFees;
        maxValue = Math.max(maxValue, pos);
        minValue = Math.min(minValue, neg);
      });

      const yMax = Math.max(maxValue, 1);
      const yMin = minValue < -10 ? minValue : -(yMax * 0.10);
      const yRange = yMax - yMin || 1;
      const usableHeight = h - padT - padB;
      const scale = usableHeight / yRange;
      const yZero = padT + (yMax / yRange) * usableHeight;

      const count = data.length;
      const barW = (w - padL - padR) / Math.max(1, count);

      const svg = document.createElementNS(svgNS,"svg");
      svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
      svg.setAttribute("width","100%");
      svg.setAttribute("height","100%");

      const gridBelowZero = 2;
      const gridAboveZero = 4;

      for (let gy = -gridBelowZero; gy <= gridAboveZero; gy++) {
        const y = yZero - gy * ((yZero - padT) / gridAboveZero);

        const gridLine = document.createElementNS(svgNS,"line");
        gridLine.setAttribute("x1",padL);
        gridLine.setAttribute("x2",w-padR);
        gridLine.setAttribute("y1",y);
        gridLine.setAttribute("y2",y);
        gridLine.setAttribute("stroke", gy >= 0 ? "var(--grid-strong)" : "var(--grid-light)");
        gridLine.setAttribute("stroke-width","0.7");
        svg.appendChild(gridLine);

        if(gy > 0){
          const lbl = document.createElementNS(svgNS,"text");
          const value = (yMax / gridAboveZero) * gy;
          lbl.textContent = "$" + Math.round(value).toLocaleString();
          lbl.setAttribute("x", padL - 10);
          lbl.setAttribute("y", y + 4);
          lbl.setAttribute("font-size","11");
          lbl.setAttribute("fill","var(--text)");
          lbl.setAttribute("text-anchor","end");
          svg.appendChild(lbl);
        }
      }

      const axis = document.createElementNS(svgNS,"line");
      axis.setAttribute("x1",padL);
      axis.setAttribute("x2",w-padR);
      axis.setAttribute("y1",yZero);
      axis.setAttribute("y2",yZero);
      axis.setAttribute("stroke","var(--grid-strong)");
      axis.setAttribute("stroke-width","1");
      svg.appendChild(axis);

      data.forEach((d, i) => {
        const stackedGroupId = `stack-drawer-${d.ownershipMonthIndex || d.monthIndex || i}`;
        const x = padL + i*barW;

        const principal = d.cumPrincipal;
        const interest = d.cumInterest;
        const negFees = -d.cumFees;

        const hPrin = principal * scale;
        const hInt  = interest  * scale;
        const hFees = Math.abs(negFees) * scale;

        const yInt  = yZero - hInt;
        const yPrin = yZero - hInt - hPrin;
        const yFee  = yZero;

        const barWidth = Math.max(2, barW-4);

        const rPrin = document.createElementNS(svgNS,"rect");
        rPrin.setAttribute("x", x+2);
        rPrin.setAttribute("y", yPrin);
        rPrin.setAttribute("width", barWidth);
        rPrin.setAttribute("height", hPrin);
        rPrin.setAttribute("fill","#0ea5e9");
        prepareStackedBar(rPrin, stackedGroupId, 0, true);

        const rInt = document.createElementNS(svgNS,"rect");
        rInt.setAttribute("x", x+2);
        rInt.setAttribute("y", yInt);
        rInt.setAttribute("width", barWidth);
        rInt.setAttribute("height", hInt);
        rInt.setAttribute("fill","#22c55e");
        prepareStackedBar(rInt, stackedGroupId, 1, true);

        const rFee = document.createElementNS(svgNS,"rect");
        rFee.setAttribute("x", x+2);
        rFee.setAttribute("y", yFee);
        rFee.setAttribute("width", barWidth);
        rFee.setAttribute("height", hFees);
        rFee.setAttribute("fill","#ef4444");
        prepareStackedBar(rFee, stackedGroupId, 2, false);

        svg.appendChild(rPrin);
        svg.appendChild(rInt);
        svg.appendChild(rFee);

        if(((d.ownershipMonthIndex || d.monthIndex) % 12) === 0 || (d.ownershipMonthIndex || d.monthIndex) === 1){
          const lbl = document.createElementNS(svgNS,"text");
          const dateLabel = d.ownershipDate || d.loanDate;
          lbl.textContent = formatMonthYear(dateLabel);
          lbl.setAttribute("x", x+barWidth/2);
          lbl.setAttribute("y", h-padB+16);
          lbl.setAttribute("font-size","11");
          lbl.setAttribute("fill","var(--text)");
          lbl.setAttribute("text-anchor","middle");
          svg.appendChild(lbl);
        }
      });

      // ==== Correct Today line using ownership start ====
const TODAY = new Date();

const firstOwnDate = new Date(loan.purchaseDate);
const lastOwnDate  = new Date(data[data.length - 1].ownershipDate);

// Total owned months
let totalOwnedMonths = monthDiff(firstOwnDate, lastOwnDate);
if (!Number.isFinite(totalOwnedMonths) || totalOwnedMonths <= 0) {
  totalOwnedMonths = data.length - 1;
}

// Months from purchase to today
let ownedMonthsToToday = monthDiff(firstOwnDate, TODAY);
if (!Number.isFinite(ownedMonthsToToday)) ownedMonthsToToday = 0;

// Clamp
ownedMonthsToToday = Math.max(0, Math.min(ownedMonthsToToday, totalOwnedMonths));

const ratio = totalOwnedMonths > 0 ? (ownedMonthsToToday / totalOwnedMonths) : 0;
const currentX = padL + ratio * (w - padL - padR);

const vline = document.createElementNS(svgNS, "line");
vline.setAttribute("x1", currentX);
vline.setAttribute("x2", currentX);
vline.setAttribute("y1", 0);
vline.setAttribute("y2", h);
vline.setAttribute("stroke", "#64748b");
vline.setAttribute("stroke-dasharray", "4,3");
vline.setAttribute("stroke-width", "1");
svg.appendChild(vline);

      containerEl.appendChild(svg);

      let lensInstance = null;
      let tooltipInstance = null;
      const lensRadius = 40;
      const lensScale = 1.5;

      function handleMove(e){
        const rect = svg.getBoundingClientRect();
        const mouseX = ((e.clientX - rect.left) / rect.width) * w;
        const mouseY = ((e.clientY - rect.top) / rect.height) * h;
        const x = Math.max(lensRadius, Math.min(w - lensRadius, mouseX));
        const y = Math.max(lensRadius, Math.min(h - lensRadius, mouseY));

        if(!lensInstance){
          lensInstance = createLens(svg, lensRadius, lensScale);
          const barClones = Array.from(svg.querySelectorAll("rect"))
            .filter(r => r.__value !== undefined || r.getAttribute("fill"));
          barClones.forEach(r => lensInstance.content.appendChild(r.cloneNode(true)));
          svg.appendChild(lensInstance.group);
        }

        if(!tooltipInstance){
          tooltipInstance = createTooltip(svg, true);
        }

        updateLens(lensInstance, x, y);

        const idx = Math.max(0, Math.min(data.length - 1, Math.floor((x - padL) / barW)));
        const row = data[idx];
        const tooltipLines = [
          `${currentLoan ? currentLoan.loanName : "Loan"} â€¢ ${formatDate(row.ownershipDate || row.loanDate)}`,
          `Principal: $${row.cumPrincipal.toFixed(2)}`,
          `Interest: $${row.cumInterest.toFixed(2)}`,
          `Fees: -$${row.cumFees.toFixed(2)}`,
          `Net: $${row.netEarnings.toFixed(2)}`
        ];

        updateTooltipContent(tooltipInstance, tooltipLines, true);
        updateTooltipPosition(tooltipInstance, x, y, lensRadius);
      }

      function handleLeave(){
        removeLens(svg, lensInstance);
        lensInstance = null;
        if(tooltipInstance){
          tooltipInstance.group.remove();
          tooltipInstance = null;
        }
      }

      svg.addEventListener("mousemove", handleMove);
      svg.addEventListener("mouseleave", handleLeave);
    }

    // --------------------------
    // Render KPI tiles
    // --------------------------
    const kpisEl = document.getElementById("kpis");
    function renderKPIs() {
      kpis = computeEarningsKPIs(loansWithEarnings);
      totalPrincipal = loans.reduce((s,l)=>s+l.purchasePrice,0);
      kpisEl.innerHTML = `
        <div class="kpi" data-kpi="netToDate">
          <h3>Total Net Earnings to Date</h3>
          <p id="kpiNetToDate">$${kpis.totalNetToDate.toLocaleString(undefined,{maximumFractionDigits:0})}</p>
        </div>
        <div class="kpi" data-kpi="projected">
          <h3>Projected Lifetime Earnings</h3>
          <p id="kpiNetProj">$${kpis.totalNetProjected.toLocaleString(undefined,{maximumFractionDigits:0})}</p>
        </div>
        <div class="kpi" data-kpi="avgMonthly">
          <h3>Average Monthly Earnings</h3>
          <p id="kpiAvgMonth">$${kpis.avgMonthlyEarnings.toFixed(2)}</p>
        </div>
        <div class="kpi" data-kpi="fees">
          <h3>Total Fees to Date</h3>
          <p id="kpiFees">$${kpis.totalFeesToDate.toLocaleString(undefined,{maximumFractionDigits:0})}</p>
        </div>
      `;
    }

    // --------------------------
    // KPI drawers (shared drawer)
    // --------------------------
    function resetDrawerContent(){
      drawerChartArea.innerHTML = "";
      drawerExtra.innerHTML = "";
    }

    function openDrawerBase(){
      drawer.classList.add("open");
      drawer.setAttribute("aria-hidden","false");
      drawer.scrollTop = 0;
    }

    function openKpi1(){
      currentLoan = null;
      drawerTitle.textContent = "Total Net Earnings to Date";
      drawerSub.textContent = "Portfolio-level earnings across all loans.";
      drawerPrimaryTitle.textContent = "Net Earnings to Date";
      drawerPrimary.textContent = `$${kpis.totalNetToDate.toFixed(2)}`;
      drawerSecondaryTitle.textContent = "Total Fees to Date";
      drawerSecondary.textContent = `$${kpis.totalFeesToDate.toFixed(2)}`;
      resetDrawerContent();
      renderKPI1Chart(loansWithEarnings, "drawerChartArea");
      drawerExtra.innerHTML = `<div class="amort-wrap" id="drawerKpiTable"></div>`;
      renderKPI1Table(loansWithEarnings, "drawerKpiTable");
      openDrawerBase();
    }

    function openKpi2(){
      currentLoan = null;
      drawerTitle.textContent = "Projected Lifetime Earnings";
      drawerSub.textContent = "Net earnings at maturity for all loans.";
      drawerPrimaryTitle.textContent = "Projected Lifetime Net";
      drawerPrimary.textContent = `$${kpis.totalNetProjected.toFixed(2)}`;
      drawerSecondaryTitle.textContent = "Total Principal";
      drawerSecondary.textContent = `$${totalPrincipal.toLocaleString()}`;
      resetDrawerContent();
      renderKPI2Chart(loansWithEarnings, "drawerChartArea");
      drawerExtra.innerHTML = `<div class="amort-wrap" id="drawerKpiTable"></div>`;
      renderKPI2Table(loansWithEarnings, "drawerKpiTable");
      openDrawerBase();
    }

    function openKpi3(){
      currentLoan = null;
      drawerTitle.textContent = "Average Monthly Earnings";
      drawerSub.textContent = `Based on net earnings through ${formatDate(new Date())}.`;
      drawerPrimaryTitle.textContent = "Avg Monthly Earnings";
      drawerPrimary.textContent = `$${kpis.avgMonthlyEarnings.toFixed(2)}`;
      drawerSecondaryTitle.textContent = "Months Counted";
      drawerSecondary.textContent = `${kpis.monthsCounted || 0} months`;
      resetDrawerContent();
      renderKPI3Chart(loansWithEarnings, "drawerChartArea");
      drawerExtra.innerHTML = `<div class="amort-wrap" id="drawerKpiTable"></div>`;
      renderKPI3Table(loansWithEarnings, "drawerKpiTable");
      openDrawerBase();
    }

    function openKpi4(){
      currentLoan = null;
      drawerTitle.textContent = "Total Fees to Date";
      drawerSub.textContent = "Cumulative monthly fees across all loans.";
      drawerPrimaryTitle.textContent = "Total Fees";
      drawerPrimary.textContent = `$${kpis.totalFeesToDate.toFixed(2)}`;
      drawerSecondaryTitle.textContent = "Total Loans";
      drawerSecondary.textContent = `${loans.length}`;
      resetDrawerContent();
      renderKPI4Chart(loansWithEarnings, "drawerChartArea");
      drawerExtra.innerHTML = `<div class="amort-wrap" id="drawerKpiTable"></div>`;
      renderKPI4Table(loansWithEarnings, "drawerKpiTable");
      openDrawerBase();
    }

    // --------------------------
    // Loan tiles
    // --------------------------
    const grid = document.getElementById("loanGrid");
    const drawer = document.getElementById("drawer");
    const drawerTitle = document.getElementById("drawerTitle");
    const drawerSub = document.getElementById("drawerSub");
    const drawerPrimaryTitle = document.getElementById("drawerPrimaryTitle");
    const drawerPrimary = document.getElementById("drawerPrimary");
    const drawerSecondaryTitle = document.getElementById("drawerSecondaryTitle");
    const drawerSecondary = document.getElementById("drawerSecondary");
    const drawerChartArea = document.getElementById("drawerChartArea");
    const drawerExtra = document.getElementById("drawerExtra");

    let currentLoan = null;

    function renderLoanTiles() {
      grid.innerHTML = "";
      loansWithEarnings.forEach(loan => {
        const hasSchedule = loan.earningsSchedule.length > 0;
        const lastIdx = hasSchedule ? loan.earningsSchedule.length - 1 : 0;
        const fallbackRow = { netEarnings: 0, ownershipDate: new Date(loan.loanStartDate), loanDate: new Date(loan.loanStartDate) };
        const loanStart = new Date(loan.loanStartDate);
        const TODAY = new Date();
        const diffMonthsFromStartRaw = monthDiff(loanStart, TODAY);
        const diffMonthsFromStart = Number.isFinite(diffMonthsFromStartRaw)
          ? Math.max(1, diffMonthsFromStartRaw)
          : 1;
        const currentIdx = Math.max(0, Math.min(diffMonthsFromStart - 1, lastIdx));
        const atCurrent = hasSchedule
          ? loan.earningsSchedule[currentIdx] || loan.earningsSchedule[lastIdx]
          : fallbackRow;
        const currentMonthLabel = formatMonthYear(atCurrent.ownershipDate || atCurrent.loanDate);

        const tile = document.createElement("div");
        tile.className = "tile";
tile.innerHTML = `
  <div class="tile-left">

    <!-- Line 1: Loan Name -->
    <div class="loan-name" style="font-weight:700; font-size:14px;">
      ${loan.loanName}
    </div>

    <!-- Line 2: School -->
    <div class="loan-name" style="font-weight:700; font-size:14px; margin-top:2px;">
      ${loan.school || "No school listed"}
    </div>

    <!-- Line 3: Rate Â· Term Â· Matures -->
    <div class="loan-sub" style="margin-top:6px;">
      Rate: ${(loan.nominalRate * 100).toFixed(2)}% &nbsp;Â·&nbsp;
      Term: ${loan.termYears} yrs &nbsp;Â·&nbsp;
      Matures: ${formatMonthYear(addMonths(new Date(loan.loanStartDate), loan.termYears * 12))}
    </div>

    <!-- Line 4: Loan ID -->
    <div class="loan-sub" style="margin-top:4px;">
      Loan ${loan.loanId}
    </div>

  </div>

  <div class="chart-wrap">
    <div class="mini-label">
      Net Earnings ${currentMonthLabel}: $${atCurrent.netEarnings.toFixed(0)}
    </div>
    <div class="mini-chart"></div>
  </div>
`;

        tile.addEventListener("click", () => openLoanDrawer(loan));
        grid.appendChild(tile);

        const mini = tile.querySelector('.mini-chart');
        createMiniStackedEarningsSVG(mini, loan.earningsSchedule, loan);
      });
    }

    async function initPage() {
      await loadLoansFromBackend();
      rebuildLoansWithEarnings();
      renderKPIs();
      renderLoanTiles();
      bindKpiClickHandlers();
    }

    // --------------------------
    // Drawer behavior
    // --------------------------
    document.getElementById("closeBtn").addEventListener("click", closeDrawer);
    document.addEventListener("keydown", e => {
      if(e.key === "Escape") closeDrawer();
    });
    document.addEventListener("click", e => {
      if(drawer.classList.contains("open")){
        const inside = drawer.contains(e.target);
        const tileClicked = e.target.closest(".tile");
        const kpiClicked = e.target.closest(".kpi");
        if(!inside && !tileClicked && !kpiClicked){
          closeDrawer();
        }
      }
    });

    function closeDrawer(){
      drawer.classList.remove("open");
      drawer.setAttribute("aria-hidden","true");
      currentLoan = null;
    }

    function openLoanDrawer(loan){
      currentLoan = loan;
      resetDrawerContent();
      const hasSchedule = loan.earningsSchedule.length > 0;
      const lastIdx = hasSchedule ? loan.earningsSchedule.length - 1 : 0;
      const fallbackRow = { netEarnings: 0, cumFees: 0, ownershipDate: new Date(loan.loanStartDate), loanDate: new Date(loan.loanStartDate) };
      const loanStart = new Date(loan.loanStartDate);
      const TODAY = new Date();
      const diffMonthsFromStartRaw = monthDiff(loanStart, TODAY);
      const diffMonthsFromStart = Number.isFinite(diffMonthsFromStartRaw)
        ? Math.max(1, diffMonthsFromStartRaw)
        : 1;
      const currentIdx = Math.max(0, Math.min(diffMonthsFromStart - 1, lastIdx));
      const atCurrent = hasSchedule
        ? loan.earningsSchedule[currentIdx] || loan.earningsSchedule[lastIdx]
        : fallbackRow;
      const atEnd = hasSchedule ? loan.earningsSchedule[lastIdx] : fallbackRow;

      drawerTitle.textContent = `${loan.loanName} â€” Earnings (${loan.school || "No school"})`;
      drawerSub.innerHTML = `
        <div>${loan.school || "No school"} â€¢ Purchased ${loan.purchaseDate} â€¢ $${loan.purchasePrice.toLocaleString()}</div>
        <div class="drawer-detail">Balance at Purchase: $${(loan.balanceAtPurchase || 0).toLocaleString()}</div>
      `;
      drawerPrimaryTitle.textContent = "Net Earnings to Date";
      drawerPrimary.textContent = `$${atCurrent.netEarnings.toFixed(2)}`;
      drawerSecondaryTitle.textContent = "Fees to Date";
      drawerSecondary.textContent = `$${atCurrent.cumFees.toFixed(2)}`;

      createDrawerStackedChart(drawerChartArea, loan.earningsSchedule, loan);

      // table
      let rowsHtml = "";
      loan.earningsSchedule.forEach(r => {
        rowsHtml += `
          <tr>
            <td>${formatDate(r.loanDate)}</td>
            <td>${r.isOwned ? formatDate(r.ownershipDate) : ""}</td>
            <td>$${r.cumPrincipal.toFixed(2)}</td>
            <td>$${r.cumInterest.toFixed(2)}</td>
            <td>-$${r.cumFees.toFixed(2)}</td>
            <td>$${r.netEarnings.toFixed(2)}</td>
          </tr>
        `;
      });

      drawerExtra.innerHTML = `
        <p style="margin:0 0 6px; font-size:13px; color:var(--muted);">
          ${loan.loanName} â€” ${loan.school || "No school"}
        </p>
        <h3 style="margin-top:12px;margin-bottom:8px;">Earnings Breakdown by Month</h3>
        <div class="amort-wrap">
          <table>
            <thead>
              <tr>
                <th>Loan Date</th>
                <th>Ownership Date</th>
                <th>Cumulative Principal</th>
                <th>Cumulative Interest</th>
                <th>Cumulative Fees</th>
                <th>Net Earnings</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>
        </div>
      `;
      openDrawerBase();
    }

    // --------------------------
    // KPI click wiring
    // --------------------------
    const kpiOpeners = {
      netToDate:openKpi1,
      projected:openKpi2,
      avgMonthly:openKpi3,
      fees:openKpi4
    };

    function bindKpiClickHandlers() {
      document.querySelectorAll(".kpi").forEach(k => {
        k.addEventListener("click", () => {
          const key = k.getAttribute("data-kpi");
          if(kpiOpeners[key]){
            kpiOpeners[key]();
          }
        });
      });
    }

    document.addEventListener("DOMContentLoaded", initPage);

    // --------------------------
    // Theme toggle
    // --------------------------
    const themeToggleBtn = document.getElementById("themeToggle");
    const root = document.documentElement;
    const THEME_KEY = "reportsTheme";

    function applyTheme(mode){
      const nextMode = mode === "dark" ? "dark" : "light";
      root.setAttribute("data-theme", nextMode);
      themeToggleBtn.textContent = nextMode === "dark" ? "â˜€ï¸" : "ðŸŒ™";
      themeToggleBtn.setAttribute("aria-label", nextMode === "dark" ? "Switch to light mode" : "Switch to dark mode");
      try { localStorage.setItem(THEME_KEY, nextMode); } catch(e){}
    }

    function initTheme(){
      let saved = null;
      try { saved = localStorage.getItem(THEME_KEY); } catch(e){}
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      applyTheme(saved || (prefersDark ? "dark" : "light"));
    }

    initTheme();

    themeToggleBtn.addEventListener("click", () => {
      const isDark = root.getAttribute("data-theme") === "dark";
      applyTheme(isDark ? "light" : "dark");
    });

    // ======================
    // KPI CHART RENDERERS
    // ======================
    const loanColors = ["#0ea5e9", "#22c55e", "#7c3aed", "#14b8a6", "#f59e0b", "#ef4444", "#6366f1", "#a855f7", "#f97316", "#06b6d4"];

    function buildKpiStackedChart(containerId, data, valueGetter, showCurrentLine = true, mode = null){
      const container = document.getElementById(containerId);
      if(!container) return;
      container.innerHTML = "";

      const key = mode || containerId;
      const TODAY = new Date();
      const startTimes = data.map(l => new Date(l.loanStartDate).getTime()).filter(t => Number.isFinite(t));
      const earliestLoanStart = startTimes.length
        ? new Date(Math.min(...startTimes))
        : new Date();

      const svgNS = "http://www.w3.org/2000/svg";
      const rect = container.getBoundingClientRect();
      const w = Math.max(360, rect.width || 700);
      const h = 260;
      const padL = 50, padR = 20, padT = 20, padB = 16;

      const maxMonths = Math.max(1, ...data.map(l => l.earningsSchedule.length));
      const months = Array.from({length:maxMonths}, (_,i) => {
        const sampleRow = data.find(l => l.earningsSchedule[i])?.earningsSchedule[i];
        const month = sampleRow?.ownershipMonthIndex || i+1;
        const monthDate = addMonths(earliestLoanStart, i);
        const contributions = data.map(loan => {
          const row = loan.earningsSchedule[Math.min(i, loan.earningsSchedule.length-1)];
          const value = valueGetter(row || {}, month, loan);
          return {
            loanId: loan.id,
            value,
            color: loanColors[(loan.id - 1) % loanColors.length]
          };
        });
        const posTotal = contributions.reduce((sum,c) => c.value > 0 ? sum + c.value : sum, 0);
        const negTotal = contributions.reduce((sum,c) => c.value < 0 ? sum + c.value : sum, 0);
        return { month, monthDate, contributions, posTotal, negTotal };
      });

      let maxValue = 0;
      let minValue = 0;
      months.forEach(m => {
        maxValue = Math.max(maxValue, m.posTotal);
        minValue = Math.min(minValue, m.negTotal);
      });

      const yMax = Math.max(maxValue, 1);
      const yMin = minValue < -10 ? minValue : - (yMax * 0.10);
      const yRange = yMax - yMin || 1;
      const usableHeight = h - padT - padB;
      const scale = usableHeight / yRange;
      const yZero = padT + (yMax / yRange) * usableHeight;

      const count = months.length;
      const barW = (w - padL - padR) / Math.max(1, count);

      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
      svg.setAttribute("width","100%");
      svg.setAttribute("height","100%");

      const gridBelowZero = 2;
      const gridAboveZero = 4;

      for (let gy = -gridBelowZero; gy <= gridAboveZero; gy++) {
        const y = yZero - gy * ((yZero - padT) / gridAboveZero);

        const gridLine = document.createElementNS(svgNS,"line");
        gridLine.setAttribute("x1",padL);
        gridLine.setAttribute("x2",w-padR);
        gridLine.setAttribute("y1",y);
        gridLine.setAttribute("y2",y);
        gridLine.setAttribute("stroke", gy >= 0 ? "var(--grid-strong)" : "var(--grid-light)");
        gridLine.setAttribute("stroke-width","0.7");
        svg.appendChild(gridLine);

        if(gy > 0){
          const lbl = document.createElementNS(svgNS,"text");
          const value = (yMax / gridAboveZero) * gy;
          lbl.textContent = "$" + Math.round(value).toLocaleString();
          lbl.setAttribute("x", padL - 10);
          lbl.setAttribute("y", y + 4);
          lbl.setAttribute("font-size","11");
          lbl.setAttribute("fill","var(--text)");
          lbl.setAttribute("text-anchor","end");
          svg.appendChild(lbl);
        }
      }

      const axis = document.createElementNS(svgNS,"line");
      axis.setAttribute("x1",padL);
      axis.setAttribute("x2",w-padR);
      axis.setAttribute("y1",yZero);
      axis.setAttribute("y2",yZero);
      axis.setAttribute("stroke","var(--grid-strong)");
      axis.setAttribute("stroke-width","1");
      svg.appendChild(axis);

      months.forEach((m, idx) => {
        const stackedGroupId = `stack-kpi-${m.month}`;
        const x = padL + idx*barW;
        let yPos = yZero;
        let yNeg = yZero;
        const barWidth = Math.max(2, barW-4);

        m.contributions.forEach((c, loanIndex) => {
          const hVal = Math.abs(c.value) * scale;
          if(hVal <= 0) return;

          const r = document.createElementNS(svgNS,"rect");
          r.setAttribute("x", x+2);
          r.setAttribute("width", barWidth);
          r.setAttribute("fill", c.color);
          prepareStackedBar(r, stackedGroupId, loanIndex, c.value >= 0);

          if(c.value >= 0){
            yPos -= hVal;
            r.setAttribute("y", yPos);
            r.setAttribute("height", hVal);
          } else {
            r.setAttribute("y", yNeg);
            r.setAttribute("height", hVal);
            yNeg += hVal;
          }

          svg.appendChild(r);
        });

        if((m.month % 12) === 0 || m.month === 1){
          const lbl = document.createElementNS(svgNS,"text");
          lbl.textContent = "M"+m.month;
          lbl.setAttribute("x", x+barWidth/2);
          lbl.setAttribute("y", h-padB+16);
          lbl.setAttribute("font-size","11");
          lbl.setAttribute("fill","var(--text)");
          lbl.setAttribute("text-anchor","middle");
          svg.appendChild(lbl);
        }
      });

      if(showCurrentLine){
        const currentMonthFromStartRaw = monthDiff(earliestLoanStart, TODAY);
        const currentMonthFromStart = Number.isFinite(currentMonthFromStartRaw)
          ? Math.max(1, currentMonthFromStartRaw)
          : 1;
        const currentX = padL + (Math.min(currentMonthFromStart, months.length) - 1) * barW;
        const vline = document.createElementNS(svgNS, "line");
        vline.setAttribute("x1", currentX);
        vline.setAttribute("x2", currentX);
        vline.setAttribute("y1", 0);
        vline.setAttribute("y2", h);
        vline.setAttribute("stroke", "#64748b");
        vline.setAttribute("stroke-dasharray", "4,3");
        vline.setAttribute("stroke-width", "1.5");
        svg.appendChild(vline);
      }

      container.appendChild(svg);

      let lensInstance = null;
      let tooltipInstance = null;
      const lensRadius = 40;
      const lensScale = 1.5;

      function handleMove(e){
        const rect = svg.getBoundingClientRect();
        const mouseX = ((e.clientX - rect.left) / rect.width) * w;
        const mouseY = ((e.clientY - rect.top) / rect.height) * h;
        const x = Math.max(lensRadius, Math.min(w - lensRadius, mouseX));
        const y = Math.max(lensRadius, Math.min(h - lensRadius, mouseY));

        if(!lensInstance){
          lensInstance = createLens(svg, lensRadius, lensScale);
          const barClones = Array.from(svg.querySelectorAll("rect"))
            .filter(r => r.__value !== undefined || r.getAttribute("fill"));
          barClones.forEach(r => lensInstance.content.appendChild(r.cloneNode(true)));
          svg.appendChild(lensInstance.group);
        }

        if(!tooltipInstance){
          tooltipInstance = createTooltip(svg, true);
        }

        updateLens(lensInstance, x, y);

        const idx = Math.max(0, Math.min(months.length - 1, Math.floor((x - padL) / barW)));
        const monthRow = months[idx];
        const month = monthRow.month;

        const aggregates = data.reduce((acc, loan) => {
          const row = loan.earningsSchedule[Math.min(idx, loan.earningsSchedule.length-1)] || {};
          acc.principal += row.cumPrincipal || 0;
          acc.interest += row.cumInterest || 0;
          acc.fees += row.cumFees || 0;
          acc.net += row.netEarnings || 0;
          return acc;
        }, {principal:0, interest:0, fees:0, net:0});

        let tooltipLines = [];
        if(key === "kpi1"){ // Net earnings to date
          tooltipLines = [
            `Date: ${formatMonthYear(monthRow.monthDate)}`,
  `Net: $${aggregates.net.toFixed(2)}`,
  `Principal: $${aggregates.principal.toFixed(2)}`,
  `Interest: $${aggregates.interest.toFixed(2)}`,
  `Fees: -$${aggregates.fees.toFixed(2)}`
          ];
        } else if(key === "kpi2"){ // Projected lifetime
          tooltipLines = [
            `Date: ${formatMonthYear(monthRow.monthDate)}`,
  `Projected Net: $${(monthRow.posTotal + monthRow.negTotal).toFixed(2)}`
          ];
        } else if(key === "kpi3"){ // Average monthly
          const avg = month > 0 ? aggregates.net / month : 0;
          tooltipLines = [
             `Date: ${formatMonthYear(monthRow.monthDate)}`,
  `Avg / Month: $${avg.toFixed(2)}`,
  `Net to Date: $${aggregates.net.toFixed(2)}`
          ];
        } else if(key === "kpi4"){ // Fees
          tooltipLines = [
            `Date: ${formatMonthYear(monthRow.monthDate)}`,
  `Fees: -$${aggregates.fees.toFixed(2)}`,
  `Net: $${aggregates.net.toFixed(2)}`
          ];
        }

        updateTooltipContent(tooltipInstance, tooltipLines, true);
        updateTooltipPosition(tooltipInstance, x, y, lensRadius);
      }

      function handleLeave(){
        removeLens(svg, lensInstance);
        lensInstance = null;
        if(tooltipInstance){
          tooltipInstance.group.remove();
          tooltipInstance = null;
        }
      }

      svg.addEventListener("mousemove", handleMove);
      svg.addEventListener("mouseleave", handleLeave);
    }


    function renderKPI1Chart(data, containerId = "kpi1Chart"){
      const limitedData = data.map(loan => ({
        ...loan,
        earningsSchedule: loan.earningsSchedule.slice(0, 18)
      }));
      buildKpiStackedChart(containerId, limitedData, row => row.netEarnings || 0, false, "kpi1");
    }
    function renderKPI2Chart(data, containerId = "kpi2Chart"){
      buildKpiStackedChart(containerId, data, row => row.netEarnings || 0, true, "kpi2");
    }
    function renderKPI3Chart(data, containerId = "kpi3Chart"){
      buildKpiStackedChart(containerId, data, (row, month) => {
        const net = row.netEarnings || 0;
        return month > 0 ? net / month : 0;
      }, true, "kpi3");
    }
    function renderKPI4Chart(data, containerId = "kpi4Chart"){
      buildKpiStackedChart(containerId, data, row => -(row.cumFees || 0), true, "kpi4");
    }

    // ======================
    // KPI TABLE RENDERERS
    // ======================
    function renderKpiTable(containerId, headers, rows){
      const container = document.getElementById(containerId);
      if(!container) return;
      const headHtml = headers.map(h=>`<th>${h}</th>`).join("");
      const bodyHtml = rows.map(r=>`<tr>${r.map(cell=>`<td>${cell}</td>`).join("")}</tr>`).join("");
      container.innerHTML = `
        <table>
          <thead><tr>${headHtml}</tr></thead>
          <tbody>${bodyHtml}</tbody>
        </table>
      `;
    }

    function renderKPI1Table(data, containerId = "kpi1Table"){
      const rows = data.map(l => {
        const { row: atCur } = getCurrentEarningsRow(l);
        return [
          `${l.loanName}`,
          `$${atCur.netEarnings.toFixed(2)}`,
          `$${atCur.cumPrincipal.toFixed(2)}`,
          `$${atCur.cumInterest.toFixed(2)}`,
          `-$${atCur.cumFees.toFixed(2)}`
        ];
      });
      renderKpiTable(containerId, ["Loan","Net Earnings","Principal","Interest","Fees"], rows);
    }
    function renderKPI2Table(data, containerId = "kpi2Table"){
      const rows = data.map(l => {
        const lastRow = l.earningsSchedule[l.earningsSchedule.length-1] || { netEarnings: 0 };
        return [
          `${l.loanName}`,
          `$${lastRow.netEarnings.toFixed(2)}`,
          `$${l.purchasePrice.toFixed(2)}`,
          `${l.termYears} yrs`,
          `${l.graceYears} yrs grace`
        ];
      });
      renderKpiTable(containerId, ["Loan","Projected Net","Principal","Term","Grace"], rows);
    }
    function renderKPI3Table(data, containerId = "kpi3Table"){
      const rows = data.map(l => {
        const { row: atCur, monthsCounted } = getCurrentEarningsRow(l);
        const monthsForAvg = Math.max(1, monthsCounted);
        const avg = monthsForAvg > 0 ? atCur.netEarnings / monthsForAvg : 0;
        return [
          `${l.loanName}`,
          `$${avg.toFixed(2)}`,
          `$${atCur.netEarnings.toFixed(2)}`,
          `${monthsForAvg}`,
          `$${(l.monthlyFeeStart || 0).toFixed(2)}/mo`
        ];
      });
      renderKpiTable(containerId, ["Loan","Avg / Mo","Net to Date","Months","Fees"], rows);
    }
    function renderKPI4Table(data, containerId = "kpi4Table"){
      const rows = data.map(l => {
        const { row: atCur } = getCurrentEarningsRow(l);
        return [
          `${l.loanName}`,
          l.purchaseDate,
          `$${(l.monthlyFeeStart || 0).toFixed(2)}/mo`,
          `-$${atCur.cumFees.toFixed(2)}`,
          `$${atCur.netEarnings.toFixed(2)}`
        ];
      });
      renderKpiTable(containerId, ["Loan","Purchase","Fee / Mo","Fees to Date","Net to Date"], rows);
    }

    function createLens(svg, radius = 40, scale = 1.5, borderColor = "#94a3b8", borderWidth = 1.5, bgFill = "rgba(255,255,255,0.7)"){
      const svgNS = "http://www.w3.org/2000/svg";
      const defs = svg.querySelector("defs") || (()=>{ const d = document.createElementNS(svgNS,"defs"); svg.insertBefore(d, svg.firstChild); return d; })();
      const clipId = `lens-clip-${Math.random().toString(36).slice(2)}`;
      const clipPath = document.createElementNS(svgNS,"clipPath");
      clipPath.setAttribute("id", clipId);
      const clipCircle = document.createElementNS(svgNS,"circle");
      clipCircle.setAttribute("r", radius);
      clipPath.appendChild(clipCircle);
      defs.appendChild(clipPath);

      const group = document.createElementNS(svgNS,"g");
      group.setAttribute("pointer-events","none");

      const bgCircle = document.createElementNS(svgNS,"circle");
      bgCircle.setAttribute("r", radius);
      bgCircle.setAttribute("fill", bgFill);
      bgCircle.setAttribute("stroke", borderColor);
      bgCircle.setAttribute("stroke-width", borderWidth);
      bgCircle.setAttribute("opacity","0.95");

      const content = document.createElementNS(svgNS,"g");
      content.setAttribute("clip-path", `url(#${clipId})`);

      const outline = document.createElementNS(svgNS,"circle");
      outline.setAttribute("r", radius);
      outline.setAttribute("fill","none");
      outline.setAttribute("stroke", borderColor);
      outline.setAttribute("stroke-width", borderWidth);

      group.appendChild(bgCircle);
      group.appendChild(content);
      group.appendChild(outline);

      return { group, content, outline, bgCircle, clipCircle, clipPath, scale, radius };
    }

    function updateLens(lens, x, y){
      if(!lens) return;
      const tx = x - x * lens.scale;
      const ty = y - y * lens.scale;
      lens.clipCircle.setAttribute("cx", x);
      lens.clipCircle.setAttribute("cy", y);
      lens.bgCircle.setAttribute("cx", x);
      lens.bgCircle.setAttribute("cy", y);
      lens.outline.setAttribute("cx", x);
      lens.outline.setAttribute("cy", y);
      lens.content.setAttribute("transform", `translate(${tx}, ${ty}) scale(${lens.scale})`);
    }

    function removeLens(svg, lens){
      if(!lens) return;
      if(lens.group && lens.group.parentNode === svg) svg.removeChild(lens.group);
      if(lens.clipPath && lens.clipPath.parentNode) lens.clipPath.parentNode.removeChild(lens.clipPath);
    }

    function createTooltip(svg, large = false){
      const svgNS = "http://www.w3.org/2000/svg";
      const group = document.createElementNS(svgNS,"g");
      group.setAttribute("pointer-events","none");
      group.setAttribute("opacity","0.95");

      const rect = document.createElementNS(svgNS,"rect");
      rect.setAttribute("rx", large ? 8 : 6);
      rect.setAttribute("ry", large ? 8 : 6);
      rect.setAttribute("fill","rgba(15,23,42,0.92)");
      rect.setAttribute("stroke","#0ea5e9");
      rect.setAttribute("stroke-width","0.6");

      const textGroup = document.createElementNS(svgNS,"g");
      textGroup.setAttribute("fill","#fff");
      textGroup.setAttribute("font-size", large ? "12" : "11");
      textGroup.setAttribute("font-weight","600");

      group.appendChild(rect);
      group.appendChild(textGroup);
      svg.appendChild(group);

      return { group, rect, textGroup, lines: [], large, width:0, height:0 };
    }

    function updateTooltipContent(tooltip, lines, large = false){
      if(!tooltip) return;
      tooltip.large = large;
      tooltip.rect.setAttribute("rx", large ? 8 : 6);
      tooltip.rect.setAttribute("ry", large ? 8 : 6);
      tooltip.textGroup.setAttribute("font-size", large ? "12" : "11");
      while(tooltip.lines.length < lines.length){
        const t = document.createElementNS("http://www.w3.org/2000/svg","text");
        tooltip.textGroup.appendChild(t);
        tooltip.lines.push(t);
      }
      while(tooltip.lines.length > lines.length){
        const t = tooltip.lines.pop();
        t.remove();
      }

      const lineHeight = large ? 15 : 14;
      let maxWidth = 0;
      tooltip.lines.forEach((t, idx) => {
        t.textContent = lines[idx];
        t.setAttribute("x", 6);
        t.setAttribute("y", 12 + idx * lineHeight);
        maxWidth = Math.max(maxWidth, t.getBBox().width);
      });

      const paddingX = 10;
      const paddingY = 8;
      const width = maxWidth + paddingX * 2;
      const height = lines.length * lineHeight + paddingY;

      tooltip.rect.setAttribute("width", width);
      tooltip.rect.setAttribute("height", height);
      tooltip.rect.setAttribute("x", 0);
      tooltip.rect.setAttribute("y", 0);
      tooltip.width = width;
      tooltip.height = height;
    }

    function updateTooltipPosition(tooltip, cx, cy, radius){
      if(!tooltip) return;
      const width = tooltip.width || 0;
      const height = tooltip.height || 0;

      let dx = radius * 0.45;
      let dy = -radius * 0.85;

      let tooltipX = cx + dx;
      let tooltipY = cy + dy;
      const minX = cx + 2;
      const maxX = cx + radius - width - 2;
      const maxY = cy - height - 2;
      const circleLimit = radius - 3;

      tooltipX = Math.min(Math.max(tooltipX, minX), maxX);
      tooltipY = Math.min(tooltipY, maxY);

      for(let i = 0; i < 10; i++){
        const corners = [
          {x: tooltipX, y: tooltipY},
          {x: tooltipX + width, y: tooltipY},
          {x: tooltipX, y: tooltipY + height},
          {x: tooltipX + width, y: tooltipY + height}
        ];

        let adjusted = false;

        for(const corner of corners){
          const distance = Math.hypot(corner.x - cx, corner.y - cy);
          if(distance >= circleLimit){
            const push = distance - circleLimit + 0.5;
            const nx = (cx - corner.x) / distance;
            const ny = (cy - corner.y) / distance;
            tooltipX += nx * push;
            tooltipY += ny * push;
            adjusted = true;
          }
        }

        tooltipX = Math.min(Math.max(tooltipX, minX), maxX);
        tooltipY = Math.min(tooltipY, maxY);

        if(!adjusted) break;
      }

      tooltipX = Math.max(tooltipX, cx + 2);
      tooltipY = Math.min(tooltipY, cy - height - 2);

      tooltip.group.setAttribute("transform", `translate(${tooltipX}, ${tooltipY})`);
    }

    // Shared drawer behavior handled above for both KPI and loan content.

    // CSV download handler
    document.body.addEventListener("click", (e) => {
      if (e.target.matches("#downloadCsvBtn") || e.target.matches("[data-download-csv]")) {
        downloadCurrentDrawerCsv();
      }
    });

    // Copy CSV
    document.body.addEventListener("click", (e) => {
      if (e.target.matches("#copyCsvBtn")) {
        navigator.clipboard.writeText(currentCsvData || "");
        alert("CSV copied to clipboard.");
      }
    });

    // Print
    document.body.addEventListener("click", (e) => {
      if (e.target.matches("#printBtn")) {
        window.print();
      }
    });

    // CSV download utility
    function downloadCurrentDrawerCsv() {
      const blob = new Blob([currentCsvData || ""], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "drawer-data.csv";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
