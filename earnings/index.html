<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio â€” Earnings</title>
 
  <style>
   :root {
    --bg:#f0f4f8;
    --surface:#f1f5f9;
    --card:#ffffff;
    --text:#0f172a;
    --muted:#64748b;
    --border:#e2e8f0;
    --shadow:rgba(0,0,0,0.08);

    --brand:#0ea5e9;
    --brand-strong:#0284c7;

    --accent1:#7c3aed;
    --accent2:#0ea5e9;
    --accent3:#14b8a6;
    --accent4:#f97316;
    --accent5:#ef4444;

    --stat-bg:#f8fafc;
    --stat-border:#e2e8f0;

    --grad-top:var(--surface);
    --grad-bottom:var(--card);

    --font-smooth:antialiased;

    --tile-bg:var(--card);
    --tile-hover-bg:#f8fafc;

    --drawer-bg:var(--card);
    --drawer-shadow:rgba(0,0,0,0.10);

    --grid-strong: #cbd5e1;
    --grid-light: #e2e8f0;
    --table-header: var(--surface);
    }



 html[data-theme="dark"] {
  color-scheme: dark;

  --bg:#0b1220;
  --surface:#1e293b;
  --card:#1e293b;

  --text:#e6eef8;
  --muted:#9aa6b2;
  --border:#334155;

  --shadow:0 12px 30px rgba(2,6,23,0.6);

  --grad-top:#071829;
  --grad-bottom:#0b1220;

  --tile-bg:#1e293b;
  --tile-hover-bg:#243447;
  --drawer-bg: var(--card);
  --drawer-shadow:rgba(2,6,23,0.55);

  --grid-strong:#334155;
  --grid-light:#1e293b;

  --table-header:#0f172a;
}


    html, body {
    height:100%;
    margin:0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    }


   body {
    background: linear-gradient(180deg, var(--grad-top) 0%, var(--grad-bottom) 100%);
    background-color: var(--bg);
    -webkit-font-smoothing: var(--font-smooth);
    transition: background-color .25s ease, color .25s ease;
    }


   .app{
    max-width:1200px;
    margin:20px auto 0 auto;
    padding:16px 16px 0 16px;
    transition:color .25s ease;
    }

    /* MATCH AMORT HEADER SPACING */
   header {
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-bottom:8px;     /* match amort */
    padding:0;
    transition:color .25s ease;
    }

    body > .app {
    background: transparent;
    padding-top:16px;
    margin-top:0;
    }

    
   header{
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-bottom:8px;
    padding:0;
    transition:color .25s ease;
    }


    .header-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

  .header-controls {
    display:flex;
    gap:10px;
    align-items:center;
    }


    h1 {
      font-size:20px;
      margin:0;
    }

    .lead {
    margin: 4px 0 0 0;
    font-size: 13px;
    color: var(--muted);
    }

     p.lead {
      margin: 0px 0;
      color: var(--muted);
      font-size: 13px;
    }

    .current-date {
      font-size:13px;
      color:var(--muted);
      margin-top:4px;
    }

    .actions { display:flex; gap:8px; align-items:center }
    .btn{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--card);
      cursor:pointer;
      font-weight:600;
      color:var(--text);
      transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--brand),var(--accent2));
      color:white;
      border:none;
      box-shadow:var(--shadow);
    }
    .close-btn{
      background:var(--card-muted);
      border:1px solid var(--border);
      padding:8px;
      border-radius:8px;
      cursor:pointer;
      color:var(--text);
      transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
    }

    /* ============================================================
   FIX: Earnings Print button matches ROI / Amort
   ============================================================ */

#printBtn {
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
}

#printBtn:hover {
  background: var(--tile-hover-bg);
}


/* Match ROI Reset Filters button exactly */
.reset-btn {
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--muted);
  font-weight: 600;
}

.reset-btn:hover {
  background: var(--tile-hover-bg);
}

    
    /* Fix KPI vertical alignment to match amort */
.kpis {
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
  margin:14px 0 18px;   /* match amort */
}

.kpi {
  background:var(--card);
  padding:12px;         /* match amort */
  border-radius:10px;   /* match amort */
  box-shadow:var(--shadow);
  border:1px solid var(--border);
  cursor:pointer;
  transition: transform .18s, box-shadow .18s,
              background-color .25s ease,
              color .25s ease, border-color .25s ease;
}

.kpi:hover {
  transform: translateY(-2px);    /* match amort */
  box-shadow: 0 6px 16px rgba(0,0,0,0.15);
}

.kpi h3 {
  margin:0;
  font-size:12px;
  color:var(--muted);
}

.kpi p {
  margin:8px 0 0;
  font-size:18px;
  font-weight:700;
}

    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      grid-auto-rows: min-content;
      gap:12px;
      height:calc(100vh - 320px);
      overflow:auto;
      padding-right:6px;
    }

    @media(max-width:900px){
      .grid{ grid-template-columns:1fr; height:auto; }
      .kpis{ grid-template-columns:repeat(2,1fr); }
    }

.loan-filters {
  display: flex;
  gap: 10px;
  align-items: center;
  margin: 0 0 14px;
  flex-wrap: wrap;
}

.loan-filters select {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  font-size: 13px;
}

/* Compact toggle */
.compact-toggle {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--muted);
  cursor: pointer;
}

/* Compact earnings tiles */
.grid.compact .tile {
  min-height: 64px;
  padding: 8px 10px;
}

.grid.compact .loan-sub,
.grid.compact .loan-meta,
.grid.compact .chart-wrap svg {
  display: none;
}


    
/* --- Unified Loan Tile Style (matches Amort exactly) --- */

.tile {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  border-radius: 12px;
  background: var(--card);
  min-height: 110px;
  cursor: pointer;
  overflow: hidden;
  border: 1px solid var(--border);
  transition: transform .18s ease, box-shadow .24s ease, background .28s ease;
}

.tile:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow);
}

/* left side */
.tile-left {
  flex: 1;
  padding-right: 10px;
}

.loan-name {
  font-weight: 600;
  font-size: 13px;
}

.loan-sub {
  font-size: 12px;
  color: var(--muted);
  margin-top: 6px;
}

.loan-meta {
  display: flex;
  gap: 8px;
  font-size: 12px;
  color: var(--muted);
  margin-top: 8px;
}
    .chart-wrap{
      width:170px;
      flex-shrink:0;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
    }
    .mini-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      text-align:right;
      width:100%;
    }

/* ============================================================
   AMORT-STYLE DRAWER FOR EARNINGS (WIDE VERSION)
   ============================================================ */

/* Base Drawer */
.drawer {
  position: fixed;
  right: 0;
  top: 0;
  height: 100vh;

  /* *** KEEP WIDE DRAWER *** */
  width: 760px;
  max-width: 1000px;

  background: var(--card);
  box-shadow: -28px 0 80px rgba(2,6,23,0.14);
  transform: translateX(110%);
  transition:
    transform .28s cubic-bezier(.2,.9,.3,1),
    background-color .25s ease,
    color .25s ease,
    border-color .25s ease,
    box-shadow .25s ease;
  z-index: 120;
  overflow: hidden;
  padding: 0;
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  opacity: 0;
}

.drawer.open {
  transform: translateX(0);
  opacity: 1;
  animation: drawerIn .28s cubic-bezier(.2,.9,.3,1);
}

@keyframes drawerIn {
  from { transform: translateX(30%); opacity: 0; }
  to   { transform: translateX(0);   opacity: 1; }
}


.drawer-head{
  padding:20px;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:8px;
  background:var(--card);
  border-bottom:1px solid var(--border);
}

.drawer h2 {
  margin: 0 0 4px;
  font-size: 20px;
  font-weight: 600;
  letter-spacing: -0.01em;
}
    
.muted {
  color: var(--muted);
  font-size: 13px;
  line-height: 1.25;
  margin-top: 2px;
  margin-bottom: 6px;
}

/* Close Button */
.close-btn {
  background: #f1f5f9;
  border: none;
  padding: 8px;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color .25s ease, color .25s ease;
}

html[data-theme="dark"] .close-btn {
  background: #0f172a;
  color: var(--text);
}

/* Drawer Body */
.drawer-body,
#drawerBody {
  flex: 1 1 auto;
  overflow-y: auto;
  overflow-x: hidden !important;
  padding: 0 20px 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* Drawer Chart */
.drawer-chart {
  height: 240px; /* Slightly taller for stacked earnings */
  background: var(--chart-bg);
  border-radius: 8px;
  border: 1px solid rgba(15,23,42,0.03);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 8px;
  position: relative;
  padding: 8px;
  box-shadow: 0 6px 18px rgba(15,23,42,0.06);
  transition:
    background-color .25s ease,
    color .25s ease,
    border-color .25s ease,
    box-shadow .25s ease;
}

.drawer-chart svg {
  width: 100%;
  height: 100%;
}

/* ============================================================
   FIX: prevent 1px overflow from box model mismatch
   ============================================================ */

.drawer,
.drawer * {
  box-sizing: border-box;
}

    
.legend {
  display: flex;
  gap: 10px;
  font-size: 12px;
  align-items: center;
  margin-top: 6px;
}

.legend .item {
  display: flex;
  gap: 6px;
  align-items: center;
}

.legend .sw {
  width: 12px;
  height: 8px;
  border-radius: 2px;
}

/* Primary + Secondary Stat Boxes (matching amort) */
.stat-boxes,
.drawer-info-row {
  display: flex;
  gap: 12px;
  margin: 0 0 12px;
  align-items: center;
}

.info-card,
.stat-box {
  flex: 1;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-height: 56px;
  transition: background-color .25s ease, border-color .25s ease;
}

.info-card.small,
.stat-box.small {
  width: 160px;
}

.muted-small,
.stat-label {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
}

.main-val,
.stat-value {
  font-size: 18px;
  font-weight: 700;
}

/* Drawer Table */
.amort-wrap {
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px;
  max-height: 40vh;
  overflow: auto;
  background: var(--card);
  transition:
    background-color .25s ease,
    border-color .25s ease,
    color .25s ease;
}

/* ============================================
   FIX: Make earnings drawer tables match amort
   ============================================ */

.drawer table,
.drawer .amort-wrap table {
  font-size: 13px !important;        /* match amort */
}

.drawer thead th,
.drawer .amort-wrap thead th {
  font-size: 13px !important;        /* match amort */
  padding: 8px !important;           /* match amort */
}

.drawer td,
.drawer .amort-wrap td {
  font-size: 13px !important;        /* match amort */
  padding: 8px !important;           /* match amort */
  border-bottom: 1px dashed rgba(15,23,42,0.04);
}

html[data-theme="dark"] .drawer td {
  border-bottom: 1px dashed rgba(148,163,184,0.24);
}

    
.drawer table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

thead th {
  position: sticky;
  top: 0;
  background: var(--table-header);
  padding: 8px;
  text-align: left;
  color: var(--muted);
  font-weight: 700;
  border-bottom: 1px solid var(--border);
}


td {
  padding: 8px;
  border-bottom: 1px dashed rgba(15,23,42,0.04);
  text-align: left;
  transition: color .25s ease, border-color .25s ease;
}

td:first-child,
th:first-child {
  text-align: left;
}

/* Footer */
.drawer-footer {
  padding: 20px;
  flex-shrink: 0;
  background: var(--surface);
  border-top: 1px solid var(--border);
}

.actions {
  display: flex;
  gap: 8px;
}

/* Dark Mode Overrides (match amort) */
html[data-theme="dark"] .drawer {
  background: var(--drawer-bg);
  border-left: 1px solid var(--border);
  box-shadow: -28px 0 80px var(--drawer-shadow);
}

html[data-theme="dark"] .amort-wrap {
  background: var(--card);
}

html[data-theme="dark"] thead th {
  background: var(--surface);
  color: var(--text);
  border-bottom: 1px solid var(--border);
}

html[data-theme="dark"] td {
  border-bottom: 1px dashed rgba(148,163,184,0.24);
}

html[data-theme="dark"] .legend .sw {
  opacity: 0.9;
}

/* Mobile */
@media(max-width:760px) {
  .drawer {
    width: 100%;
    max-width: none;
  }
}


    /* Theme toggle */
    .theme-icon{
      background:var(--card);
      border:1px solid var(--border);
      font-size:18px;
      cursor:pointer;
      transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease, transform .2s ease;
      width:38px;
      height:38px;
      border-radius:10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow:var(--shadow);
    }
    .theme-icon:hover{ opacity:0.95; transform:translateY(-1px); }

    .lens-tooltip-html {
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      background: rgba(0,0,0,0.85);     /* solid black like amort */
      color: #ffffff;                   /* white text */
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
      white-space: nowrap;
    }


    
    /* KPI4 table */
#drawerExtra table {
  width: 100%;
  border-collapse: collapse;
}

#drawerExtra th {
  color: var(--muted);
  font-weight: 600;
  text-align: left;
  padding: 8px;
}

#drawerExtra td {
  color: inherit;
  padding: 8px;
}

/* ============================================================
   EMBED MODE (Dashboard iframe)
   ============================================================ */

.embed-mode header,
.embed-mode .loan-filters,
.embed-mode .kpis {
  display: none !important;
}

/* ============================================================
   EMBED MODE â€” EARNINGS LAYOUT
   ============================================================ */

.embed-mode .drawer {
  position: static !important;
  inset: auto !important;
  transform: none !important;
  height: 100% !important;
  max-height: none !important;
  width: 100% !important;
  max-width: none !important;
  box-shadow: none !important;
  border-radius: 0 !important;
}

/* ============================================================
   EMBED MODE â€” REMOVE LOAN GRID ENTIRELY (AUTHORITATIVE FIX)
   ============================================================ */

.embed-mode .grid {
  display: none !important;
}


/* ============================================================
   EMBED MODE â€” SCROLL BEHAVIOR
   ============================================================ */

.embed-mode .drawer-body {
  overflow-y: auto;
  max-height: none;
}

    /* Embed page itself must never scroll */
.embed-mode html,
.embed-mode body {
  overflow: hidden !important;
}


/* ============================================================
   EMBED MODE â€” BUTTON VISIBILITY
   ============================================================ */

.embed-mode .drawer-close,
.embed-mode button[aria-label="Close"] {
  display: none !important;
}

.embed-mode .close-btn {
  display: inline-flex !important;
}

.embed-mode .drawer-footer {
  display: block !important;
}



    /* =========================================
   KPI1 + KPI2 table hover (ONLY)
   ========================================= */
.kpi1-table tbody tr,
.kpi2-table tbody tr {
  cursor: pointer;
  transition: background-color .15s ease, opacity .15s ease;
}

.kpi1-table tbody tr:hover,
.kpi2-table tbody tr:hover {
  background: var(--tile-hover-bg);
}

.kpi1-table tbody tr.dimmed,
.kpi2-table tbody tr.dimmed {
  opacity: 0.25;
}

    /* ============================================================
   EMBED MODE â€” UNIFIED DRAWER LAYOUT (ALIGN ALL IFRAMES)
   ============================================================ */

.embed-mode .drawer-head {
  padding: 20px !important;
  min-height: 64px;
  border-bottom: 1px solid var(--border);
  background: var(--card);
}

/* Chart: same height everywhere */
.embed-mode .drawer-chart {
  height: 220px !important;
  margin-bottom: 12px !important;
}

/* Stat boxes row */
.embed-mode .stat-boxes,
.embed-mode .drawer-info-row {
  margin-bottom: 12px !important;
  min-height: 56px;
}

/* Drawer body spacing */
.embed-mode .drawer-body {
  gap: 12px !important;
  padding-left: 16px !important;
  padding-right: 16px !important;
}

/* Table container */
.embed-mode .amort-wrap {
  max-height: 40vh !important;
}

    
  </style>
</head>
<body>
  <div class="app" role="main">
<header>
  <div class="header-top">
    <div>
      <h1>Loan Portfolio â€” Earnings</h1>
      <p class="lead">Cumulative principal, interest, and fees for each loan and for the portfolio.</p>
    </div>

    <div class="header-controls">
      <div style="font-size:13px; color:var(--muted)">
        Name: <strong id="currentUserLabel" style="color:var(--brand)"></strong>
      </div>
      <button id="themeToggle" class="theme-icon" title="Toggle dark mode">ðŸŒ™</button>
    </div>
  </div>
   <div class="current-date" id="currentDateLabel">
    Current Date: <span id="currentDate"></span>
  </div>
</header>



    <section class="kpis" id="kpis">
      <div class="kpi" data-kpi="net">
        <h3>Net Earnings to Date</h3>
        <p id="kpiNetToDate">--</p>
      </div>

      <div class="kpi" data-kpi="projected">
        <h3>Projected Lifetime Earnings</h3>
        <p id="kpiNetProj">--</p>
      </div>

      <div class="kpi" data-kpi="avgMonthly">
        <h3>Avg Monthly Income (Net of Fees)</h3>
        <p id="kpiAvgMonth">--</p>
      </div>

      <div class="kpi" data-kpi="fees">
        <h3>Projected Avg Monthly Earnings</h3>
        <p id="kpiFees">--</p>
      </div>
    </section>

<!-- Loan Filters / Sort -->
<section class="loan-filters" id="loanFilters">
  <select id="filterName">
    <option value="">All loan names</option>
  </select>

  <select id="filterSchool">
    <option value="">All schools</option>
  </select>

  <select id="filterRate">
    <option value="">All interest rates</option>
    <option value="low">Below 5%</option>
    <option value="mid">5% â€“ 8%</option>
    <option value="high">Above 8%</option>
  </select>

  <select id="sortLoans">
    <option value="purchase_asc">Purchase date â†‘</option>
    <option value="purchase_desc">Purchase date â†“</option>
    <option value="start_asc">Loan start date â†‘</option>
    <option value="start_desc">Loan start date â†“</option>
    <option value="amount_asc">Orig amount â†‘</option>
    <option value="amount_desc">Orig amount â†“</option>
    <option value="rate_asc">Interest rate â†‘</option>
    <option value="rate_desc">Interest rate â†“</option>
  </select>

  <label class="compact-toggle">
  <input type="checkbox" id="toggleCompact" />
  <span>Compact</span>
</label>


  <button class="btn reset-btn" id="resetFilters">Reset filters</button>

</section>

    
    <section class="grid" id="loanGrid" aria-live="polite"></section>
  </div>

  <!-- Drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
        <div class="drawer-head">
      <div>
        <h2 id="drawerTitle"></h2>
        <div class="muted" id="drawerSub"></div>
      </div>
    
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
        <button class="close-btn" id="closeBtn">âœ•</button>
      </div>
    </div>


    <div id="drawerBody" class="drawer-body">
  <div class="drawer-chart" id="drawerChartArea"></div>
  <div class="legend" id="drawerLegend" style="display:none"></div>

  <div style="display:flex;gap:10px;margin-bottom:8px">
    <div style="flex:1;background:var(--surface);padding:10px;border-radius:8px;border:1px solid var(--border)">
      <div style="font-size:12px;color:var(--muted)" id="drawerPrimaryTitle">Purchase Price</div>
      <div id="drawerPrimary" style="font-weight:800;font-size:18px"></div>
    </div>
    <div style="width:120px;background:var(--surface);padding:10px;border-radius:8px;border:1px solid var(--border)">
      <div style="font-size:12px;color:var(--muted)" id="drawerSecondaryTitle">Rate</div>
      <div id="drawerSecondary" style="font-weight:800;font-size:16px"></div>
    </div>
  </div>
  
    <div id="drawerExtra"></div>
  </div>
  
  <div class="drawer-footer">
    <div class="actions">
      <button class="btn" id="printBtn">Print</button>
      <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
    </div>
  </div>
  </aside>
  

<script type="module">
import {
  addMonths,
  monthDiff,          // âœ… ADD THIS LINE
  formatDate,
  formatMonthYear,
  getStandardToday,
  loadLoans,
  attachSchedules,
  buildPortfolioViews
} from "../js/loanEngine.js?v=dev1";


let currentLoan = null;
let currentMode = 'portfolio';

let PORTFOLIO_START = null;


const earlyParams = new URLSearchParams(window.location.search);
if (earlyParams.get('embed') === 'true') {
document.documentElement.style.visibility = 'hidden';
}

const PAGE_USER =
new URLSearchParams(window.location.search).get("user") || "jeff";

const USER_LABELS = {
jeff: "Jeff Customer",
nick: "Nick Lender",
john: "John Investor"
};

const currentUserLabelEl = document.getElementById("currentUserLabel");
if (currentUserLabelEl) {
currentUserLabelEl.textContent =
USER_LABELS[PAGE_USER] || PAGE_USER;
}

  // =====================================================
// STANDARD DATE â€” SINGLE SOURCE OF TRUTH (EARNINGS)
// =====================================================
const TODAY = getStandardToday();

const isEmbed =
new URLSearchParams(window.location.search).get("embed") === "true";

if (isEmbed) {
document.body.classList.add("embed-mode");
}

if (isEmbed) {
const userParam =
new URLSearchParams(window.location.search).get("user") || "jeff";

const targetUrl =
`/loan-dashboard/earnings/index.html?user=${userParam}&open=kpi2`;

function redirectToFull(e) {
e.preventDefault();
e.stopImmediatePropagation();
window.top.location.href = targetUrl;
}

const closeBtn = document.getElementById("closeBtn");
if (closeBtn) closeBtn.addEventListener("click", redirectToFull, true);

const downloadBtn = document.getElementById("downloadCsvBtn");
if (downloadBtn) downloadBtn.addEventListener("click", redirectToFull, true);

const printBtn = document.getElementById("printBtn");
if (printBtn) printBtn.addEventListener("click", redirectToFull, true);

const copyBtn = document.getElementById("copyCsvBtn");
if (copyBtn) copyBtn.addEventListener("click", redirectToFull, true);
}

function formatCurrency(value) {
if (!Number.isFinite(value)) return "$0.00";
return "$" + value.toLocaleString("en-US", {
minimumFractionDigits: 2,
maximumFractionDigits: 2
});
}

let loans = [];

  let loansForUser = [];
let views = null;


document.getElementById("currentDate").textContent =
  formatDate(TODAY);


let stackedBarGroupCounter = 0;

function prepareStackedBar(bar, groupId, index, isPositive = true){
bar.setAttribute("data-stack-group", groupId);
bar.setAttribute("data-stack-index", index);
}




const KPI_PALETTE = [
"#2563eb",
"#dc2626",
"#16a34a",
"#7c3aed",
"#ea580c",
"#0891b2",
"#9333ea",
"#15803d",
"#b91c1c",
"#1e40af",
"#c2410c",
"#0f766e"
];

function buildLoanColorMap(sortedLoans) {
const map = {};
sortedLoans.forEach((loan, idx) => {
map[loan.loanId] = KPI_PALETTE[idx % KPI_PALETTE.length];
});
window.KPI_COLOR_MAP = map;
}

document.querySelectorAll(".kpi").forEach(tile => {
tile.addEventListener("click", () => {
const type = tile.dataset.kpi;

switch (type) {
case "net":
openKpi1();
break;

case "projected":
openKpi2();
break;

case "avgMonthly":
openKpi3();
break;

case "fees":
openKpi4();
break;

default:
console.warn("Unknown KPI tile:", type);
}
});
});


let miniHtmlTooltip = null;
function getMiniHtmlTooltip() {
if (!miniHtmlTooltip) {
miniHtmlTooltip = document.createElement("div");
miniHtmlTooltip.className = "lens-tooltip-html";
miniHtmlTooltip.style.display = "none";
document.body.appendChild(miniHtmlTooltip);
}
return miniHtmlTooltip;
}

function setMiniTooltipContent(lines) {
const el = getMiniHtmlTooltip();
el.innerHTML = lines.join("<br>");
}

function positionMiniTooltip(clientX, clientY, radius) {
const el = getMiniHtmlTooltip();
const rect = el.getBoundingClientRect();

const padding = 12;

let x = clientX - rect.width / 2;
let y = clientY - radius - rect.height - 8;

if (x < padding) {
x = padding;
} else if (x + rect.width > window.innerWidth - padding) {
x = window.innerWidth - rect.width - padding;
}

if (y < padding) {
y = clientY + radius + 8;
}

el.style.left = `${x}px`;
el.style.top  = `${y}px`;
el.style.display = "block";
}

function hideMiniTooltip() {
if (miniHtmlTooltip) miniHtmlTooltip.style.display = "none";
}

function createMiniStackedEarningsSVG(containerEl) {

  // --------------------------------------------------
  // Phase 3: UI-only placeholder
  // Earnings data will be engine-provided later
  // --------------------------------------------------

  containerEl.innerHTML = "";

  // Minimal SVG placeholder to preserve layout
  const svgNS = "http://www.w3.org/2000/svg";
  const w = 170;
  const h = 48;

  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "48");

  // Baseline only (visual consistency)
  const axis = document.createElementNS(svgNS, "line");
  axis.setAttribute("x1", 4);
  axis.setAttribute("x2", w - 4);
  axis.setAttribute("y1", h / 2);
  axis.setAttribute("y2", h / 2);
  axis.setAttribute("stroke", "#cbd5e1");
  axis.setAttribute("stroke-width", "0.8");

  svg.appendChild(axis);
  containerEl.appendChild(svg);
}


function niceAxisMax(v){
const x = Math.max(0, Number(v) || 0);
if (x <= 0) return 1;

const exp = Math.floor(Math.log10(x));
const base = Math.pow(10, exp);
const f = x / base;

let nf;
if (f <= 1) nf = 1;
else if (f <= 2) nf = 2;
else if (f <= 5) nf = 5;
else nf = 10;

return nf * base;
}

function createKpiStackedChart(container) {
  container.innerHTML = `
    <div style="padding:24px;color:var(--muted);text-align:center">
      Portfolio earnings timeline will be provided by loanEngine
    </div>
  `;
}


function highlightLoanInKpiChart(container, loanId) {
if (!container) return;

container.querySelectorAll("rect[data-loan-id]").forEach(el => {
el.style.opacity =
el.dataset.loanId === loanId ? "1" : "0.15";
});
}

function clearKpiChartHighlight(container) {
if (!container) return;

container.querySelectorAll("rect[data-loan-id]").forEach(el => {
el.style.opacity = "";
});
}

function highlightKpiRow(tableEl, loanId) {
tableEl.querySelectorAll("tbody tr").forEach(tr => {
tr.classList.toggle("dimmed", tr.dataset.loanId !== loanId);
});
}

function clearKpiRowHighlight(tableEl) {
tableEl.querySelectorAll("tbody tr").forEach(tr => {
tr.classList.remove("dimmed");
});
}

function renderKpi3AvgLineChart(container, rows, opts = {}) {

container.innerHTML = "";
if (!rows || !rows.length) return;

const svgNS = "http://www.w3.org/2000/svg";
const w = container.clientWidth || 700;
const h = container.clientHeight || 240;

const padL = 60, padR = 20, padT = 20, padB = 52;

const svg = document.createElementNS(svgNS, "svg");
svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
svg.setAttribute("width", "100%");
svg.setAttribute("height", "100%");

const maxValRaw = Math.max(...rows.map(r => Number(r.avg) || 0));
const minValRaw = Math.min(...rows.map(r => Number(r.avg) || 0));

const maxVal = niceAxisMax(maxValRaw);
const minVal = -niceAxisMax(Math.abs(minValRaw));

const usableH = h - padT - padB;
const usableW = w - padL - padR;

const range = maxVal - minVal || 1;
const scaleY = usableH / range;

const stepX = usableW / Math.max(1, rows.length - 1);

for (let i = 0; i <= 4; i++) {
const y = padT + i * (usableH / 4);
const val = maxVal - (range * i / 4);

const line = document.createElementNS(svgNS, "line");
line.setAttribute("x1", padL);
line.setAttribute("x2", w - padR);
line.setAttribute("y1", y);
line.setAttribute("y2", y);
line.setAttribute("stroke", "var(--grid-light)");
svg.appendChild(line);

const txt = document.createElementNS(svgNS, "text");
txt.textContent = formatCurrency(val);
txt.setAttribute("x", padL - 8);
txt.setAttribute("y", y + 4);
txt.setAttribute("font-size", "11");
txt.setAttribute("text-anchor", "end");
txt.setAttribute("fill", "var(--text)");
svg.appendChild(txt);
}

let d = "";
rows.forEach((r, i) => {
const x = padL + i * stepX;
const y =
padT + (maxVal - (Number(r.avg) || 0)) * scaleY;
d += i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`;
});

const path = document.createElementNS(svgNS, "path");
path.setAttribute("d", d);
path.setAttribute("fill", "none");
path.setAttribute("stroke", "var(--brand)");
path.setAttribute("stroke-width", "3");
svg.appendChild(path);

const xAxisY = h - padB + 18;

const xEvery = (opts && Number.isFinite(opts.xLabelEveryMonths))
? opts.xLabelEveryMonths
: 4;

for (let i = 0; i < rows.length; i += xEvery) {

const x = padL + i * stepX;

const tick = document.createElementNS(svgNS, "line");
tick.setAttribute("x1", x);
tick.setAttribute("x2", x);
tick.setAttribute("y1", h - padB);
tick.setAttribute("y2", h - padB + 6);
tick.setAttribute("stroke", "var(--grid-light)");
tick.setAttribute("stroke-width", "1");
svg.appendChild(tick);

const lbl = document.createElementNS(svgNS, "text");
lbl.textContent = formatMonthYear(rows[i].date);
lbl.setAttribute("x", x);
lbl.setAttribute("y", xAxisY);
lbl.setAttribute("font-size", "11");
lbl.setAttribute("fill", "var(--text)");
lbl.setAttribute("text-anchor", "middle");
svg.appendChild(lbl);
}

const vLine = document.createElementNS(svgNS, "line");
vLine.setAttribute("y1", padT);
vLine.setAttribute("y2", h - padB);
vLine.setAttribute("stroke", "var(--text)");
vLine.setAttribute("stroke-dasharray", "3 4");
vLine.setAttribute("stroke-opacity", "0");
svg.appendChild(vLine);

const dot = document.createElementNS(svgNS, "circle");
dot.setAttribute("r", "5");
dot.setAttribute("fill", "var(--brand)");
dot.setAttribute("stroke", "white");
dot.setAttribute("stroke-width", "2");
dot.setAttribute("opacity", "0");
svg.appendChild(dot);



const firstDate = rows[0]?.date;
const lastDate  = rows[rows.length - 1]?.date;

if (firstDate && lastDate) {
const totalMonths = monthDiff(firstDate, lastDate);
let monthsToToday = monthDiff(firstDate, TODAY);

if (!Number.isFinite(monthsToToday)) monthsToToday = 0;
monthsToToday = Math.max(0, Math.min(monthsToToday, totalMonths));

const ratio = totalMonths > 0 ? monthsToToday / totalMonths : 0;
const todayX = padL + ratio * usableW;

const todayLine = document.createElementNS(svgNS, "line");
todayLine.setAttribute("x1", todayX);
todayLine.setAttribute("x2", todayX);
todayLine.setAttribute("y1", padT);
todayLine.setAttribute("y2", h - padB);
todayLine.setAttribute("stroke", "#64748b");
todayLine.setAttribute("stroke-dasharray", "4,3");
todayLine.setAttribute("stroke-width", "1");
todayLine.setAttribute("pointer-events", "none");

svg.appendChild(todayLine);
}

container.appendChild(svg);

function idxFromClientX(clientX) {
const rect = svg.getBoundingClientRect();
const x = ((clientX - rect.left) / rect.width) * w;
const t = (x - padL) / stepX;
return Math.max(0, Math.min(rows.length - 1, Math.round(t)));
}

function handleMove(e) {
  const idx = idxFromClientX(e.clientX);
  const r = rows[idx];
  if (!r) return;

  const x = padL + idx * stepX;
  const y =
    padT + (maxVal - (Number(r.avg) || 0)) * scaleY;

  // Crosshair
  vLine.setAttribute("x1", x);
  vLine.setAttribute("x2", x);
  vLine.setAttribute("stroke-opacity", "0.8");

  // Dot
  dot.setAttribute("cx", x);
  dot.setAttribute("cy", y);
  dot.setAttribute("opacity", "1");

  // Tooltip content (APPROVED FORMAT)
  // ------------------------------------
// KPI-3 hover math (AUTHORITATIVE)
// ------------------------------------
let netToDate = 0;
for (let i = 0; i <= idx; i++) {
  netToDate += Number(rows[i].avg || 0);
}

const avgToDate = (idx + 1) > 0
  ? netToDate / (idx + 1)
  : 0;

setMiniTooltipContent([
  `Date: ${formatMonthYear(r.date)}`,
  `Avg / Month: ${formatCurrency(avgToDate)}`,
  `Net to Date: ${formatCurrency(netToDate)}`
]);



  positionMiniTooltip(e.clientX, e.clientY, 5);
}


function handleLeave() {
  vLine.setAttribute("stroke-opacity", "0");
  dot.setAttribute("opacity", "0");
  hideMiniTooltip(); // âœ… REQUIRED
}


svg.addEventListener("mousemove", handleMove);
svg.addEventListener("mouseleave", handleLeave);



svg.addEventListener("mousemove", handleMove);
svg.addEventListener("mouseleave", handleLeave);
}

function createKpi1StackedBarChart(container, series) {
  container.innerHTML = "";
  if (!series || !series.length) return;

  const svgNS = "http://www.w3.org/2000/svg";
  const w = container.clientWidth || 720;
  const h = container.clientHeight || 240;

  const padL = 60, padR = 20, padT = 20, padB = 52;
  const usableW = w - padL - padR;
  const usableH = h - padT - padB;

  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");

  // ----------------------------------
  // Y scale (MATCH KPI-3)
  // ----------------------------------
  const maxValRaw = Math.max(...series.map(d => d.total));
  const maxVal = niceAxisMax(maxValRaw);
  const scaleY = usableH / maxVal;

  // ----------------------------------
  // Grid + Y labels
  // ----------------------------------
  for (let i = 0; i <= 4; i++) {
    const y = padT + i * (usableH / 4);
    const val = maxVal - (maxVal * i / 4);

    const line = document.createElementNS(svgNS, "line");
    line.setAttribute("x1", padL);
    line.setAttribute("x2", w - padR);
    line.setAttribute("y1", y);
    line.setAttribute("y2", y);
    line.setAttribute("stroke", "var(--grid-light)");
    svg.appendChild(line);

    const lbl = document.createElementNS(svgNS, "text");
    lbl.textContent = formatCurrency(val);
    lbl.setAttribute("x", padL - 8);
    lbl.setAttribute("y", y + 4);
    lbl.setAttribute("font-size", "11");
    lbl.setAttribute("text-anchor", "end");
    lbl.setAttribute("fill", "var(--text)");
    svg.appendChild(lbl);
  }

  // ----------------------------------
  // Bars
  // ----------------------------------
  const barW = usableW / series.length;

  series.forEach((m, i) => {
    let yCursor = h - padB;

    Object.entries(m.byLoan).forEach(([loanId, val]) => {
      const barH = val * scaleY;
      if (barH <= 0) return;

      const rect = document.createElementNS(svgNS, "rect");
      rect.setAttribute("x", padL + i * barW);
      rect.setAttribute("y", yCursor - barH);
      rect.setAttribute("width", barW - 2);
      rect.setAttribute("height", barH);
      rect.setAttribute("fill", KPI_COLOR_MAP[loanId] || "#64748b");
      rect.dataset.loanId = loanId;

      rect.style.opacity = "1";
rect.setAttribute("data-stack", "kpi1");


      svg.appendChild(rect);
      yCursor -= barH;
    });
  });

  // ----------------------------------
  // X axis labels (MATCH KPI-3)
  // ----------------------------------
  const stepX = usableW / Math.max(1, series.length - 1);
  for (let i = 0; i < series.length; i += 4) {
    const x = padL + i * stepX;

    const tick = document.createElementNS(svgNS, "line");
    tick.setAttribute("x1", x);
    tick.setAttribute("x2", x);
    tick.setAttribute("y1", h - padB);
    tick.setAttribute("y2", h - padB + 6);
    tick.setAttribute("stroke", "var(--grid-light)");
    svg.appendChild(tick);

    const lbl = document.createElementNS(svgNS, "text");
    lbl.textContent = formatMonthYear(series[i].date);
    lbl.setAttribute("x", x);
    lbl.setAttribute("y", h - padB + 18);
    lbl.setAttribute("font-size", "11");
    lbl.setAttribute("text-anchor", "middle");
    lbl.setAttribute("fill", "var(--text)");
    svg.appendChild(lbl);
  }

  // ----------------------------------
  // Hover / tooltip (MATCH EXAMPLE)
  // ----------------------------------
  function idxFromClientX(clientX) {
    const rect = svg.getBoundingClientRect();
    const x = ((clientX - rect.left) / rect.width) * w;
    const t = (x - padL) / barW;
    return Math.max(0, Math.min(series.length - 1, Math.floor(t)));
  }

  svg.addEventListener("mousemove", e => {
    const idx = idxFromClientX(e.clientX);
    const m = series[idx];
    if (!m) return;

    let principal = 0;
    let interest  = 0;
    let fees      = 0;

    // Engine already computed net; tooltip format matches screenshot
  Object.values(m.byLoan).forEach(v => {
    if (v > 0) principal += v;
    else fees += v;
  });

  setMiniTooltipContent([
    `Date: ${formatMonthYear(m.date)}`,
    `Principal: ${formatCurrency(principal)}`,
    `Interest: â€”`,
    `Fees: ${formatCurrency(fees)}`,
    `Cumulative Net: ${formatCurrency(m.total)}`
  ]);

  positionMiniTooltip(e.clientX, e.clientY, 8);
});

svg.addEventListener("mouseleave", hideMiniTooltip);

container.appendChild(svg);
}



  
function renderKpi4AvgLineChart(container, rows) {
  // --------------------------------------------------
  // Phase 3: UI-only placeholder
  // KPI4 data will be provided by engine in later phase
  // --------------------------------------------------

  container.innerHTML = "";

  const svgNS = "http://www.w3.org/2000/svg";
  const w = container.clientWidth || 700;
  const h = container.clientHeight || 240;

  const padL = 60, padR = 20, padT = 20, padB = 52;

  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");

  // Horizontal grid + axis labels (visual consistency only)
  const gridLines = 4;
  for (let i = 0; i <= gridLines; i++) {
    const y = padT + i * ((h - padT - padB) / gridLines);

    const line = document.createElementNS(svgNS, "line");
    line.setAttribute("x1", padL);
    line.setAttribute("x2", w - padR);
    line.setAttribute("y1", y);
    line.setAttribute("y2", y);
    line.setAttribute("stroke", "var(--grid-light)");
    svg.appendChild(line);
  }

  // Zero / baseline
  const axis = document.createElementNS(svgNS, "line");
  axis.setAttribute("x1", padL);
  axis.setAttribute("x2", w - padR);
  axis.setAttribute("y1", h - padB);
  axis.setAttribute("y2", h - padB);
  axis.setAttribute("stroke", "var(--grid-strong)");
  axis.setAttribute("stroke-width", "1");
  svg.appendChild(axis);

  // Placeholder message
  const msg = document.createElementNS(svgNS, "text");
  msg.textContent = "Projected average earnings will appear here";
  msg.setAttribute("x", w / 2);
  msg.setAttribute("y", padT + (h - padT - padB) / 2);
  msg.setAttribute("text-anchor", "middle");
  msg.setAttribute("font-size", "13");
  msg.setAttribute("fill", "var(--muted)");
  svg.appendChild(msg);

  container.appendChild(svg);
}


function createDrawerStackedChart(containerEl, earningsSchedule, loan) {
  // --------------------------------------------------
  // Phase 3: UI-only placeholder
  // Detailed earnings chart will be engine-provided
  // --------------------------------------------------

  containerEl.innerHTML = "";

  const svgNS = "http://www.w3.org/2000/svg";
  const rect = containerEl.getBoundingClientRect();
  const w = Math.max(360, rect.width || 700);
  const h = 260;

  const padL = 50, padR = 20, padT = 20, padB = 16;

  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");

  // --------------------------------------------------
  // Grid (visual consistency only)
  // --------------------------------------------------
  const gridLines = 4;
  const usableHeight = h - padT - padB;

  for (let i = 0; i <= gridLines; i++) {
    const y = padT + i * (usableHeight / gridLines);

    const gridLine = document.createElementNS(svgNS, "line");
    gridLine.setAttribute("x1", padL);
    gridLine.setAttribute("x2", w - padR);
    gridLine.setAttribute("y1", y);
    gridLine.setAttribute("y2", y);
    gridLine.setAttribute("stroke", i === gridLines ? "var(--grid-strong)" : "var(--grid-light)");
    gridLine.setAttribute("stroke-width", "0.8");
    svg.appendChild(gridLine);
  }

  // --------------------------------------------------
  // Baseline
  // --------------------------------------------------
  const axis = document.createElementNS(svgNS, "line");
  axis.setAttribute("x1", padL);
  axis.setAttribute("x2", w - padR);
  axis.setAttribute("y1", h - padB);
  axis.setAttribute("y2", h - padB);
  axis.setAttribute("stroke", "var(--grid-strong)");
  axis.setAttribute("stroke-width", "1");
  svg.appendChild(axis);

  // --------------------------------------------------
  // Placeholder label
  // --------------------------------------------------
  const msg = document.createElementNS(svgNS, "text");
  msg.textContent = "Detailed earnings chart will appear here";
  msg.setAttribute("x", (padL + w - padR) / 2);
  msg.setAttribute("y", padT + usableHeight / 2);
  msg.setAttribute("text-anchor", "middle");
  msg.setAttribute("font-size", "14");
  msg.setAttribute("fill", "var(--muted)");
  svg.appendChild(msg);

  containerEl.appendChild(svg);
}


const kpisEl = document.getElementById("kpis");
const kpiCards = document.querySelectorAll('.kpi');

kpiCards.forEach((card, idx) => {
card.addEventListener("click", (e) => {
e.stopPropagation();
if (idx === 0) openKpi1();
else if (idx === 1) openKpi2();
else if (idx === 2) openKpi3();
else if (idx === 3) openKpi4();
openDrawer();
});
});

function resetDrawerContent() {
if (drawerChartArea) drawerChartArea.innerHTML = "";
if (drawerExtra) drawerExtra.innerHTML = "";
}

function openDrawerBase() {
drawer.classList.add("open");
drawer.setAttribute("aria-hidden","false");
drawer.scrollTop = 0;
}

function openDrawer() {
openDrawerBase();
}


function openKpi1() {
  currentLoan = null;
  currentMode = "kpi";

  resetDrawerContent();

  drawerTitle.textContent = "Total Net Earnings to Date";
  drawerSub.textContent = "Portfolio-level earnings across all loans.";

  drawerPrimaryTitle.textContent = "Net Earnings to Date";
  drawerSecondaryTitle.textContent = "Total Fees to Date";

  const portfolio = views?.portfolioEarnings || {};

  drawerPrimary.textContent =
    formatCurrency(portfolio.totalNetToDate ?? 0);

  drawerSecondary.textContent =
    formatCurrency(portfolio.totalFeesToDate ?? 0);

  // ----------------------------------
  // KPI-1 chart + table (ENGINE-DRIVEN)
  // ----------------------------------
  const series = portfolio.kpi1Series || [];

  // Always clear chart area before rendering
  drawerChartArea.innerHTML = "";

  // Guard: no data
  if (!series.length) {
    drawerChartArea.innerHTML =
      `<div class="empty-state">No earnings data available.</div>`;
    drawerExtra.innerHTML = "";
    openDrawer();
    return;
  }

  // Render stacked chart
  createKpi1StackedBarChart(
    drawerChartArea,
    series          // ðŸ”‘ DO NOT pass loansForUser here
  );

  // Render table container
  drawerExtra.innerHTML =
    `<div class="amort-wrap" id="drawerKpiTable"></div>`;

  // Render table
  renderKpi1Table(
    series,
    "drawerKpiTable"
  );

  openDrawer();
}


function openKpi2() {
  currentLoan = null;
  currentMode = "kpi";

  resetDrawerContent();

  drawerTitle.textContent = "Projected Total Net Earnings";
  drawerSub.textContent =
    "Projected lifetime earnings across all loans, assuming full term.";

  drawerPrimaryTitle.textContent = "Projected Net Earnings";
  drawerSecondaryTitle.textContent = "Projected Total Fees";

  const portfolio = views?.portfolioEarnings || {};

  drawerPrimary.textContent =
    formatCurrency(portfolio.totalNetProjected ?? 0);

  drawerSecondary.textContent =
    formatCurrency(portfolio.totalFeesProjected ?? 0);

  drawerExtra.innerHTML =
    `<div class="amort-wrap" id="drawerKpiTable"></div>`;

  openDrawer();
}

function openKpi3() {
  currentLoan = null;
  currentMode = "kpi";

  resetDrawerContent();

  drawerTitle.textContent = "Avg Monthly Income (Net of Fees)";
drawerSub.textContent =
  "Total principal + interest received, minus fees, averaged per completed month.";

drawerPrimaryTitle.textContent = "Avg Monthly Net Cash Inflow";

  drawerSecondaryTitle.textContent = "Months Counted";

  const portfolio = views?.portfolioEarnings || {};

  drawerPrimary.textContent =
    formatCurrency(portfolio.avgMonthlyNet ?? 0);

  drawerSecondary.textContent =
    String(Math.max(0, Number(portfolio.monthsCounted ?? 0)));

  // Chart + table will be engine-provided in later phase
  drawerExtra.innerHTML =
    `<div class="amort-wrap" id="drawerKpiTable"></div>`;

renderKpi3AvgLineChart(
  drawerChartArea,
  views.portfolioEarnings.kpi3Series.filter(d => d.avg !== null)
);
  
renderKPI3Table(
  views?.portfolioEarnings?.kpi3Rows || [],
  "drawerKpiTable"
);

  
  openDrawer();
}

function openKpi4() {
  currentLoan = null;
  currentMode = "kpi";

  resetDrawerContent();

  drawerTitle.textContent = "Projected Avg Monthly Earnings";
  drawerSub.textContent =
    "Average projected net earnings per month across the full lifetime of all loans.";

  drawerPrimaryTitle.textContent = "Avg / Month (Projected)";
  drawerSecondaryTitle.textContent = "Months Through Maturity";

  const portfolio = views?.portfolioEarnings || {};

  drawerPrimary.textContent =
    formatCurrency(portfolio.projectedAvgMonthlyNet ?? 0);

  // Not yet exposed by engine
  drawerSecondary.textContent = "â€”";

  // Chart + table will be engine-provided in later phase
  drawerExtra.innerHTML =
    `<div class="amort-wrap" id="drawerKpiTable"></div>`;

  openDrawer();
}


document.getElementById("drawerLegend").style.display = "none";

if (isEmbed) {
const params = new URLSearchParams(location.search);
const open = params.get("open");

currentLoan = null;
currentMode = 'kpi';
requestAnimationFrame(() => {
requestAnimationFrame(() => {
if (open === "projectedNet") {

openKpi2();
}
});
});

setTimeout(() => {
document.documentElement.style.visibility = 'visible';
}, 150);
}

const grid = document.getElementById("loanGrid");
const drawer = document.getElementById("drawer");
const drawerTitle = document.getElementById("drawerTitle");
const drawerSub = document.getElementById("drawerSub");
const drawerPrimaryTitle = document.getElementById("drawerPrimaryTitle");
const drawerPrimary = document.getElementById("drawerPrimary");
const drawerSecondaryTitle = document.getElementById("drawerSecondaryTitle");
const drawerSecondary = document.getElementById("drawerSecondary");
const drawerChartArea = document.getElementById("drawerChartArea");
const drawerExtra = document.getElementById("drawerExtra");
const amortBody = document.getElementById("amortBody");
const closeBtn = document.getElementById("closeBtn");

function renderLoanTiles(loansList) {
  const grid = document.getElementById("loanGrid");
  if (!grid) return;

  grid.innerHTML = "";

  (loansList || []).forEach(loan => {
    const loanId = loan.loanId ?? loan.id;

    // Engine-provided loan view (single source of truth)
    const loanView = views?.loanEarnings?.[loanId] || null;

    const atCurrent = loanView?.current || { netEarnings: 0 };
    const currentMonthLabel = formatMonthYear(
      loanView?.currentDate ? new Date(loanView.currentDate) : new Date()
    );

    // Use engine maturity if provided, otherwise fallback display-only estimate
    const matLabel = loanView?.maturityDate
      ? formatMonthYear(new Date(loanView.maturityDate))
      : formatMonthYear(addMonths(new Date(loan.loanStartDate), Math.round((Number(loan.termYears || 0) + Number(loan.graceYears || 0)) * 12)));

    const tile = document.createElement("div");
    tile.className = "tile";
    tile.dataset.loanName = (loan.loanName || "").toLowerCase();
    tile.dataset.school = (loan.school || "").toLowerCase();
    tile.dataset.rate = loan.nominalRate;
    tile.dataset.purchaseDate = new Date(loan.purchaseDate).getTime();
    tile.dataset.startDate = new Date(loan.loanStartDate).getTime();
    tile.dataset.amount = Number(loan.purchasePrice || 0);

    tile.setAttribute("data-loan", loan.loanName);

    tile.innerHTML = `
      <div class="tile-left">
        <div class="loan-name" style="font-weight:700; font-size:14px;">
          ${loan.loanName}
        </div>

        <div class="loan-name" style="font-weight:700; font-size:14px; margin-top:2px;">
          ${loan.school || "No school listed"}
        </div>

        <div class="loan-sub" style="margin-top:6px;">
          Rate: ${(Number(loan.nominalRate || 0) * 100).toFixed(2)}% &nbsp;Â·&nbsp;
          Term: ${loan.termYears} yrs &nbsp;Â·&nbsp;
          Matures: ${matLabel}
        </div>

        <div class="loan-sub" style="margin-top:4px;">
          Loan ${loanId}
        </div>
      </div>

      <div class="chart-wrap">
        <div class="mini-label">
          Net Earnings ${currentMonthLabel}: ${formatCurrency(atCurrent.netEarnings || 0)}
        </div>
        <div class="mini-chart"></div>
      </div>
    `;

    grid.appendChild(tile);

    tile.addEventListener("click", () => openLoanDrawer(loan));

    // Mini chart is render-only; data comes from engine
    const mini = tile.querySelector(".mini-chart");
    const schedule = loanView?.schedule || [];
    createMiniStackedEarningsSVG(mini, schedule, loan);
  });
}

  function filterLoansByUser(loans, user) {
  return (loans || []).filter(l =>
    l.user === user ||
    l.owner === user ||
    l.assignedUser === user
  );
}


async function initPage() {

  // ------------------------------------
  // UI references
  // ------------------------------------
  const nameSelect    = document.getElementById("filterName");
  const schoolSelect  = document.getElementById("filterSchool");
  const filterRate    = document.getElementById("filterRate");
  const sortLoans     = document.getElementById("sortLoans");
  const resetBtn      = document.getElementById("resetFilters");
  const compactToggle = document.getElementById("toggleCompact");
  const loanGrid      = document.getElementById("loanGrid");

// ------------------------------------
// Load loans + attach engine schedules
// ------------------------------------
const rawLoans = await loadLoans(PAGE_USER);
const normalizedLoans = rawLoans || [];

// ------------------------------------
// ðŸ”‘ AUTHORITATIVE USER FILTER (ONCE)
// ------------------------------------
const ownedLoans = filterLoansByUser(normalizedLoans, PAGE_USER);

// Attach schedules ONLY to owned loans
const loansWithAmort = attachSchedules(ownedLoans);

// Everything downstream uses owned loans only
views = buildPortfolioViews(loansWithAmort);
loansForUser = loansWithAmort;


  // ------------------------------------
// KPI color map (REQUIRED for KPI-1)
// ------------------------------------
buildLoanColorMap(loansForUser);

  
  // ------------------------------------
  // Populate filter dropdowns (UI-only)
  // ------------------------------------
  const sourceLoans = loansForUser || [];

  const uniqueNames = [...new Set(
    sourceLoans.map(l => l.loanName).filter(Boolean)
  )];

  const uniqueSchools = [...new Set(
    sourceLoans.map(l => l.school).filter(Boolean)
  )];

  // Reset existing options (except placeholder)
  nameSelect.querySelectorAll("option:not(:first-child)").forEach(o => o.remove());
  schoolSelect.querySelectorAll("option:not(:first-child)").forEach(o => o.remove());

  uniqueNames.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name.toLowerCase();
    opt.textContent = name;
    nameSelect.appendChild(opt);
  });

  uniqueSchools.forEach(school => {
    const opt = document.createElement("option");
    opt.value = school.toLowerCase();
    opt.textContent = school;
    schoolSelect.appendChild(opt);
  });

  // ------------------------------------
  // Filter / sort handlers
  // ------------------------------------
  nameSelect.addEventListener("change", applyLoanFilters);
  schoolSelect.addEventListener("change", applyLoanFilters);
  filterRate.addEventListener("change", applyLoanFilters);
  sortLoans.addEventListener("change", applyLoanSort);

  resetBtn.addEventListener("click", () => {
    nameSelect.value = "";
    schoolSelect.value = "";
    filterRate.value = "";
    applyLoanFilters();
  });

  // ------------------------------------
  // Compact view toggle
  // ------------------------------------
  const savedCompact = localStorage.getItem("loanGridCompact");
  if (savedCompact !== null) {
    compactToggle.checked = savedCompact === "true";
  }

  loanGrid.classList.toggle("compact", compactToggle.checked);

  compactToggle.addEventListener("change", () => {
    loanGrid.classList.toggle("compact", compactToggle.checked);
    localStorage.setItem("loanGridCompact", compactToggle.checked);
  });

  // ------------------------------------
  // KPIs â€” engine driven (UI only)
  // ------------------------------------
  const portfolio = views?.portfolioEarnings || {};

  document.getElementById("kpiNetToDate").textContent =
    formatCurrency(portfolio.totalNetToDate ?? 0);

  document.getElementById("kpiNetProj").textContent =
    formatCurrency(portfolio.totalNetProjected ?? 0);

  document.getElementById("kpiAvgMonth").textContent =
    formatCurrency(portfolio.avgMonthlyNet ?? 0);

  document.getElementById("kpiFees").textContent =
    formatCurrency(portfolio.projectedAvgMonthlyNet ?? 0);

  // ------------------------------------
  // Loan tiles â€” engine loans only
  // ------------------------------------
  renderLoanTiles(loansForUser);

  // ------------------------------------
  // URL-driven behavior (embed / deep link)
  // ------------------------------------
  const params   = new URLSearchParams(window.location.search);
  const openParam = params.get("open");
  const isEmbed   = params.get("embed") === "true";
  const userParam = params.get("user") || "jeff";

  if (openParam === "kpi2") {
    currentLoan = null;
    currentMode = "kpi";
    requestAnimationFrame(() => {
      requestAnimationFrame(openKpi2);
    });
  }

  if (isEmbed) {
    const header = document.querySelector("header");
    if (header) header.style.display = "none";

    if (loanGrid) loanGrid.style.display = "none";

    document.body.style.margin = "0";
    document.body.style.padding = "0";

    const app = document.querySelector(".app");
    if (app) {
      app.style.margin = "0";
      app.style.padding = "0";
    }

    document.body.addEventListener(
      "click",
      e => {
        if (e.target.closest("button, a")) return;
        window.top.location.href =
          `/loan-dashboard/earnings/index.html?user=${userParam}&open=kpi2`;
      },
      true
    );
  }

// ====================================
// PHASE 0 â€” ARCHITECTURE GUARDS
// ====================================
console.assert(
  typeof buildPortfolioViews === "function",
  "ENGINE MISSING: buildPortfolioViews"
);

console.assert(
  views && views.portfolioEarnings,
  "ENGINE NOT INITIALIZED: views.portfolioEarnings"
);

console.assert(
  Array.isArray(loansForUser),
  "DATA ERROR: loansForUser not set"
);
  
}



function applyLoanFilters() {
const nameVal = filterName.value;
const schoolVal = filterSchool.value;
const rateVal = filterRate.value;

document.querySelectorAll("#loanGrid .tile").forEach(tile => {
let show = true;

if (nameVal && !tile.dataset.loanName.includes(nameVal)) show = false;
if (schoolVal && !tile.dataset.school.includes(schoolVal)) show = false;

if (rateVal) {
const r = Number(tile.dataset.rate) * 100;
if (
(rateVal === "low" && r >= 5) ||
(rateVal === "mid" && (r < 5 || r > 8)) ||
(rateVal === "high" && r <= 8)
) show = false;
}

tile.style.display = show ? "" : "none";
});

applyLoanSort();
}

function applyLoanSort() {
const grid = document.getElementById("loanGrid");
const mode = sortLoans.value;

const tiles = Array.from(grid.children)
.filter(t => t.style.display !== "none");

const get = (el, k) => Number(el.dataset[k] || 0);

tiles.sort((a, b) => {
switch (mode) {
case "purchase_asc": return get(a,"purchaseDate") - get(b,"purchaseDate");
case "purchase_desc": return get(b,"purchaseDate") - get(a,"purchaseDate");
case "start_asc": return get(a,"startDate") - get(b,"startDate");
case "start_desc": return get(b,"startDate") - get(a,"startDate");
case "amount_asc": return get(a,"amount") - get(b,"amount");
case "amount_desc": return get(b,"amount") - get(a,"amount");
case "rate_asc": return get(a,"rate") - get(b,"rate");
case "rate_desc": return get(b,"rate") - get(a,"rate");
default: return 0;
}
});

tiles.forEach(t => grid.appendChild(t));
}

closeBtn.addEventListener("click", closeDrawer);
document.addEventListener("keydown", e => {
if(e.key === "Escape") closeDrawer();
});

function closeDrawer(){
drawer.classList.remove("open");
drawer.setAttribute("aria-hidden","true");
currentLoan = null;
}

document.addEventListener("click", function(e){
if (!drawer.classList.contains("open")) return;
if (drawer.contains(e.target)) return;
if (e.target.closest(".tile")) return;
closeDrawer();
});

function openLoanDrawer(loan) {
  currentLoan = loan;

  resetDrawerContent();

  const loanId = loan.loanId;

  // ------------------------------------
  // Engine-provided loan earnings view
  // ------------------------------------
  const loanView = views?.loanEarnings?.[loanId] || null;

  const currentDateLabel = loanView?.currentDate
    ? formatMonthYear(new Date(loanView.currentDate))
    : formatMonthYear(new Date());

  // ------------------------------------
  // Drawer header (UI-only)
  // ------------------------------------
  drawerTitle.textContent = loan.loanName;

  drawerSub.innerHTML = `
    <div>${loan.school || ""}</div>
    <div>
      Purchased ${loan.purchaseDate || ""}
      â€¢ Orig Loan Amt ${formatCurrency(loan.purchasePrice || 0)}
    </div>
  `;

  // ------------------------------------
  // Loan-level KPIs (ENGINE-DRIVEN ONLY)
  // ------------------------------------
  drawerPrimaryTitle.textContent = `Net Earnings ${currentDateLabel}`;
  drawerPrimary.textContent = formatCurrency(
    loanView?.current?.netEarnings ?? 0
  );

  drawerSecondaryTitle.textContent = "Fees to Date";
  drawerSecondary.textContent = formatCurrency(
    loanView?.feesToDate ?? 0
  );

  // ------------------------------------
  // Chart area (render-only placeholder)
  // ------------------------------------
  drawerChartArea.innerHTML = `
    <div style="height:220px;display:flex;align-items:center;justify-content:center;
                color:var(--muted);font-size:13px;">
      Earnings chart will be rendered here
    </div>
  `;

  // ------------------------------------
  // Extra content (table placeholder)
  // ------------------------------------
  drawerExtra.innerHTML = `
    <h3 style="margin-top:12px;margin-bottom:8px;">
      Earnings Breakdown by Month
    </h3>
    <div class="amort-wrap">
      <div style="padding:12px;text-align:center;color:var(--muted);font-size:13px">
        Monthly earnings details will be available here
      </div>
    </div>
  `;

  openDrawerBase();
}



document.addEventListener("DOMContentLoaded", initPage);

const themeToggleBtn = document.getElementById("themeToggle");
const root = document.documentElement;
const THEME_KEY = "reportsTheme";

function applyTheme(mode){
const nextMode = mode === "dark" ? "dark" : "light";
root.setAttribute("data-theme", nextMode);
themeToggleBtn.textContent = nextMode === "dark" ? "â˜€ï¸" : "ðŸŒ™";
themeToggleBtn.setAttribute("aria-label", nextMode === "dark" ? "Switch to light mode" : "Switch to dark mode");
try { localStorage.setItem(THEME_KEY, nextMode); } catch(e){}
}

function initTheme(){
let saved = null;
try { saved = localStorage.getItem(THEME_KEY); } catch(e){}
const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
applyTheme(saved || (prefersDark ? "dark" : "light"));
}

initTheme();

themeToggleBtn.addEventListener("click", () => {
const isDark = root.getAttribute("data-theme") === "dark";
applyTheme(isDark ? "light" : "dark");
});

const loanColors = ["#0ea5e9", "#22c55e", "#7c3aed", "#14b8a6", "#f59e0b", "#ef4444", "#6366f1", "#a855f7", "#f97316", "#06b6d4"];

function buildKpiStackedChart(
  containerId,
  data,
  valueGetter,
  showCurrentLine = true,
  mode = null
) {
  // --------------------------------------------------
  // Phase 3: UI-only placeholder
  // KPI stacked charts will be engine-provided
  // --------------------------------------------------

  const container = document.getElementById(containerId);
  if (!container) return;

  container.innerHTML = "";

  const svgNS = "http://www.w3.org/2000/svg";
  const rect = container.getBoundingClientRect();
  const w = Math.max(360, rect.width || 700);
  const h = 260;

  const padL = 50, padR = 20, padT = 20, padB = 16;
  const usableHeight = h - padT - padB;

  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");

  // --------------------------------------------------
  // Grid (visual consistency only)
  // --------------------------------------------------
  const gridLines = 4;
  for (let i = 0; i <= gridLines; i++) {
    const y = padT + i * (usableHeight / gridLines);

    const gridLine = document.createElementNS(svgNS, "line");
    gridLine.setAttribute("x1", padL);
    gridLine.setAttribute("x2", w - padR);
    gridLine.setAttribute("y1", y);
    gridLine.setAttribute("y2", y);
    gridLine.setAttribute("stroke", "var(--grid-light)");
    gridLine.setAttribute("stroke-width", "0.8");
    svg.appendChild(gridLine);
  }

  // --------------------------------------------------
  // Baseline
  // --------------------------------------------------
  const axis = document.createElementNS(svgNS, "line");
  axis.setAttribute("x1", padL);
  axis.setAttribute("x2", w - padR);
  axis.setAttribute("y1", h - padB);
  axis.setAttribute("y2", h - padB);
  axis.setAttribute("stroke", "var(--grid-strong)");
  axis.setAttribute("stroke-width", "1");
  svg.appendChild(axis);

  // --------------------------------------------------
  // Placeholder label
  // --------------------------------------------------
  const msg = document.createElementNS(svgNS, "text");
  msg.textContent = "KPI chart will appear here";
  msg.setAttribute("x", (padL + w - padR) / 2);
  msg.setAttribute("y", padT + usableHeight / 2);
  msg.setAttribute("text-anchor", "middle");
  msg.setAttribute("font-size", "14");
  msg.setAttribute("fill", "var(--muted)");
  svg.appendChild(msg);

  container.appendChild(svg);
}


function renderKPI2Chart(loans) {
  // --------------------------------------------------
  // Phase 3: UI-only placeholder
  // KPI2 chart will be engine-provided in later phase
  // --------------------------------------------------

  const container = document.getElementById("drawerChartArea");
  if (!container) return;

  container.innerHTML = `
    <div style="color:var(--muted);font-size:13px;padding:12px;text-align:center">
      Projected earnings chart will appear here
    </div>
  `;
}


function renderKPI3Chart(data, containerId = "kpi3Chart") {
  // --------------------------------------------------
  // Phase 3: UI-only placeholder
  // KPI3 chart will be engine-provided in later phase
  // --------------------------------------------------

  const container = document.getElementById(containerId);
  if (!container) return;

  container.innerHTML = `
    <div style="color:var(--muted);font-size:13px;padding:12px;text-align:center">
      Avg monthly earnings chart will appear here
    </div>
  `;
}

  function buildKpi4AvgMonthlySeries(loans) {
  // --------------------------------------------------
  // Phase 3: UI-only placeholder
  // KPI4 avg monthly series will be built in loanEngine
  // --------------------------------------------------

  return [];
}


function buildKpi4AvgMonthlyRows(loans) {
  // --------------------------------------------------
  // Phase 3: UI-only placeholder
  // KPI4 avg monthly rows will be built in loanEngine
  // --------------------------------------------------

  return [];
}


function renderKpiTable(containerId, headers, rows) {
const container = document.getElementById(containerId);
if (!container) return;

const colors = window.KPI_COLOR_MAP || {};

let html = `<table><thead><tr>`;
headers.forEach(h => html += `<th>${h}</th>`);
html += `</tr></thead><tbody>`;

rows.forEach(r => {
const color = colors[r.loanId] || "var(--text)";

html += `
<tr
data-loan-id="${r.loanId}"
style="--loan-color:${color}; color:var(--loan-color)"
>
`;

r.cells.forEach(c => {
html += `<td>${c}</td>`;
});

html += `</tr>`;
});

html += `</tbody></table>`;
container.innerHTML = html;
}

function renderKpi1Table(series, containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  const totals = {};

  series.forEach(m => {
    Object.entries(m.byLoan || {}).forEach(([loanId, net]) => {
      if (!totals[loanId]) {
        totals[loanId] = {
          net: 0,
          principal: 0,
          interest: 0,
          fees: 0
        };
      }

      totals[loanId].net += net;
      if (net > 0) totals[loanId].principal += net;
      else totals[loanId].fees += net;
    });
  });

  const rows = loansForUser.map(loan => {
    const loanId = loan.loanId;
    const t = totals[loanId] || {};
    const color = KPI_COLOR_MAP[loanId] || "#64748b";

    return `
      <tr data-loan-id="${loanId}">
        <td>
          <div style="display:flex;gap:10px;align-items:flex-start">
            <div style="width:10px;height:10px;border-radius:2px;background:${color};margin-top:4px"></div>
            <div>
              <div style="font-weight:600;color:${color}">
                ${loan.loanName}
              </div>
              <div style="font-size:12px;color:${color};opacity:.8">
                ${loan.school || ""}
              </div>
            </div>
          </div>
        </td>
        <td>${formatCurrency(t.net || 0)}</td>
        <td>${formatCurrency(t.principal || 0)}</td>
        <td>${formatCurrency(t.interest || 0)}</td>
        <td>${formatCurrency(t.fees || 0)}</td>
      </tr>
    `;
  });

  container.innerHTML = `
    <table class="kpi1-table">
      <thead>
        <tr>
          <th>Loan</th>
          <th>Net Earnings</th>
          <th>Principal</th>
          <th>Interest</th>
          <th>Fees</th>
        </tr>
      </thead>
      <tbody>
        ${rows.join("")}
      </tbody>
    </table>
  `;

  const table = container.querySelector("table");

  table.querySelectorAll("tbody tr").forEach(row => {
    const loanId = row.dataset.loanId;

    row.addEventListener("mouseenter", () => {
      highlightLoanInKpiChart(drawerChartArea, loanId);
      highlightKpiRow(table, loanId);
    });

    row.addEventListener("mouseleave", () => {
      clearKpiChartHighlight(drawerChartArea);
      clearKpiRowHighlight(table);
    });
  });
}





function toggleLoanVisibility(loanId) {
if (hiddenLoans.has(loanId)) {
hiddenLoans.delete(loanId);
} else {
hiddenLoans.add(loanId);
}

openKpi4();
}

function renderKPI2Table(data, containerId = "kpi2Table") {
  // --------------------------------------------------
  // Phase 3: UI-only placeholder
  // KPI2 table rows will be engine-provided
  // --------------------------------------------------

  const rows = (data || []).map(l => {
    const color = window.KPI_COLOR_MAP?.[l.loanId] || "#64748b";

    return {
      loanId: l.loanId,
      cells: [
        `<div
          class="loan-swatch"
          style="
            width:10px;
            height:10px;
            border-radius:2px;
            background:${color};
            margin:4px auto;
            opacity:0.5;
          "
        ></div>`,

        `<div style="line-height:1.15">
          <div style="font-weight:600;color:${color}">
            ${l.loanName}
          </div>
          <div style="font-size:12px;color:${color}">
            ${l.school || ""}
          </div>
        </div>`
      ]
    };
  });

  renderKpiTable(
    containerId,
    ["Loan", "Loan"],
    rows
  );

  const table = document.getElementById(containerId);
  if (!table) return;

  table.classList.add("kpi2-table");
}


function renderKPI3Table(data, containerId = "kpi3Table") {
  const rows = (data || []).map(l => ({
    loanId: l.loanId,
    cells: [
      `
      <div>
        <div style="font-weight:600;">
          ${l.loanName}
        </div>
        <div style="font-size:12px;color:var(--muted);margin-top:2px;">
          ${l.school || ""}
        </div>
      </div>
      `,
      formatCurrency(l.avgMonthly ?? 0),
      l.purchaseDate
        ? formatMonthYear(new Date(l.purchaseDate))
        : "â€”",
      l.maturityDate
        ? formatMonthYear(new Date(l.maturityDate))
        : "â€”"
    ]
  }));

  renderKpiTable(
    containerId,
    [
      "Loan",
      "Avg Monthly Earnings To Date",
      "Purchase Date",
      "Maturity Date"
    ],
    rows
  );

  const table = document.getElementById(containerId);
  if (!table) return;

  table.classList.add("kpi3-table");
}



function renderKPI4Table(data, containerId = "kpi4Table") {
  // --------------------------------------------------
  // Phase 3: UI-only placeholder
  // KPI4 table rows will be engine-provided
  // --------------------------------------------------

  const rows = (data || []).map(l => ({
    loanId: l.loanId,
    cells: [
      `<div style="line-height:1.15">
        <div style="font-weight:600;color:var(--text)">
          ${l.loanName}
        </div>
        <div style="font-size:12px;color:var(--muted);margin-top:2px">
          ${l.school || ""}
        </div>
      </div>`,
      "â€”",
      "â€”",
      formatCurrency(l.purchasePrice || 0),
      "â€”"
    ]
  }));

  renderKpiTable(
    containerId,
    [
      "Loan",
      "Projected Avg Monthly Earnings",
      "Projected Net",
      "Purchase Price",
      "Maturity Date"
    ],
    rows
  );
}


function createLens(svg, radius = 40, scale = 1.5, borderColor = "#94a3b8", borderWidth = 1.5, bgFill = "rgba(255,255,255,0.7)"){
const svgNS = "http://www.w3.org/2000/svg";
const defs = svg.querySelector("defs") || (()=>{ const d = document.createElementNS(svgNS,"defs"); svg.insertBefore(d, svg.firstChild); return d; })();
const clipId = `lens-clip-${Math.random().toString(36).slice(2)}`;
const clipPath = document.createElementNS(svgNS,"clipPath");
clipPath.setAttribute("id", clipId);
const clipCircle = document.createElementNS(svgNS,"circle");
clipCircle.setAttribute("r", radius);
clipPath.appendChild(clipCircle);
defs.appendChild(clipPath);

const group = document.createElementNS(svgNS,"g");
group.setAttribute("pointer-events","none");

const bgCircle = document.createElementNS(svgNS,"circle");
bgCircle.setAttribute("r", radius);
bgCircle.setAttribute("fill", bgFill);
bgCircle.setAttribute("stroke", borderColor);
bgCircle.setAttribute("stroke-width", borderWidth);
bgCircle.setAttribute("opacity","0.95");

const content = document.createElementNS(svgNS,"g");
content.setAttribute("clip-path", `url(#${clipId})`);

const outline = document.createElementNS(svgNS,"circle");
outline.setAttribute("r", radius);
outline.setAttribute("fill","none");
outline.setAttribute("stroke", borderColor);
outline.setAttribute("stroke-width", borderWidth);

group.appendChild(bgCircle);
group.appendChild(content);
group.appendChild(outline);

return { group, content, outline, bgCircle, clipCircle, clipPath, scale, radius };
}

function updateLens(lens, x, y){
if(!lens) return;
const tx = x - x * lens.scale;
const ty = y - y * lens.scale;
lens.clipCircle.setAttribute("cx", x);
lens.clipCircle.setAttribute("cy", y);
lens.bgCircle.setAttribute("cx", x);
lens.bgCircle.setAttribute("cy", y);
lens.outline.setAttribute("cx", x);
lens.outline.setAttribute("cy", y);
lens.content.setAttribute("transform", `translate(${tx}, ${ty}) scale(${lens.scale})`);
}

function removeLens(svg, lens){
if(!lens) return;
if(lens.group && lens.group.parentNode === svg) svg.removeChild(lens.group);
if(lens.clipPath && lens.clipPath.parentNode) lens.clipPath.parentNode.removeChild(lens.clipPath);
}

function createTooltip(svg, large = false){
const svgNS = "http://www.w3.org/2000/svg";
const group = document.createElementNS(svgNS,"g");
group.setAttribute("pointer-events","none");
group.setAttribute("opacity","0.95");

const rect = document.createElementNS(svgNS,"rect");
rect.setAttribute("rx", large ? 8 : 6);
rect.setAttribute("ry", large ? 8 : 6);
rect.setAttribute("fill","rgba(15,23,42,0.92)");
rect.setAttribute("stroke","#0ea5e9");
rect.setAttribute("stroke-width","0.6");

const textGroup = document.createElementNS(svgNS,"g");
textGroup.setAttribute("fill","#fff");
textGroup.setAttribute("font-size", large ? "12" : "11");
textGroup.setAttribute("font-weight","600");

group.appendChild(rect);
group.appendChild(textGroup);
svg.appendChild(group);

return { group, rect, textGroup, lines: [], large, width:0, height:0 };
}

function updateTooltipContent(tooltip, lines, large = false){
if(!tooltip) return;
tooltip.large = large;
tooltip.rect.setAttribute("rx", large ? 8 : 6);
tooltip.rect.setAttribute("ry", large ? 8 : 6);
tooltip.textGroup.setAttribute("font-size", large ? "12" : "11");
while(tooltip.lines.length < lines.length){
const t = document.createElementNS("http://www.w3.org/2000/svg","text");
tooltip.textGroup.appendChild(t);
tooltip.lines.push(t);
}
while(tooltip.lines.length > lines.length){
const t = tooltip.lines.pop();
t.remove();
}

const lineHeight = large ? 15 : 14;
let maxWidth = 0;
tooltip.lines.forEach((t, idx) => {
t.textContent = lines[idx];
t.setAttribute("x", 6);
t.setAttribute("y", 12 + idx * lineHeight);
maxWidth = Math.max(maxWidth, t.getBBox().width);
});

const paddingX = 10;
const paddingY = 8;
const width = maxWidth + paddingX * 2;
const height = lines.length * lineHeight + paddingY;

tooltip.rect.setAttribute("width", width);
tooltip.rect.setAttribute("height", height);
tooltip.rect.setAttribute("x", 0);
tooltip.rect.setAttribute("y", 0);
tooltip.width = width;
tooltip.height = height;
}

function updateTooltipPosition(tooltip, cx, cy, radius){
if(!tooltip) return;
const width = tooltip.width || 0;
const height = tooltip.height || 0;

let dx = radius * 0.45;
let dy = -radius * 0.85;

let tooltipX = cx + dx;
let tooltipY = cy + dy;
const minX = cx + 2;
const maxX = cx + radius - width - 2;
const maxY = cy - height - 2;
const circleLimit = radius - 3;

tooltipX = Math.min(Math.max(tooltipX, minX), maxX);
tooltipY = Math.min(tooltipY, maxY);

for(let i = 0; i < 10; i++){
const corners = [
{x: tooltipX, y: tooltipY},
{x: tooltipX + width, y: tooltipY},
{x: tooltipX, y: tooltipY + height},
{x: tooltipX + width, y: tooltipY + height}
];

let adjusted = false;

for(const corner of corners){
const distance = Math.hypot(corner.x - cx, corner.y - cy);
if(distance >= circleLimit){
const push = distance - circleLimit + 0.5;
const nx = (cx - corner.x) / distance;
const ny = (cy - corner.y) / distance;
tooltipX += nx * push;
tooltipY += ny * push;
adjusted = true;
}
}

tooltipX = Math.min(Math.max(tooltipX, minX), maxX);
tooltipY = Math.min(tooltipY, maxY);

if(!adjusted) break;
}

tooltipX = Math.max(tooltipX, cx + 2);
tooltipY = Math.min(tooltipY, cy - height - 2);

tooltip.group.setAttribute("transform", `translate(${tooltipX}, ${tooltipY})`);
}

document.body.addEventListener("click", (e) => {
if (e.target.matches("#downloadCsvBtn") || e.target.matches("[data-download-csv]")) {
downloadCurrentDrawerCsv();
}
});

document.body.addEventListener("click", (e) => {
if (e.target.matches("#copyCsvBtn")) {
navigator.clipboard.writeText(currentCsvData || "");
alert("CSV copied to clipboard.");
}
});

document.body.addEventListener("click", (e) => {
if (e.target.matches("#printBtn")) {
window.print();
}
});

function downloadCurrentDrawerCsv() {
const blob = new Blob([currentCsvData || ""], { type: "text/csv" });
const url = URL.createObjectURL(blob);
const a = document.createElement("a");
a.href = url;
a.download = "drawer-data.csv";
a.click();
URL.revokeObjectURL(url);
}
  </script>
</body>
</html>
