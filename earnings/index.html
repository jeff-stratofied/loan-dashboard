<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio â€” Rebuilt Dashboard</title>

  <!-- ====================================
       Styles (organized, with dark mode)
       ==================================== -->
  <style>
    :root {
      --bg-light: #f8fafc;
      --bg-dark: #0b1220;
      --surface-light: #f1f5f9;
      --surface-dark: #020617;
      --card-light: #ffffff;
      --card-dark: #020617;
      --border-light: rgba(148,163,184,0.4);
      --border-dark: rgba(15,23,42,0.9);
      --text-light: #020617;
      --text-dark: #e2e8f0;
      --muted: #64748b;
      --muted-dark: #94a3b8;
      --brand: #0ea5e9;
      --brand-soft: rgba(56,189,248,0.15);
      --accent: #7c3aed;
      --accent-soft: rgba(124,58,237,0.1);
      --danger: #f97373;
      --danger-soft: rgba(248,113,113,0.08);
      --success: #10b981;
      --success-soft: rgba(16,185,129,0.12);

      --shadow: 0 18px 45px rgba(15,23,42,0.18);
      --shadow-soft: 0 10px 30px rgba(15,23,42,0.14);

      --chart-bg-light: linear-gradient(180deg, #ffffff, #fcfeff);
      --chart-bg-dark: linear-gradient(180deg, rgba(56,189,248,0.12), rgba(124,58,237,0.16));
      --table-header-light: #ffffff;
      --table-header-dark: #020617;
      --table-border-light: rgba(148,163,184,0.5);
      --table-border-dark: rgba(15,23,42,0.9);

      --tooltip-bg-light: #020617;
      --tooltip-bg-dark: #020617;
      --tooltip-text-light: #e5e7eb;
      --tooltip-text-dark: #e5e7eb;

      --kpi-hover: translateY(-6px);
    }

    html[data-theme="light"] {
      --bg: var(--bg-light);
      --surface: var(--surface-light);
      --card: var(--card-light);
      --border: var(--border-light);
      --text: var(--text-light);
      --muted-text: var(--muted);
      --chart-bg: var(--chart-bg-light);
      --table-header: var(--table-header-light);
      --table-border: var(--table-border-light);
      --tooltip-bg: var(--tooltip-bg-light);
      --tooltip-text: var(--tooltip-text-light);
    }

    html[data-theme="dark"] {
      --bg: var(--bg-dark);
      --surface: var(--surface-dark);
      --card: var(--card-dark);
      --border: var(--border-dark);
      --text: var(--text-dark);
      --muted-text: var(--muted-dark);
      --chart-bg: var(--chart-bg-dark);
      --table-header: var(--table-header-dark);
      --table-border: var(--table-border-dark);
      --tooltip-bg: var(--tooltip-bg-dark);
      --tooltip-text: var(--tooltip-text-dark);
    }

    /* Smooth theme transitions */
    html, body,
    .app,
    header,
    .kpi, .tile,
    .drawer, .drawer-head, .drawer-body, .drawer-footer,
    .info-card, .drawer-chart,
    table, thead th, td,
    .tooltip,
    .theme-icon,
    svg text {
      transition:
        background-color .25s ease,
        color .25s ease,
        border-color .25s ease,
        box-shadow .25s ease,
        fill .25s ease;
    }

    html,body{
      height:100%;
      margin:0;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      color:var(--text);
      background:radial-gradient(circle at top,rgba(56,189,248,0.28),transparent 60%),radial-gradient(circle at bottom,rgba(124,58,237,0.28),transparent 60%),var(--bg);
    }
    body{
      display:flex;
      justify-content:center;
      align-items:stretch;
      padding:24px;
      box-sizing:border-box;
    }
    .app{
      width:100%;
      max-width:1280px;
      max-height:100%;
      background:radial-gradient(circle at top left,rgba(148,163,184,0.18),transparent 55%),radial-gradient(circle at bottom right,rgba(15,23,42,0.45),transparent 60%),var(--surface);
      border-radius:28px;
      box-shadow:0 32px 90px rgba(15,23,42,0.55);
      padding:22px 26px 24px;
      box-sizing:border-box;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:18px;
      border:1px solid rgba(148,163,184,0.3);
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      border-radius:22px;
      padding:14px 20px;
      background:linear-gradient(120deg,rgba(15,23,42,0.96),rgba(15,23,42,0.95));
      color:#e5e7eb;
      box-shadow:0 18px 55px rgba(15,23,42,0.75);
    }
    .title-block h1{
      margin:0;
      font-size:22px;
      letter-spacing:-0.02em;
    }
    .title-block .subtitle{
      margin-top:2px;
      font-size:13px;
      color:#94a3b8;
    }
    .title-block .badge-row{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:3px 10px;
      font-size:11px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.85);
    }
    .pill strong{
      color:#e5e7eb;
    }
    .current-date{
      font-size:12px;
      color:#cbd5f5;
    }

    .theme-icon{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.9);
      color:#facc15;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(15,23,42,0.45);
      font-size:16px;
    }

    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:14px;
      overflow:hidden;
    }

    .kpis{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:12px;
    }
    .kpi{
      background:radial-gradient(circle at top left,rgba(56,189,248,0.08),transparent 65%),radial-gradient(circle at bottom right,rgba(129,140,248,0.2),transparent 60%),var(--card);
      border-radius:18px;
      padding:12px 14px;
      border:1px solid rgba(148,163,184,0.3);
      box-shadow:0 12px 30px rgba(15,23,42,0.35);
      display:flex;
      flex-direction:column;
      gap:4px;
      cursor:pointer;
    }
    .kpi h3{
      margin:0;
      font-size:12px;
      color:var(--muted-text);
    }
    .kpi p{
      margin:0;
      font-size:18px;
      font-weight:600;
    }

    .grid{
      flex:1;
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px;
      padding:2px 2px 6px;
      overflow:auto;
    }

    .tile{
      position:relative;
      background:radial-gradient(circle at top left,rgba(56,189,248,0.06),transparent 55%),radial-gradient(circle at bottom right,rgba(124,58,237,0.12),transparent 60%),var(--card);
      border-radius:18px;
      padding:12px 14px;
      border:1px solid rgba(148,163,184,0.35);
      display:flex;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      box-shadow:0 16px 40px rgba(15,23,42,0.45);
    }
    .tile-left{
      flex:1;
      min-width:0;
    }
    .loan-name{
      font-weight:700;
      font-size:14px;
    }
    .loan-sub{
      font-size:12px;
      color:var(--muted-text);
      margin-top:4px;
    }
    .loan-meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
      font-size:11px;
      color:var(--muted-text);
    }
    .loan-meta div{
      padding:3px 7px;
      border-radius:999px;
      background:rgba(15,23,42,0.04);
      border:1px solid rgba(148,163,184,0.4);
    }

    .chart-wrap{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      min-width:160px;
    }
    .mini-label{
      font-size:11px;
      color:var(--muted-text);
    }
    .mini-chart{
      width:170px;
      height:48px;
      border-radius:12px;
      background:rgba(15,23,42,0.04);
      overflow:hidden;
      border:1px solid rgba(148,163,184,0.35);
    }

    .drawer{
      position:fixed;
      right:0;
      top:0;
      height:100vh;
      max-width:1000px;
      width:760px;
      background:var(--card);
      box-shadow:-28px 0 80px rgba(2,6,23,0.85);
      transform:translateX(20%);
      opacity:0;
      display:flex;
      flex-direction:column;
      z-index:120;
      pointer-events:none;
    }
    .drawer.open{
      transform:translateX(0);
      opacity:1;
      pointer-events:auto;
    }
    @keyframes drawerIn {
      from { transform: translateX(30%); opacity:0; }
      to { transform: translateX(0); opacity:1; }
    }
    .drawer-head{
      padding:16px 20px 12px;
      border-bottom:1px solid rgba(148,163,184,0.25);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .drawer-head h2{
      margin:0;
      font-size:18px;
    }
    .drawer-head .muted{
      margin-top:4px;
      font-size:12px;
      color:var(--muted-text);
    }
    .drawer-body{
      flex:1;
      overflow:auto;
      padding:16px 20px 18px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .drawer-footer{
      padding:10px 18px 14px;
      border-top:1px solid rgba(148,163,184,0.25);
      display:flex;
      justify-content:flex-end;
    }

    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.03);
      padding:6px 11px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:var(--text);
      cursor:pointer;
    }
    .btn.primary{
      background:linear-gradient(120deg,#0ea5e9,#4f46e5);
      border:none;
      color:white;
      box-shadow:0 10px 30px rgba(37,99,235,0.7);
    }

    .drawer-metrics{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    .info-card{
      background:radial-gradient(circle at top left,rgba(56,189,248,0.14),transparent 55%),radial-gradient(circle at bottom right,rgba(129,140,248,0.25),transparent 55%),var(--card);
      border-radius:14px;
      padding:10px 12px;
      border:1px solid rgba(148,163,184,0.45);
      box-shadow:0 10px 28px rgba(15,23,42,0.42);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .info-card h4{
      margin:0;
      font-size:11px;
      color:var(--muted-text);
    }
    .info-card .value{
      font-size:18px;
      font-weight:600;
    }

    .drawer-chart{
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.45);
      background:var(--card);
      box-shadow:0 16px 40px rgba(15,23,42,0.4);
      padding:12px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    thead th{
      text-align:left;
      padding:6px 8px;
      background:var(--table-header);
      border-bottom:1px solid var(--table-border);
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody td{
      padding:5px 8px;
      border-bottom:1px solid rgba(148,163,184,0.22);
    }
    tbody tr:nth-child(2n){
      background:rgba(15,23,42,0.03);
    }

    .actions{
      display:flex;
      gap:8px;
    }

    #tooltip{
      position:fixed;
      pointer-events:none;
      background:var(--tooltip-bg);
      color:var(--tooltip-text);
      padding:4px 7px;
      border-radius:6px;
      font-size:10px;
      z-index:200;
      box-shadow:0 8px 20px rgba(15,23,42,0.7);
      opacity:0;
      transform:translateY(4px);
      transition:opacity .15s ease,transform .15s ease;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-block">
        <h1>Loan Portfolio â€” Earnings Dashboard</h1>
        <div class="subtitle">Net earnings, fees, and ROI for each loan in your portfolio.</div>
        <div class="badge-row">
          <span class="pill"><span>Mode:</span> <strong>Earnings</strong></span>
          <span class="pill"><span>View:</span> <strong>Loans &amp; Drawers</strong></span>
        </div>
        <div class="current-date" style="margin-top:4px;">
          Current Month: <strong id="currentMonthLabel">18</strong>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <div style="font-size:13px; color:var(--muted-text)">
          User: <strong style="color:var(--brand)">Jeff L Customer</strong>
        </div>
        <button id="themeToggle" class="theme-icon" aria-label="Toggle dark mode" title="Toggle dark mode">ðŸŒ™</button>
      </div>
    </header>

    <div class="main">
      <!-- KPI Row -->
      <section class="kpis" id="kpis"></section>

      <!-- Loan grid -->
      <section class="grid" id="loanGrid" aria-live="polite"></section>
    </div>

    <!-- Drawer -->
    <aside id="drawer" class="drawer" aria-hidden="true">
      <div class="drawer-head">
        <div>
          <h2 id="drawerTitle">Drawer</h2>
          <div class="muted" id="drawerSub">details</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="downloadCsvBtn">Download CSV</button>
          <button class="btn" id="printBtn">Print</button>
          <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
          <button class="btn" id="closeBtn" aria-label="Close drawer">âœ•</button>
        </div>
      </div>

      <div class="drawer-body">
        <div class="drawer-metrics">
          <div class="info-card" id="drawerPrimaryCard">
            <h4 id="drawerPrimaryTitle">Primary</h4>
            <div class="value" id="drawerPrimary">$0</div>
          </div>
          <div class="info-card" id="drawerSecondaryCard">
            <h4 id="drawerSecondaryTitle">Secondary</h4>
            <div class="value" id="drawerSecondary">$0</div>
          </div>
        </div>

        <div class="drawer-chart" id="drawerChartArea" style="margin-top:10px;"></div>

        <div id="drawerExtra" style="margin-top:10px;">
          <table id="roiLoansTable" class="roi-table">
            <thead><tr><th>Loan</th><th>ROI to Date</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="margin-top:12px" id="drawerAmortContainer"></div>
      </div>

      <div class="drawer-footer">
        <div class="actions">
          <button class="btn" id="printBtnFooter">Print</button>
        </div>
      </div>
    </aside>

    <div id="tooltip" role="tooltip"></div>
  </div>

<script>
// ===== Global settings =====
const CURRENT_MONTH = 18;
const WORKER_URL = "https://loan-dashboard-api.jeff-263.workers.dev/loans";

const state = {
  loans: [],
  currentLoan: null,
  currentCsv: ""
};

// ------------ Utilities ------------
function monthDiff(d1, d2) {
  const a = new Date(d1);
  const b = new Date(d2);
  return (b.getFullYear() - a.getFullYear()) * 12 + (b.getMonth() - a.getMonth());
}

function clampNumber(v, fallback = 0) {
  v = Number(v);
  return Number.isFinite(v) ? v : fallback;
}

// ------------ Theme toggle ------------
function setupThemeToggle() {
  const root = document.documentElement;
  const toggle = document.getElementById("themeToggle");
  if (!toggle) return;
  function applyTheme(theme) {
    root.setAttribute("data-theme", theme);
    toggle.textContent = theme === "dark" ? "â˜€ï¸" : "ðŸŒ™";
  }
  const stored = localStorage.getItem("loanTheme");
  if (stored === "dark" || stored === "light") {
    applyTheme(stored);
  } else {
    applyTheme("light");
  }
  toggle.addEventListener("click", () => {
    const current = root.getAttribute("data-theme") === "dark" ? "dark" : "light";
    const next = current === "dark" ? "light" : "dark";
    localStorage.setItem("loanTheme", next);
    applyTheme(next);
  });
}

// ------------ Loan loading / normalization ------------
async function fetchLoans() {
  try {
    const res = await fetch(WORKER_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("worker " + res.status);
    const data = await res.json();
    const arr = Array.isArray(data) ? data : (data.loans || []);
    if (!Array.isArray(arr) || !arr.length) throw new Error("no loans array");
    return arr;
  } catch (err) {
    console.error("Falling back to local default loans", err);
    return [
      { loanId:1, loanName:"Loan 1", school:"Penn State", purchaseDate:"2025-01-31", principal:7000, rate:0.0883, termYears:10, graceYears:0.83, upfrontFee:150, monthlyFeeStart:9 },
      { loanId:2, loanName:"Loan 2", school:"Ohio State", purchaseDate:"2025-02-01", principal:7500, rate:0.075, termYears:8, graceYears:2, upfrontFee:150, monthlyFeeStart:9 },
      { loanId:3, loanName:"Loan 3", school:"Pitt", purchaseDate:"2025-03-01", principal:12000, rate:0.0825, termYears:12, graceYears:3, upfrontFee:150, monthlyFeeStart:9 },
      { loanId:4, loanName:"Loan 4", school:"Michigan", purchaseDate:"2025-04-01", principal:6000, rate:0.095, termYears:9, graceYears:1.5, upfrontFee:150, monthlyFeeStart:9 },
      { loanId:5, loanName:"Loan 5", school:"Carnegie Mellon", purchaseDate:"2025-07-01", principal:5000, rate:0.09, termYears:10, graceYears:1, upfrontFee:150, monthlyFeeStart:9 }
    ];
  }
}

function normalizeLoan(raw, idx) {
  const id = clampNumber(raw.loanId ?? raw.id ?? (idx + 1));
  const purchasePrice = clampNumber(raw.purchasePrice ?? raw.principal ?? 0);
  const rate = clampNumber(raw.nominalRate ?? raw.rate ?? 0);
  const termYears = clampNumber(raw.termYears ?? raw.term ?? 0);
  const graceYears = clampNumber(raw.graceYears ?? raw.grace ?? 0);
  const upfrontFee = clampNumber(raw.upfrontFee ?? 150);
  const monthlyFeeStart = clampNumber(raw.monthlyFeeStart ?? 9);

  return {
    ...raw,
    id,
    loanId: id,
    loanName: raw.loanName || `Loan ${id}`,
    school: raw.school || "No school listed",
    purchaseDate: raw.purchaseDate || "2025-01-31",
    purchasePrice,
    principal: purchasePrice,
    nominalRate: rate,
    rate,
    termYears,
    graceYears,
    upfrontFee,
    monthlyFeeStart
  };
}

// ------------ Amortization + earnings ------------
function calcAmort(principal, annualRate, termYears, graceYears) {
  principal = clampNumber(principal);
  annualRate = clampNumber(annualRate);
  termYears = clampNumber(termYears);
  graceYears = clampNumber(graceYears);

  const monthlyRate = annualRate / 12;
  const graceMonths = Math.round(graceYears * 12);
  const termMonths = Math.round(termYears * 12);

  const schedule = [];
  let balance = principal;

  // grace period: interest only
  for (let m = 1; m <= graceMonths; m++) {
    const interest = +(balance * monthlyRate).toFixed(2);
    balance = +(balance + interest).toFixed(2);
    schedule.push({
      monthIndex: m,
      payment: 0,
      interest,
      principalPaid: 0,
      balance
    });
  }

  const repayMonths = Math.max(1, termMonths);
  const P = monthlyRate === 0
    ? (balance / repayMonths)
    : (balance * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -repayMonths));
  const payment = +P.toFixed(2);

  for (let i = 1; i <= repayMonths; i++) {
    const m = graceMonths + i;
    const interest = +(balance * monthlyRate).toFixed(2);
    let principalPaid = +(payment - interest).toFixed(2);
    if (principalPaid < 0) principalPaid = 0;
    balance = +(balance - principalPaid).toFixed(2);
    if (balance < 0) balance = 0;
    schedule.push({
      monthIndex: m,
      payment,
      interest,
      principalPaid,
      balance
    });
    if (balance === 0) break;
  }

  return { payment, schedule };
}

function buildLoanEarnings(loan) {
  const amort = calcAmort(loan.purchasePrice, loan.nominalRate, loan.termYears, loan.graceYears);
  let cumPrincipal = 0;
  let cumInterest = 0;
  let cumFees = 0;

  const termMonths = Math.max(1, Math.round(loan.termYears * 12));
  const earningsSchedule = amort.schedule.map(row => {
    const m = row.monthIndex;

    const upfrontFee = (m === 1 ? loan.upfrontFee : 0);
    let monthlyFee = loan.monthlyFeeStart * (1 - (m / termMonths));
    if (!Number.isFinite(monthlyFee) || monthlyFee < 0) monthlyFee = 0;

    const feeThisMonth = upfrontFee + monthlyFee;
    cumFees = +(cumFees + feeThisMonth).toFixed(2);

    cumPrincipal = +(cumPrincipal + row.principalPaid).toFixed(2);
    cumInterest = +(cumInterest + row.interest).toFixed(2);

    const netEarnings = +(cumPrincipal + cumInterest - cumFees).toFixed(2);

    return {
      ...row,
      feeThisMonth,
      cumPrincipal,
      cumInterest,
      cumFees,
      netEarnings
    };
  });

  return {
    ...loan,
    amort,
    earningsSchedule
  };
}

// ------------ KPI computation ------------
function computePortfolioKPIs(loans) {
  let totalNetToDate = 0;
  let totalNetProjected = 0;
  let totalFeesToDate = 0;
  let maxMonths = 0;

  loans.forEach(loan => {
    const sched = loan.earningsSchedule;
    if (!sched.length) return;
    const last = sched[sched.length - 1];
    totalNetProjected += last.netEarnings;

    const idx = Math.min(CURRENT_MONTH - 1, sched.length - 1);
    const atCurrent = sched[idx];
    totalNetToDate += atCurrent.netEarnings;
    totalFeesToDate += atCurrent.cumFees;

    maxMonths = Math.max(maxMonths, last.monthIndex);
  });

  const avgMonthlyEarnings = maxMonths ? (totalNetProjected / maxMonths) : 0;

  return {
    totalNetToDate,
    totalNetProjected,
    avgMonthlyEarnings,
    totalFeesToDate
  };
}

// ------------ Rendering helpers ------------
function formatMoney(v) {
  const sign = v < 0 ? "-" : "";
  const abs = Math.abs(v);
  return sign + "$" + abs.toLocaleString(undefined, { maximumFractionDigits: 0 });
}

function renderKPIs() {
  const kpisEl = document.getElementById("kpis");
  if (!kpisEl) return;
  const k = computePortfolioKPIs(state.loans);

  kpisEl.innerHTML = `
    <div class="kpi" data-kpi="netToDate">
      <h3>Net Earnings to Date</h3>
      <p>${formatMoney(k.totalNetToDate)}</p>
    </div>
    <div class="kpi" data-kpi="projected">
      <h3>Projected Lifetime Earnings</h3>
      <p>${formatMoney(k.totalNetProjected)}</p>
    </div>
    <div class="kpi" data-kpi="avgMonthly">
      <h3>Average Monthly Earnings</h3>
      <p>$${k.avgMonthlyEarnings.toFixed(2)}</p>
    </div>
    <div class="kpi" data-kpi="fees">
      <h3>Fees to Date</h3>
      <p>${formatMoney(k.totalFeesToDate)}</p>
    </div>
  `;
}

function createMiniEarningsChart(container, sched) {
  if (!container || !sched.length) return;
  const w = 170;
  const h = 48;
  const svgNS = "http://www.w3.org/2000/svg";

  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.setAttribute("preserveAspectRatio", "none");
  container.innerHTML = "";
  container.appendChild(svg);

  const maxAbs = sched.reduce((m, row) => Math.max(m, Math.abs(row.netEarnings)), 0) || 1;
  const slice = sched.slice(0, Math.min(36, sched.length));
  const barW = w / slice.length;

  slice.forEach((row, i) => {
    const value = row.netEarnings;
    const barHeight = (Math.abs(value) / maxAbs) * (h - 4);
    const x = i * barW;
    const y = value >= 0 ? (h / 2 - barHeight) : (h / 2);
    const rect = document.createElementNS(svgNS, "rect");
    rect.setAttribute("x", x.toFixed(2));
    rect.setAttribute("y", isNaN(y) ? (h / 2).toFixed(2) : y.toFixed(2));
    rect.setAttribute("width", Math.max(1, barW - 1).toFixed(2));
    rect.setAttribute("height", isNaN(barHeight) ? "0" : barHeight.toFixed(2));
    rect.setAttribute("fill", value >= 0 ? "#22c55e" : "#ef4444");
    svg.appendChild(rect);
  });
}

function renderLoanTiles() {
  const grid = document.getElementById("loanGrid");
  if (!grid) return;
  grid.innerHTML = "";

  state.loans.forEach(loan => {
    const sched = loan.earningsSchedule;
    if (!sched.length) return;
    const idx = Math.min(CURRENT_MONTH - 1, sched.length - 1);
    const atCurrent = sched[idx];

    const tile = document.createElement("article");
    tile.className = "tile loan-tile";
    tile.innerHTML = `
      <div class="tile-left">
        <div class="loan-name">Loan ${loan.loanId} â€” ${loan.loanName}</div>
        <div class="loan-sub">${loan.school}</div>
        <div class="loan-meta">
          <div>Principal $${loan.purchasePrice.toLocaleString()}</div>
          <div>Rate ${(loan.nominalRate * 100).toFixed(2)}%</div>
          <div>Term ${loan.termYears}y</div>
        </div>
      </div>
      <div class="chart-wrap">
        <div class="mini-label">Net M${CURRENT_MONTH}: ${formatMoney(atCurrent.netEarnings)}</div>
        <div class="mini-chart"></div>
      </div>
    `;
    tile.addEventListener("click", () => openLoanDrawer(loan));
    grid.appendChild(tile);

    const mini = tile.querySelector(".mini-chart");
    createMiniEarningsChart(mini, sched);
  });
}

// ------------ Drawer + CSV ------------
function openLoanDrawer(loan) {
  state.currentLoan = loan;
  const drawer = document.getElementById("drawer");
  const title = document.getElementById("drawerTitle");
  const sub = document.getElementById("drawerSub");
  const chartArea = document.getElementById("drawerChartArea");
  const extra = document.getElementById("drawerExtra");
  const amortContainer = document.getElementById("drawerAmortContainer");

  if (!drawer) return;

  title.textContent = `Loan ${loan.loanId} â€” Earnings (${loan.school})`;
  sub.textContent = `${loan.school} â€¢ Purchased ${loan.purchaseDate} â€¢ $${loan.purchasePrice.toLocaleString()}`;

  const sched = loan.earningsSchedule;
  const last = sched[sched.length - 1];
  const idx = Math.min(CURRENT_MONTH - 1, sched.length - 1);
  const atCurrent = sched[idx];

  document.getElementById("drawerPrimaryTitle").textContent = "Net Earnings To Date";
  document.getElementById("drawerPrimary").textContent = formatMoney(atCurrent.netEarnings);
  document.getElementById("drawerSecondaryTitle").textContent = "Fees To Date";
  document.getElementById("drawerSecondary").textContent = formatMoney(atCurrent.cumFees);

  // Chart
  if (chartArea) {
    chartArea.innerHTML = "";
    const canvas = document.createElement("canvas");
    chartArea.appendChild(canvas);
    const ctx = canvas.getContext("2d");
    const w = (canvas.width = chartArea.clientWidth || 800);
    const h = (canvas.height = 260);

    const max = sched.reduce((m,row) => Math.max(m, row.netEarnings), 0);
    const min = sched.reduce((m,row) => Math.min(m, row.netEarnings), 0);
    const span = max - min || 1;

    const pad = 20;
    const innerW = w - pad * 2;
    const innerH = h - pad * 2;

    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = "#0f172a";
    ctx.fillRect(0,0,w,h);

    ctx.strokeStyle = "#1f2937";
    ctx.beginPath();
    ctx.moveTo(pad, h/2);
    ctx.lineTo(w-pad, h/2);
    ctx.stroke();

    const barW = innerW / sched.length;
    sched.forEach((row,i) => {
      const value = row.netEarnings;
      const norm = (value - min) / span;
      const y = h - pad - norm * innerH;
      const barHeight = h - pad - y;
      ctx.fillStyle = value >= 0 ? "#22c55e" : "#ef4444";
      ctx.fillRect(pad + i*barW, y, Math.max(1, barW-1), barHeight);
    });
  }

  // Table
  if (amortContainer) {
    amortContainer.innerHTML = "";
    const table = document.createElement("table");
    table.className = "roi-table";
    const thead = document.createElement("thead");
    thead.innerHTML = "<tr><th>Month</th><th>Cumulative Principal</th><th>Cumulative Interest</th><th>Cumulative Fees</th><th>Net Earnings</th></tr>";
    table.appendChild(thead);
    const tbody = document.createElement("tbody");
    sched.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>M${row.monthIndex}</td>
        <td>$${row.cumPrincipal.toFixed(2)}</td>
        <td>$${row.cumInterest.toFixed(2)}</td>
        <td>${formatMoney(-row.cumFees)}</td>
        <td>${formatMoney(row.netEarnings)}</td>
      `;
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    amortContainer.appendChild(table);
  }

  // ROI to date simple table
  if (extra) {
    const roi = (atCurrent.netEarnings / loan.purchasePrice) || 0;
    extra.innerHTML = `
      <table id="roiLoansTable" class="roi-table">
        <thead><tr><th>Loan</th><th>ROI to Date</th></tr></thead>
        <tbody><tr><td>Loan ${loan.loanId}</td><td>${(roi*100).toFixed(2)}%</td></tr></tbody>
      </table>
    `;
  }

  const rows = [
    ["Month","Payment","Interest","Principal Paid","Balance","Cum Principal","Cum Interest","Cum Fees","Net Earnings"],
    ...sched.map(r => [
      r.monthIndex,
      r.payment.toFixed(2),
      r.interest.toFixed(2),
      r.principalPaid.toFixed(2),
      r.balance.toFixed(2),
      r.cumPrincipal.toFixed(2),
      r.cumInterest.toFixed(2),
      r.cumFees.toFixed(2),
      r.netEarnings.toFixed(2)
    ])
  ];
  state.currentCsv = rows.map(row => row.join(",")).join("\n");

  drawer.classList.add("open");
  drawer.setAttribute("aria-hidden","false");
}

function closeDrawer() {
  const drawer = document.getElementById("drawer");
  if (!drawer) return;
  drawer.classList.remove("open");
  drawer.setAttribute("aria-hidden","true");
}

function setupDrawerControls() {
  const closeBtn = document.getElementById("closeBtn");
  if (closeBtn) closeBtn.addEventListener("click", closeDrawer);
  const downloadBtn = document.getElementById("downloadCsvBtn");
  if (downloadBtn) downloadBtn.addEventListener("click", () => {
    if (!state.currentCsv) return;
    const blob = new Blob([state.currentCsv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "loan-earnings.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
  const copyBtn = document.getElementById("copyCsvBtn");
  if (copyBtn) copyBtn.addEventListener("click", async () => {
    if (!state.currentCsv || !navigator.clipboard) return;
    try {
      await navigator.clipboard.writeText(state.currentCsv);
    } catch (e) {
      console.error("copy failed", e);
    }
  });
  const printBtn = document.getElementById("printBtn");
  if (printBtn) printBtn.addEventListener("click", () => window.print());
  const printFooter = document.getElementById("printBtnFooter");
  if (printFooter) printFooter.addEventListener("click", () => window.print());
}

// ------------ Init ------------
document.addEventListener("DOMContentLoaded", async () => {
  const currentMonthLabel = document.getElementById("currentMonthLabel");
  if (currentMonthLabel) currentMonthLabel.textContent = CURRENT_MONTH;

  setupThemeToggle();
  setupDrawerControls();

  const rawLoans = await fetchLoans();
  const normalized = rawLoans.map(normalizeLoan);
  state.loans = normalized.map(buildLoanEarnings);

  renderKPIs();
  renderLoanTiles();
});
</script>
</body>
</html>
