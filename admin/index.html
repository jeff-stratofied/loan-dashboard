<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Admin</title>

<style>

/* ===========================================
   THEME VARIABLES â€” MATCH EXACTLY WITH ROI
   =========================================== */

html {
  --bg: #0f172a;
  --card: #1e293b;
  --text: #e2e8f0;
  --muted: #94a3b8;
  --border: #1e293b;
  --input-bg: #020617;
  --input-border: #334155;
  --shadow: 0 18px 40px rgba(0,0,0,0.4);
  --button-bg: #1e293b;
  --button-border: #334155;
  --delete-bg: #111827;
  --delete-border: #374151;
  --green: #22c55e;
}

html[data-theme="light"] {
  --bg: #f8fafc;
  --card: #ffffff;
  --text: #0f172a;
  --muted: #64748b;
  --border: #e2e8f0;
  --input-bg: #ffffff;
  --input-border: #cbd5e1;
  --shadow: 0 1px 4px rgba(0,0,0,0.08);
  --button-bg: #ffffff;
  --button-border: #cbd5e1;
  --delete-bg: #f1f5f9;
  --delete-border: #cbd5e1;
  --green: #16a34a;
}

/* Smooth theme transition */
body, table, th, td, input, select, button {
  transition: background 0.25s ease, color 0.25s ease, border-color 0.25s ease;
}

/* ===========================================
   GLOBAL LAYOUT
   =========================================== */

body {
  margin: 0;
  padding: 1.5rem;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: var(--bg);
  color: var(--text);
}

/* Titles */
h1 {
  margin: 0 0 0.3rem 0;
  font-size: 1.45rem;
}

.sub {
  font-size: 0.9rem;
  color: var(--muted);
  margin-bottom: 1.2rem;
}

/* ===========================================
   BUTTONS
   =========================================== */

button {
  border-radius: 999px;
  border: 1px solid var(--button-border);
  padding: 0.35rem 0.9rem;
  font-size: 0.8rem;
  cursor: pointer;
  font-weight: 500;
  background: var(--button-bg);
  color: var(--text);
}

button:hover {
  opacity: 0.8;
}

/* Add Loan (green pill) */
#add-row {
  background: var(--green);
  border-color: var(--green);
  color: #ffffff;
}

/* Save button */
#save-btn {
  background: var(--button-bg);
  border-color: var(--button-border);
}

/* Delete button â€” small, dark, not red */
.delete-btn {
  background: var(--delete-bg) !important;
  border: 1px solid var(--delete-border) !important;
  color: var(--text) !important;
  font-size: 0.75rem !important;
  padding: 0.22rem 0.6rem !important;
  border-radius: 0.35rem !important;
}

/* ===========================================
   STATUS PILL (matches ROI)
   =========================================== */

.pill {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.15rem 0.55rem;
  border-radius: 999px;
  border: 1px solid var(--border);
  color: var(--muted);
  font-size: 0.78rem;
}

.pill-dot {
  width: 7px;
  height: 7px;
  border-radius: 999px;
  background: var(--green);
}

/* ===========================================
   TABLE (matches ROI card/table style)
   =========================================== */

table {
  width: 100%;
  border-collapse: collapse;
  background: var(--card);
  border-radius: 0.75rem;
  overflow: hidden;
  box-shadow: var(--shadow);
  font-size: 0.78rem;
}

thead {
  background: var(--card);
}

th, td {
  padding: 0.45rem 0.55rem;
  border-bottom: 1px solid var(--border);
}

th {
  color: var(--muted);
  font-weight: 600;
  white-space: nowrap;
}

tbody tr:hover {
  background: color-mix(in srgb, var(--card) 90%, var(--text) 10%);
}

/* ===========================================
   INPUTS + SELECTS
   =========================================== */

input, select {
  width: 100%;
  box-sizing: border-box;
  border-radius: 0.45rem;
  border: 1px solid var(--input-border);
  background: var(--input-bg);
  color: var(--text);
  padding: 0.25rem 0.3rem;
  font-size: 0.78rem;
}

input:focus, select:focus {
  outline: none;
  border-color: var(--green);
  box-shadow: 0 0 0 1px color-mix(in srgb, var(--green) 40%, transparent);
}

/* Column widths */
.cell-id { max-width: 50px; }
.cell-number { max-width: 100px; }
.cell-date { max-width: 130px; }
.cell-school { min-width: 140px; }
.cell-name { min-width: 150px; }

</style>


</head>

<body>

<!-- =========================================================
     HEADER
     ========================================================= -->
<div class="header-row">
  <div class="header-left">
    <h1>Loan Admin</h1>
    <p>Edit the loans that power your ROI, Earnings, and Amort dashboards.</p>
  </div>

  <div class="header-right">
    <!-- NAVIGATION BUTTONS -->
    <button onclick="location.href='https://jeff-stratofied.github.io/loan-dashboard/roi/index.html'">ðŸ“ˆ ROI</button>
    <button onclick="location.href='https://jeff-stratofied.github.io/loan-dashboard/earnings/index.html'">ðŸ’° Earnings</button>
    <button onclick="location.href='https://jeff-stratofied.github.io/loan-dashboard/amortization/index.html'">ðŸ“Š Amort</button>

    <!-- THEME TOGGLE -->
    <button id="themeToggle" class="toggle-btn">ðŸŒ™</button>
  </div>
</div>

<!-- STATUS -->
<div id="status" class="pill">Idle</div>

<!-- =========================================================
     TOP BUTTONS (ADD ROW + SAVE)
     ========================================================= -->
<div style="margin: 16px 0; display: flex; gap: 10px;">
  <button id="add-row">+ Add Loan</button>
  <button id="save-btn">ðŸ’¾ Save Changes</button>
</div>

<!-- =========================================================
     TABLE
     ========================================================= -->
<table id="loan-table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Loan Name</th>
      <th>School</th>
      <th>Loan Start Date</th>
      <th>Purchase Date</th>
      <th>Orig Loan Amt</th>
      <th>Purchase Price</th>
      <th>Rate</th>
      <th>Term (yrs)</th>
      <th>Grace (yrs)</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="loan-table-body"></tbody>
</table>

<!-- =========================================================
     SCRIPT: FUNCTIONALITY (from working WrongColors version)
     ========================================================= -->
<script type="module">
  import { loadLoans } from "/loan-dashboard/js/loadLoans.js";

  let currentLoans = [];
  let currentSha = null;

  const schoolOptions = [
    "Penn State","Ohio State","Pitt","Carnegie Mellon",
    "Michigan","UCLA","USC","NYU"
  ];

  /* Normalize loan */
  function normalizeLoan(l, idx) {
    return {
      loanId: l.loanId ?? (idx + 1),
      loanName: l.loanName ?? `Loan ${l.loanId ?? (idx + 1)}`,
      school: l.school ?? "Penn State",
      loanStartDate: l.loanStartDate ?? l.purchaseDate ?? "",
      purchaseDate: l.purchaseDate ?? "",
      principal: Number(l.principal ?? 0),        // Orig Loan Amt
      purchasePrice: Number(l.purchasePrice ?? 0),
      rate: Number(l.rate ?? 0),
      termYears: Number(l.termYears ?? 10),
      graceYears: Number(l.graceYears ?? 0)
    };
  }

  /* Render table */
  function renderTable() {
    const tbody = document.getElementById("loan-table-body");
    tbody.innerHTML = "";

    currentLoans.forEach((loan) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${loan.loanId}</td>

        <td><input type="text" value="${loan.loanName}" data-field="loanName"></td>

        <td>
          <select data-field="school">
            ${schoolOptions.map(s => 
              `<option value="${s}" ${loan.school === s ? "selected" : ""}>${s}</option>`
            ).join("")}
          </select>
        </td>

        <td><input type="date" value="${loan.loanStartDate}" data-field="loanStartDate"></td>
        <td><input type="date" value="${loan.purchaseDate}" data-field="purchaseDate"></td>

        <td><input type="number" step="0.01" value="${loan.principal}" data-field="principal"></td>
        <td><input type="number" step="0.01" value="${loan.purchasePrice}" data-field="purchasePrice"></td>

        <td><input type="number" step="0.0001" value="${loan.rate}" data-field="rate"></td>
        <td><input type="number" step="1" value="${loan.termYears}" data-field="termYears"></td>
        <td><input type="number" step="0.1" value="${loan.graceYears}" data-field="graceYears"></td>

        <td>
          <button class="delete-btn" data-action="delete">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  /* Collect from table */
  function collectLoans() {
    const rows = document.querySelectorAll("#loan-table-body tr");
    const list = [];

    rows.forEach((row, i) => {
      const obj = {};
      const inputs = row.querySelectorAll("[data-field]");

      inputs.forEach(inp => {
        const k = inp.dataset.field;
        let v = inp.value;

        if (["principal","purchasePrice","rate","termYears","graceYears"].includes(k)) {
          v = Number(v);
        }
        obj[k] = v;
      });

      obj.loanId = i + 1;
      list.push(obj);
    });

    return list;
  }
  
    /* Load from Worker */
  const status = document.getElementById("status");

  async function loadFromBackend() {
    status.textContent = "Loadingâ€¦";

    try {
      const res = await fetch("https://loan-dashboard-api.jeff-263.workers.dev/loans");
      const data = await res.json();

      currentLoans = data.loans.map(normalizeLoan);
      currentSha = data.sha;

      renderTable();
      status.textContent = "Loaded âœ”";
    } catch (e) {
      console.error(e);
      status.textContent = "Load failed";
    }
  }

  /* Save to Worker */
  async function saveToBackend() {
    status.textContent = "Savingâ€¦";

    const updated = collectLoans();

    try {
      const res = await fetch("https://loan-dashboard-api.jeff-263.workers.dev/loans", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          loans: updated,
          sha: currentSha
        })
      });

      const data = await res.json();
      if (!res.ok) throw data;

      currentSha = data.content.sha;
      status.textContent = "Saved âœ”";
    } catch (err) {
      console.error(err);
      status.textContent = "Save failed";
    }
  }

  /* Buttons */
  document.getElementById("add-row").onclick = () => {
    currentLoans.push(normalizeLoan({}, currentLoans.length));
    renderTable();
  };

  document.getElementById("save-btn").onclick = saveToBackend;

  document.getElementById("loan-table").addEventListener("click", (e) => {
    if (e.target.dataset.action === "delete") {
      const row = e.target.closest("tr");
      const idx = Array.from(row.parentNode.children).indexOf(row);
      currentLoans.splice(idx, 1);
      renderTable();
    }
  });

  /* ===========================
     THEME TOGGLE
     =========================== */
  const themeToggle = document.getElementById("themeToggle");

  function applyTheme(t) {
    document.documentElement.setAttribute("data-theme", t);
    themeToggle.textContent = t === "dark" ? "ðŸŒ™" : "â˜€ï¸";
    localStorage.setItem("admin-theme", t);
  }

  themeToggle.onclick = () => {
    const newTheme = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
    applyTheme(newTheme);
  };

  const savedTheme = localStorage.getItem("admin-theme") || "dark";
  applyTheme(savedTheme);

  loadFromBackend();
</script>

</body>
</html>
