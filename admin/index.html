<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Loan Admin â€” Loan Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #0f172a;
      color: #e5e7eb;
    }
    h1 {
      margin: 0 0 0.25rem 0;
      font-size: 1.4rem;
    }
    .sub {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 1rem;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      align-items: center;
    }
    button {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 0.35rem 0.9rem;
      font-size: 0.8rem;
      cursor: pointer;
      font-weight: 500;
    }
    #add-row {
      background: #22c55e;
      color: #022c22;
      border-color: #16a34a;
    }
    #save-btn {
      background: #0f172a;
      color: #e5e7eb;
      border-color: #374151;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    #status {
      min-height: 1.1rem;
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #020617;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,0.4);
      font-size: 0.78rem;
    }
    thead {
      background: #020617;
    }
    th, td {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid #111827;
      text-align: left;
    }
    th {
      color: #9ca3af;
      font-weight: 600;
      white-space: nowrap;
    }
    tbody tr:nth-child(even) {
      background: #020617;
    }
    tbody tr:hover {
      background: #030712;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      border-radius: 0.4rem;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      padding: 0.18rem 0.3rem;
      font-size: 0.78rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px #22c55e33;
    }
    .cell-id { max-width: 60px; }
    .cell-number { max-width: 90px; }
    .cell-date { max-width: 130px; }
    .cell-school { min-width: 130px; }
    .cell-name { min-width: 150px; }
    .actions button {
      background: #111827;
      color: #e5e7eb;
      border-color: #374151;
      padding: 0.2rem 0.6rem;
    }
    .pill {
      font-size: 0.75rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #374151;
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }
  </style>
</head>
<body>
  <h1>Loan Admin</h1>
  <div class="sub">
    Edit the loans that power your ROI, Earnings, and Amort dashboards.
    Data is stored in <code>data/loans.json</code> in the <code>loan-dashboard</code> repo.
  </div>

  <div class="toolbar">
    <button id="add-row">+ Add Loan</button>
    <button id="save-btn">ðŸ’¾ Save Changes</button>
    <span class="pill">
      <span class="pill-dot"></span>
      Backend: Cloudflare Worker â†’ GitHub
    </span>
  </div>

  <div id="status"></div>

  <table id="loan-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Loan Name</th>
        <th>School</th>
        <th>Loan Start Date</th>
        <th>Purchase Date</th>
        <th>Principal</th>
        <th>Rate</th>
        <th>Term (yrs)</th>
        <th>Grace (yrs)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="loan-table-body"></tbody>
  </table>

  <script type="module">
  import { loadLoans as fetchLoans, saveLoans as postLoans } from "../js/loadLoans.js";

  let loans = [];
  let currentSha = null;

  const SCHOOL_OPTIONS = [
    "Select schoolâ€¦",
    "Penn State",
    "Ohio State",
    "Pitt",
    "Carnegie Mellon",
    "Michigan",
    "UCLA",
    "USC",
    "NYU",
    "Community College",
    "Other"
  ];

  function setStatus(msg, type = "ok") {
    const el = document.getElementById("status");
    el.textContent = msg;
    el.style.color = type === "error" ? "#fecaca" : "#a7f3d0";
  }

  // -----------------------------
  // LOAD FROM WORKER
  // -----------------------------
  async function loadFromBackend() {
    setStatus("Loading loansâ€¦");

    try {
      const data = await fetchLoans(); // { loans: [...], sha: "xxxx" }
      currentSha = data.sha || null;

      const arr = data.loans || [];
      loans = arr.map((l, i) => normalizeLoan(l, i));

      if (!loans.length) loans = getDefaultLoans();

      renderTable();
      setStatus("Loans loaded.");
    } catch (err) {
      console.error(err);
      loans = getDefaultLoans();
      renderTable();
      setStatus("Error loading from backend â€” using defaults.", "error");
    }
  }

  // -----------------------------
  // SAVE TO WORKER
  // -----------------------------
  async function handleSave() {
    const saveBtn = document.getElementById("save-btn");
    saveBtn.disabled = true;
    setStatus("Savingâ€¦");

    const newLoans = collectLoansFromTable();

    // Simple date validation
    for (const loan of newLoans) {
      if (new Date(loan.loanStartDate) > new Date(loan.purchaseDate)) {
        alert("Purchase Date cannot be before Loan Start Date.");
        saveBtn.disabled = false;
        return;
      }
    }

    try {
      const res = await postLoans(newLoans, currentSha);

      // Update SHA returned from GitHub
      if (res?.content?.sha) {
        currentSha = res.content.sha;
      }

      loans = newLoans;
      setStatus("Saved successfully.");
    } catch (err) {
      console.error(err);
      setStatus("Failed to save â€” check Worker & GitHub.", "error");
    } finally {
      saveBtn.disabled = false;
    }
  }

  // -----------------------------
  // TABLE HELPERS
  // -----------------------------
  function normalizeLoan(l, idx) {
    return {
      loanId: l.loanId ?? (idx + 1),
      loanName: l.loanName ?? `Loan ${l.loanId ?? (idx + 1)}`,
      school: l.school ?? "Select schoolâ€¦",
      loanStartDate: l.loanStartDate ?? l.purchaseDate ?? "",
      purchaseDate: l.purchaseDate ?? "2024-01-01",
      principal: Number(l.principal ?? 0),
      rate: Number(l.rate ?? 0),
      termYears: Number(l.termYears ?? 10),
      graceYears: Number(l.graceYears ?? 0)
    };
  }

  function getDefaultLoans() {
    return [
      {
        loanId: 1,
        loanName: "Loan 1 â€” Freshman Fall",
        school: "Penn State",
        loanStartDate: "2024-01-01",
        purchaseDate: "2024-01-01",
        principal: 7000,
        rate: 0.0883,
        termYears: 10,
        graceYears: 0.83
      },
      {
        loanId: 2,
        loanName: "Loan 2 â€” Sophomore Fall",
        school: "Ohio State",
        loanStartDate: "2024-08-01",
        purchaseDate: "2024-09-01",
        principal: 7500,
        rate: 0.075,
        termYears: 8,
        graceYears: 2
      }
    ];
  }

  function renderTable() {
    const tbody = document.getElementById("loan-table-body");
    tbody.innerHTML = "";

    loans.forEach((loan, idx) => {
      const tr = document.createElement("tr");

      const schoolOpts = SCHOOL_OPTIONS.map(opt =>
        `<option value="${opt}" ${opt === loan.school ? "selected" : ""}>${opt}</option>`
      ).join("");

      tr.innerHTML = `
        <td><input type="number" class="cell-id" value="${loan.loanId}" data-field="loanId"></td>
        <td><input type="text" class="cell-name" value="${loan.loanName}" data-field="loanName"></td>
        <td><select class="cell-school" data-field="school">${schoolOpts}</select></td>
        <td><input type="date" class="cell-date" value="${loan.loanStartDate}" data-field="loanStartDate"></td>
        <td><input type="date" class="cell-date" value="${loan.purchaseDate}" data-field="purchaseDate"></td>
        <td><input type="number" step="0.01" class="cell-number" value="${loan.principal}" data-field="principal"></td>
        <td><input type="number" step="0.0001" class="cell-number" value="${loan.rate}" data-field="rate"></td>
        <td><input type="number" step="0.1" class="cell-number" value="${loan.termYears}" data-field="termYears"></td>
        <td><input type="number" step="0.1" class="cell-number" value="${loan.graceYears}" data-field="graceYears"></td>
        <td class="actions"><button onclick="deleteRow(${idx})">Delete</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function collectLoansFromTable() {
    return [...document.querySelectorAll("#loan-table-body tr")].map(row => {
      const obj = {};
      row.querySelectorAll("input, select").forEach(f => {
        const key = f.dataset.field;
        obj[key] = ["loanId", "principal", "rate", "termYears", "graceYears"].includes(key)
          ? Number(f.value)
          : f.value;
      });
      return obj;
    });
  }

  function deleteRow(idx) {
    loans.splice(idx, 1);
    renderTable();
  }

  // Expose deleteRow to global scope for inline button
  window.deleteRow = deleteRow;

  // -----------------------------
  // INIT
  // -----------------------------
  document.getElementById("add-row").addEventListener("click", () => {
    const nextId = loans.length ? Math.max(...loans.map(l => l.loanId || 0)) + 1 : 1;
    loans.push({
      loanId: nextId,
      loanName: `Loan ${nextId}`,
      school: "Select schoolâ€¦",
      loanStartDate: "2024-01-01",
      purchaseDate: "2024-01-01",
      principal: 0,
      rate: 0,
      termYears: 10,
      graceYears: 0
    });
    renderTable();
  });

  document.getElementById("save-btn").addEventListener("click", handleSave);
  window.addEventListener("DOMContentLoaded", loadFromBackend);
</script>

</body>
</html>
