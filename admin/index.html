<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Loan Admin â€” Edit Loan Data</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #0f172a;
      color: #e5e7eb;
    }
    h1 {
      margin-top: 0;
      margin-bottom: 0.5rem;
    }
    .sub {
      color: #9ca3af;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    .toolbar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 0.35rem 0.9rem;
      font-size: 0.85rem;
      cursor: pointer;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
    }
    button.secondary {
      background: #1f2937;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    button.danger {
      background: #b91c1c;
      color: #fee2e2;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    #status {
      font-size: 0.8rem;
      min-height: 1.2rem;
    }
    #status.error {
      color: #fecaca;
    }
    #status.ok {
      color: #a7f3d0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      background: #020617;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
    }
    thead {
      background: #0b1120;
    }
    th, td {
      padding: 0.45rem 0.55rem;
      border-bottom: 1px solid #1f2937;
      font-size: 0.78rem;
      text-align: left;
    }
    th {
      font-weight: 600;
      color: #9ca3af;
      white-space: nowrap;
    }
    tbody tr:hover {
      background: #020617;
      outline: 1px solid #1d4ed8;
    }
    input {
      width: 100%;
      box-sizing: border-box;
      border-radius: 0.4rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      padding: 0.18rem 0.3rem;
      font-size: 0.78rem;
    }
    input:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px #22c55e33;
    }
    .cell-number {
      max-width: 80px;
    }
    .cell-id {
      max-width: 60px;
    }
    .cell-date {
      max-width: 130px;
    }
    .actions {
      white-space: nowrap;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #0f172a;
      border: 1px solid #1f2937;
      color: #9ca3af;
      margin-left: auto;
    }
    .pill span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }
    .token-hint {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 0.5rem;
      max-width: 600px;
    }
    .token-hint code {
      background: #020617;
      padding: 0.1rem 0.3rem;
      border-radius: 0.25rem;
      border: 1px solid #111827;
    }
  </style>
</head>
<body>

<h1>Loan Admin</h1>
<div class="sub">
  Edit your loan data here. Changes save directly to
  <code>data/loans.json</code> in <code>jeff-stratofied/loan-dashboard</code>.
</div>

<div class="toolbar">
  <button id="add-row">+ Add Loan</button>
  <button id="save-btn">ðŸ’¾ Save Changes</button>
  <span class="pill">
    <span class="dot"></span>
    GitHub JSON backend
  </span>
</div>

<div id="status"></div>

<table id="loan-table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Loan Name</th>
      <th>School</th>
      <th>Purchase Date</th>
      <th>Principal</th>
      <th>Rate</th>
      <th>Term (yrs)</th>
      <th>Grace (yrs)</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="token-hint">
  Insert your GitHub fine-grained token in the code below:
  <code>const GITHUB_TOKEN = "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"</code>
</div>

<script>
const WORKER_BASE_URL = "https://loan-dashboard-api.jeff-263.workers.dev";

let loans = [];
let currentSha = null;

// -----------------------------
// Load loans.json through Worker
// -----------------------------
async function loadFromBackend() {
  setStatus("Loading loansâ€¦");

  try {
    const res = await fetch(`${WORKER_BASE_URL}/loans`);
    if (!res.ok) throw new Error(`Worker error ${res.status}`);

    const data = await res.json();

    currentSha = data.sha || null;
    loans = data.loans || [];

    // If file does not exist yet, seed defaults
    if (!loans.length) {
      loans = getDefaultLoans();
      currentSha = null;
    }

    renderTable();
    setStatus("Loans loaded.");
  } catch (err) {
    console.error(err);
    loans = getDefaultLoans();
    currentSha = null;
    renderTable();
    setStatus("Backend error â€” using defaults.", "error");
  }
}

// -----------------------------
// Save loans.json through Worker
// -----------------------------
async function saveToBackend() {
  const saveBtn = document.getElementById("save-btn");
  saveBtn.disabled = true;

  setStatus("Savingâ€¦");

  const newLoans = collectLoansFromTable();

  try {
    const res = await fetch(`${WORKER_BASE_URL}/loans`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        loans: newLoans,
        sha: currentSha
      })
    });

    const data = await res.json();

    if (!res.ok || !data.ok) {
      throw new Error("Worker save failed");
    }

    // Update SHA returned by GitHub
    currentSha = data.content?.sha || currentSha;

    loans = newLoans;

    setStatus("Saved successfully.");
  } catch (err) {
    console.error(err);
    setStatus("Error saving â€” check Worker logs.", "error");
  } finally {
    saveBtn.disabled = false;
  }
}

// -----------------------------
// Render table / create new row
// Existing code remains unchanged
// -----------------------------
function renderTable() {
  const tbody = document.getElementById("loan-table-body");
  tbody.innerHTML = "";

  loans.forEach((loan, idx) => {
    const row = document.createElement("tr");

    row.innerHTML = `
      <td><input type="number" value="${loan.loanId}" data-field="loanId"></td>
      <td><input type="date" value="${loan.purchaseDate}" data-field="purchaseDate"></td>
      <td><input type="number" step="0.01" value="${loan.principal}" data-field="principal"></td>
      <td><input type="number" step="0.01" value="${loan.rate}" data-field="rate"></td>
      <td><input type="number" step="0.1" value="${loan.termYears}" data-field="termYears"></td>
      <td><input type="number" step="0.1" value="${loan.graceYears}" data-field="graceYears"></td>
      <td><button onclick="deleteRow(${idx})">Delete</button></td>
    `;

    tbody.appendChild(row);
  });
}

function collectLoansFromTable() {
  const rows = [...document.querySelectorAll("#loan-table-body tr")];
  return rows.map(row => {
    const fields = row.querySelectorAll("input");
    const obj = {};
    fields.forEach(f => {
      const key = f.dataset.field;
      let val = f.value;

      if (["loanId", "principal", "rate", "termYears", "graceYears"].includes(key)) {
        val = Number(val);
      }
      obj[key] = val;
    });
    return obj;
  });
}

function addLoanRow() {
  loans.push({
    loanId: loans.length + 1,
    purchaseDate: "2024-01-01",
    principal: 0,
    rate: 0,
    termYears: 10,
    graceYears: 0
  });
  renderTable();
}

function deleteRow(i) {
  loans.splice(i, 1);
  renderTable();
}

// Example defaults
function getDefaultLoans() {
  return [
    { loanId: 1, purchaseDate: "2024-01-01", principal: 7000, rate: 0.0883, termYears: 10, graceYears: 0.83 },
    { loanId: 2, purchaseDate: "2024-02-01", principal: 7500, rate: 0.075, termYears: 8, graceYears: 2 }
  ];
}

function setStatus(msg, type = "ok") {
  const el = document.getElementById("status");
  el.textContent = msg;
  el.style.color = type === "error" ? "red" : "black";
}

// Load data immediately
window.addEventListener("DOMContentLoaded", loadFromBackend);
</script>


</body>
</html>

