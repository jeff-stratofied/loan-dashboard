<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Admin</title>

  <!-- ===========================================
       Modern Dark Theme (from adminRightColors)
       =========================================== -->
  <style>
    :root {
      --bg: #0f172a;
      --panel: #1e293b;
      --panel-light: #334155;
      --text: #e2e8f0;
      --accent: #22c55e;
      --border: #334155;
      --hover: #283547;
      --danger: #ef4444;
      --danger-dark: #b91c1c;
    }

    body {
      margin: 0;
      padding: 24px;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }

    h1 {
      font-size: 26px;
      margin: 0 0 12px 0;
      font-weight: 600;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .pill {
      background: var(--panel);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 13px;
      border: 1px solid var(--panel-light);
      margin-left: auto;
    }

    /* Buttons */
    button {
      padding: 7px 14px;
      border-radius: 8px;
      border: 1px solid var(--panel-light);
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: var(--panel-light);
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--panel);
      border-radius: 10px;
      overflow: hidden;
      font-size: 14px;
    }

    th {
      background: var(--panel-light);
      padding: 10px;
      text-align: left;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
    }

    tr:hover td {
      background: var(--hover);
    }

    input, select {
      width: 100%;
      padding: 5px;
      background: #0f172a;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 14px;
    }

    /* Delete button */
    .delete-btn {
      background: var(--danger);
      border-color: var(--danger-dark);
      color: white;
    }
    .delete-btn:hover {
      background: var(--danger-dark);
    }

    #status {
      font-size: 14px;
      margin-left: 12px;
      opacity: 0.85;
    }
  </style>
</head>

<body>

<h1>Loan Admin</h1>

<div class="toolbar">
  <button id="add-row">+ Add Loan</button>
  <button id="save-btn">ðŸ’¾ Save Changes</button>
  <span id="status" class="pill">Idle</span>
</div>

<table id="loan-table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Loan Name</th>
      <th>School</th>
      <th>Loan Start Date</th>
      <th>Purchase Date</th>
      <th>Orig Loan Amt</th>
      <th>Purchase Price</th>
      <th>Rate</th>
      <th>Term (yrs)</th>
      <th>Grace (yrs)</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="loan-table-body"></tbody>
</table>

<!-- ============================================
     WORKING LOGIC (from adminWrongColors)
     ============================================ -->
<script type="module">
  import { loadLoans } from "/loan-dashboard/js/loadLoans.js";

  let currentLoans = [];
  let currentSha = null;

  const schoolOptions = [
    "Penn State",
    "Ohio State",
    "Pitt",
    "Carnegie Mellon",
    "Michigan",
    "UCLA",
    "USC",
    "NYU"
  ];

  /* Normalize loan objects */
  function normalizeLoan(l, idx) {
    return {
      loanId: l.loanId ?? (idx + 1),
      loanName: l.loanName ?? `Loan ${l.loanId ?? (idx + 1)}`,
      school: l.school ?? "Select schoolâ€¦",
      loanStartDate: l.loanStartDate ?? l.purchaseDate ?? "",
      purchaseDate: l.purchaseDate ?? "",
      origLoanAmt: Number(l.origLoanAmt ?? l.principal ?? 0),
      purchasePrice: Number(l.purchasePrice ?? 0),
      rate: Number(l.rate ?? 0),
      termYears: Number(l.termYears ?? 10),
      graceYears: Number(l.graceYears ?? 0)
    };
  }

  /* Render table rows */
  function renderTable() {
    const tbody = document.getElementById("loan-table-body");
    tbody.innerHTML = "";

    currentLoans.forEach((loan) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${loan.loanId}</td>

        <td><input type="text" value="${loan.loanName}" data-field="loanName"></td>

        <td>
          <select data-field="school">
            ${schoolOptions
              .map(
                (s) =>
                  `<option value="${s}" ${
                    loan.school === s ? "selected" : ""
                  }>${s}</option>`
              )
              .join("")}
          </select>
        </td>

        <td><input type="date" value="${loan.loanStartDate}" data-field="loanStartDate"></td>
        <td><input type="date" value="${loan.purchaseDate}" data-field="purchaseDate"></td>

        <td><input type="number" step="0.01" value="${loan.origLoanAmt}" data-field="origLoanAmt"></td>
        <td><input type="number" step="0.01" value="${loan.purchasePrice}" data-field="purchasePrice"></td>

        <td><input type="number" step="0.0001" value="${loan.rate}" data-field="rate"></td>
        <td><input type="number" step="1" value="${loan.termYears}" data-field="termYears"></td>
        <td><input type="number" step="0.1" value="${loan.graceYears}" data-field="graceYears"></td>

        <td><button class="delete-btn" data-action="delete">Delete</button></td>
      `;

      tbody.appendChild(row);
    });
  }

  /* Collect data from table */
  function collectLoansFromTable() {
    const rows = Array.from(document.querySelectorAll("#loan-table-body tr"));
    const loans = [];

    rows.forEach((row, i) => {
      const inputs = row.querySelectorAll("[data-field]");
      const loan = {};

      inputs.forEach((inp) => {
        const key = inp.getAttribute("data-field");
        let val = inp.value;

        if (
          ["origLoanAmt", "purchasePrice", "rate", "termYears", "graceYears"].includes(
            key
          )
        ) {
          val = Number(val);
        }

        loan[key] = val;
      });

      loan.loanId = i + 1;
      loans.push(loan);
    });

    return loans;
  }

  /* Load from Worker backend */
  async function loadFromBackend() {
    document.getElementById("status").textContent = "Loadingâ€¦";

    try {
      const res = await fetch(
        "https://loan-dashboard-api.jeff-263.workers.dev/loans"
      );
      const data = await res.json();

      currentLoans = data.loans.map(normalizeLoan);
      currentSha = data.sha;

      renderTable();
      document.getElementById("status").textContent = "Loaded âœ”";
    } catch (err) {
      document.getElementById("status").textContent = "Load failed";
      console.error(err);
    }
  }

  /* Save to Worker backend */
  async function saveToBackend() {
    const updatedLoans = collectLoansFromTable();

    document.getElementById("status").textContent = "Savingâ€¦";

    try {
      const res = await fetch(
        "https://loan-dashboard-api.jeff-263.workers.dev/loans",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            loans: updatedLoans,
            sha: currentSha,
          }),
        }
      );

      const data = await res.json();

      if (!res.ok) throw new Error(JSON.stringify(data));

      currentSha = data.content.sha;
      document.getElementById("status").textContent = "Saved âœ”";
    } catch (err) {
      document.getElementById("status").textContent = "Save failed";
      console.error(err);
    }
  }

  /* Button handlers */
  document.getElementById("add-row").addEventListener("click", () => {
    currentLoans.push(normalizeLoan({}, currentLoans.length));
    renderTable();
  });

  document.getElementById("save-btn").addEventListener("click", saveToBackend);

  /* Row delete handler */
  document
    .getElementById("loan-table")
    .addEventListener("click", (e) => {
      if (e.target.matches("[data-action='delete']")) {
        const row = e.target.closest("tr");
        const idx = Array.from(row.parentNode.children).indexOf(row);
        currentLoans.splice(idx, 1);
        renderTable();
      }
    });

  loadFromBackend();
</script>

</body>
</html>
