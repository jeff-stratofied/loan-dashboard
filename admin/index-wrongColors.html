<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Admin</title>

  <style>
    body {
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
      margin: 0;
      padding: 20px;
      background: #0f172a;
      color: #e2e8f0;
    }
    h1 { margin-top: 0; }
    .btn {
      padding: 6px 12px;
      background: #334155;
      color: #e2e8f0;
      border: 1px solid #475569;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 6px;
    }
    .btn:hover {
      background: #475569;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background: #1e293b;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #334155;
      text-align: left;
    }
    th {
      background: #334155;
      font-weight: 600;
    }
    tr:hover td {
      background: #283547;
    }
    input, select {
      background: #283547;
      color: #e2e8f0;
      border: 1px solid #475569;
      border-radius: 4px;
      padding: 4px 6px;
      width: 100%;
    }
    .actions button {
      background: #ef4444;
      border-color: #b91c1c;
    }
    .actions button:hover {
      background: #dc2626;
    }
    .status {
      margin-top: 10px;
      font-size: 14px;
      color: #fca5a5;
    }
  </style>
</head>

<body>
<h1>Loan Admin</h1>
<p>Edit the loans that power your ROI, Earnings, and Amort dashboards.<br>
Data is stored in <code>data/loans.json</code> in the <code>loan-dashboard</code> repo.</p>

<button class="btn" id="addLoanBtn">+ Add Loan</button>
<button class="btn" id="saveChangesBtn">ðŸ’¾ Save Changes</button>
<span class="status" id="statusMsg"></span>

<table id="loanTable">
<thead>
  <tr>
    <th>ID</th>
    <th>Loan Name</th>
    <th>School</th>
    <th>Loan Start Date</th>
    <th>Purchase Date</th>
    <th>Orig Loan Amt</th>
    <th>Purchase Price</th>
    <th>Rate</th>
    <th>Term (yrs)</th>
    <th>Grace (yrs)</th>
    <th>Actions</th>
  </tr>
</thead>
<tbody></tbody>
</table>

<script type="module">
  import { loadLoans } from "/loan-dashboard/js/loadLoans.js";

  let currentLoans = [];
  let currentSha = null;

  const schoolOptions = [
    "Penn State", "Ohio State", "Pitt", "Carnegie Mellon",
    "Michigan", "UCLA", "USC", "NYU"
  ];

  function normalizeLoan(l, idx) {
    return {
      loanId: l.loanId ?? (idx + 1),
      loanName: l.loanName ?? `Loan ${l.loanId ?? (idx + 1)}`,
      school: l.school ?? "Select schoolâ€¦",
      loanStartDate: l.loanStartDate ?? l.purchaseDate ?? "",
      purchaseDate: l.purchaseDate ?? "",
      origLoanAmt: Number(l.origLoanAmt ?? l.principal ?? 0),
      purchasePrice: Number(l.purchasePrice ?? 0),
      rate: Number(l.rate ?? 0),
      termYears: Number(l.termYears ?? 10),
      graceYears: Number(l.graceYears ?? 0)
    };
  }

  function renderTable() {
    const tbody = document.querySelector("#loanTable tbody");
    tbody.innerHTML = "";

    currentLoans.forEach(loan => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${loan.loanId}</td>

        <td><input type="text" value="${loan.loanName}" data-field="loanName"></td>

        <td>
          <select data-field="school">
            ${schoolOptions.map(s => 
              `<option value="${s}" ${loan.school === s ? "selected" : ""}>${s}</option>`
            ).join("")}
          </select>
        </td>

        <td><input type="date" value="${loan.loanStartDate}" data-field="loanStartDate"></td>
        <td><input type="date" value="${loan.purchaseDate}" data-field="purchaseDate"></td>

        <td><input type="number" step="0.01" class="cell-number" value="${loan.origLoanAmt}" data-field="origLoanAmt"></td>
        <td><input type="number" step="0.01" class="cell-number" value="${loan.purchasePrice}" data-field="purchasePrice"></td>

        <td><input type="number" step="0.0001" class="cell-number" value="${loan.rate}" data-field="rate"></td>
        <td><input type="number" step="1" class="cell-number" value="${loan.termYears}" data-field="termYears"></td>
        <td><input type="number" step="0.1" class="cell-number" value="${loan.graceYears}" data-field="graceYears"></td>

        <td class="actions">
          <button data-action="delete">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function collectLoansFromTable() {
    const rows = Array.from(document.querySelectorAll("#loanTable tbody tr"));
    const loans = [];

    rows.forEach((row, i) => {
      const inputs = row.querySelectorAll("input, select");
      const loan = {};

      inputs.forEach(inp => {
        const key = inp.getAttribute("data-field");
        let v = inp.value;

        if (["loanId", "origLoanAmt", "purchasePrice", "rate", "termYears", "graceYears"].includes(key)) {
          v = Number(v);
        }

        loan[key] = v;
      });

      loan.loanId = i + 1;
      loans.push(loan);
    });

    return loans;
  }

  async function loadFromBackend() {
    document.getElementById("statusMsg").textContent = "Loadingâ€¦";

    try {
      const data = await fetch("https://loan-dashboard-api.jeff-263.workers.dev/loans")
        .then(r => r.json());

      currentLoans = data.loans.map(normalizeLoan);
      currentSha = data.sha;

      renderTable();
      document.getElementById("statusMsg").textContent = "Loaded.";
    } catch (err) {
      document.getElementById("statusMsg").textContent = "Failed to load.";
      console.error(err);
    }
  }

  async function saveToBackend() {
    const updatedLoans = collectLoansFromTable();

    document.getElementById("statusMsg").textContent = "Savingâ€¦";

    try {
      const res = await fetch("https://loan-dashboard-api.jeff-263.workers.dev/loans", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          loans: updatedLoans,
          sha: currentSha
        })
      });

      const data = await res.json();

      if (!res.ok) throw new Error(JSON.stringify(data));

      currentSha = data.content.sha;
      document.getElementById("statusMsg").textContent = "Saved.";
    } catch (err) {
      document.getElementById("statusMsg").textContent = "Save failed.";
      console.error("Save error", err);
    }
  }

  document.getElementById("addLoanBtn").addEventListener("click", () => {
    currentLoans.push(normalizeLoan({}, currentLoans.length));
    renderTable();
  });

  document.getElementById("saveChangesBtn").addEventListener("click", saveToBackend);

  document.querySelector("#loanTable").addEventListener("click", e => {
    if (e.target.dataset.action === "delete") {
      const row = e.target.closest("tr");
      const idx = Array.from(row.parentNode.children).indexOf(row);
      currentLoans.splice(idx, 1);
      renderTable();
    }
  });

  loadFromBackend();
</script>

</body>
</html>
