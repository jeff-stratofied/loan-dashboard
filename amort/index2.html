<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio â€” Amortization</title>

  <style>
    :root {
     --bg:#f0f4f8;
     --surface:#f1f5f9;
     --card:#ffffff;
     --text:#0f172a;
     --muted:#64748b;
     --border:#e2e8f0;
     --shadow:rgba(0,0,0,0.08);
     --brand:#0ea5e9;
     --brand-strong:#0284c7;
     --accent1:#7c3aed;
     --accent2:#0ea5e9;
     --accent3:#14b8a6;
     --accent4:#f97316;
     --accent5:#ef4444;
    --stat-bg:#f8fafc;
    --stat-border:#e2e8f0;
    --grad-top:var(--surface);
    --grad-bottom:var(--card);
    --font-smooth:antialiased;
    --tile-bg:var(--card);
    --tile-hover-bg:#f8fafc;
    --drawer-bg:var(--card);
    --drawer-shadow:rgba(0,0,0,0.10);
    --tooltip-bg:#0f172a;     /* solid black tooltip */
    --tooltip-text:#f8fafc;   /* white text */
    --table-header: var(--surface);
      --chart-bg: linear-gradient(180deg, #ffffff, #fcfeff);
  }
    
    html { color-scheme:light; }

      html[data-theme="dark"] {
      color-scheme: dark;

      --bg:#0f172a;
      --surface:#1e293b;
      --card:#1e293b;
      --text:#f1f5f9;
      --muted:#94a3b8;
      --border:#334155;
      --shadow:rgba(0,0,0,0.45);

      --stat-bg:#1e293b;
      --stat-border:#334155;

      --grad-top:#1e293b;
      --grad-bottom:#0f172a;

      --tile-bg:#1e293b;
      --tile-hover-bg:#243447;

      --drawer-bg:#1e293b;
      --drawer-shadow:rgba(0,0,0,0.55);

      --table-header:#1e293b;
      --table-stripe:rgba(255,255,255,0.02);

      --tooltip-bg:#0f172a;
      --tooltip-text:#f8fafc;
        --tooltip-text:#f8fafc;
    }


    html,body{
      height:100%;
      margin:0;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }

    body {
      background: linear-gradient(180deg, var(--grad-top) 0%, var(--grad-bottom) 100%);
      background-color: var(--bg);
      -webkit-font-smoothing: var(--font-smooth);
      transition: background-color .25s ease, color .25s ease;
    }

    
    html[data-theme="dark"] body { background:linear-gradient(180deg,#0b1224 0%, #0f172a 100%); }

    .app{
      max-width:1200px;
      margin:20px auto 0 auto;   /* remove extra bottom margin */
      padding:16px 16px 0 16px;  /* remove extra bottom padding */
      transition:color .25s ease;
    }

     body > .app {
      background: transparent;
      padding-top: 16px;  /* match earnings exactly */
      margin-top: 0;
    }

    header{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:8px;   /* match earnings */
      padding:0;            /* remove invisible offset */
      transition:color .25s ease;
    }

    .header-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .header-controls{display:flex;gap:10px;align-items:center}

    h1{ font-size:20px; margin:0; }
    p.lead{ margin:0; color:var(--muted); font-size:13px; }
    .current-date{ font-size:13px; color:var(--muted); margin-top:4px; }

    /* KPI row */
    .kpis{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
      margin:14px 0 18px;
    }
    .kpi{
      background:var(--card);
      padding:12px;
      border-radius:10px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      cursor:pointer;
      transition: transform .18s, box-shadow .18s, background-color .25s ease, color .25s ease, border-color .25s ease;
    }
    .kpi:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }

    .kpi h3{ margin:0; font-size:12px; color:var(--muted) }
    .kpi p{ margin:8px 0 0; font-size:18px; font-weight:700 }

    /* Grid of tiles */
    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
      height:calc(100vh - 320px);
      overflow:auto;
      padding-right:6px;
    }

/* Loan filter row */
.loan-filters {
  display:flex;
  gap:10px;
  align-items:center;
  margin:0 0 14px;
  flex-wrap:wrap;
}

.loan-filters select {
  padding:6px 10px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  font-size:13px;
}

/* Reset button â€” match ROI */
.reset-btn {
  background:var(--surface);
  border:1px solid var(--border);
  color:var(--muted);
  font-weight:600;
}

/* Compact toggle */
.compact-toggle {
  display:flex;
  align-items:center;
  gap:6px;
  font-size:13px;
  color:var(--muted);
}

/* Compact tiles */
.grid.compact .tile {
  min-height:64px;
  padding:8px 10px;
}

.grid.compact .loan-sub,
.grid.compact .loan-meta,
.grid.compact .chart-wrap svg {
  display:none;
}

/* ðŸ”‘ IMPORTANT: prevent tile stretching (same as ROI/Earnings) */
.grid {
  grid-auto-rows: min-content;
}

    
    @media(max-width:900px){
      .grid{ grid-template-columns:1fr; height:auto }
      .kpis{ grid-template-columns:repeat(2,1fr) }
    }

    .tile{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-radius:12px;
      background:var(--card);
      min-height:110px;
      cursor:pointer;
      overflow:hidden;
      border:1px solid var(--border);
      transition: transform .18s ease, box-shadow .18s ease, background-color .25s ease, color .25s ease, border-color .25s ease;
    }
    .tile:hover{ transform:translateY(-6px); box-shadow:var(--shadow) }

    .tile-left{ flex:1; padding-right:10px }
    .loan-name{ font-weight:700; font-size:14px }
    .loan-sub{ font-size:12px; color:var(--muted); margin-top:6px }
    .loan-meta{ display:flex; gap:8px; font-size:12px; color:var(--muted); margin-top:8px }

    .chart-wrap{ width:170px; flex-shrink:0; display:flex; flex-direction:column; align-items:flex-end }
    .mini-label{ font-size:12px; color:var(--muted); margin-bottom:6px }
    svg.sparkline{ width:170px; height:48px; display:block }

    /* Drawer */
    .drawer{
      position:fixed;
      right:0;
      top:0;
      height:100vh;
      width:560px;
      background:var(--card);
      box-shadow:-28px 0 80px rgba(2,6,23,0.14);
      transform:translateX(110%);
      transition:transform .28s cubic-bezier(.2,.9,.3,1), background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
      z-index:90;
      overflow:hidden;
      padding:0;
      border-left:1px solid var(--border);
      display:flex;
      flex-direction:column;
    }
    .drawer.open{ transform:translateX(0) }

    .drawer-head{ display:flex; align-items:start; justify-content:space-between; gap:8px }
    .close-btn{
      background:#f1f5f9;
      border:none;
      padding:8px;
      border-radius:8px;
      cursor:pointer;
      transition:background-color .25s ease, color .25s ease;
    }
    .drawer h2{
      margin:0 0 4px;
      font-size:20px;
      font-weight:600;
      letter-spacing:-0.01em; /* âœ… ROI match */
    }

    .muted{
    color:var(--muted);
    font-size:13px;
    line-height:1.25;
    margin-bottom:6px;
  }


    .drawer-body,
    #drawerBody{ flex:1 1 auto; overflow-y:auto; overflow-x:hidden; padding:0 20px 20px; }

    .drawer,
    .drawer-body,
    #drawerBody{ overflow-x:hidden; }

    .drawer-footer{
      flex-shrink:0;
      padding:20px;
      background:var(--surface);          /* âœ… same gray as ROI */
      border-top:1px solid var(--border); /* âœ… visual anchor */
    }

    .drawer-footer .actions{ justify-content:flex-start; }

    .drawer-chart{
      height:220px;
      background:var(--chart-bg);
      border-radius:8px;
      border:1px solid rgba(15,23,42,0.03);
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:8px;
      position:relative;
      padding:8px;
      box-shadow:0 6px 18px rgba(15,23,42,0.06);
      transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
    }

/* =========================================
   KPI table hover â€” ONLY interactive KPIs
   (KPI 2 + KPI 4)
========================================= */
.drawer.kpi-interactive #drawerExtra table tbody:hover tr {
  opacity: 0.45;
}

.drawer.kpi-interactive #drawerExtra table tbody tr:hover {
  opacity: 1;
  background: rgba(148, 163, 184, 0.12);
  cursor: pointer;
}

    /* ============================================
   DRAWER HEADER â€” MATCH ROI / EARNINGS EXACTLY
   ============================================ */

.drawer-header {
  padding: 0;              /* remove extra wrapper spacing */
  background: transparent; /* let drawer-head control chrome */
  border: none;
}

.drawer-head {
  padding: 20px;                 /* EXACT match */
  background: var(--card);
  border-bottom: 1px solid var(--border);
  align-items: flex-start;
}

    
    .legend { display:flex; gap:10px; font-size:12px; align-items:center; margin-top:6px; }
    .legend .item { display:flex; gap:6px; align-items:center; }
    .legend .sw { width:12px; height:8px; border-radius:2px; display:inline-block; }

    .amort-wrap{
      border:1px solid var(--border);
      border-radius:8px;
      padding:8px;
      max-height:40vh;
      overflow:auto;
      background:var(--card);
      transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
    }

    table{ width:100%; border-collapse:collapse; font-size:13px; transition:color .25s ease; }
    thead th{
      position:sticky; top:0; background:var(--table-header);
      padding:8px; text-align:left; color:var(--muted); font-weight:700; border-bottom:1px solid var(--border);
      transition:background-color .25s ease, color .25s ease, border-color .25s ease;
    }
    td{ padding:8px; border-bottom:1px dashed rgba(15,23,42,0.04); text-align:right; transition:color .25s ease, border-color .25s ease; }
  
    td:first-child, th:first-child{ text-align:left }

    .actions{ display:flex; gap:8px; margin-top:12px }
    .btn{ padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); background:transparent; cursor:pointer; font-weight:600; transition:background-color .25s ease, color .25s ease, border-color .25s ease; }
    .btn.primary{ background:linear-gradient(90deg,var(--brand),var(--accent2)); color:white; border:none; box-shadow:var(--shadow); }

    .tooltip{
      position:fixed;
      pointer-events:none;
      background:var(--tooltip-bg);
      color:var(--tooltip-text);
      padding:6px 8px;
      border-radius:6px;
      font-size:12px;
      transform:translate(-50%,-120%);
      box-shadow:0 6px 18px rgba(2,6,23,0.2);
      display:none;
      z-index:9999;
      line-height:1.12;
      border:1px solid rgba(148,163,184,0.3);
      transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
    }

    .small { font-size:12px; color:var(--muted) }

    @media(max-width:760px){ .drawer{ width:100%; min-width:0; } }

    /* Theme toggle */
    .theme-icon{
    background:var(--card);
    border:1px solid var(--border);
    font-size:18px;
    cursor:pointer;
    transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease, transform .2s ease;
    width:38px;
    height:38px;
    border-radius:10px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    box-shadow:var(--shadow);
    }
    .theme-icon:hover{
    opacity:0.95;
    transform:translateY(-1px);
    }

        
    /* Dark mode overrides */
html[data-theme="dark"] .tile,
html[data-theme="dark"] .kpi,
html[data-theme="dark"] .amort-wrap {
  background:var(--card);
  border-color:var(--border);
  box-shadow:0 10px 30px rgba(0,0,0,0.35);
}

html[data-theme="dark"] .drawer {
  background:var(--drawer-bg);
  border-left:1px solid var(--border);
  box-shadow:-28px 0 80px var(--drawer-shadow);
}

html[data-theme="dark"] thead th {
  background:var(--surface);
  border-bottom:1px solid var(--border);
  color:var(--text);
}

html[data-theme="dark"] td {
  border-bottom:1px dashed rgba(148,163,184,0.24);
}

html[data-theme="dark"] .tooltip {
  background:var(--tooltip-bg);
  color:var(--tooltip-text);
  border-color:rgba(148,163,184,0.35);
  box-shadow:0 12px 30px rgba(0,0,0,0.45);
}

html[data-theme="dark"] .close-btn {
  background:#0f172a;
  color:var(--text);
}
    svg text{ fill:var(--text); transition:fill .25s ease; }

/* ============================================================
   EMBED MODE â€” AMORT (iframe)
   ============================================================ */

.embed-mode body {
  background: var(--bg);
}

.embed-mode .app {
  margin: 0 !important;
  padding: 0 !important;
}

/* Drawer container */
.embed-mode .drawer {
  position: static !important;
  inset: auto !important;
  transform: none !important;

  width: 100% !important;
  max-width: none !important;

  display: flex !important;
  flex-direction: column !important;

  box-shadow: none !important;
  border: none !important;
  border-radius: 0 !important;

  background: var(--card) !important;
  padding-top: 0 !important;
}

/* Header */
.embed-mode .drawer-head {
  padding: 20px !important;
  background: var(--card) !important;
  border-bottom: 1px solid var(--border) !important;
}

/* Body scrolls */
.embed-mode .drawer-body {
  padding: 0 20px 20px !important;
  overflow-y: auto !important;
  flex: 1 1 auto !important;
}

/* Hide embed-only helper text */
.embed-mode .drawer-body .muted {
  display: none !important;
}

/* Ensure chart first */
.embed-mode .drawer-chart {
  order: 0 !important;
}
.embed-mode .drawer-info-row,
.embed-mode .stat-boxes,
.embed-mode #drawerExtra {
  order: 1 !important;
}

/* Footer (anchored + visible) */
.embed-mode .drawer-footer {
  display: block !important;
  flex: 0 0 auto !important;

  padding: 20px !important;
  background: var(--surface) !important;
  border-top: 1px solid var(--border) !important;
}

    .embed-mode .app {
  display: none !important;
}

    
  </style>
</head>

<body>
  <div class="app" role="main">
    <header>
      <div class="header-top">
        <div>
          <h1>Loan Portfolio - Amortization Schedules</h1>
          <p class="lead">Click on the loan below to see & export the amortization schedule.</p>
        </div>
        <div class="header-controls">
          <div style="font-size:13px;color:var(--muted)">Name: <strong id="currentUserLabel" style="color:var(--brand)"></strong>
</div>
          <button id="themeToggle" class="theme-icon" title="Toggle dark mode">ðŸŒ™</button>
        </div>
      </div>

      <div class="current-date" id="currentDateLabel">Current Date: </div>
    </header>

    <section class="kpis" id="kpis"></section>

<!-- Loan Filters / Sort -->
<section class="loan-filters" id="loanFilters">
  <select id="filterName">
    <option value="">All loans</option>
  </select>

  <select id="filterSchool">
    <option value="">All schools</option>
  </select>

  <select id="filterRate">
    <option value="">All interest rates</option>
    <option value="low">Below 5%</option>
    <option value="mid">5% â€“ 8%</option>
    <option value="high">Above 8%</option>
  </select>

  <select id="sortLoans">
    <option value="purchase_asc">Purchase date â†‘</option>
    <option value="purchase_desc">Purchase date â†“</option>
    <option value="amount_asc">Orig amount â†‘</option>
    <option value="amount_desc">Orig amount â†“</option>
    <option value="rate_asc">Interest rate â†‘</option>
    <option value="rate_desc">Interest rate â†“</option>
  </select>

  <label class="compact-toggle">
    <input type="checkbox" id="toggleCompact" checked />
    <span>Compact</span>
  </label>

  <button class="btn reset-btn" id="resetFilters">Reset filters</button>
</section>

    
    <section class="grid" id="loanGrid" aria-live="polite"></section>
  </div>

  <!-- Right drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <div class="drawer-head">
        <div>
          <h2 id="drawerTitle">Drawer</h2>
          <div class="muted" id="drawerSub">details</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="downloadCsvBtn">Download CSV</button>
          <button class="close-btn" id="closeBtn" aria-label="Close drawer">âœ•</button>
        </div>
      </div>
    </div>

    <div id="drawerBody" class="drawer-body">
      <div class="drawer-chart" id="drawerChartArea"></div>
      <div class="legend" id="drawerLegend" style="display:none"></div>

      <div style="display:flex;gap:10px;margin-bottom:8px">
        <div style="flex:1;background:var(--surface);padding:10px;border-radius:8px;border:1px solid var(--border)">
          <div style="font-size:12px;color:var(--muted)" id="drawerPrimaryTitle">Purchase Price</div>
          <div id="drawerPrimary" style="font-weight:800;font-size:18px"></div>
        </div>
        <div style="width:120px;background:var(--surface);padding:10px;border-radius:8px;border:1px solid var(--border)">
          <div style="font-size:12px;color:var(--muted)" id="drawerSecondaryTitle">Rate</div>
          <div id="drawerSecondary" style="font-weight:800;font-size:16px"></div>
        </div>
      </div>

      <div id="drawerExtra"></div>

      <div id="drawerAmortContainer">
        <h3 style="margin-top:8px">Amortization</h3>
        <!-- Purchase marker note -->
        <div class="small" style="margin:4px 0 8px 0;">
          <span style="
            display:inline-block;
            width:10px;
            height:2px;
            background:#22c55e;
            vertical-align:middle;
            margin-right:6px;
          "></span>
          Green line indicates the month the loan was purchased
        </div>
        <div class="amort-wrap" id="amortWrap">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Payment</th><th>Principal</th><th>Interest</th><th>Balance</th>
              </tr>
            </thead>
            <tbody id="amortBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="drawer-footer">
      <div class="actions">
        <button class="btn" id="printBtn">Print</button>
        <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
      </div>
    </div>
  </aside>

  <div id="tooltip" class="tooltip" role="status" aria-live="polite"></div>

  <script type="module">
import { loadLoans } from "../js/loadLoans.js";
import { attachSchedules } from "../js/loanEngine.js";
import { normalizeLoan } from "../js/normalizeLoan.js";

let currentLoans = [];
let allLoans = [];
let apiLoans = [];
let cachedKPIs = null;

let currentLoan = null;
let currentMode = null;

let tpvSeriesData = [];
let USE_DYNAMIC_DATA = true;

const params = new URLSearchParams(window.location.search);
const userParam = params.get("user") || "jeff";
const isEmbed = params.get("embed") === "true";
const openParam = params.get("open");
const loanIdParam = Number(params.get("loanId")) || null;

if (isEmbed) {
  document.body.classList.add('embed-mode');
}

const PAGE_USER =
  new URLSearchParams(window.location.search).get("user") || "jeff";

const USER_LABELS = {
  jeff: "Jeff Customer",
  nick: "Nick Lender",
  john: "John Investor"
};

document.getElementById("currentUserLabel").textContent =
  USER_LABELS[PAGE_USER] || "Unknown User";

const hiddenLoans = new Set();

const drawer = document.getElementById("drawer");
const drawerTitle = document.getElementById("drawerTitle");
const drawerSub = document.getElementById("drawerSub");
const drawerPrimaryTitle = document.getElementById("drawerPrimaryTitle");
const drawerPrimary = document.getElementById("drawerPrimary");
const drawerSecondaryTitle = document.getElementById("drawerSecondaryTitle");
const drawerSecondary = document.getElementById("drawerSecondary");
const drawerChartArea = document.getElementById("drawerChartArea");
const drawerLegend = document.getElementById("drawerLegend");
const drawerAmortContainer = document.getElementById("drawerAmortContainer");
const amortBody = document.getElementById("amortBody");
const drawerExtra = document.getElementById("drawerExtra");
const drawerBody = document.getElementById("drawerBody");
const tooltip = document.querySelector(".tooltip");

let stackedBarGroupCounter = 0;

function prepareStackedBar(bar, groupId, index, isPositive = true){
  bar.setAttribute("data-stack-group", groupId);
  bar.setAttribute("data-stack-index", index);
}

let miniHtmlTooltip = null;
function getMiniHtmlTooltip() {
  if (!miniHtmlTooltip) {
    miniHtmlTooltip = document.createElement("div");
    miniHtmlTooltip.className = "lens-tooltip-html";
    miniHtmlTooltip.style.display = "none";
    document.body.appendChild(miniHtmlTooltip);
  }
  return miniHtmlTooltip;
}

function setMiniTooltipContent(lines) {
  const el = getMiniHtmlTooltip();
  el.innerHTML = lines.join("<br>");
}

function positionMiniTooltip(clientX, clientY, radius) {
  const el = getMiniHtmlTooltip();
  const rect = el.getBoundingClientRect();

  const padding = 12;

  let x = clientX - rect.width / 2;
  let y = clientY - radius - rect.height - 8;

  if (x < padding) {
    x = padding;
  } else if (x + rect.width > window.innerWidth - padding) {
    x = window.innerWidth - rect.width - padding;
  }

  if (y < padding) {
    y = clientY + radius + 8;
  }

  el.style.left = `${x}px`;
  el.style.top  = `${y}px`;
  el.style.display = "block";
}

function hideMiniTooltip() {
  if (miniHtmlTooltip) miniHtmlTooltip.style.display = "none";
}

function formatDate(date) {
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "short",
    day: "numeric"
  });
}

async function init() {
  apiLoans = await loadLoans();
  allLoans = (apiLoans.loans || [])
    .map(normalizeLoan)
    .filter(l => l.user === PAGE_USER);

  currentLoans = allLoans;

  attachSchedules(currentLoans);

  currentLoans.sort((a, b) => {
    const da = new Date(a.purchaseDate).getTime() || 0;
    const db = new Date(b.purchaseDate).getTime() || 0;
    return da - db;
  });

  buildKpiColorMap(currentLoans);

  cachedKPIs = computeKPIs(currentLoans);

  renderKpiTiles(cachedKPIs);

  const nameSelect = document.getElementById("filterName");
  const schoolSelect = document.getElementById("filterSchool");

  nameSelect.querySelectorAll("option:not(:first-child)").forEach(o => o.remove());
  schoolSelect.querySelectorAll("option:not(:first-child)").forEach(o => o.remove());

  const uniqueNames = [...new Set(
    currentLoans.map(l => l.loanName).filter(Boolean)
  )];

  const uniqueSchools = [...new Set(
    currentLoans.map(l => l.school).filter(Boolean)
  )];

  uniqueNames.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name.toLowerCase();
    opt.textContent = name;
    nameSelect.appendChild(opt);
  });

  uniqueSchools.forEach(school => {
    const opt = document.createElement("option");
    opt.value = school.toLowerCase();
    opt.textContent = school;
    schoolSelect.appendChild(opt);
  });

  const filterName = document.getElementById("filterName");
  const filterSchool = document.getElementById("filterSchool");
  const filterRate = document.getElementById("filterRate");
  const sortLoans = document.getElementById("sortLoans");
  const resetBtn = document.getElementById("resetFilters");
  const compactToggle = document.getElementById("toggleCompact");
  const loanGrid = document.getElementById("loanGrid");

  filterName.addEventListener("change", applyLoanFilters);
  filterSchool.addEventListener("change", applyLoanFilters);
  filterRate.addEventListener("change", applyLoanFilters);

  sortLoans.addEventListener("change", applyLoanSort);

  resetBtn.addEventListener("click", () => {
    filterName.value = "";
    filterSchool.value = "";
    filterRate.value = "";
    applyLoanFilters();
  });

  const savedCompact = localStorage.getItem("loanGridCompact");
  if (savedCompact !== null) {
    compactToggle.checked = savedCompact === "true";
  }

  loanGrid.classList.toggle("compact", compactToggle.checked);

  compactToggle.addEventListener("change", () => {
    loanGrid.classList.toggle("compact", compactToggle.checked);
    localStorage.setItem("loanGridCompact", compactToggle.checked);
  });

  renderLoanTiles(currentLoans);

  if (openParam === "tpv") {
    renderTpvDrawer();
  } else if (openParam === "rates") {
    renderRatesDrawer();
  } else if (openParam === "payments") {
    renderPaymentsDrawer();
  } else if (openParam === "first" && currentLoans.length) {
    const sorted = currentLoans
      .slice()
      .sort(
        (a, b) =>
          new Date(a.purchaseDate).getTime() -
          new Date(b.purchaseDate).getTime()
      );

    const loan = sorted[0];
    currentLoan = loan;
    requestAnimationFrame(() => openDrawerForLoan(loan));

    if (isEmbed) {
      drawer.style.display = "flex";
      drawer.classList.add("open");
      drawer.setAttribute("aria-hidden", "false");
    }
  } else if (openParam === "loan" && loanIdParam) {
    const loan = currentLoans.find(
      l => (l.loanId ?? l.id) === loanIdParam
    );

    if (loan) {
      currentLoan = loan;
      requestAnimationFrame(() => openDrawerForLoan(loan));

      if (isEmbed) {
        drawer.style.display = "flex";
        drawer.classList.add("open");
        drawer.setAttribute("aria-hidden", "false");
      }
    }
  } else if (isEmbed && currentLoans.length && !drawer.classList.contains("open")) {
    const sorted = currentLoans
      .slice()
      .sort(
        (a, b) =>
          new Date(a.purchaseDate).getTime() -
          new Date(b.purchaseDate).getTime()
      );

    const loan = sorted[0];
    currentLoan = loan;

    drawer.style.display = "flex";
    drawer.classList.add("open");
    drawer.setAttribute("aria-hidden", "false");

    requestAnimationFrame(() => openDrawerForLoan(loan));
  }
}

function applyLoanFilters() {
  const nameVal = filterName.value;
  const schoolVal = filterSchool.value;
  const rateVal = filterRate.value;

  document.querySelectorAll("#loanGrid .tile").forEach(tile => {
    let show = true;

    if (nameVal && !tile.dataset.loanName.includes(nameVal)) show = false;
    if (schoolVal && !tile.dataset.school.includes(schoolVal)) show = false;

    if (rateVal) {
      const r = Number(tile.dataset.rate) * 100;
      if (
        (rateVal === "low" && r >= 5) ||
        (rateVal === "mid" && (r < 5 || r > 8)) ||
        (rateVal === "high" && r <= 8)
      ) show = false;
    }

    tile.style.display = show ? "" : "none";
  });

  applyLoanSort();
}

function applyLoanSort() {
  const grid = document.getElementById("loanGrid");
  const mode = sortLoans.value;

  const tiles = Array.from(grid.children)
    .filter(t => t.style.display !== "none");

  const get = (el, k) => Number(el.dataset[k] || 0);

  tiles.sort((a, b) => {
    switch (mode) {
      case "purchase_asc": return get(a,"purchaseDate") - get(b,"purchaseDate");
      case "purchase_desc": return get(b,"purchaseDate") - get(a,"purchaseDate");
      case "amount_asc": return get(a,"amount") - get(b,"amount");
      case "amount_desc": return get(b,"amount") - get(a,"amount");
      case "rate_asc": return get(a,"rate") - get(b,"rate");
      case "rate_desc": return get(b,"rate") - get(a,"rate");
      default: return 0;
    }
  });

  tiles.forEach(t => grid.appendChild(t));
}

function renderLoanTiles(loans) {
  const grid = document.getElementById("loanGrid");
  grid.innerHTML = "";

  loans.forEach(loan => {
    const hasSchedule = loan.amort && loan.amort.schedule && loan.amort.schedule.length > 0;
    const lastIdx = hasSchedule ? loan.amort.schedule.length - 1 : 0;
    const fallbackRow = { balance: loan.purchasePrice || 0, monthIndex: 0 };
    const currentIdx = Math.max(0, Math.min(loan.monthsSinceStart - 1, lastIdx));
    const atCurrent = hasSchedule
      ? loan.amort.schedule[currentIdx] || loan.amort.schedule[lastIdx]
      : fallbackRow;

    const tile = document.createElement("div");
    tile.className = "tile";
    tile.dataset.loanName = (loan.loanName || "").toLowerCase();
    tile.dataset.school = (loan.school || "").toLowerCase();
    tile.dataset.rate = loan.nominalRate;
    tile.dataset.purchaseDate = new Date(loan.purchaseDate).getTime();
    tile.dataset.amount = Number(loan.purchasePrice || 0);

    tile.innerHTML = `
      <div class="tile-left">
        <!-- Line 1: Loan Name -->
        <div class="loan-name" style="font-weight:700; font-size:14px;">
          ${loan.loanName}
        </div>

        <!-- Line 2: School -->
        <div class="loan-name" style="font-weight:700; font-size:14px; margin-top:2px;">
          ${loan.school || "No school listed"}
        </div>

        <!-- Line 3: Rate Â· Term Â· Matures -->
        <div class="loan-sub" style="margin-top:6px;">
          Rate: ${(loan.nominalRate * 100).toFixed(2)}% &nbsp;Â·&nbsp;
          Term: ${loan.termYears} yrs &nbsp;Â·&nbsp;
          Matures: ${formatMonthYear(addMonths(new Date(loan.loanStartDate), loan.termYears * 12))}
        </div>

        <!-- Line 4: Loan ID -->
        <div class="loan-sub" style="margin-top:4px;">
          Loan ${loan.loanId}
        </div>
      </div>

      <div class="chart-wrap">
        <div class="mini-label">
          Balance: $${atCurrent.balance.toFixed(0)}
        </div>
        <div class="mini-chart"></div>
      </div>
    `;

    grid.appendChild(tile);

    tile.addEventListener("click", () => openDrawerForLoan(loan));

    const mini = tile.querySelector('.mini-chart');
    createMiniAmortChart(mini, loan);
  });
}

function openDrawerForLoan(loan) {
  currentMode = 'loan';
  currentLoan = loan;

  drawer.classList.remove('kpi-interactive');

  drawerTitle.textContent = loan.loanName;

  drawerSub.innerHTML = `
    <div>${loan.school}</div>
    <div>
      Purchased ${loan.purchaseDate}
      â€¢ Orig Loan Amt ${formatCurrency(loan.purchasePrice)}
    </div>
  `;

  drawerPrimaryTitle.textContent = "Purchase Price";
  drawerPrimary.textContent = `$${loan.purchasePrice.toLocaleString()}`;
  drawerSecondaryTitle.textContent = "Rate";
  drawerSecondary.textContent = `${(loan.nominalRate * 100).toFixed(2)}%`;

  drawerChartArea.innerHTML = "";
  drawerLegend.style.display = "flex";
  drawerLegend.innerHTML = `
    <div class="item">
      <div class="sw" style="background:#0ea5e9"></div>
      Principal
    </div>
    <div class="item">
      <div class="sw" style="background:#22c55e"></div>
      Interest
    </div>
  `;

  createDrawerStackedChart(
    drawerChartArea,
    loan.amort?.schedule || [],
    loan
  );

  drawerAmortContainer.style.display = "block";

  let rowsHtml = "";
  (loan.amort?.schedule || []).forEach(r => {
    rowsHtml += `
      <tr ${r.monthIndex === loan.monthsSinceStart ? 'style="border-top:2px solid #22c55e"' : ''}>
        <td>${r.monthIndex}</td>
        <td>$${r.payment.toFixed(2)}</td>
        <td>$${r.principalPaid.toFixed(2)}</td>
        <td>$${r.interest.toFixed(2)}</td>
        <td>$${r.balance.toFixed(2)}</td>
      </tr>
    `;
  });

  amortBody.innerHTML = rowsHtml;

  drawerExtra.innerHTML = "";

  openDrawer();
}

function closeDrawer() {
  drawer.classList.remove("open");
  drawer.setAttribute("aria-hidden", "true");
  currentLoan = null;
  currentMode = null;
}

document.addEventListener("click", function (e) {
  if (!drawer.classList.contains("open")) return;

  const clickedInsideDrawer = drawer.contains(e.target);
  const clickedTile = !!e.target.closest(".tile");

  if (!clickedInsideDrawer && !clickedTile) {
    closeDrawer();
  }
});

document.addEventListener("keydown", e => {
  if (e.key === "Escape") closeDrawer();
});

const closeBtn = document.getElementById("closeBtn");
closeBtn.addEventListener("click", closeDrawer);

function formatCurrency(value) {
  if (!Number.isFinite(value)) return "$0.00";
  return "$" + value.toLocaleString("en-US", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

function formatMonthYear(date) {
  return date.toLocaleString("en-US", {
    month: "short",
    year: "numeric"
  });
}

function addMonths(date, months) {
  const d = new Date(date);
  d.setMonth(d.getMonth() + months);
  return d;
}

function monthDiff(d1, d2) {
  let months;
  months = (d2.getFullYear() - d1.getFullYear()) * 12;
  months -= d1.getMonth();
  months += d2.getMonth();
  return months <= 0 ? 0 : months;
}

function buildKpiColorMap(sortedLoans) {
  const map = {};
  sortedLoans.forEach((loan, idx) => {
    map[loan.loanId] = KPI_PALETTE[idx % KPI_PALETTE.length];
  });
  window.KPI_COLOR_MAP = map;
}

const KPI_PALETTE = [
  "#2563eb",
  "#dc2626",
  "#16a34a",
  "#7c3aed",
  "#ea580c",
  "#0891b2",
  "#9333ea",
  "#15803d",
  "#b91c1c",
  "#1e40af",
  "#c2410c",
  "#0f766e"
];

function computeKPIs(loans) {
  let totalPurchase = 0;
  let totalBalance = 0;
  let avgRate = 0;
  let avgTerm = 0;
  let count = loans.length;

  loans.forEach(l => {
    totalPurchase += Number(l.purchasePrice || 0);

    const hasSchedule = l.amort && l.amort.schedule && l.amort.schedule.length > 0;
    const lastIdx = hasSchedule ? l.amort.schedule.length - 1 : 0;
    const fallbackRow = { balance: l.purchasePrice || 0 };
    const currentIdx = Math.max(0, Math.min(l.monthsSinceStart - 1, lastIdx));
    const atCurrent = hasSchedule
      ? l.amort.schedule[currentIdx] || l.amort.schedule[lastIdx]
      : fallbackRow;

    totalBalance += Number(atCurrent.balance || 0);
    avgRate += Number(l.nominalRate || 0);
    avgTerm += Number(l.termYears || 0);
  });

  avgRate = count > 0 ? avgRate / count : 0;
  avgTerm = count > 0 ? avgTerm / count : 0;

  return {
    totalPurchase,
    totalBalance,
    avgRate,
    avgTerm,
    count
  };
}

function renderKpiTiles(kpis) {
  const kpisEl = document.getElementById("kpis");
  kpisEl.innerHTML = "";

  const tiles = [
    {
      id: "tpv",
      title: "Total Portfolio Value",
      value: formatCurrency(kpis.totalPurchase)
    },
    {
      id: "rates",
      title: "Average Interest Rate",
      value: `${(kpis.avgRate * 100).toFixed(2)}%`
    },
    {
      id: "payments",
      title: "Average Term",
      value: `${kpis.avgTerm.toFixed(1)} years`
    },
    {
      id: "count",
      title: "Number of Loans",
      value: kpis.count
    }
  ];

  tiles.forEach(tile => {
    const el = document.createElement("div");
    el.className = "kpi";
    el.dataset.kpi = tile.id;
    el.innerHTML = `
      <h3>${tile.title}</h3>
      <p>${tile.value}</p>
    `;

    el.addEventListener("click", () => {
      switch (tile.id) {
        case "tpv":
          renderTpvDrawer();
          break;
        case "rates":
          renderRatesDrawer();
          break;
        case "payments":
          renderPaymentsDrawer();
          break;
        default:
          console.warn("Unknown KPI tile:", tile.id);
      }
    });

    kpisEl.appendChild(el);
  });
}

function createMiniAmortChart(containerEl, loan) {
  containerEl.innerHTML = "";
  const svgNS = "http://www.w3.org/2000/svg";
  const w = 170;
  const h = 48;
  const padL = 4, padR = 4, padT = 4, padB = 4;

  const data = loan.amort && loan.amort.schedule || [];

  let maxAbs = 0;
  data.forEach(d => {
    const pos = d.principalPaid + d.interest;
    maxAbs = Math.max(maxAbs, pos);
  });
  if (maxAbs <= 0) maxAbs = 1;

  const yZero = h / 2;
  const halfHeight = (h - padT - padB) / 2;
  const scale = halfHeight / maxAbs;

  const count = data.length;
  const barW = (w - padL - padR) / Math.max(1, count);

  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "48");

  const stackedGroupId = `stack-${stackedBarGroupCounter++}`;

  const axis = document.createElementNS(svgNS, "line");
  axis.setAttribute("x1", padL);
  axis.setAttribute("x2", w - padR);
  axis.setAttribute("y1", yZero);
  axis.setAttribute("y2", yZero);
  axis.setAttribute("stroke", "#cbd5e1");
  axis.setAttribute("stroke-width", "0.8");
  svg.appendChild(axis);

  data.forEach((d, i) => {
    const x = padL + i * barW;

    const principal = d.principalPaid;
    const interest = d.interest;

    const hPrin = principal * scale;
    const hInt = interest * scale;

    const yInt = yZero - hInt;
    const yPrin = yZero - hInt - hPrin;

    const barWidth = Math.max(1, barW - 2);

    const rPrin = document.createElementNS(svgNS, "rect");
    rPrin.setAttribute("x", x + 1);
    rPrin.setAttribute("y", yPrin);
    rPrin.setAttribute("width", barWidth);
    rPrin.setAttribute("height", hPrin);
    rPrin.setAttribute("fill", "#0ea5e9");
    prepareStackedBar(rPrin, stackedGroupId, 0, true);

    const rInt = document.createElementNS(svgNS, "rect");
    rInt.setAttribute("x", x + 1);
    rInt.setAttribute("y", yInt);
    rInt.setAttribute("width", barWidth);
    rInt.setAttribute("height", hInt);
    rInt.setAttribute("fill", "#22c55e");
    prepareStackedBar(rInt, stackedGroupId, 1, true);

    svg.appendChild(rPrin);
    svg.appendChild(rInt);
  });

  const loanStart = new Date(loan.loanStartDate);
  const TODAY = new Date();

  const totalMonths = data.length - 1;
  let monthsToToday = monthDiff(loanStart, TODAY);
  if (!Number.isFinite(monthsToToday)) monthsToToday = 0;

  monthsToToday = Math.max(0, Math.min(monthsToToday, totalMonths));

  const ratio = totalMonths > 0 ? (monthsToToday / totalMonths) : 0;
  const currentX = padL + ratio * (w - padL - padR);

  const vline = document.createElementNS(svgNS, "line");
  vline.setAttribute("x1", currentX);
  vline.setAttribute("x2", currentX);
  vline.setAttribute("y1", 0);
  vline.setAttribute("y2", h);
  vline.setAttribute("stroke", "#64748b");
  vline.setAttribute("stroke-dasharray", "4,3");
  vline.setAttribute("stroke-width", "1");
  svg.appendChild(vline);

  containerEl.appendChild(svg);

  let lensInstance = null;
  const lensRadius = 20;
  const lensScale = 2;

  function handleMove(e) {
    const rect = svg.getBoundingClientRect();
    const mouseX = ((e.clientX - rect.left) / rect.width) * w;
    const mouseY = ((e.clientY - rect.top) / rect.height) * h;
    const x = Math.max(lensRadius, Math.min(w - lensRadius, mouseX));
    const y = Math.max(lensRadius, Math.min(h - lensRadius, mouseY));

    if (!lensInstance) {
      lensInstance = createLens(svg, lensRadius, lensScale);
      const barClones = Array.from(svg.querySelectorAll("rect"))
        .filter(r => r.__value !== undefined || r.getAttribute("fill"));
      barClones.forEach(r => lensInstance.content.appendChild(r.cloneNode(true)));
      svg.appendChild(lensInstance.group);
    }

    updateLens(lensInstance, x, y);

    const idx = Math.max(0, Math.min(data.length - 1, Math.floor((x - padL) / barW)));
    const row = data[idx];
    const tooltipDate = addMonths(loanStart, idx);
    const tooltipLines = [
      `Date: ${formatDate(tooltipDate)}`,
      `Principal: $${row.principalPaid.toFixed(2)}`,
      `Interest: $${row.interest.toFixed(2)}`,
      `Payment: $${row.payment.toFixed(2)}`,
      `Balance: $${row.balance.toFixed(2)}`
    ];

    setMiniTooltipContent(tooltipLines);
    positionMiniTooltip(e.clientX, e.clientY, lensRadius);
  }

  function handleLeave() {
    removeLens(svg, lensInstance);
    lensInstance = null;
    hideMiniTooltip();
  }

  svg.addEventListener("mousemove", handleMove);
  svg.addEventListener("mouseleave", handleLeave);
}

function createDrawerStackedChart(containerEl, data, loan) {
  containerEl.innerHTML = "";
  const svgNS = "http://www.w3.org/2000/svg";
  const rect = containerEl.getBoundingClientRect();
  const w = Math.max(360, rect.width || 700);
  const h = 220;
  const padL = 50, padR = 20, padT = 20, padB = 16;

  let maxValue = 0;
  data.forEach(d => {
    const pos = d.principalPaid + d.interest;
    maxValue = Math.max(maxValue, pos);
  });

  const yMax = Math.max(maxValue, 1);
  const yMin = 0;
  const yRange = yMax - yMin || 1;
  const usableHeight = h - padT - padB;
  const scale = usableHeight / yRange;
  const yZero = padT + (yMax / yRange) * usableHeight;

  const count = data.length;
  const barW = (w - padL - padR) / Math.max(1, count);

  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");

  const gridAboveZero = 4;

  for (let gy = 0; gy <= gridAboveZero; gy++) {
    const y = yZero - gy * ((yZero - padT) / gridAboveZero);

    const gridLine = document.createElementNS(svgNS, "line");
    gridLine.setAttribute("x1", padL);
    gridLine.setAttribute("x2", w - padR);
    gridLine.setAttribute("y1", y);
    gridLine.setAttribute("y2", y);
    gridLine.setAttribute("stroke", "var(--grid-light)");
    gridLine.setAttribute("stroke-width", "0.7");
    svg.appendChild(gridLine);

    const lbl = document.createElementNS(svgNS, "text");
    const value = (yMax / gridAboveZero) * gy;
    lbl.textContent = "$" + Math.round(value).toLocaleString();
    lbl.setAttribute("x", padL - 10);
    lbl.setAttribute("y", y + 4);
    lbl.setAttribute("font-size", "11");
    lbl.setAttribute("fill", "var(--text)");
    lbl.setAttribute("text-anchor", "end");
    svg.appendChild(lbl);
  }

  const axis = document.createElementNS(svgNS, "line");
  axis.setAttribute("x1", padL);
  axis.setAttribute("x2", w - padR);
  axis.setAttribute("y1", yZero);
  axis.setAttribute("y2", yZero);
  axis.setAttribute("stroke", "var(--grid-strong)");
  axis.setAttribute("stroke-width", "1");
  svg.appendChild(axis);

  data.forEach((d, i) => {
    const stackedGroupId = `stack-drawer-${d.monthIndex || i}`;
    const x = padL + i * barW;

    const principal = d.principalPaid;
    const interest = d.interest;

    const hPrin = principal * scale;
    const hInt = interest * scale;

    const yInt = yZero - hInt;
    const yPrin = yZero - hInt - hPrin;

    const barWidth = Math.max(2, barW - 4);

    const rPrin = document.createElementNS(svgNS, "rect");
    rPrin.setAttribute("x", x + 2);
    rPrin.setAttribute("y", yPrin);
    rPrin.setAttribute("width", barWidth);
    rPrin.setAttribute("height", hPrin);
    rPrin.setAttribute("fill", "#0ea5e9");
    prepareStackedBar(rPrin, stackedGroupId, 0, true);

    const rInt = document.createElementNS(svgNS, "rect");
    rInt.setAttribute("x", x + 2);
    rInt.setAttribute("y", yInt);
    rInt.setAttribute("width", barWidth);
    rInt.setAttribute("height", hInt);
    rInt.setAttribute("fill", "#22c55e");
    prepareStackedBar(rInt, stackedGroupId, 1, true);

    svg.appendChild(rPrin);
    svg.appendChild(rInt);

    if (d.monthIndex % 12 === 0 || d.monthIndex === 1) {
      const lbl = document.createElementNS(svgNS, "text");
      const dateLabel = addMonths(new Date(loan.loanStartDate), d.monthIndex - 1);
      lbl.textContent = formatMonthYear(dateLabel);
      lbl.setAttribute("x", x + barWidth / 2);
      lbl.setAttribute("y", h - padB + 16);
      lbl.setAttribute("font-size", "11");
      lbl.setAttribute("fill", "var(--text)");
      lbl.setAttribute("text-anchor", "middle");
      svg.appendChild(lbl);
    }
  });

  const loanStart = new Date(loan.loanStartDate);
  const TODAY = new Date();

  const totalMonths = data.length - 1;
  let monthsToToday = monthDiff(loanStart, TODAY);
  if (!Number.isFinite(monthsToToday)) monthsToToday = 0;

  monthsToToday = Math.max(0, Math.min(monthsToToday, totalMonths));

  const ratio = totalMonths > 0 ? (monthsToToday / totalMonths) : 0;
  const currentX = padL + ratio * (w - padL - padR);

  const vline = document.createElementNS(svgNS, "line");
  vline.setAttribute("x1", currentX);
  vline.setAttribute("x2", currentX);
  vline.setAttribute("y1", 0);
  vline.setAttribute("y2", h);
  vline.setAttribute("stroke", "#64748b");
  vline.setAttribute("stroke-dasharray", "4,3");
  vline.setAttribute("stroke-width", "1");
  svg.appendChild(vline);

  containerEl.appendChild(svg);

  let lensInstance = null;
  let tooltipInstance = null;
  const lensRadius = 40;
  const lensScale = 1.5;

  function handleMove(e) {
    const rect = svg.getBoundingClientRect();
    const mouseX = ((e.clientX - rect.left) / rect.width) * w;
    const mouseY = ((e.clientY - rect.top) / rect.height) * h;
    const x = Math.max(lensRadius, Math.min(w - lensRadius, mouseX));
    const y = Math.max(lensRadius, Math.min(h - lensRadius, mouseY));

    if (!lensInstance) {
      lensInstance = createLens(svg, lensRadius, lensScale);
      const barClones = Array.from(svg.querySelectorAll("rect"))
        .filter(r => r.__value !== undefined || r.getAttribute("fill"));
      barClones.forEach(r => lensInstance.content.appendChild(r.cloneNode(true)));
      svg.appendChild(lensInstance.group);
    }

    if (!tooltipInstance) {
      tooltipInstance = createTooltip(svg, true);
    }

    updateLens(lensInstance, x, y);

    const idx = Math.max(0, Math.min(data.length - 1, Math.floor((x - padL) / barW)));
    const row = data[idx];
    const tooltipDate = addMonths(loanStart, idx);
    const tooltipLines = [
      `${loan.loanName} â€¢ ${formatDate(tooltipDate)}`,
      `Principal: $${row.principalPaid.toFixed(2)}`,
      `Interest: $${row.interest.toFixed(2)}`,
      `Payment: $${row.payment.toFixed(2)}`,
      `Balance: $${row.balance.toFixed(2)}`
    ];

    updateTooltipContent(tooltipInstance, tooltipLines, true);
    updateTooltipPosition(tooltipInstance, x, y, lensRadius);
  }

  function handleLeave() {
    removeLens(svg, lensInstance);
    lensInstance = null;
    if (tooltipInstance) {
      tooltipInstance.group.remove();
      tooltipInstance = null;
    }
  }

  svg.addEventListener("mousemove", handleMove);
  svg.addEventListener("mouseleave", handleLeave);
}

function renderTpvDrawer() {
  currentMode = 'kpi';
  currentLoan = null;

  drawer.classList.add('kpi-interactive');

  drawerTitle.textContent = "Total Portfolio Value";
  drawerSub.textContent = "Total purchase price of all loans";

  drawerPrimaryTitle.textContent = "Total Portfolio Value";
  drawerPrimary.textContent = formatCurrency(cachedKPIs.totalPurchase);
  drawerSecondaryTitle.textContent = "Total Balance";
  drawerSecondary.textContent = formatCurrency(cachedKPIs.totalBalance);

  drawerChartArea.innerHTML = "";
  drawerLegend.style.display = "none";
  drawerExtra.innerHTML = "";

  const activeLoans = currentLoans.filter(l => !hiddenLoans.has(l.loanId));

  const series = buildTpvSeries(activeLoans);

  renderTpvLineChart(drawerChartArea, series);

  drawerExtra.innerHTML = `<div class="amort-wrap" id="drawerKpiTable"></div>`;
  renderTpvTable(activeLoans, "drawerKpiTable");

  openDrawer();
}

function buildTpvSeries(loans) {
  const rows = buildPortfolioAmortRows(loans);
  if (!rows.length) return [];

  const start = new Date(rows[0].date);
  start.setDate(1);

  const end = new Date();
  end.setDate(1);

  let cumulativeBalance = 0;
  let monthsElapsed = 0;

  const series = [];

  const cursor = new Date(start);
  while (cursor <= end) {
    const ym = `${cursor.getFullYear()}-${cursor.getMonth()}`;

    const row = rows.find(r => {
      const d = new Date(r.date);
      return d.getFullYear() === cursor.getFullYear() &&
             d.getMonth() === cursor.getMonth();
    });

    if (row) {
      const monthBalance = row.contributions.reduce(
        (s, c) => s + (Number(c.monthlyBalance) || 0),
        0
      );
      cumulativeBalance += monthBalance;
    }

    monthsElapsed += 1;

    series.push({
      date: new Date(cursor),
      balance: cumulativeBalance
    });

    cursor.setMonth(cursor.getMonth() + 1);
  }

  return series;
}

function renderTpvLineChart(container, rows) {
  container.innerHTML = "";
  if (!rows || !rows.length) return;

  const svgNS = "http://www.w3.org/2000/svg";
  const w = container.clientWidth || 700;
  const h = container.clientHeight || 220;

  const padL = 60, padR = 20, padT = 20, padB = 52;

  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");

  const values = rows.map(r => Number(r.balance) || 0);
  const maxVal = niceAxisMax(Math.max(...values));
  const minVal = 0;

  const usableH = h - padT - padB;
  const usableW = w - padL - padR;
  const scaleY = usableH / (maxVal - minVal || 1);
  const stepX = usableW / Math.max(1, rows.length - 1);

  for (let i = 0; i <= 4; i++) {
    const y = padT + i * (usableH / 4);
    const val = maxVal - (maxVal * i / 4);

    const line = document.createElementNS(svgNS, "line");
    line.setAttribute("x1", padL);
    line.setAttribute("x2", w - padR);
    line.setAttribute("y1", y);
    line.setAttribute("y2", y);
    line.setAttribute("stroke", "var(--grid-light)");
    svg.appendChild(line);

    const txt = document.createElementNS(svgNS, "text");
    txt.textContent = formatCurrency(val);
    txt.setAttribute("x", padL - 8);
    txt.setAttribute("y", y + 4);
    txt.setAttribute("font-size", "11");
    txt.setAttribute("text-anchor", "end");
    txt.setAttribute("fill", "var(--text)");
    svg.appendChild(txt);
  }

  let d = "";
  rows.forEach((r, i) => {
    const x = padL + i * stepX;
    const y = padT + (maxVal - r.balance) * scaleY;
    d += i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`;
  });

  const path = document.createElementNS(svgNS, "path");
  path.setAttribute("d", d);
  path.setAttribute("fill", "none");
  path.setAttribute("stroke", "var(--brand)");
  path.setAttribute("stroke-width", "3");
  svg.appendChild(path);

  const xAxisY = h - padB + 18;
  const labelEvery = Math.max(1, Math.floor(rows.length / 6));

  for (let i = 0; i < rows.length; i += labelEvery) {
    const x = padL + i * stepX;

    const lbl = document.createElementNS(svgNS, "text");
    lbl.textContent = formatMonthYear(rows[i].date);
    lbl.setAttribute("x", x);
    lbl.setAttribute("y", xAxisY);
    lbl.setAttribute("font-size", "11");
    lbl.setAttribute("fill", "var(--muted)");
    lbl.setAttribute("text-anchor", "middle");
    svg.appendChild(lbl);
  }

  const vLine = document.createElementNS(svgNS, "line");
  vLine.setAttribute("y1", padT);
  vLine.setAttribute("y2", h - padB);
  vLine.setAttribute("stroke", "var(--text)");
  vLine.setAttribute("stroke-dasharray", "3 4");
  vLine.setAttribute("stroke-opacity", "0");
  svg.appendChild(vLine);

  const dot = document.createElementNS(svgNS, "circle");
  dot.setAttribute("r", "5");
  dot.setAttribute("fill", "var(--brand)");
  dot.setAttribute("stroke", "white");
  dot.setAttribute("stroke-width", "2");
  dot.setAttribute("opacity", "0");
  svg.appendChild(dot);

  container.appendChild(svg);

  function idxFromClientX(clientX) {
    const rect = svg.getBoundingClientRect();
    const x = ((clientX - rect.left) / rect.width) * w;
    return Math.max(0, Math.min(rows.length - 1, Math.round((x - padL) / stepX)));
  }

  function handleMove(e) {
    const idx = idxFromClientX(e.clientX);
    const r = rows[idx];

    const x = padL + idx * stepX;
    const y = padT + (maxVal - r.balance) * scaleY;

    vLine.setAttribute("x1", x);
    vLine.setAttribute("x2", x);
    vLine.setAttribute("stroke-opacity", "0.8");

    dot.setAttribute("cx", x);
    dot.setAttribute("cy", y);
    dot.setAttribute("opacity", "1");

    setMiniTooltipContent([
      `Date: ${formatMonthYear(r.date)}`,
      `Balance: ${formatCurrency(r.balance)}`
    ]);
    positionMiniTooltip(e.clientX, e.clientY, 40);
  }

  function handleLeave() {
    vLine.setAttribute("stroke-opacity", "0");
    dot.setAttribute("opacity", "0");
    hideMiniTooltip();
  }

  svg.addEventListener("mousemove", handleMove);
  svg.addEventListener("mouseleave", handleLeave);
}

function renderTpvTable(data, containerId = "drawerKpiTable") {
  const rows = data
    .map(l => {
      const { row: atCur } = getCurrentAmortRow(l);
      if (!atCur) return null;

      const color = window.KPI_COLOR_MAP?.[l.loanId] || "#64748b";

      return {
        loanId: l.loanId,
        cells: [
          `<div
            class="loan-swatch"
            data-loan-id="${l.loanId}"
            title="Toggle loan"
            style="
              width:10px;
              height:10px;
              border-radius:2px;
              background:${color};
              margin:4px auto;
              cursor:pointer;
            "
          ></div>`,

          `<div style="line-height:1.15">
            <div style="font-weight:600;color:${color}">
              ${l.loanName}
            </div>
            <div style="font-size:12px;color:${color}">
              ${l.school || ""}
            </div>
          </div>`,

          `<span style="color:var(--text)">${formatCurrency(atCur.balance)}</span>`,
          `<span style="color:var(--text)">${formatCurrency(l.purchasePrice)}</span>`,
          `<span style="color:var(--text)">${l.purchaseDate}</span>`
        ]
      };
    })
    .filter(Boolean);

  renderKpiTable(
    containerId,
    ["Loan On/Off", "Loan", "Current Balance", "Purchase Price", "Purchase Date"],
    rows
  );

  const table = document.getElementById(containerId);
  if (!table) return;

  table.classList.add("tpv-table");

  const chartRects = () =>
    document.querySelectorAll("#drawerChartArea svg rect[data-loan-id]");

  const setChartHighlight = (loanId) => {
    chartRects().forEach(r => {
      r.style.opacity = (r.dataset.loanId === loanId) ? "1" : "0.15";
    });
  };

  const clearChartHighlight = () => {
    chartRects().forEach(r => {
      r.style.opacity = "";
    });
  };

  const setRowHighlight = (loanId) => {
    table.querySelectorAll("tbody tr[data-loan-id]").forEach(tr => {
      tr.classList.toggle("dimmed", tr.dataset.loanId !== loanId);
    });
  };

  const clearRowHighlight = () => {
    table.querySelectorAll("tbody tr[data-loan-id]").forEach(tr => {
      tr.classList.remove("dimmed");
    });
  };

  table.querySelectorAll("tbody tr[data-loan-id]").forEach(tr => {
    const loanId = tr.dataset.loanId;

    tr.addEventListener("mouseenter", () => {
      setRowHighlight(loanId);
      setChartHighlight(loanId);
    });

    tr.addEventListener("mouseleave", () => {
      clearRowHighlight();
      clearChartHighlight();
    });
  });

  table.querySelectorAll(".loan-swatch").forEach(sw => {
    const loanId = sw.dataset.loanId;

    if (hiddenLoans.has(loanId)) sw.style.opacity = "0.25";

    sw.addEventListener("click", (e) => {
      e.stopPropagation();

      if (hiddenLoans.has(loanId)) {
        hiddenLoans.delete(loanId);
        sw.style.opacity = "1";
      } else {
        hiddenLoans.add(loanId);
        sw.style.opacity = "0.25";
      }

      renderTpvDrawer();
    });
  });
}

function renderRatesDrawer() {
  currentMode = 'kpi';
  currentLoan = null;

  drawer.classList.add('kpi-interactive');

  drawerTitle.textContent = "Average Interest Rate";
  drawerSub.textContent = "Weighted average rate across all loans";

  drawerPrimaryTitle.textContent = "Average Rate";
  drawerPrimary.textContent = `${(cachedKPIs.avgRate * 100).toFixed(2)}%`;
  drawerSecondaryTitle.textContent = "Number of Loans";
  drawerSecondary.textContent = cachedKPIs.count;

  drawerChartArea.innerHTML = "";
  drawerLegend.style.display = "none";
  drawerExtra.innerHTML = "";

  const activeLoans = currentLoans.filter(l => !hiddenLoans.has(l.loanId));

  const rates = activeLoans.map(l => l.nominalRate * 100);

  const minRate = Math.min(...rates);
  const maxRate = Math.max(...rates);

  const bins = 5;
  const width = (maxRate - minRate) / bins || 1;

  const binLoans = Array.from({ length: bins }, () => []);

  activeLoans.forEach(l => {
    const r = l.nominalRate * 100;
    let idx = Math.floor((r - minRate) / Math.max(0.0001, width));
    idx = Math.max(0, Math.min(bins - 1, idx));
    binLoans[idx].push(l);
  });

  const svgNS = 'http://www.w3.org/2000/svg';
  const w = 480, h = 220, pad = 30;

  const svg = document.createElementNS(svgNS, 'svg');
  svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
  svg.setAttribute('width', '100%');
  svg.setAttribute('height', '100%');

  const yAxis = document.createElementNS(svgNS, 'line');
  yAxis.setAttribute('x1', pad);
  yAxis.setAttribute('x2', pad);
  yAxis.setAttribute('y1', pad);
  yAxis.setAttribute('y2', h - pad);
  yAxis.setAttribute('stroke', '#cbd5e1');
  svg.appendChild(yAxis);

  const xAxis = document.createElementNS(svgNS, 'line');
  xAxis.setAttribute('x1', pad);
  xAxis.setAttribute('x2', w - pad);
  xAxis.setAttribute('y1', h - pad);
  xAxis.setAttribute('y2', h - pad);
  xAxis.setAttribute('stroke', '#cbd5e1');
  svg.appendChild(xAxis);

  const maxCount = Math.max(...binLoans.map(b => b.length), 1);

  for (let i = 0; i < bins; i++) {
    const loansInBin = binLoans[i];
    if (!loansInBin.length) continue;

    const barW = (w - pad * 2) / bins * 0.7;
    const gap = ((w - pad * 2) / bins - barW) / 2;
    const x = pad + i * ((w - pad * 2) / bins) + gap;

    let yCursor = h - pad;
    const unitH = (h - pad * 2) / maxCount;

    loansInBin.forEach(l => {
      yCursor -= unitH;

      const rect = document.createElementNS(svgNS, 'rect');
      rect.setAttribute('x', x);
      rect.setAttribute('y', yCursor);
      rect.setAttribute('width', barW);
      rect.setAttribute('height', unitH);
      rect.setAttribute(
        'fill',
        window.KPI_COLOR_MAP?.[l.loanId] || '#64748b'
      );
      rect.setAttribute('data-loan-id', l.loanId);

      rect.addEventListener('mousemove', ev => {
        tooltip.style.display = 'block';
        tooltip.style.left = ev.clientX + 'px';
        tooltip.style.top = (ev.clientY - 12) + 'px';
        tooltip.innerHTML =
          `${l.loanName}<br>${(l.nominalRate * 100).toFixed(2)}%`;
      });

      rect.addEventListener('mouseleave', () => {
        tooltip.style.display = 'none';
      });

      svg.appendChild(rect);
    });

    const label =
      `${(minRate + i * width).toFixed(2)}â€“${(minRate + (i + 1) * width).toFixed(2)}`;
    const text = document.createElementNS(svgNS, 'text');
    text.setAttribute('x', x + barW / 2);
    text.setAttribute('y', h - pad + 14);
    text.setAttribute('font-size', '11');
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('fill', '#475569');
    text.textContent = label;
    svg.appendChild(text);
  }

  drawerChartArea.appendChild(svg);

  const sorted = activeLoans
    .slice()
    .sort((a, b) => b.nominalRate - a.nominalRate);

  drawerExtra.innerHTML = `
    <div style="margin-top:10px">
      <strong class="small">Loans sorted by rate</strong>
      <div style="
        max-height:45vh;
        overflow:auto;
        margin-top:6px;
        border-radius:6px;
        padding:6px;
        border:1px solid var(--border);
        background:var(--card)
      ">
        <table class="kpi2-table" style="width:100%; font-size:13px">
          <thead>
            <tr>
              <th></th>
              <th>Loan</th>
              <th>Rate</th>
              <th>Purchase</th>
              <th style="text-align:right">Balance</th>
            </tr>
          </thead>
          <tbody>
            ${sorted.map(l => `
              <tr
                data-loan-id="${l.loanId}"
                style="--loan-color:${window.KPI_COLOR_MAP?.[l.loanId] || 'var(--text)'}"
              >
                <td>
                  <span style="
                    display:inline-block;
                    width:10px;
                    height:10px;
                    border-radius:2px;
                    background:var(--loan-color);
                  "></span>
                </td>

                <td style="text-align:left;">
                  <div style="font-weight:700;">${l.loanName}</div>
                  <div style="font-size:12px; color:var(--muted); margin-top:2px;">
                    ${l.school || ''}
                  </div>
                </td>

                <td style="color:var(--loan-color); font-weight:600;">
                  ${(l.nominalRate * 100).toFixed(2)}%
                </td>

                <td>${l.purchaseDate}</td>
                <td style="text-align:right;">
                  $${l.purchasePrice.toLocaleString()}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;

  document
    .querySelectorAll('.kpi2-table tbody tr')
    .forEach(tr => {
      const loanId = tr.dataset.loanId;

      tr.addEventListener('mouseenter', () => {
        document
          .querySelectorAll('#drawerChartArea rect[data-loan-id]')
          .forEach(rect => {
            rect.style.opacity =
              rect.dataset.loanId === loanId ? '1' : '0.15';
          });
      });

      tr.addEventListener('mouseleave', () => {
        document
          .querySelectorAll('#drawerChartArea rect[data-loan-id]')
          .forEach(rect => {
            rect.style.opacity = '1';
          });
      });
    });

  openDrawer();
}

function renderPaymentsDrawer() {
  currentMode = 'kpi';
  currentLoan = null;

  drawer.classList.remove('kpi-interactive');

  drawerTitle.textContent = 'Total Expected Payments (monthly)';
  drawerSub.textContent = 'Sum of scheduled payments across loans';

  let loansForSeries = currentLoans.length ? currentLoans : allLoans;

  loansForSeries = loansForSeries.filter(l => l.loanStartDate && l.amort && l.amort.schedule && l.amort.schedule.length > 0);

  if (!loansForSeries.length) {
    console.warn('Payments drawer: no valid loans with schedules');
    drawerChartArea.innerHTML = `<div style="color:var(--muted);font-size:13px">No valid loan data available</div>`;
    return;
  }

  drawerSecondaryTitle.textContent = 'Total Invested';
  drawerSecondary.textContent =
    `$${loansForSeries.reduce((s, l) => s + (l.purchasePrice || 0), 0).toLocaleString()}`;

  drawerAmortContainer.style.display = 'none';
  drawerLegend.style.display = 'none';
  drawerExtra.innerHTML = '';
  drawerChartArea.innerHTML = '';

  const toMonthStart = d => {
    const x = new Date(d);
    x.setDate(1);
    x.setHours(0, 0, 0, 0);
    return x;
  };

  const starts = loansForSeries
    .map(l => l.loanStartDate)
    .filter(Boolean)
    .map(d => toMonthStart(d));

  const ends = loansForSeries
    .map(l => {
      const d = toMonthStart(l.loanStartDate);
      d.setMonth(d.getMonth() + l.amort.schedule.length - 1);
      return d;
    });

  if (!starts.length || !ends.length) {
    console.warn('Payments drawer: no month range computed', loansForSeries);
    drawerChartArea.innerHTML = `<div style="color:var(--muted);font-size:13px">No month range data available</div>`;
    return;
  }

  const minDate = new Date(Math.min(...starts));
  const maxDate = new Date(Math.max(...ends));

  const months = [];
  const cursor = new Date(minDate);
  while (cursor <= maxDate) {
    months.push(cursor.toISOString().slice(0, 7));
    cursor.setMonth(cursor.getMonth() + 1);
  }

  const today = toMonthStart(new Date());
  const todayStr = today.toISOString().slice(0, 7);

  let todayIndex = months.indexOf(todayStr);
  if (todayIndex === -1) {
    todayIndex = today < minDate ? 0 : months.length - 1;
  }

  const ymToDate = ym => new Date(ym + '-01T00:00:00');
  const monthOffset = (a, b) =>
    (a.getFullYear() - b.getFullYear()) * 12 +
    (a.getMonth() - b.getMonth());

  const paymentsByMonth = months.map(ym => {
    const globalMonth = ymToDate(ym);

    return loansForSeries.reduce((sum, loan) => {
      const start = toMonthStart(loan.loanStartDate);
      const off = monthOffset(globalMonth, start);
      if (off < 0 || off >= loan.amort.schedule.length) return sum;

      return sum + (loan.amort.schedule[off]?.payment || 0);
    }, 0);
  });

  const currentMonthlyIncome = paymentsByMonth[todayIndex] || 0;

  drawerPrimaryTitle.textContent = 'Current Monthly Income';
  drawerPrimary.textContent =
    `$${currentMonthlyIncome.toLocaleString(undefined, {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    })}`;

  const svgNS = 'http://www.w3.org/2000/svg';
  const w = 480, h = 220, pad = 36;
  const svg = document.createElementNS(svgNS, 'svg');

  svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
  svg.setAttribute('width', '100%');
  svg.setAttribute('height', '100%');

  const maxV = Math.max(...paymentsByMonth, 1);
  const stepX = (w - pad * 2) / Math.max(1, months.length - 1);

  for (let i = 0; i <= 5; i++) {
    const v = (maxV / 5) * i;
    const y = pad + (h - pad * 2) * (1 - v / maxV);

    const line = document.createElementNS(svgNS, 'line');
    line.setAttribute('x1', pad);
    line.setAttribute('x2', w - pad);
    line.setAttribute('y1', y);
    line.setAttribute('y2', y);
    line.setAttribute('stroke', 'var(--grid-light)');
    svg.appendChild(line);

    const label = document.createElementNS(svgNS, 'text');
    label.setAttribute('x', pad - 6);
    label.setAttribute('y', y + 4);
    label.setAttribute('text-anchor', 'end');
    label.setAttribute('font-size', '11');
    label.textContent = `$${Math.round(v).toLocaleString()}`;
    svg.appendChild(label);
  }

  const poly = document.createElementNS(svgNS, 'polyline');
  poly.setAttribute(
    'points',
    paymentsByMonth
      .map((v, i) => {
        const x = pad + i * stepX;
        const y = pad + (h - pad * 2) * (1 - v / maxV);
        return `${x},${y}`;
      })
      .join(' ')
  );
  poly.setAttribute('fill', 'none');
  poly.setAttribute('stroke', '#fb7185');
  poly.setAttribute('stroke-width', '2');
  svg.appendChild(poly);

  const todayX = pad + todayIndex * stepX;

  const todayLine = document.createElementNS(svgNS, 'line');
  todayLine.setAttribute('x1', todayX);
  todayLine.setAttribute('x2', todayX);
  todayLine.setAttribute('y1', pad);
  todayLine.setAttribute('y2', h - pad);
  todayLine.setAttribute('stroke', '#111827');
  todayLine.setAttribute('stroke-dasharray', '3 4');
  todayLine.setAttribute('stroke-opacity', '0.6');

  svg.appendChild(todayLine);

  months.forEach((ym, i) => {
    if (i % 24 !== 0) return;

    const x = pad + i * stepX;
    const text = document.createElementNS(svgNS, 'text');
    text.setAttribute('x', x);
    text.setAttribute('y', h - pad + 14);
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('font-size', '11');
    text.setAttribute('fill', '#475569');
    text.textContent =
      new Date(ym + '-01').toLocaleDateString(undefined, {
        month: 'short',
        year: 'numeric'
      });

    svg.appendChild(text);
  });

  const hoverLine = document.createElementNS(svgNS, 'line');
  hoverLine.setAttribute('stroke', '#111827');
  hoverLine.setAttribute('stroke-dasharray', '3 4');
  hoverLine.style.opacity = '0';
  svg.appendChild(hoverLine);

  const hoverDot = document.createElementNS(svgNS, 'circle');
  hoverDot.setAttribute('r', 4);
  hoverDot.setAttribute('fill', '#fb7185');
  hoverDot.style.opacity = '0';
  svg.appendChild(hoverDot);

  svg.addEventListener('mousemove', ev => {
    const rect = svg.getBoundingClientRect();
    const x = ((ev.clientX - rect.left) / rect.width) * w;
    const idx = Math.max(0, Math.min(
      months.length - 1,
      Math.round((x - pad) / stepX)
    ));

    const v = paymentsByMonth[idx];
    const cx = pad + idx * stepX;
    const cy = pad + (h - pad * 2) * (1 - v / maxV);

    hoverLine.setAttribute('x1', cx);
    hoverLine.setAttribute('x2', cx);
    hoverLine.setAttribute('y1', pad);
    hoverLine.setAttribute('y2', h - pad);
    hoverLine.style.opacity = '0.6';

    hoverDot.setAttribute('cx', cx);
    hoverDot.setAttribute('cy', cy);
    hoverDot.style.opacity = '1';

    tooltip.style.display = 'block';
    tooltip.style.left = ev.clientX + 'px';
    tooltip.style.top = (ev.clientY - 12) + 'px';
    tooltip.innerHTML =
      `${new Date(months[idx] + '-01').toLocaleDateString(undefined, {
        month: 'short',
        year: 'numeric'
      })}<br>
       Monthly Income $${v.toLocaleString(undefined,{minimumFractionDigits:2})}`;
  });

  svg.addEventListener('mouseleave', () => {
    hoverLine.style.opacity = '0';
    hoverDot.style.opacity = '0';
    tooltip.style.display = 'none';
  });

  drawerChartArea.appendChild(svg);

  drawerExtra.innerHTML = `
    <strong class="small">Monthly expected payments</strong>
    <div style="max-height:45vh;overflow:auto;margin-top:6px;
         border-radius:6px;padding:6px;
         border:1px solid var(--border);background:var(--card)">
      <table style="width:100%;font-size:13px">
        <thead>
          <tr>
            <th>Month</th>
            <th style="text-align:right">Payments</th>
          </tr>
        </thead>
        <tbody>
          ${months.map((m, i) => `
            <tr>
              <td>${new Date(m + '-01').toLocaleDateString(undefined, {
                month: 'short',
                year: 'numeric'
              })}</td>
              <td style="text-align:right">
                $${paymentsByMonth[i].toLocaleString(undefined,{minimumFractionDigits:2})}
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  openDrawer();
}

function amortToCSV(loan) {
  const rows = [['Month', 'Payment', 'Principal', 'Interest', 'Balance']];
  (loan.amort.schedule || []).forEach(r =>
    rows.push([r.monthIndex, r.payment.toFixed(2), r.principalPaid.toFixed(2), r.interest.toFixed(2), r.balance.toFixed(2)])
  );
  return rows.map(r => r.join(',')).join('\n');
}

document.getElementById('copyCsvBtn')?.addEventListener('click', async () => {
  if (currentMode !== 'loan' || !currentLoan) return alert('Open an individual loan drawer to copy CSV');
  const csv = amortToCSV(currentLoan);
  try { await navigator.clipboard.writeText(csv); alert('CSV copied to clipboard'); }
  catch (e) { alert('Copy failed â€” browser denied clipboard access'); }
});

document.getElementById('downloadCsvBtn')?.addEventListener('click', () => {
  if (currentMode === 'loan' && currentLoan) {
    const csv = amortToCSV(currentLoan);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `loan-${currentLoan.loanId}-amort.csv`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  } else {
    alert('Download CSV is supported for individual loan drawers only.');
  }
});

document.getElementById('printBtn')?.addEventListener('click', () => window.print());

document.querySelector('.grid').addEventListener('scroll', () => tooltip.style.display = 'none');

const themeToggleBtn = document.getElementById('themeToggle');
const root = document.documentElement;

function setTheme(mode) {
  root.setAttribute('data-theme', mode);
  if (mode === 'dark') {
    themeToggleBtn.textContent = 'â˜€ï¸';
  } else {
    themeToggleBtn.textContent = 'ðŸŒ™';
  }
  try { localStorage.setItem('amortTheme', mode); } catch (e) {}
}

const stored = (() => { try { return localStorage.getItem('amortTheme'); } catch (e) { return null; } })();
if (stored === 'dark' || (!stored && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
  setTheme('dark');
} else {
  setTheme('light');
}

themeToggleBtn.addEventListener('click', () => {
  const current = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
  setTheme(current === 'dark' ? 'light' : 'dark');
});

document.addEventListener("DOMContentLoaded", async () => {
  const currentDateEl = document.getElementById('currentDateLabel');
  if (currentDateEl) {
    const today = new Date();
    currentDateEl.textContent =
      `Current Date: ${today.toLocaleDateString(undefined, {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      })}`;
  }

  await init();

  if (isEmbed) {
    const user = PAGE_USER || "jeff";
    const baseUrl = `/loan-dashboard/amort/index.html?user=${user}`;

    function redirectToFullPage() {
      let url = baseUrl;

      if (currentLoan && (currentLoan.loanId || currentLoan.id)) {
        url += `&open=loan&id=${currentLoan.loanId ?? currentLoan.id}`;
      } else {
        url += `&open=first`;
      }

      window.top.location.href = url;
    }

    document.addEventListener(
      "click",
      (e) => {
        if (e.target.closest("button, select, a, input, textarea")) return;
        redirectToFullPage();
      },
      true
    );

    ["closeBtn", "printBtn", "copyCsvBtn", "downloadCsvBtn"].forEach(id => {
      const btn = document.getElementById(id);
      if (btn) btn.addEventListener("click", redirectToFullPage, true);
    });
  }
});

function getCurrentAmortRow(loan) {
  const sched = loan.amort?.schedule || [];

  if (!sched.length || !loan.loanStartDate) {
    return { row: { balance: loan.purchasePrice || 0 }, idx: 0 };
  }

  const lastIdx = sched.length - 1;

  const loanStart = new Date(loan.loanStartDate);
  const TODAY = new Date();
  const diffRaw = monthDiff(loanStart, TODAY);
  const diff = Number.isFinite(diffRaw) ? Math.max(1, diffRaw) : 1;

  const idx = Math.max(0, Math.min(diff - 1, lastIdx));
  return { row: sched[idx], idx };
}

function buildPortfolioAmortRows(loans) {
  const monthly = new Map();

  loans.forEach(loan => {
    if (!loan.loanStartDate || !loan.amort || !loan.amort.schedule) return;

    loan.amort.schedule.forEach(r => {
      const d = addMonths(new Date(loan.loanStartDate), r.monthIndex - 1);
      d.setHours(0, 0, 0, 0);

      const key = `${d.getFullYear()}-${d.getMonth()}`;

      if (!monthly.has(key)) {
        monthly.set(key, {
          date: d,
          contributions: []
        });
      }

      monthly.get(key).contributions.push({
        loanId: loan.loanId,
        monthlyBalance: r.balance,
        hasData: true
      });
    });
  });

  const sorted = [...monthly.values()].sort((a, b) => a.date - b.date);

  const allLoanIds = loans.map(l => l.loanId);

  for (let i = 0; i < sorted.length; i++) {
    const row = sorted[i];
    const present = new Set(row.contributions.map(c => c.loanId));

    allLoanIds.forEach(id => {
      if (present.has(id)) return;

      let last = { monthlyBalance: 0 };

      for (let j = i - 1; j >= 0; j--) {
        const prev = sorted[j].contributions.find(c => c.loanId === id);
        if (prev) {
          last = prev;
          break;
        }
      }

      row.contributions.push({
        loanId: id,
        monthlyBalance: last.monthlyBalance,
        hasData: false
      });
    });
  }

  return sorted;
}

function niceAxisMax(v) {
  const x = Math.max(0, Number(v) || 0);
  if (x <= 0) return 1;

  const exp = Math.floor(Math.log10(x));
  const base = Math.pow(10, exp);
  const f = x / base;

  let nf;
  if (f <= 1) nf = 1;
  else if (f <= 2) nf = 2;
  else if (f <= 5) nf = 5;
  else nf = 10;

  return nf * base;
}

function renderKpiTable(containerId, headers, rows) {
  const container = document.getElementById(containerId);
  if (!container) return;

  const colors = window.KPI_COLOR_MAP || {};

  let html = `<table><thead><tr>`;
  headers.forEach(h => html += `<th>${h}</th>`);
  html += `</tr></thead><tbody>`;

  rows.forEach(r => {
    const color = colors[r.loanId] || "var(--text)";

    html += `
      <tr
        data-loan-id="${r.loanId}"
        style="--loan-color:${color}; color:var(--loan-color)"
      >
    `;

    r.cells.forEach(c => {
      html += `<td>${c}</td>`;
    });

    html += `</tr>`;
  });

  html += `</tbody></table>`;
  container.innerHTML = html;
}

function openDrawer() {
  drawer.classList.add("open");
  drawer.setAttribute("aria-hidden", "false");
  drawerBody.scrollTop = 0;
}

function createLens(svg, radius = 40, scale = 1.5, borderColor = "#94a3b8", borderWidth = 1.5, bgFill = "rgba(255,255,255,0.7)"){
  const svgNS = "http://www.w3.org/2000/svg";
  const defs = svg.querySelector("defs") || (()=>{ const d = document.createElementNS(svgNS,"defs"); svg.insertBefore(d, svg.firstChild); return d; })();
  const clipId = `lens-clip-${Math.random().toString(36).slice(2)}`;
  const clipPath = document.createElementNS(svgNS,"clipPath");
  clipPath.setAttribute("id", clipId);
  const clipCircle = document.createElementNS(svgNS,"circle");
  clipCircle.setAttribute("r", radius);
  clipPath.appendChild(clipCircle);
  defs.appendChild(clipPath);

  const group = document.createElementNS(svgNS,"g");
  group.setAttribute("pointer-events","none");

  const bgCircle = document.createElementNS(svgNS,"circle");
  bgCircle.setAttribute("r", radius);
  bgCircle.setAttribute("fill", bgFill);
  bgCircle.setAttribute("stroke", borderColor);
  bgCircle.setAttribute("stroke-width", borderWidth);
  bgCircle.setAttribute("opacity","0.95");

  const content = document.createElementNS(svgNS,"g");
  content.setAttribute("clip-path", `url(#${clipId})`);

  const outline = document.createElementNS(svgNS,"circle");
  outline.setAttribute("r", radius);
  outline.setAttribute("fill","none");
  outline.setAttribute("stroke", borderColor);
  outline.setAttribute("stroke-width", borderWidth);

  group.appendChild(bgCircle);
  group.appendChild(content);
  group.appendChild(outline);

  return { group, content, outline, bgCircle, clipCircle, clipPath, scale, radius };
}

function updateLens(lens, x, y){
  if(!lens) return;
  const tx = x - x * lens.scale;
  const ty = y - y * lens.scale;
  lens.clipCircle.setAttribute("cx", x);
  lens.clipCircle.setAttribute("cy", y);
  lens.bgCircle.setAttribute("cx", x);
  lens.bgCircle.setAttribute("cy", y);
  lens.outline.setAttribute("cx", x);
  lens.outline.setAttribute("cy", y);
  lens.content.setAttribute("transform", `translate(${tx}, ${ty}) scale(${lens.scale})`);
}

function removeLens(svg, lens){
  if(!lens) return;
  if(lens.group && lens.group.parentNode === svg) svg.removeChild(lens.group);
  if(lens.clipPath && lens.clipPath.parentNode) lens.clipPath.parentNode.removeChild(lens.clipPath);
}

function createTooltip(svg, large = false){
  const svgNS = "http://www.w3.org/2000/svg";
  const group = document.createElementNS(svgNS,"g");
  group.setAttribute("pointer-events","none");
  group.setAttribute("opacity","0.95");

  const rect = document.createElementNS(svgNS,"rect");
  rect.setAttribute("rx", large ? 8 : 6);
  rect.setAttribute("ry", large ? 8 : 6);
  rect.setAttribute("fill","rgba(15,23,42,0.92)");
  rect.setAttribute("stroke","#0ea5e9");
  rect.setAttribute("stroke-width","0.6");

  const textGroup = document.createElementNS(svgNS,"g");
  textGroup.setAttribute("fill","#fff");
  textGroup.setAttribute("font-size", large ? "12" : "11");
  textGroup.setAttribute("font-weight","600");

  group.appendChild(rect);
  group.appendChild(textGroup);
  svg.appendChild(group);

  return { group, rect, textGroup, lines: [], large, width:0, height:0 };
}

function updateTooltipContent(tooltip, lines, large = false){
  if(!tooltip) return;
  tooltip.large = large;
  tooltip.rect.setAttribute("rx", large ? 8 : 6);
  tooltip.rect.setAttribute("ry", large ? 8 : 6);
  tooltip.textGroup.setAttribute("font-size", large ? "12" : "11");
  while(tooltip.lines.length < lines.length){
    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    tooltip.textGroup.appendChild(t);
    tooltip.lines.push(t);
  }
  while(tooltip.lines.length > lines.length){
    const t = tooltip.lines.pop();
    t.remove();
  }

  const lineHeight = large ? 15 : 14;
  let maxWidth = 0;
  tooltip.lines.forEach((t, idx) => {
    t.textContent = lines[idx];
    t.setAttribute("x", 6);
    t.setAttribute("y", 12 + idx * lineHeight);
    maxWidth = Math.max(maxWidth, t.getBBox().width);
  });

  const paddingX = 10;
  const paddingY = 8;
  const width = maxWidth + paddingX * 2;
  const height = lines.length * lineHeight + paddingY;

  tooltip.rect.setAttribute("width", width);
  tooltip.rect.setAttribute("height", height);
  tooltip.rect.setAttribute("x", 0);
  tooltip.rect.setAttribute("y", 0);
  tooltip.width = width;
  tooltip.height = height;
}

function updateTooltipPosition(tooltip, cx, cy, radius){
  if(!tooltip) return;
  const width = tooltip.width || 0;
  const height = tooltip.height || 0;

  let dx = radius * 0.45;
  let dy = -radius * 0.85;

  let tooltipX = cx + dx;
  let tooltipY = cy + dy;
  const minX = cx + 2;
  const maxX = cx + radius - width - 2;
  const maxY = cy - height - 2;
  const circleLimit = radius - 3;

  tooltipX = Math.min(Math.max(tooltipX, minX), maxX);
  tooltipY = Math.min(tooltipY, maxY);

  for(let i = 0; i < 10; i++){
    const corners = [
      {x: tooltipX, y: tooltipY},
      {x: tooltipX + width, y: tooltipY},
      {x: tooltipX, y: tooltipY + height},
      {x: tooltipX + width, y: tooltipY + height}
    ];

    let adjusted = false;

    for(const corner of corners){
      const distance = Math.hypot(corner.x - cx, corner.y - cy);
      if(distance >= circleLimit){
        const push = distance - circleLimit + 0.5;
        const nx = (cx - corner.x) / distance;
        const ny = (cy - corner.y) / distance;
        tooltipX += nx * push;
        tooltipY += ny * push;
        adjusted = true;
      }
    }

    tooltipX = Math.min(Math.max(tooltipX, minX), maxX);
    tooltipY = Math.min(tooltipY, maxY);

    if(!adjusted) break;
  }

  tooltipX = Math.max(tooltipX, cx + 2);
  tooltipY = Math.min(tooltipY, cy - height - 2);

  tooltip.group.setAttribute("transform", `translate(${tooltipX}, ${tooltipY})`);
}
</script>
</body>
</html>
