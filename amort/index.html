<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio â€” Amortization</title>

  <style>
    :root {
     --bg:#f0f4f8;
     --surface:#f1f5f9;
     --card:#ffffff;
     --text:#0f172a;
     --muted:#64748b;
     --border:#e2e8f0;
     --shadow:rgba(0,0,0,0.08);
     --brand:#0ea5e9;
     --brand-strong:#0284c7;
     --accent1:#7c3aed;
     --accent2:#0ea5e9;
     --accent3:#14b8a6;
     --accent4:#f97316;
     --accent5:#ef4444;
    --stat-bg:#f8fafc;
    --stat-border:#e2e8f0;
    --grad-top:var(--surface);
    --grad-bottom:var(--card);
    --font-smooth:antialiased;
    --tile-bg:var(--card);
    --tile-hover-bg:#f8fafc;
    --drawer-bg:var(--card);
    --drawer-shadow:rgba(0,0,0,0.10);
    --tooltip-bg:#0f172a;     /* solid black tooltip */
    --tooltip-text:#f8fafc;   /* white text */
    --table-header: var(--surface);
  }
    
    html { color-scheme:light; }

      html[data-theme="dark"] {
      color-scheme: dark;

      --bg:#0f172a;
      --surface:#1e293b;
      --card:#1e293b;
      --text:#f1f5f9;
      --muted:#94a3b8;
      --border:#334155;
      --shadow:rgba(0,0,0,0.45);

      --stat-bg:#1e293b;
      --stat-border:#334155;

      --grad-top:#1e293b;
      --grad-bottom:#0f172a;

      --tile-bg:#1e293b;
      --tile-hover-bg:#243447;

      --drawer-bg:#1e293b;
      --drawer-shadow:rgba(0,0,0,0.55);

      --table-header:#1e293b;
      --table-stripe:rgba(255,255,255,0.02);

      --tooltip-bg:#0f172a;
      --tooltip-text:#f8fafc;
    }


    html,body{
      height:100%;
      margin:0;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }

    body {
      background: linear-gradient(180deg, var(--grad-top) 0%, var(--grad-bottom) 100%);
      background-color: var(--bg);
      -webkit-font-smoothing: var(--font-smooth);
      transition: background-color .25s ease, color .25s ease;
    }

    
    html[data-theme="dark"] body { background:linear-gradient(180deg,#0b1224 0%, #0f172a 100%); }

    .app{
      max-width:1200px;
      margin:20px auto 0 auto;   /* remove extra bottom margin */
      padding:16px 16px 0 16px;  /* remove extra bottom padding */
      transition:color .25s ease;
    }

     body > .app {
      background: transparent;
      padding-top: 16px;  /* match earnings exactly */
      margin-top: 0;
    }

    header{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:8px;   /* match earnings */
      padding:0;            /* remove invisible offset */
      transition:color .25s ease;
    }

    .header-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .header-controls{display:flex;gap:10px;align-items:center}

    h1{ font-size:20px; margin:0; }
    p.lead{ margin:0; color:var(--muted); font-size:13px; }
    .current-date{ font-size:13px; color:var(--muted); margin-top:4px; }

    /* KPI row */
    .kpis{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
      margin:14px 0 18px;
    }
    .kpi{
      background:var(--card);
      padding:12px;
      border-radius:10px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      cursor:pointer;
      transition: transform .18s, box-shadow .18s, background-color .25s ease, color .25s ease, border-color .25s ease;
    }
    .kpi:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }

    .kpi h3{ margin:0; font-size:12px; color:var(--muted) }
    .kpi p{ margin:8px 0 0; font-size:18px; font-weight:700 }

    /* Grid of tiles */
    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
      height:calc(100vh - 320px);
      overflow:auto;
      padding-right:6px;
    }

/* Loan filter row */
.loan-filters {
  display:flex;
  gap:10px;
  align-items:center;
  margin:0 0 14px;
  flex-wrap:wrap;
}

.loan-filters select {
  padding:6px 10px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  font-size:13px;
}

/* Reset button â€” match ROI */
.reset-btn {
  background:var(--surface);
  border:1px solid var(--border);
  color:var(--muted);
  font-weight:600;
}

/* Compact toggle */
.compact-toggle {
  display:flex;
  align-items:center;
  gap:6px;
  font-size:13px;
  color:var(--muted);
}

/* Compact tiles */
.grid.compact .tile {
  min-height:64px;
  padding:8px 10px;
}

.grid.compact .loan-sub,
.grid.compact .loan-meta,
.grid.compact .chart-wrap svg {
  display:none;
}

/* ðŸ”‘ IMPORTANT: prevent tile stretching (same as ROI/Earnings) */
.grid {
  grid-auto-rows: min-content;
}

    
    @media(max-width:900px){
      .grid{ grid-template-columns:1fr; height:auto }
      .kpis{ grid-template-columns:repeat(2,1fr) }
    }

    .tile{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-radius:12px;
      background:var(--card);
      min-height:110px;
      cursor:pointer;
      overflow:hidden;
      border:1px solid var(--border);
      transition: transform .18s ease, box-shadow .18s ease, background-color .25s ease, color .25s ease, border-color .25s ease;
    }
    .tile:hover{ transform:translateY(-6px); box-shadow:var(--shadow) }

    .tile-left{ flex:1; padding-right:10px }
    .loan-name{ font-weight:700; font-size:14px }
    .loan-sub{ font-size:12px; color:var(--muted); margin-top:6px }
    .loan-meta{ display:flex; gap:8px; font-size:12px; color:var(--muted); margin-top:8px }

    .chart-wrap{ width:170px; flex-shrink:0; display:flex; flex-direction:column; align-items:flex-end }
    .mini-label{ font-size:12px; color:var(--muted); margin-bottom:6px }
    svg.sparkline{ width:170px; height:48px; display:block }

    /* Drawer */
    .drawer{
      position:fixed;
      right:0;
      top:0;
      height:100vh;
      width:560px;
      background:var(--card);
      box-shadow:-28px 0 80px rgba(2,6,23,0.14);
      transform:translateX(110%);
      transition:transform .28s cubic-bezier(.2,.9,.3,1), background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
      z-index:90;
      overflow:hidden;
      padding:0;
      border-left:1px solid var(--border);
      display:flex;
      flex-direction:column;
    }
    .drawer.open{ transform:translateX(0) }

    .drawer-head{ display:flex; align-items:start; justify-content:space-between; gap:8px }
    .close-btn{
      background:#f1f5f9;
      border:none;
      padding:8px;
      border-radius:8px;
      cursor:pointer;
      transition:background-color .25s ease, color .25s ease;
    }
    .drawer h2{
      margin:0 0 4px;
      font-size:20px;
      font-weight:600;
      letter-spacing:-0.01em; /* âœ… ROI match */
    }

    .muted{
    color:var(--muted);
    font-size:13px;
    line-height:1.25;
    margin-bottom:6px;
  }


    .drawer-body,
    #drawerBody{ flex:1 1 auto; overflow-y:auto; overflow-x:hidden; padding:0 20px 20px; }

    .drawer,
    .drawer-body,
    #drawerBody{ overflow-x:hidden; }

    .drawer-footer{
      flex-shrink:0;
      padding:20px;
      background:var(--surface);          /* âœ… same gray as ROI */
      border-top:1px solid var(--border); /* âœ… visual anchor */
    }

    .drawer-footer .actions{ justify-content:flex-start; }

    .drawer-chart{
      height:220px;
      background:var(--chart-bg);
      border-radius:8px;
      border:1px solid rgba(15,23,42,0.03);
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:8px;
      position:relative;
      padding:8px;
      box-shadow:0 6px 18px rgba(15,23,42,0.06);
      transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
    }

/* =========================================
   KPI table hover â€” ONLY interactive KPIs
   (KPI 2 + KPI 4)
========================================= */
.drawer.kpi-interactive #drawerExtra table tbody:hover tr {
  opacity: 0.45;
}

.drawer.kpi-interactive #drawerExtra table tbody tr:hover {
  opacity: 1;
  background: rgba(148, 163, 184, 0.12);
  cursor: pointer;
}

    /* ============================================
   DRAWER HEADER â€” MATCH ROI / EARNINGS EXACTLY
   ============================================ */

.drawer-header {
  padding: 0;              /* remove extra wrapper spacing */
  background: transparent; /* let drawer-head control chrome */
  border: none;
}

.drawer-head {
  padding: 20px;                 /* EXACT match */
  background: var(--card);
  border-bottom: 1px solid var(--border);
  align-items: flex-start;
}

    
    .legend { display:flex; gap:10px; font-size:12px; align-items:center; margin-top:6px; }
    .legend .item { display:flex; gap:6px; align-items:center; }
    .legend .sw { width:12px; height:8px; border-radius:2px; display:inline-block; }

    .amort-wrap{
      border:1px solid var(--border);
      border-radius:8px;
      padding:8px;
      max-height:40vh;
      overflow:auto;
      background:var(--card);
      transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
    }

    table{ width:100%; border-collapse:collapse; font-size:13px; transition:color .25s ease; }
    thead th{
      position:sticky; top:0; background:var(--table-header);
      padding:8px; text-align:left; color:var(--muted); font-weight:700; border-bottom:1px solid var(--border);
      transition:background-color .25s ease, color .25s ease, border-color .25s ease;
    }
    td{ padding:8px; border-bottom:1px dashed rgba(15,23,42,0.04); text-align:right; transition:color .25s ease, border-color .25s ease; }
  
    td:first-child, th:first-child{ text-align:left }

    .actions{ display:flex; gap:8px; margin-top:12px }
    .btn{ padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); background:transparent; cursor:pointer; font-weight:600; transition:background-color .25s ease, color .25s ease, border-color .25s ease; }
    .btn.primary{ background:linear-gradient(90deg,var(--brand),var(--accent2)); color:white; border:none; box-shadow:var(--shadow); }

    .tooltip{
      position:fixed;
      pointer-events:none;
      background:var(--tooltip-bg);
      color:var(--tooltip-text);
      padding:6px 8px;
      border-radius:6px;
      font-size:12px;
      transform:translate(-50%,-120%);
      box-shadow:0 6px 18px rgba(2,6,23,0.2);
      display:none;
      z-index:9999;
      line-height:1.12;
      border:1px solid rgba(148,163,184,0.3);
      transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
    }

    .small { font-size:12px; color:var(--muted) }

    @media(max-width:760px){ .drawer{ width:100%; min-width:0; } }

    /* Theme toggle */
    .theme-icon{
    background:var(--card);
    border:1px solid var(--border);
    font-size:18px;
    cursor:pointer;
    transition:background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease, transform .2s ease;
    width:38px;
    height:38px;
    border-radius:10px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    box-shadow:var(--shadow);
    }
    .theme-icon:hover{
    opacity:0.95;
    transform:translateY(-1px);
    }

    /* Dark mode overrides */
html[data-theme="dark"] .tile,
html[data-theme="dark"] .kpi,
html[data-theme="dark"] .amort-wrap {
  background:var(--card);
  border-color:var(--border);
  box-shadow:0 10px 30px rgba(0,0,0,0.35);
}

html[data-theme="dark"] .drawer {
  background:var(--drawer-bg);
  border-left:1px solid var(--border);
  box-shadow:-28px 0 80px var(--drawer-shadow);
}

html[data-theme="dark"] thead th {
  background:var(--surface);
  border-bottom:1px solid var(--border);
  color:var(--text);
}

html[data-theme="dark"] td {
  border-bottom:1px dashed rgba(148,163,184,0.24);
}

html[data-theme="dark"] .tooltip {
  background:var(--tooltip-bg);
  color:var(--tooltip-text);
  border-color:rgba(148,163,184,0.35);
  box-shadow:0 12px 30px rgba(0,0,0,0.45);
}

html[data-theme="dark"] .close-btn {
  background:#0f172a;
  color:var(--text);
}

    svg text{ fill:var(--text); transition:fill .25s ease; }

/* ============================================================
   EMBED MODE â€” AMORT (Portfolio iframe)
   ============================================================ */

.embed-mode header,
.embed-mode .loan-filters,
.embed-mode .kpis,
.embed-mode #loanGrid {
  display: none !important;
}

/* Drawer should behave like earnings */
.embed-mode .drawer {
  position: static !important;
  inset: auto !important;
  transform: none !important;
  height: 100% !important;
  width: 100% !important;
  max-width: none !important;
  box-shadow: none !important;
  border-left: none !important;
  border-radius: 0 !important;
}

/* ============================================
   EMBED MODE â€” SCROLL BODY, PIN FOOTER
   ============================================ */

/* Drawer is a vertical flex container */
.embed-mode .drawer {
  display: flex !important;
  flex-direction: column !important;
}

/* Only the body scrolls */
.embed-mode .drawer-body {
  flex: 1 1 auto !important;
  overflow-y: auto !important;
  padding-top: 0 !important;
}

/* Footer stays pinned */
.embed-mode .drawer-footer {
  display: block !important;
  flex-shrink: 0 !important;
  background: var(--surface) !important;
  border-top: 1px solid var(--border) !important;
}


    /* Remove top gray bar caused by .app spacing */
.embed-mode .app {
  margin: 0 !important;
  padding: 0 !important;
  max-width: none !important;
}

/* Ensure body background does not bleed */
.embed-mode body {
  background: var(--card) !important;
}



    /* ============================================
   EMBED MODE â€” AMORT (remove top chrome)
   ============================================ */


.embed-mode .drawer {
  padding-top: 0 !important;
}

    
  </style>
</head>

<body>
  <div class="app" role="main">
    <header>
      <div class="header-top">
        <div>
          <h1>Loan Portfolio - Amortization Schedules</h1>
          <p class="lead">Click on the loan below to see & export the amortization schedule.</p>
        </div>
        <div class="header-controls">
          <div style="font-size:13px;color:var(--muted)">Name: <strong id="currentUserLabel" style="color:var(--brand)"></strong>
</div>
          <button id="themeToggle" class="theme-icon" title="Toggle dark mode">ðŸŒ™</button>
        </div>
      </div>

      <div class="current-date" id="currentDateLabel">Current Date: </div>
    </header>

    <section class="kpis" id="kpis"></section>

<!-- Loan Filters / Sort -->
<section class="loan-filters" id="loanFilters">
  <select id="filterName">
    <option value="">All loans</option>
  </select>

  <select id="filterSchool">
    <option value="">All schools</option>
  </select>

  <select id="filterRate">
    <option value="">All interest rates</option>
    <option value="low">Below 5%</option>
    <option value="mid">5% â€“ 8%</option>
    <option value="high">Above 8%</option>
  </select>

  <select id="sortLoans">
    <option value="purchase_asc">Purchase date â†‘</option>
    <option value="purchase_desc">Purchase date â†“</option>
    <option value="amount_asc">Orig amount â†‘</option>
    <option value="amount_desc">Orig amount â†“</option>
    <option value="rate_asc">Interest rate â†‘</option>
    <option value="rate_desc">Interest rate â†“</option>
  </select>

  <label class="compact-toggle">
    <input type="checkbox" id="toggleCompact" checked />
    <span>Compact</span>
  </label>

  <button class="btn reset-btn" id="resetFilters">Reset filters</button>
</section>

    
    <section class="grid" id="loanGrid" aria-live="polite"></section>
  </div>

  <!-- Right drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <div class="drawer-head">
        <div>
          <h2 id="drawerTitle">Drawer</h2>
          <div class="muted" id="drawerSub">details</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="downloadCsvBtn">Download CSV</button>
          <button class="close-btn" id="closeBtn" aria-label="Close drawer">âœ•</button>
        </div>
      </div>
    </div>

    <div id="drawerBody" class="drawer-body">
      <div class="drawer-chart" id="drawerChartArea"></div>
      <div class="legend" id="drawerLegend" style="display:none"></div>

      <div style="display:flex;gap:10px;margin-bottom:8px">
        <div style="flex:1;background:var(--surface);padding:10px;border-radius:8px;border:1px solid var(--border)">
          <div style="font-size:12px;color:var(--muted)" id="drawerPrimaryTitle">Purchase Price</div>
          <div id="drawerPrimary" style="font-weight:800;font-size:18px"></div>
        </div>
        <div style="width:120px;background:var(--surface);padding:10px;border-radius:8px;border:1px solid var(--border)">
          <div style="font-size:12px;color:var(--muted)" id="drawerSecondaryTitle">Rate</div>
          <div id="drawerSecondary" style="font-weight:800;font-size:16px"></div>
        </div>
      </div>

      <div id="drawerExtra"></div>

      <div id="drawerAmortContainer">
        <h3 style="margin-top:8px">Amortization</h3>
        <!-- Purchase marker note -->
        <div class="small" style="margin:4px 0 8px 0;">
          <span style="
            display:inline-block;
            width:10px;
            height:2px;
            background:#22c55e;
            vertical-align:middle;
            margin-right:6px;
          "></span>
          Green line indicates the month the loan was purchased
        </div>
        <div class="amort-wrap" id="amortWrap">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Payment</th><th>Principal</th><th>Interest</th><th>Balance</th>
              </tr>
            </thead>
            <tbody id="amortBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="drawer-footer">
      <div class="actions">
        <button class="btn" id="printBtn">Print</button>
        <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
      </div>
    </div>
  </aside>

  <div id="tooltip" class="tooltip" role="status" aria-live="polite"></div>

<script type="module">
    import { loadLoans } from "../js/loadLoans.js";
    import { attachSchedules } from "../js/loanEngine.js";
    import { normalizeLoan } from "../js/normalizeLoan.js";

    // =====================================================
    // EMBED MODE + AUTO-OPEN LOAN (AMORT)
    // =====================================================
    const params = new URLSearchParams(window.location.search);
    const userParam = params.get("user") || "jeff";
    const isEmbed = params.get("embed") === "true";
    const openParam = params.get("open");
    const loanIdParam = Number(params.get("id"));

    // =====================================================
    // EMBED MODE â€” CLICK â†’ OPEN FULL AMORT PAGE WITH DRAWER
    // (match Earnings behavior exactly)
    // =====================================================
    if (isEmbed) {
      document.addEventListener(
        "click",
        (e) => {
          e.preventDefault();
          e.stopImmediatePropagation();

          // Always resolve the loan deterministically
          const loan =
            currentLoan ||
            currentLoans?.[0] ||
            allLoans?.[0];

          if (!loan) return;

          const loanId = loan.loanId ?? loan.id;
          if (!Number.isFinite(loanId)) return;

          const user =
            new URLSearchParams(window.location.search).get("user") || "jeff";

          window.top.location.href =
            `/loan-dashboard/amort/index.html` +
            `?user=${encodeURIComponent(user)}` +
            `&open=loan&id=${loanId}`;
        },
        true // CAPTURE â€” must beat all drawer handlers
      );
    }

    function isEmbedMode() {
      return new URLSearchParams(window.location.search).get("embed") === "true";
    }

    const PAGE_USER =
      new URLSearchParams(window.location.search).get("user") || "jeff";

    let currentLoans = [];

    const USER_LABELS = {
      jeff: "Jeff Customer",
      nick: "Nick Lender",
      john: "John Investor"
    };

    document.getElementById("currentUserLabel").textContent =
      USER_LABELS[PAGE_USER] || "Unknown User";

    let tpvSeriesData = [];   // <-- GLOBAL so all drawers can use it

    let USE_DYNAMIC_DATA = true;   // stays false until Step 7
    let allLoans = [];              // unified variable replacing allLoans
    let cachedKPIs = null;
    let apiLoans = [];   // <-- REQUIRED so init() can assign to it

    /* ============================
       Loan data (dates spread across ~6 months)
       ============================ */
    const loans = [
      { id:1, purchaseDate:'2025-01-15', purchasePrice:10000, termYears:10, graceYears:4.5, nominalRate:0.08 },
      { id:2, purchaseDate:'2025-02-01', purchasePrice:7500, termYears:8, graceYears:2, nominalRate:0.075 },
      { id:3, purchaseDate:'2025-02-20', purchasePrice:12000, termYears:12, graceYears:3, nominalRate:0.0825 },
      { id:4, purchaseDate:'2025-03-10', purchasePrice:6000, termYears:9, graceYears:1.5, nominalRate:0.095 },
      { id:5, purchaseDate:'2025-03-30', purchasePrice:5000, termYears:10, graceYears:1, nominalRate:0.09 },
      { id:6, purchaseDate:'2025-04-15', purchasePrice:7500, termYears:5, graceYears:0, nominalRate:0.073 },
      { id:7, purchaseDate:'2025-04-30', purchasePrice:10000, termYears:8, graceYears:0, nominalRate:0.09 },
      { id:8, purchaseDate:'2025-05-20', purchasePrice:5000, termYears:9, graceYears:0.5, nominalRate:0.11 },
      { id:9, purchaseDate:'2025-06-10', purchasePrice:10000, termYears:7, graceYears:0.25, nominalRate:0.10 },
      { id:10,purchaseDate:'2025-06-30', purchasePrice:8000, termYears:3, graceYears:0, nominalRate:0.06 }
    ];

    /* ============================
       Amortization (grace interest capitalized)
       ============================ */
    function calcAmort(principal, annualRate, termYears, graceYears) {
      const monthlyRate = annualRate / 12;
      const totalMonths = Math.round(termYears * 12);
      const graceMonths = Math.round(graceYears * 12);
      const repayMonths = Math.max(1, totalMonths - graceMonths);

      let balance = principal;
      const schedule = [];

      // Grace months â€” interest accrues and capitalizes (payment = 0)
      for (let m = 1; m <= graceMonths; m++) {
        const interest = +(balance * monthlyRate).toFixed(2);
        balance = +(balance + interest).toFixed(2); // capitalize
        schedule.push({ monthIndex: m, payment: 0, principalPaid: 0, interest, balance });
      }

      // Payment computed on capitalized balance after grace
      const payment = monthlyRate === 0
        ? +(balance / repayMonths).toFixed(2)
        : +((balance * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -repayMonths))).toFixed(2);

      // Repayment months
      for (let m = 1; m <= repayMonths; m++) {
        const interest = +(balance * monthlyRate).toFixed(2);
        const principalPaid = +Math.min(balance, +(payment - interest).toFixed(2));
        balance = +(Math.max(0, balance - principalPaid).toFixed(2));
        schedule.push({ monthIndex: graceMonths + m, payment: +payment.toFixed(2), principalPaid, interest, balance });
      }

      return { payment, schedule };
    }

    /* ============================
       Build loans with amort + cumulative metrics + mini points
       ============================ */
    function buildStaticLoans() {
      return loans.map(l => {
        const amort = calcAmort(l.purchasePrice, l.nominalRate, l.termYears, l.graceYears);

        let cumP = 0, cumI = 0, cumTotal = 0;

        const cumSchedule = amort.schedule.map(r => {
          cumP = +(cumP + r.principalPaid).toFixed(2);
          cumI = +(cumI + r.interest).toFixed(2);
          cumTotal = +(cumTotal + r.payment).toFixed(2);

          return {
            ...r,
            cumPrincipal: cumP,
            cumInterest: cumI,
            cumTotal,
            loanDate: new Date(),
            ownershipDate: new Date()
          };
        });

        const miniPts = cumSchedule
          .slice(0, Math.min(24, cumSchedule.length))
          .map(s => ({
            x: s.monthIndex,
            y: s.balance
          }));

        return {
          ...l,
          loanName: "Loan " + l.loanId,
          loanStartDate: l.purchaseDate,
          amort,
          cumSchedule,
          miniPts
        };
      });
    }

    async function init() {
      if (USE_DYNAMIC_DATA) {
        const apiResult = await loadLoans();

        // Support BOTH return shapes:
        // 1) array (amort page)
        // 2) { loans, sha } (admin / other pages)
        const rawLoans = Array.isArray(apiResult)
          ? apiResult
          : apiResult.loans;

        apiLoans = rawLoans.map(normalizeLoan);

        console.log("Normalized loan sample:", apiLoans[0]);

        // --------------------------------------------------
        // DEV-ONLY SCHEMA DRIFT GUARD
        // --------------------------------------------------
        const DEV_MODE =
          location.hostname === "localhost" ||
          location.hostname.includes("github.io");

        if (DEV_MODE) {
          apiLoans.forEach(l => {
            const problems = [];

            if (!Number.isFinite(l.nominalRate))
              problems.push("nominalRate");

            if (!Number.isFinite(l.principal))
              problems.push("principal");

            if (!Number.isFinite(l.purchasePrice))
              problems.push("purchasePrice");

            if (!Number.isFinite(l.termYears))
              problems.push("termYears");

            if (!l.loanStartDate)
              problems.push("loanStartDate");

            if (!l.user)
              problems.push("user");

            if (problems.length) {
              console.warn(
                "âš ï¸ Loan schema issue",
                {
                  loanId: l.loanId,
                  loanName: l.loanName,
                  problems,
                  loan: l
                }
              );
            }
          });
        }

        apiLoans = attachSchedules(apiLoans);

        allLoans = apiLoans.map(l => {

          // ADD cumulative values directly into amort.schedule
          let cumP = 0, cumI = 0, cumT = 0;

          const schedule = l.amort.schedule.map(r => {
            cumP += r.principalPaid;
            cumI += r.interest;
            cumT += r.payment;

            return {
              ...r,
              cumPrincipal: +(cumP.toFixed(2)),
              cumInterest: +(cumI.toFixed(2)),
              cumTotal: +(cumT.toFixed(2))
            };
          });

          // build mini sparkline points
          const miniPts = schedule
            .slice(0, Math.min(24, schedule.length))
            .map(s => ({
              x: s.monthIndex,
              y: s.balance
            }));

          // IMPORTANT: overwrite amort.schedule so drawer charts work
          return {
            ...l,
            amort: { ...l.amort, schedule },
            cumSchedule: schedule,
            miniPts
          };
        });

        // --------------------------------------------------
        // NORMALIZE user + visible (match Admin defaults)
        // --------------------------------------------------
        allLoans = allLoans.map(l => ({
          ...l,
          user: l.user ?? "jeff",
          visible: l.visible !== false
        }));

        // --------------------------------------------------
        // USER + VISIBILITY FILTER (STEP 2B)
        // --------------------------------------------------
        allLoans = allLoans.filter(l =>
          l.user === PAGE_USER && l.visible === true
        );
        currentLoans = [...allLoans];

        // -------------------------------------------
// KPI COLOR MAP â€” MATCH ROI PAGE (SOURCE OF TRUTH)
        // -------------------------------------------
        window.KPI_COLOR_MAP = {};

        // High-contrast, human-distinguishable palette
        const BASE_DISTINCT_COLORS = [
          '#2563eb', // blue
          '#dc2626', // red
          '#16a34a', // green
          '#7c3aed', // purple
          '#ea580c', // orange
          '#0891b2', // cyan
          '#ca8a04', // amber
          '#be185d', // rose
          '#15803d', // dark green
          '#1d4ed8', // deep blue
          '#9333ea', // violet
          '#b91c1c'  // dark red
        ];

        // Stable ordering so colors never reshuffle
        const sortedLoansForColors = allLoans
          .slice()
          .sort((a, b) => (a.loanId ?? a.id) - (b.loanId ?? b.id));

        // Assign deterministically
        sortedLoansForColors.forEach((loan, i) => {
          const id = loan.loanId ?? loan.id;
          window.KPI_COLOR_MAP[id] =
            BASE_DISTINCT_COLORS[i % BASE_DISTINCT_COLORS.length];
        });

      } else {
        allLoans = buildStaticLoans();
      }
      /* ============================
         Render KPI tiles
         ============================ */
      cachedKPIs = computeKPIs(currentLoans);
      const kpis = cachedKPIs;

      const kpisEl = document.getElementById('kpis');
      kpisEl.innerHTML = `
        <div class="kpi" data-kpi="tpv"><h3>Total Portfolio Value</h3><p id="tpvTile">$${kpis.totalPrincipal.toLocaleString()}</p></div>
        <div class="kpi" data-kpi="rates"><h3>Avg Rate</h3><p>${(kpis.weightedRate * 100).toFixed(2)}%</p></div>
        <div class="kpi" data-kpi="payments"><h3>Monthly Income</h3><p>$${kpis.monthlyIncome.toFixed(2)}</p></div>
        <div class="kpi" data-kpi="distribution">
          <h3>Total Invested</h3>
          <p>$${kpis.totalPrincipal.toLocaleString()}</p>
        </div>

      `;

      /* ============================
         Wire KPI clicks
         ============================ */
      document.querySelectorAll('.kpi').forEach(k => {
        k.addEventListener('click', (ev) => {
          ev.stopPropagation();
          const key = k.getAttribute('data-kpi');
          if (key === 'distribution') renderDistributionDrawer();
          if (key === 'tpv') renderTPVDrawer();
          if (key === 'rates') renderRatesDrawer();
          if (key === 'payments') renderPaymentsDrawer();
        });
      });

      // Now it is safe: allLoans exists
      tpvSeriesData = tpvSeries(currentLoans);   // assign to global
      // --------------------------------------------------
      // Sort loans by purchase date (match Earnings page)
      // --------------------------------------------------
      allLoans.sort((a, b) => {
        const da = new Date(a.purchaseDate || a.loanStartDate).getTime() || 0;
        const db = new Date(b.purchaseDate || b.loanStartDate).getTime() || 0;
        return da - db;
      });

      const curIdx = getCurrentMonthIndex(allLoans) - 1;
      const tpvIdx = Math.min(curIdx, tpvSeriesData.length - 1);
      const tpvVal =
        tpvSeriesData.length > 0 && tpvSeriesData[tpvIdx]
          ? tpvSeriesData[tpvIdx].value
          : 0;

      document.getElementById('tpvTile').textContent =
        `$${Math.round(tpvVal).toLocaleString()}`;


      /* ============================
         Render loan tiles with mini-charts (cumulative principal & interest)
         ============================ */
      const grid = document.getElementById('loanGrid');
      const tooltip = document.getElementById('tooltip');
      grid.innerHTML = "";
      currentLoans.forEach((loan, idx) => {
        const tile = document.createElement('div');
        tile.className = 'tile';

        tile.dataset.loanName = (loan.loanName || "").toLowerCase();
        tile.dataset.school = (loan.school || "").toLowerCase();
        tile.dataset.rate = loan.nominalRate;
        tile.dataset.purchaseDate = new Date(loan.purchaseDate).getTime();
        tile.dataset.amount = Number(loan.purchasePrice || 0);

        tile.setAttribute('tabindex', '0');

        tile.innerHTML = `
          <div class="tile-left">
            <!-- Line 1: Loan Name (bold) -->
            <div class="loan-name" style="font-weight:700;font-size:14px;">
              ${loan.loanName}
            </div>

            <!-- Line 2: School (bold) -->
            <div class="loan-name" style="font-weight:700;font-size:13px;">
              ${loan.school || ('School ')}
            </div>

            <!-- Line 3: Rate Â· Term Â· Matures -->
            <div class="loan-sub" style="margin-top:6px;">
              Rate: ${(loan.nominalRate * 100).toFixed(2)}%
              &nbsp;Â·&nbsp;
              Term: ${loan.termYears}y
              &nbsp;Â·&nbsp;
              Matures: ${
                (() => {
                  const first = new Date(loan.loanStartDate + 'T00:00:00');
                  const lastIdx = loan.amort.schedule[loan.amort.schedule.length - 1].monthIndex;
                  first.setMonth(first.getMonth() + (lastIdx - 1));
                  return first.toLocaleDateString(undefined, { month: "short", year: "numeric" });
                })()
              }
            </div>

            <!-- Line 4: Loan ID -->
            <div class="loan-sub">
              Loan ${loan.loanId}
            </div>
          </div>


          <div class="chart-wrap">
            <div class="mini-label">Rate ${(loan.nominalRate * 100).toFixed(2)}%</div>
            <svg class="sparkline" viewBox="0 0 170 48" preserveAspectRatio="none" data-idx="${idx}" aria-hidden="true"></svg>
          </div>
        `;

        // Important: stop propagation on click so the page-level click listener doesn't close the drawer immediately.
        tile.addEventListener('click', e => { e.stopPropagation(); openDrawerForLoan(loan); });
        tile.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openDrawerForLoan(loan); } });

        grid.appendChild(tile);

        // render mini sparkline
        const svg = tile.querySelector('svg.sparkline');
        const w = 170, h = 48, pad = 6;

        // Correct: use cumulative schedule
        const fullSched = loan.cumSchedule || [];

        if (!fullSched.length) {
          svg.innerHTML = "";   // nothing to plot
          return;
        }

        // build point arrays
        const pPoints = fullSched.map(s => ({ y: s.cumPrincipal }));
        const iPoints = fullSched.map(s => ({ y: s.cumInterest }));

        const pathP = buildPathFromPoints(pPoints, w, h, pad);
        const pathI = buildPathFromPoints(iPoints, w, h, pad);

        // calculate x-position on chart based on month index
        const maxMonth = Math.max(1, fullSched.length);
        const xForMonth = month => {
          const stepX = (w - pad * 2) / Math.max(1, maxMonth - 1);
          return pad + (Math.min(Math.max(month, 1), maxMonth) - 1) * stepX;
        };

        // derive "current month index" based on loan purchase date â†’ today
        const curMonthForLoan = getCurrentMonthForLoan(loan);

        // render SVG
        svg.innerHTML = `
          <path d="${pathI}" fill="none" stroke="#a78bfa" stroke-width="1.6"
                stroke-linecap="round" stroke-linejoin="round"></path>

          <path d="${pathP}" fill="none" stroke="#06b6d4" stroke-width="1.6"
                stroke-linecap="round" stroke-linejoin="round"></path>

          <g class="mini-hover"></g>

          <line class="current-line"
                x1="${xForMonth(curMonthForLoan)}"
                y1="2"
                x2="${xForMonth(curMonthForLoan)}"
                y2="${h - 2}"
                stroke="#111827"
                stroke-dasharray="3 3"
                stroke-opacity="0.6" />
        `;


        // Hover tooltip for mini chart
        svg.addEventListener('mousemove', ev => {
          const rect = svg.getBoundingClientRect();
          const relativeX = ev.clientX - rect.left;
          const frac = relativeX / rect.width;

          // ---------------------------------
          // SAFETY CHECK â€” INSERT HERE
          // ---------------------------------
          if (!fullSched.length) return;

          const idxNearest = Math.round(frac * (fullSched.length - 1));
          const p = fullSched[Math.max(0, Math.min(fullSched.length - 1, idxNearest))];
          if (!p) return;
          // ---------------------------------

          tooltip.style.left = (ev.clientX) + 'px';
          tooltip.style.top = (ev.clientY - 10) + 'px';
          tooltip.style.display = 'block';
          const dateLabel = chartDateLabel(loan.loanStartDate, p.monthIndex);
          tooltip.innerHTML =
            `${dateLabel} â€¢ Principal $${p.cumPrincipal.toLocaleString()} â€¢ Interest $${p.cumInterest.toLocaleString()}`;

          // draw hover circles
          const hoverG = svg.querySelector('g.mini-hover');
          hoverG.innerHTML = '';
          const svgNS = 'http://www.w3.org/2000/svg';
          const stepX = (w - pad * 2) / Math.max(1, fullSched.length - 1);
          const iX = pad + idxNearest * stepX;

          const valsP = pPoints.map(pp => pp.y);
          const valsI = iPoints.map(pp => pp.y);

          if (!valsP.length || !valsI.length || !p) return;

          const minP = Math.min(...valsP), maxP = Math.max(...valsP), rangeP = Math.max(1, maxP - minP);
          const minI = Math.min(...valsI), maxI = Math.max(...valsI), rangeI = Math.max(1, maxI - minI);

          const cyP = pad + (h - pad * 2) - ((p.cumPrincipal - minP) / rangeP) * (h - pad * 2);
          const cyI = pad + (h - pad * 2) - ((p.cumInterest - minI) / rangeI) * (h - pad * 2);

          const cP = document.createElementNS(svgNS, 'circle');
          cP.setAttribute('cx', iX); 
          cP.setAttribute('cy', cyP); 
          cP.setAttribute('r', 3.4); 
          cP.setAttribute('fill', '#06b6d4');
          cP.setAttribute('stroke', '#fff');
          cP.setAttribute('stroke-width', '1');
          hoverG.appendChild(cP);

          const cI = document.createElementNS(svgNS, 'circle');
          cI.setAttribute('cx', iX); 
          cI.setAttribute('cy', cyI); 
          cI.setAttribute('r', 3.4); 
          cI.setAttribute('fill', '#a78bfa');
          cI.setAttribute('stroke', '#fff');
          cI.setAttribute('stroke-width', '1');
          hoverG.appendChild(cI);

        });

        svg.addEventListener('mouseleave', () => {
          tooltip.style.display = 'none';
          const hoverG = svg.querySelector('g.mini-hover');
          if (hoverG) hoverG.innerHTML = '';
        });
      });


      /* Populate amort filter dropdowns */
      const filterName = document.getElementById("filterName");
      const filterSchool = document.getElementById("filterSchool");
      const filterRate = document.getElementById("filterRate");
      const sortLoans = document.getElementById("sortLoans");
      const resetBtn = document.getElementById("resetFilters");


      const names = [...new Set(allLoans.map(l => l.loanName).filter(Boolean))];
      const schools = [...new Set(allLoans.map(l => l.school).filter(Boolean))];

      names.forEach(n => {
        const o = document.createElement("option");
        o.value = n.toLowerCase();
        o.textContent = n;
        filterName.appendChild(o);
      });

      schools.forEach(s => {
        const o = document.createElement("option");
        o.value = s.toLowerCase();
        o.textContent = s;
        filterSchool.appendChild(o);
      });


      function applyLoanFilters() {
        const nameVal = filterName.value;
        const schoolVal = filterSchool.value;
        const rateVal = filterRate.value;

        document.querySelectorAll("#loanGrid .tile").forEach(tile => {
          let show = true;

          if (nameVal && !tile.dataset.loanName.includes(nameVal)) show = false;
          if (schoolVal && !tile.dataset.school.includes(schoolVal)) show = false;

          if (rateVal) {
            const r = Number(tile.dataset.rate) * 100;
            if (
              (rateVal === "low" && r >= 5) ||
              (rateVal === "mid" && (r < 5 || r > 8)) ||
              (rateVal === "high" && r <= 8)
            ) show = false;
          }

          tile.style.display = show ? "" : "none";
        });

        applyLoanSort();
      }

      function applyLoanSort() {
        const grid = document.getElementById("loanGrid");
        const mode = sortLoans.value;

        const tiles = Array.from(grid.children)
          .filter(t => t.style.display !== "none");

        const get = (el, k) => Number(el.dataset[k] || 0);

        tiles.sort((a, b) => {
          switch (mode) {
            case "purchase_asc": return get(a,"purchaseDate") - get(b,"purchaseDate");
            case "purchase_desc": return get(b,"purchaseDate") - get(a,"purchaseDate");
            case "amount_asc": return get(a,"amount") - get(b,"amount");
            case "amount_desc": return get(b,"amount") - get(a,"amount");
            case "rate_asc": return get(a,"rate") - get(b,"rate");
            case "rate_desc": return get(b,"rate") - get(a,"rate");
            default: return 0;
          }
        });

        tiles.forEach(t => grid.appendChild(t));
      }

      // filters
      filterName.addEventListener("change", applyLoanFilters);
      filterSchool.addEventListener("change", applyLoanFilters);
      filterRate.addEventListener("change", applyLoanFilters);

      // sort
      sortLoans.addEventListener("change", applyLoanSort);

      // reset
      resetBtn.addEventListener("click", () => {
        filterName.value = "";
        filterSchool.value = "";
        filterRate.value = "";
        applyLoanFilters();
      });


      /* -------------------------
         Compact tile toggle (persisted)
         ------------------------- */
      const compactToggle = document.getElementById("toggleCompact");
      const loanGrid = document.getElementById("loanGrid");

      // Restore saved preference
      const savedCompact = localStorage.getItem("loanGridCompact");
      if (savedCompact !== null) {
        compactToggle.checked = savedCompact === "true";
      }

      // Apply initial state
      loanGrid.classList.toggle("compact", compactToggle.checked);

      // Persist on change
      compactToggle.addEventListener("change", () => {
        loanGrid.classList.toggle("compact", compactToggle.checked);
        localStorage.setItem("loanGridCompact", compactToggle.checked);
      });

      /* ============================
         Drawer helpers
         ============================ */
      const drawer = document.getElementById('drawer');
      const drawerTitle = document.getElementById('drawerTitle');
      const drawerSub = document.getElementById('drawerSub');
      const drawerPrimary = document.getElementById('drawerPrimary');
      const drawerSecondary = document.getElementById('drawerSecondary');
      const drawerPrimaryTitle = document.getElementById('drawerPrimaryTitle');
      const drawerSecondaryTitle = document.getElementById('drawerSecondaryTitle');
      const drawerBody = document.getElementById('drawerBody');
      const amortBody = document.getElementById('amortBody');
      const drawerChartArea = document.getElementById('drawerChartArea');
      const drawerLegend = document.getElementById('drawerLegend');
      const drawerExtra = document.getElementById('drawerExtra');
      const drawerAmortContainer = document.getElementById('drawerAmortContainer');


      document.getElementById('closeBtn').addEventListener('click', () => closeDrawer());
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeDrawer(); });

      let currentLoan = null;
      let allowEmbedRedirect = false;

      let currentMode = null; // 'loan' or 'kpi'

      function closeDrawer() {
        drawer.classList.remove('open');
        drawer.setAttribute('aria-hidden', 'true');
        tooltip.style.display = 'none';
        currentLoan = null;
        currentMode = null;
      }

      function formatCurrency(val) {
        const n = Number(val) || 0;
        return `$${n.toLocaleString(undefined, {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        })}`;
      }

      function highlightLoanInDistributionChart(loanId) {
        document
          .querySelectorAll('#drawerChartArea [data-loan-id]')
          .forEach(el => {
            el.style.opacity =
              el.dataset.loanId === loanId ? '1' : '0.15';
            el.style.strokeWidth =
              el.dataset.loanId === loanId ? '3' : '1';
          });
      }

      /* ---------- Open drawer for loan ---------- */
      function openDrawerForLoan(loan) {
        // =====================================================
        // FORCE STATE FOR PROGRAMMATIC OPEN (URL / embed)
        // =====================================================
        currentMode = "loan";
        currentLoan = loan;

        // ------------------------------------
        // ROI / Earningsâ€“style amort header
        // ------------------------------------
        drawerTitle.textContent = loan.name || loan.loanName;

        drawerSub.innerHTML = `
          <div>${loan.school || ""}</div>
          <div>
            Purchased ${loan.purchaseDate}
            â€¢ Orig Loan Amt ${formatCurrency(loan.purchasePrice || loan.origLoanAmt || 0)}
          </div>
        `;
        drawerPrimaryTitle.textContent = 'Purchase Price';
        drawerPrimary.textContent = `$${loan.purchasePrice.toLocaleString()}`;
        drawerSecondaryTitle.textContent = 'Rate';
        drawerPrimary.textContent = `$${loan.purchasePrice.toLocaleString()}`;
        drawerSecondary.textContent = `${(loan.nominalRate * 100).toFixed(2)}%`;

        /* render amort rows */
        drawerAmortContainer.style.display = 'block';
        amortBody.innerHTML = '';

        // *** THIS WAS MISSING â€” MUST EXIST BEFORE ANY DATE CHECKS ***
        const purchaseDate = new Date(loan.purchaseDate + "T00:00:00");

        // walk full amort schedule (from loan start),
        // but mark purchase row and dim pre-purchase rows
        loan.amort.schedule.forEach((r) => {
          const rowDate = new Date(loan.loanStartDate + "T00:00:00");
          rowDate.setMonth(rowDate.getMonth() + (r.monthIndex - 1));
          const isBeforePurchase = rowDate < purchaseDate;
          const isPurchaseRow = rowDate.getTime() === purchaseDate.getTime();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="text-align:left">${offsetDateByMonths(loan.loanStartDate, r.monthIndex - 1)}</td>
            <td style="text-align:right">$${Number(r.payment).toFixed(2)}</td>
            <td style="text-align:right">$${Number(r.principalPaid).toFixed(2)}</td>
            <td style="text-align:right">$${Number(r.interest).toFixed(2)}</td>
            <td style="text-align:right">$${Number(r.balance).toFixed(2)}</td>
          `;
          if (isBeforePurchase) {
            tr.style.opacity = "0.45";
          }
          if (isPurchaseRow) {
            tr.querySelectorAll('td').forEach(td => {
              td.style.borderTop = "2px solid #22c55e";
            });
          }
          amortBody.appendChild(tr);
        });

        /* build drawer chart (multi-line with legend & current date marker) */
        drawerChartArea.innerHTML = '';
        drawerLegend.style.display = 'flex';
        drawerLegend.innerHTML = `
          <div class="item"><span class="sw" style="background:#0f172a"></span>Balance</div>
          <div class="item"><span class="sw" style="background:#06b6d4"></span>Cum Principal</div>
          <div class="item"><span class="sw" style="background:#a78bfa"></span>Cum Interest</div>
          <div class="item"><span class="sw" style="background:#fb7185"></span>Total</div>
        `;

        const svgNS = 'http://www.w3.org/2000/svg';
        const w = 480, h = 240, pad = 28;
        const svg = document.createElementNS(svgNS, 'svg');
        svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
        svg.setAttribute('width', '100%');
        svg.setAttribute('height', '100%');

        const schedule = loan.amort?.schedule || [];
        if (!schedule.length) {
          drawerChartArea.innerHTML = "<p>No schedule data available</p>";
          drawer.classList.add('open');
          drawer.setAttribute('aria-hidden', 'false');
          return;
        }

        // NEW: Compute cumulative fields on the fly (since they're not in the base schedule)
        let cumInterest = 0;
        let cumPrincipal = 0;
        let cumTotal = 0;
        schedule.forEach(s => {
          cumInterest += s.interest;
          cumPrincipal += s.principalPaid;
          cumTotal += s.payment;
          s.cumInterest = Math.round(cumInterest * 100) / 100;  // Round for precision
          s.cumPrincipal = Math.round(cumPrincipal * 100) / 100;
          s.cumTotal = Math.round(cumTotal * 100) / 100;
        });

        // Build series
        const balances = schedule.map(s => ({ x: s.monthIndex, y: s.balance }));
        const cumP = schedule.map(s => ({ x: s.monthIndex, y: s.cumPrincipal }));
        const cumI = schedule.map(s => ({ x: s.monthIndex, y: s.cumInterest }));
        const cumT = schedule.map(s => ({ x: s.monthIndex, y: s.cumTotal }));

        // global Y range for consistent scaling
        const allYs = [
          ...balances.map(p => p.y),
          ...cumP.map(p => p.y),
          ...cumI.map(p => p.y),
          ...cumT.map(p => p.y)
        ];
        const maxY = Math.max(...allYs);
        const minY = Math.min(...allYs);
        const range = Math.max(1, maxY - minY);
        const stepX = (w - pad * 2) / Math.max(1, schedule.length - 1);

        function toXY(point, i) {
          const x = pad + i * stepX;
          const y = pad + (h - pad * 2) - ((point.y - minY) / range) * (h - pad * 2);
          return [x, y];
        }

        function buildPath(arr) {
          return arr.map((p, i) => {
            const [x, y] = toXY(p, i);
            return (i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
          }).join(' ');
        }

        // subtle grid lines
        for (let gy = 0; gy < 5; gy++) {
          const y = pad + gy * ((h - pad * 2) / 4);
          const line = document.createElementNS(svgNS, 'line');
          line.setAttribute('x1', pad);
          line.setAttribute('x2', w - pad);
          line.setAttribute('y1', y);
          line.setAttribute('y2', y);
          line.setAttribute('stroke', '#eef2f7');
          line.setAttribute('stroke-width', '1');
          svg.appendChild(line);
        }

        const pathBal = buildPath(balances);
        const pathP = buildPath(cumP);
        const pathI = buildPath(cumI);
        const pathT = buildPath(cumT);

        const elBal = document.createElementNS(svgNS, 'path');
        elBal.setAttribute('d', pathBal);
        elBal.setAttribute('fill', 'none');
        elBal.setAttribute('stroke', '#0f172a');
        elBal.setAttribute('stroke-width', '2');
        svg.appendChild(elBal);

        const elP = document.createElementNS(svgNS, 'path');
        elP.setAttribute('d', pathP);
        elP.setAttribute('fill', 'none');
        elP.setAttribute('stroke', '#06b6d4');
        elP.setAttribute('stroke-width', '1.6');
        svg.appendChild(elP);

        const elI = document.createElementNS(svgNS, 'path');
        elI.setAttribute('d', pathI);
        elI.setAttribute('fill', 'none');
        elI.setAttribute('stroke', '#a78bfa');
        elI.setAttribute('stroke-width', '1.6');
        svg.appendChild(elI);

        const elT = document.createElementNS(svgNS, 'path');
        elT.setAttribute('d', pathT);
        elT.setAttribute('fill', 'none');
        elT.setAttribute('stroke', '#fb7185');
        elT.setAttribute('stroke-width', '1.4');
        svg.appendChild(elT);

        // current date marker based on today's date vs. this loan's purchase date
        const curMonthForLoan = getCurrentMonthForLoan(loan);
        const maxMonth = schedule.length;
        const curX = pad + (Math.max(1, Math.min(curMonthForLoan, maxMonth)) - 1) * stepX;
        const curLine = document.createElementNS(svgNS, 'line');
        curLine.setAttribute('x1', curX);
        curLine.setAttribute('x2', curX);
        curLine.setAttribute('y1', pad);
        curLine.setAttribute('y2', h - pad);
        curLine.setAttribute('stroke', '#111827');
        curLine.setAttribute('stroke-dasharray', '3 4');
        curLine.setAttribute('stroke-opacity', '0.6');
        svg.appendChild(curLine);

        // hover overlay (vertical line and circles)
        const vLine = document.createElementNS(svgNS, 'line');
        vLine.setAttribute('stroke', '#0f172a');
        vLine.setAttribute('stroke-width', '1');
        vLine.setAttribute('stroke-dasharray', '3 4');
        vLine.setAttribute('opacity', '0.6');
        svg.appendChild(vLine);

        const circles = document.createElementNS(svgNS, 'g');
        svg.appendChild(circles);

        // Drawer hover interactions
        svg.addEventListener('mousemove', (ev) => {
          const rect = svg.getBoundingClientRect();
          const x = ev.clientX - rect.left;
          let idx = Math.round((x - pad) / stepX);
          idx = Math.max(0, Math.min(schedule.length - 1, idx));
          const px = pad + idx * stepX;
          const row = schedule[idx];
          // vertical hover line
          vLine.setAttribute('x1', px);
          vLine.setAttribute('x2', px);
          vLine.setAttribute('y1', pad);
          vLine.setAttribute('y2', h - pad);
          circles.innerHTML = '';
          // 4 series: Balance, Cum P, Cum I, Total
          const series = [
            { val: balances[idx].y, color: '#0f172a' },
            { val: cumP[idx].y, color: '#06b6d4' },
            { val: cumI[idx].y, color: '#a78bfa' },
            { val: cumT[idx].y, color: '#fb7185' }
          ];
          // draw hover dots
          series.forEach(s => {
            const [cx, cy] = toXY({ y: s.val }, idx);
            const dot = document.createElementNS(svgNS, 'circle');
            dot.setAttribute('cx', cx);
            dot.setAttribute('cy', cy);
            dot.setAttribute('r', 4);
            dot.setAttribute('fill', s.color);
            dot.setAttribute('stroke', '#fff');
            dot.setAttribute('stroke-width', '1.2');
            circles.appendChild(dot);
          });
          // Calendar date label
          const dateLabel = chartDateLabel(loan.loanStartDate, row.monthIndex);
          // Tooltip
          tooltip.style.display = 'block';
          tooltip.style.left = ev.clientX + 'px';
          tooltip.style.top = (ev.clientY - 10) + 'px';
          tooltip.innerHTML =
            `${dateLabel}<br>
             Balance $${row.balance.toLocaleString()}<br>
             Principal $${row.cumPrincipal.toLocaleString()}<br>
             Interest $${row.cumInterest.toLocaleString()}`;
        }); // <-- closes mousemove listener

        // Hide hover state on leave
        svg.addEventListener('mouseleave', () => {
          vLine.setAttribute('y1', 0);
          vLine.setAttribute('y2', 0);
          circles.innerHTML = '';
          tooltip.style.display = 'none';
        }); // <-- closes mouseleave listener

        drawerChartArea.appendChild(svg);

        // ==============================================================
        // EMBED MODE SPECIFIC BEHAVIOR
        // ==============================================================
        if (isEmbed) {
          // Compute full URL for redirect
          const params = new URLSearchParams(location.search);
          const user = params.get('user') || 'jeff';
          const fullUrl = `/loan-dashboard/amort/index.html?user=${user}&open=loan&loanId=${loan.loanId}`;

          function redirectToFull(e) {
            e.preventDefault();
            e.stopImmediatePropagation();
            window.top.location.href = fullUrl;
          }

          // Override button clicks (show buttons but redirect on click)
          const closeBtn = document.getElementById('closeBtn');
          const printBtn = document.getElementById('printBtn');
          const copyCsvBtn = document.getElementById('copyCsvBtn');
          const downloadCsvBtn = document.getElementById('downloadCsvBtn');

          if (closeBtn) closeBtn.addEventListener('click', redirectToFull, true);
          if (printBtn) printBtn.addEventListener('click', redirectToFull, true);
          if (copyCsvBtn) copyCsvBtn.addEventListener('click', redirectToFull, true);
          if (downloadCsvBtn) downloadCsvBtn.addEventListener('click', redirectToFull, true);

          // NEW: Click anywhere (except buttons/links) redirects to full page
          document.body.addEventListener('click', (e) => {
            if (e.target.closest('button, a')) return; // Exclude buttons/links (they already redirect)
            window.top.location.href = fullUrl;
          }, true);

          // Fix extra scrollbar in embed mode
          document.body.style.overflow = 'hidden';
          document.documentElement.style.overflow = 'hidden';
          const drawerBody = document.querySelector('.drawer-body');
          if (drawerBody) {
            drawerBody.style.overflowY = 'auto';  // Internal scroll for table
            drawerBody.style.maxHeight = '100%';  // Prevent overgrowth
          }
        }

        // ==============================================================
        // FINAL DRAWER OPEN
        // ==============================================================
        drawer.classList.add('open');
        drawer.setAttribute('aria-hidden', 'false');
        drawerBody.scrollTop = 0;
      }

      /* ============================
         CSV / copy / download / print
         ============================ */
      function amortToCSV(loan) {
        const rows = [['Month', 'Payment', 'Principal', 'Interest', 'Balance']];
        loan.amort.schedule.forEach(r =>
          rows.push([r.monthIndex, r.payment.toFixed(2), r.principalPaid.toFixed(2), r.interest.toFixed(2), r.balance.toFixed(2)])
        );
        return rows.map(r => r.join(',')).join('\n');
      }

      document.getElementById('copyCsvBtn')?.addEventListener('click', async () => {
        if (currentMode !== 'loan' || !currentLoan) return alert('Open an individual loan drawer to copy CSV');
        const csv = amortToCSV(currentLoan);
        try { await navigator.clipboard.writeText(csv); alert('CSV copied to clipboard'); }
        catch (e) { alert('Copy failed â€” browser denied clipboard access'); }
      });

      document.getElementById('downloadCsvBtn')?.addEventListener('click', () => {
        if (currentMode === 'loan' && currentLoan) {
          const csv = amortToCSV(currentLoan);
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = `loan-${currentLoan.loanId}-amort.csv`;
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        } else {
          alert('Download CSV is supported for individual loan drawers only.');
        }
      });

      document.getElementById('printBtn')?.addEventListener('click', () => window.print());

      // Accessibility tweak: hide tooltip when grid scrolls
      document.querySelector('.grid').addEventListener('scroll', () => tooltip.style.display = 'none');

      /* ============================
         Click outside to close drawer
         - If drawer is open, close it when user clicks anywhere that's
           not inside the drawer AND not on another tile.
         - Important: tile clicks call stopPropagation so the tile's click
           will open drawer and not cause immediate close.
         ============================ */
      document.addEventListener('click', function (e) {
        if (!drawer.classList.contains('open')) return;

        const clickedInsideDrawer = drawer.contains(e.target);
        const clickedTile = !!e.target.closest('.tile'); // matches all tiles

        // If the click is outside both drawer and tiles â†’ close
        if (!clickedInsideDrawer && !clickedTile) {
          closeDrawer();
        }
      });

      /* ============================
         Theme toggle (matches ROI)
         ============================ */
      const themeToggleBtn = document.getElementById('themeToggle');
      const root = document.documentElement;

      function setTheme(mode) {
        root.setAttribute('data-theme', mode);
        if (mode === 'dark') {
          themeToggleBtn.textContent = 'â˜€ï¸';
        } else {
          themeToggleBtn.textContent = 'ðŸŒ™';
        }
        try { localStorage.setItem('amortTheme', mode); } catch (e) {}
      }

      const stored = (() => { try { return localStorage.getItem('amortTheme'); } catch (e) { return null; } })();
      if (stored === 'dark' || (!stored && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        setTheme('dark');
      } else {
        setTheme('light');
      }

      themeToggleBtn.addEventListener('click', () => {
        const current = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        setTheme(current === 'dark' ? 'light' : 'dark');
      });

      // --------------------------------------------------
      // USER + VISIBILITY FILTER (already done earlier)
      // --------------------------------------------------

      // ensure UI renders filtered set
      currentLoans = [...allLoans];

      console.log("[AMORT] init complete");
      console.log("[AMORT] openParam =", openParam);
      console.log("[AMORT] loanIdParam =", loanIdParam);
      console.log("[AMORT] loans loaded =", currentLoans.length);

      // =====================================================
      // EMBED MODE â€” AUTO OPEN FIRST PURCHASED LOAN (DISPLAY ONLY)
      // =====================================================
      if (isEmbed && openParam === "first" && currentLoans.length) {
        const sorted = currentLoans
          .slice()
          .sort((a, b) =>
            new Date(a.purchaseDate).getTime() -
            new Date(b.purchaseDate).getTime()
          );

        const loan = sorted[0];
        currentLoan = loan; // set state only

        openDrawerForLoan(loan);
      }

      // =====================================================
      // FULL PAGE â€” AUTO OPEN LOAN DRAWER FROM URL (AUTHORITATIVE)
      // =====================================================
      if (!isEmbed && openParam === "loan" && loanIdParam != null) {
        const loanIdNum = Number(loanIdParam);

        const loanToOpen = allLoans.find(
          l => Number(l.loanId ?? l.id) === loanIdNum
        );

        console.log("[AMORT] attempting auto-open for loan", loanIdNum);
        console.log(
          "[AMORT] available loan ids",
          allLoans.map(l => Number(l.loanId ?? l.id))
        );

        if (loanToOpen) {
          requestAnimationFrame(() => {
            openDrawerForLoan(loanToOpen);
          });
        } else {
          console.warn("[AMORT] loan not found for id", loanIdNum);
        }
      }

    } // <--- End of init()

    // Set Current Date in header
    const currentDateEl = document.getElementById('currentDateLabel');
    if (currentDateEl) {
      const today = new Date();
      const formatted = today.toLocaleDateString(undefined, {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      currentDateEl.textContent = `Current Date: ${formatted}`;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // Set Current Date in header
      const currentDateEl = document.getElementById('currentDateLabel');
      if (currentDateEl) {
        const today = new Date();
        const formatted = today.toLocaleDateString(undefined, {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        currentDateEl.textContent = `Current Date: ${formatted}`;
      }

      // Wait for loan data to load
      await loadLoans();

      // Now initialize the UI
      init();

      console.log("[AMORT] init complete");
      console.log("[AMORT] openParam =", openParam);
      console.log("[AMORT] loanIdParam =", loanIdParam);
      console.log("[AMORT] loans loaded =", currentLoans.length);

      // EMBED MODE â€” AUTO OPEN FIRST PURCHASED LOAN
      if (isEmbed && openParam === "first" && currentLoans.length) {
        const sorted = currentLoans
          .slice()
          .sort((a, b) =>
            new Date(a.purchaseDate).getTime() -
            new Date(b.purchaseDate).getTime()
          );

        const loan = sorted[0];
        currentLoan = loan;
        openDrawerForLoan(loan);
      }

      // FULL PAGE â€” AUTO OPEN LOAN DRAWER FROM URL
      if (!isEmbed && openParam === "loan" && loanIdParam != null) {
        const loanIdNum = Number(loanIdParam);

        const loanToOpen = allLoans.find(
          l => Number(l.loanId ?? l.id) === loanIdNum
        );

        console.log("[AMORT] attempting auto-open for loan", loanIdNum);
        console.log(
          "[AMORT] available loan ids",
          allLoans.map(l => Number(l.loanId ?? l.id))
        );

        if (loanToOpen) {
          requestAnimationFrame(() => {
            openDrawerForLoan(loanToOpen);
          });
        } else {
          console.warn("[AMORT] loan not found for id", loanIdNum);
        }
      }
    });

    // ======================================================
    // EMBED MODE â€” REDIRECT ON CLICKS (LIKE ROI/EARNINGS)
    // ======================================================
    // (No changes needed hereâ€”reuses existing 'isEmbed' and 'params')
    if (isEmbed) {
      const user = PAGE_USER || "jeff";  // Assuming PAGE_USER is defined; fallback to 'jeff' like in ROI/Earnings
      const targetUrl = `/loan-dashboard/amort/index.html?user=${user}&open=first`;  // Adjust path/user/open param as needed

      // Function for redirects (like Earnings)
      function redirectToFullAmort(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        window.top.location.href = targetUrl;
      }

      // Override buttons (close, download, print, copy) to redirect instead
      const closeBtn = document.getElementById("closeBtn");
      if (closeBtn) {
        closeBtn.addEventListener("click", redirectToFullAmort, true);
      }

      const downloadBtn = document.getElementById("downloadCsvBtn");
      if (downloadBtn) {
        downloadBtn.addEventListener("click", redirectToFullAmort, true);
      }

      const printBtn = document.getElementById("printBtn");
      if (printBtn) {
        printBtn.addEventListener("click", redirectToFullAmort, true);
      }

      const copyBtn = document.getElementById("copyCsvBtn");
      if (copyBtn) {
        copyBtn.addEventListener("click", redirectToFullAmort, true);
      }

      // General click redirect on non-interactive areas (like ROI/Earnings)
      document.addEventListener("click", (e) => {
        // Exclude interactive elements and tiles (to allow drawer interactions if needed)
        if (e.target.closest("button, select, a, input, textarea, .tile")) return;
        window.top.location.href = targetUrl;
      }, { passive: true });
    }
</script>
</body>
</html>
