<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Loan Portfolio – Amortization Schedules</title>

  <!-- ===============================
       Global CSS (matching Earnings)
       =============================== -->
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --border: #e2e8f0;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #4f46e5;
      --brand: #0ea5e9;
      --shadow: rgba(15,23,42,0.08);

      --drawer-bg: #ffffff;
      --drawer-border: #e2e8f0;
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --card: #1e293b;
      --border: #334155;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --shadow: rgba(0,0,0,0.32);

      --drawer-bg: #1e293b;
      --drawer-border: #334155;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    h1 {
      margin-top: 0;
      font-size: 1.6rem;
    }

    .page {
      padding: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* ===============================
       KPI Tiles
       =============================== */

    .kpi-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .kpi {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      cursor: pointer;
      box-shadow: 0 1px 3px var(--shadow);
      transition: background 0.25s;
    }

    .kpi:hover {
      background: var(--border);
    }

    .kpi h3 {
      margin: 0;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .kpi p {
      margin: 0.35rem 0 0;
      font-size: 1.3rem;
      font-weight: 600;
    }

    /* ===============================
       Loan Tile Grid
       =============================== */

    .loan-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 1rem;
    }

    .loan-tile {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      cursor: pointer;
      box-shadow: 0 1px 3px var(--shadow);
      transition: transform 0.15s ease;
    }

    .loan-tile:hover {
      transform: translateY(-3px);
    }

    .loan-header {
      font-weight: 600;
      font-size: 1.05rem;
      margin-bottom: 0.3rem;
    }

    .loan-school {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }

    /* mini chart area */
    .mini-chart {
      height: 80px;
      margin-top: 0.5rem;
    }

    /* ===============================
       Unified Drawer (Earnings Shell)
       =============================== */

    .drawer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.32);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 900;
    }

    .drawer-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: 760px;
      max-width: 100%;
      height: 100%;
      background: var(--drawer-bg);
      border-left: 1px solid var(--drawer-border);
      box-shadow: -2px 0 10px rgba(0,0,0,0.25);
      transform: translateX(100%);
      transition: transform 0.28s ease;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    .drawer.open {
      transform: translateX(0);
    }

    .drawer-header {
      padding: 1.2rem 1.4rem 0.6rem;
      border-bottom: 1px solid var(--drawer-border);
      position: relative;
    }

    .drawer-close-btn {
      position: absolute;
      top: 14px;
      right: 14px;
      background: transparent;
      border: none;
      font-size: 1.4rem;
      color: var(--muted);
      cursor: pointer;
    }

    .drawer-title {
      margin: 0;
      font-size: 1.35rem;
      font-weight: 600;
    }

    .drawer-subtitle {
      margin: 0.25rem 0 0;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .drawer-body {
      flex: 1;
      overflow-y: auto;
      padding: 1.2rem 1.4rem;
    }

    /* KPI metric boxes */
    .metric-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .metric-box {
      flex: 1;
      background: var(--card);
      padding: 0.75rem 1rem;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .metric-title {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.2rem;
    }

    .metric-value {
      font-size: 1.2rem;
      font-weight: 600;
    }

    /* Chart area */
    #drawerChartArea {
      margin-top: 1.2rem;
      margin-bottom: 1rem;
    }

    /* Extra tables */
    #drawerExtra {
      margin-top: 1.2rem;
    }

  </style>
</head>

<body>
<div class="page">

  <h1>Loan Portfolio – Amortization Schedules</h1>
  <div style="font-size:0.9rem;color:var(--muted);margin-bottom:1rem;">
    Current Date: <span id="currentDate"></span>
  </div>

  <!-- ===============================
       KPI ROW
       =============================== -->
  <div class="kpi-row" id="kpiRow">
    <div class="kpi" data-kpi="tpv">
      <h3>Total Invested</h3>
      <p id="kpiTotalInvested">$0</p>
    </div>

    <div class="kpi" data-kpi="portfolio">
      <h3>Portfolio Value</h3>
      <p id="kpiPortfolioValue">$0</p>
    </div>

    <div class="kpi" data-kpi="payments">
      <h3 id="kpiPaymentsLabel">Expected Income</h3>
      <p id="kpiPaymentsValue">$0</p>
    </div>

    <div class="kpi" data-kpi="yield">
      <h3>Annualized Yield</h3>
      <p id="kpiYieldValue">0%</p>
    </div>
  </div>

  <!-- ===============================
       LOAN TILE GRID
       =============================== -->
  <div class="loan-grid" id="loanGrid"></div>

</div> <!-- end .page -->

<!-- ===============================
     Unified Drawer Shell
     =============================== -->

<div id="drawerOverlay" class="drawer-overlay"></div>

<aside id="drawer" class="drawer" aria-hidden="true">

  <div class="drawer-header">
    <button class="drawer-close-btn" data-close-drawer>&times;</button>
    <h2 id="drawerTitle" class="drawer-title"></h2>
    <div id="drawerSub" class="drawer-subtitle"></div>
  </div>

  <div id="drawerBody" class="drawer-body">

    <!-- KPI Metric Boxes -->
    <div class="metric-row" id="drawerMetricRow">
      <div class="metric-box">
        <div class="metric-title" id="drawerPrimaryTitle"></div>
        <div class="metric-value" id="drawerPrimary"></div>
      </div>
      <div class="metric-box">
        <div class="metric-title" id="drawerSecondaryTitle"></div>
        <div class="metric-value" id="drawerSecondary"></div>
      </div>
    </div>

    <!-- Chart Area -->
    <div id="drawerChartArea"></div>

    <!-- KPI tables or loan amortization table -->
    <div id="drawerExtra"></div>

  </div>
</aside>

<!-- ===============================
     Begin JavaScript (Part 2 continues here)
     =============================== -->
<script>
/* ============================================================
   GLOBAL STATE
   ============================================================ */

let loans = [];
let loansWithAmort = [];
let kpis = {};
let currentLoan = null;
let currentMode = null; // 'loan' or 'kpi'

document.getElementById("currentDate").textContent =
  new Date().toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });


/* ============================================================
   LOAN DATA LOADING
   ============================================================ */

async function loadLoans() {
  try {
    const res = await fetch("https://loan-dashboard-github-app.jeff-263.workers.dev/loans");
    if (!res.ok) throw new Error("Network error loading loans");
    loans = await res.json();
  } catch (err) {
    console.error("Failed loading loans:", err);
    loans = [];
  }
}


/* ============================================================
   AMORTIZATION REBUILD
   (you already had this logic, corrected + stabilized)
   ============================================================ */

function rebuildLoansWithAmort() {
  loansWithAmort = loans.map(loan => {
    const schedule = loan.earningsSchedule || [];
    const amort = { schedule };

    return {
      ...loan,
      amort,
      cumSchedule: schedule.map((r, i) => ({
        ...r,
        isOwned: true,
        cumInterest: r.cumInterest ?? 0,
        cumPrincipal: r.cumPrincipal ?? 0
      }))
    };
  });
}


/* ============================================================
   KPI CALCULATIONS
   ============================================================ */

function monthDiff(start, end) {
  return (end.getFullYear() - start.getFullYear()) * 12 +
         (end.getMonth() - start.getMonth());
}

function computeKpis() {
  if (!loansWithAmort.length) return;

  const totalInvested = loansWithAmort.reduce((s, l) => s + (l.purchasePrice || 0), 0);
  const portfolioValue = loansWithAmort.reduce((s, l) => {
    const last = l.amort.schedule[l.amort.schedule.length - 1];
    return s + (last ? last.balance : 0);
  }, 0);

  // Expected Income (next month)
  const nextMonthLabel = "Next Month";
  const monthlyIncomeKpi = loansWithAmort.reduce((s, l) => {
    const nextRow = l.amort.schedule.find(r => r.monthIndex === 1);
    return s + (nextRow ? nextRow.payment : 0);
  }, 0);

  // Yield calculation
  const totalEarnedInterest = loansWithAmort.reduce((sum, loan) => {
    const owned = loan.cumSchedule.filter(r => r.isOwned);
    const latest = owned[owned.length - 1];
    return sum + (latest ? latest.cumInterest : 0);
  }, 0);

  const minStart = Math.min(...loansWithAmort.map(l => new Date(l.purchaseDate).getTime()));
  const monthsOwned = Math.max(1, monthDiff(new Date(minStart), new Date()));

  const annualizedYield =
    totalInvested > 0
      ? (totalEarnedInterest / totalInvested) * (12 / monthsOwned)
      : 0;

  // Weighted nominal interest rate
  const weightedRate =
    loansWithAmort.reduce((s, l) => s + (l.nominalRate * (l.purchasePrice || 0)), 0) /
    (totalInvested || 1);

  kpis = {
    totalInvested,
    portfolioValue,
    nextMonthLabel,
    monthlyIncomeKpi,
    annualizedYield,
    weightedRate
  };
}


/* ============================================================
   RENDER KPI ROW
   ============================================================ */

function renderKpiTiles() {
  document.getElementById("kpiTotalInvested").textContent =
    `$${kpis.totalInvested.toLocaleString()}`;

  document.getElementById("kpiPortfolioValue").textContent =
    `$${kpis.portfolioValue.toLocaleString()}`;

  document.getElementById("kpiPaymentsLabel").textContent =
    `${kpis.nextMonthLabel} Expected Income`;

  document.getElementById("kpiPaymentsValue").textContent =
    `$${kpis.monthlyIncomeKpi.toFixed(2)}`;

  document.getElementById("kpiYieldValue").textContent =
    `${(kpis.annualizedYield * 100).toFixed(2)}%`;
}


/* ============================================================
   RENDER LOAN TILES
   ============================================================ */

function renderLoanTiles() {
  const grid = document.getElementById("loanGrid");
  grid.innerHTML = "";

  loansWithAmort.forEach(loan => {
    const div = document.createElement("div");
    div.className = "loan-tile";
    div.dataset.loanId = loan.id;

    div.innerHTML = `
      <div class="loan-header">${loan.loanName}</div>
      <div class="loan-school">${loan.school}</div>
      <div>Term: ${loan.term}y &nbsp; Grace: ${loan.grace}y</div>
      <div class="mini-chart" id="mini-${loan.id}"></div>
    `;

    div.addEventListener("click", () => openLoanDrawer(loan));

    grid.appendChild(div);

    drawMiniChart(loan, `mini-${loan.id}`);
  });
}


/* ============================================================
   DRAW MINI CHART (same behavior you had, cleaned up)
   ============================================================ */

function drawMiniChart(loan, elementId) {
  const el = document.getElementById(elementId);
  if (!el) return;

  const w = el.clientWidth;
  const h = el.clientHeight;
  const pad = 6;

  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", w);
  svg.setAttribute("height", h);

  const schedule = loan.amort.schedule || [];
  if (!schedule.length) {
    el.appendChild(svg);
    return;
  }

  const balances = schedule.map(r => r.balance);
  const minB = Math.min(...balances);
  const maxB = Math.max(...balances);

  const pts = schedule.map((r, i) => {
    const x = pad + (i / (schedule.length - 1)) * (w - pad * 2);
    const y = h - pad - ((r.balance - minB) / (maxB - minB || 1)) * (h - pad * 2);
    return [x, y];
  });

  let path = "";
  pts.forEach((p, i) => {
    path += (i === 0 ? "M" : "L") + p[0] + "," + p[1];
  });

  const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
  line.setAttribute("d", path);
  line.setAttribute("stroke", "#0ea5e9");
  line.setAttribute("stroke-width", "2");
  line.setAttribute("fill", "none");

  svg.appendChild(line);
  el.appendChild(svg);
}


/* ============================================================
   DRAWER OPEN / CLOSE (Earnings shell)
   ============================================================ */

const drawer = document.getElementById("drawer");
const drawerOverlay = document.getElementById("drawerOverlay");
const drawerTitle = document.getElementById("drawerTitle");
const drawerSub = document.getElementById("drawerSub");
const drawerBody = document.getElementById("drawerBody");

const drawerPrimaryTitle = document.getElementById("drawerPrimaryTitle");
const drawerPrimary = document.getElementById("drawerPrimary");
const drawerSecondaryTitle = document.getElementById("drawerSecondaryTitle");
const drawerSecondary = document.getElementById("drawerSecondary");

const drawerChartArea = document.getElementById("drawerChartArea");
const drawerExtra = document.getElementById("drawerExtra");


// Close button
document
  .querySelector("[data-close-drawer]")
  .addEventListener("click", closeDrawer);

// Close on overlay click
drawerOverlay.addEventListener("click", closeDrawer);

// Close on ESC
document.addEventListener("keydown", e => {
  if (e.key === "Escape") closeDrawer();
});


function openDrawer() {
  drawer.classList.add("open");
  drawerOverlay.classList.add("open");
  drawer.setAttribute("aria-hidden", "false");
}

function closeDrawer() {
  drawer.classList.remove("open");
  drawerOverlay.classList.remove("open");
  drawer.setAttribute("aria-hidden", "true");
  currentLoan = null;
  currentMode = null;
}


/* ============================================================
   OPEN LOAN DRAWER
   ============================================================ */

function openLoanDrawer(loan) {
  currentLoan = loan;
  currentMode = "loan";

  drawerTitle.textContent = `${loan.loanName} — ${loan.school}`;
  drawerSub.textContent =
    `Purchased ${loan.purchaseDate} • Orig Loan Amt $${loan.originalLoanAmount.toLocaleString()}`;

  drawerPrimaryTitle.textContent = "Purchase Price";
  drawerPrimary.textContent = `$${loan.purchasePrice.toLocaleString()}`;

  drawerSecondaryTitle.textContent = "Rate";
  drawerSecondary.textContent = `${(loan.nominalRate * 100).toFixed(2)}%`;

  drawerChartArea.innerHTML = "";
  drawerExtra.innerHTML = "";

  drawLoanDrawerChart(loan);
  renderAmortizationTable(loan);

  openDrawer();
}


/* ============================================================
   KPI DRAWERS — FIXED & UNIFIED
   ============================================================ */

function openKpiDrawer(title, subtitle, primaryT, primaryV, secondaryT, secondaryV) {
  currentMode = "kpi";
  currentLoan = null;

  drawerTitle.textContent = title;
  drawerSub.textContent = subtitle;

  drawerPrimaryTitle.textContent = primaryT;
  drawerPrimary.textContent = primaryV;

  drawerSecondaryTitle.textContent = secondaryT;
  drawerSecondary.textContent = secondaryV;

  drawerChartArea.innerHTML = "";
  drawerExtra.innerHTML = "";
  openDrawer();
}


/* ------------------------------
   TPV Drawer
------------------------------ */
function renderTPVDrawer() {
  openKpiDrawer(
    "Total Portfolio Value",
    "TPV across all loans",
    "Total Invested",
    `$${kpis.totalInvested.toLocaleString()}`,
    "Portfolio Value",
    `$${kpis.portfolioValue.toLocaleString()}`
  );

  // Simple TPV moment series
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "200");
  drawerChartArea.appendChild(svg);

  // No complex series needed for now (placeholder)
}


/* ------------------------------
   Rates Drawer
------------------------------ */
function renderRatesDrawer() {
  openKpiDrawer(
    "Rates Distribution",
    "Histogram of loan nominal rates",
    "Avg Rate",
    `${(kpis.weightedRate * 100).toFixed(2)}%`,
    "",
    ""
  );

  drawerChartArea.innerHTML = drawRatesHistogram();
  drawerExtra.innerHTML = drawRatesTable();
}


/* ------------------------------
   Payments Drawer
------------------------------ */
function renderPaymentsDrawer() {
  openKpiDrawer(
    "Expected Income",
    "Projected next-month income across portfolio",
    kpis.nextMonthLabel,
    `$${kpis.monthlyIncomeKpi.toFixed(2)}`,
    "",
    ""
  );

  drawerChartArea.innerHTML = "";
  drawerExtra.innerHTML = "";
}


/* ------------------------------
   Yield Drawer
------------------------------ */
function renderYieldDrawer() {
  openKpiDrawer(
    "Annualized Yield",
    "Yield based on interest accrued to date",
    "Annualized Yield",
    `${(kpis.annualizedYield * 100).toFixed(2)}%`,
    "",
    ""
  );

  drawerChartArea.innerHTML = "";
  drawerExtra.innerHTML = "";
}


/* ============================================================
   KPI TILE CLICK WIRING — FIXED
   ============================================================ */

function wireKpiClicks() {
  document.querySelector("[data-kpi='tpv']")
    .addEventListener("click", renderTPVDrawer);

  document.querySelector("[data-kpi='portfolio']")
    .addEventListener("click", renderTPVDrawer);

  document.querySelector("[data-kpi='payments']")
    .addEventListener("click", renderPaymentsDrawer);

  document.querySelector("[data-kpi='yield']")
    .addEventListener("click", renderYieldDrawer);
}
/* ============================================================
   LOAN DRAWER CHART
   (simple amortization balance chart, same behavior as your old page)
   ============================================================ */

function drawLoanDrawerChart(loan) {
  const schedule = loan.amort.schedule || [];
  if (!schedule.length) return;

  const w = 700;
  const h = 220;
  const pad = 30;

  const balances = schedule.map(r => r.balance);
  const minB = Math.min(...balances);
  const maxB = Math.max(...balances);

  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", h);

  let path = "";
  schedule.forEach((r, i) => {
    const x = pad + (i / (schedule.length - 1)) * (w - pad * 2);
    const y = h - pad - ((r.balance - minB) / (maxB - minB || 1)) * (h - pad * 2);
    path += (i === 0 ? "M" : "L") + x + "," + y;
  });

  const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
  line.setAttribute("d", path);
  line.setAttribute("stroke", "#4f46e5");
  line.setAttribute("stroke-width", "2");
  line.setAttribute("fill", "none");

  svg.appendChild(line);
  drawerChartArea.appendChild(svg);
}


/* ============================================================
   AMORTIZATION TABLE
   ============================================================ */

function renderAmortizationTable(loan) {
  const schedule = loan.amort.schedule || [];
  if (!schedule.length) {
    drawerExtra.innerHTML = "<div>No amortization data.</div>";
    return;
  }

  let html = `
    <h3 style="margin-top:1.4rem;margin-bottom:0.5rem;">Amortization Schedule</h3>
    <table style="width:100%;border-collapse:collapse;font-size:0.85rem;">
      <thead>
        <tr style="border-bottom:1px solid var(--border);">
          <th style="text-align:left;padding:6px;">Month</th>
          <th style="text-align:right;padding:6px;">Payment</th>
          <th style="text-align:right;padding:6px;">Principal</th>
          <th style="text-align:right;padding:6px;">Interest</th>
          <th style="text-align:right;padding:6px;">Balance</th>
        </tr>
      </thead>
      <tbody>
  `;

  schedule.forEach(r => {
    html += `
      <tr>
        <td style="padding:6px;">${r.monthIndex}</td>
        <td style="padding:6px;text-align:right;">$${r.payment.toFixed(2)}</td>
        <td style="padding:6px;text-align:right;">$${r.principalPaid.toFixed(2)}</td>
        <td style="padding:6px;text-align:right;">$${r.interest.toFixed(2)}</td>
        <td style="padding:6px;text-align:right;">$${r.balance.toFixed(2)}</td>
      </tr>
    `;
  });

  html += "</tbody></table>";

  drawerExtra.innerHTML = html;
}


/* ============================================================
   KPI: RATES HISTOGRAM + TABLE
   ============================================================ */

function drawRatesHistogram() {
  const rates = loansWithAmort.map(l => (l.nominalRate * 100));
  const min = Math.min(...rates);
  const max = Math.max(...rates);
  const bins = 5;
  const binSize = (max - min) / bins || 1;
  const counts = new Array(bins).fill(0);

  rates.forEach(r => {
    let idx = Math.floor((r - min) / binSize);
    if (idx >= bins) idx = bins - 1;
    counts[idx]++;
  });

  const w = 480;
  const h = 220;
  const pad = 30;

  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", h);

  const maxC = Math.max(...counts, 1);

  for (let i = 0; i < bins; i++) {
    const barW = (w - pad * 2) / bins * 0.7;
    const gap = ((w - pad * 2) / bins - barW) / 2;
    const x = pad + i * ((w - pad * 2) / bins) + gap;

    const barH = (counts[i] / maxC) * (h - pad * 2);
    const y = h - pad - barH;

    // bar
    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    rect.setAttribute("x", x);
    rect.setAttribute("y", y);
    rect.setAttribute("width", barW);
    rect.setAttribute("height", barH);
    rect.setAttribute("fill", "#4f46e5");
    svg.appendChild(rect);

    // label
    const labelLow = (min + i * binSize).toFixed(2);
    const labelHigh = (min + (i + 1) * binSize).toFixed(2);

    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
    text.setAttribute("x", x + barW / 2);
    text.setAttribute("y", h - pad + 12);
    text.setAttribute("text-anchor", "middle");
    text.setAttribute("font-size", "11");
    text.textContent = `${labelLow}-${labelHigh}`;
    svg.appendChild(text);
  }

  return svg.outerHTML;
}


function drawRatesTable() {
  const sorted = loansWithAmort
    .slice()
    .sort((a, b) => (b.nominalRate - a.nominalRate));

  let html = `
    <h3 style="margin-top:1rem;margin-bottom:0.5rem;">Loans Sorted by Rate</h3>
    <div style="max-height:240px;overflow:auto;border:1px solid var(--border);border-radius:8px;background:var(--card);padding:6px;">
      <table style="width:100%;font-size:0.85rem;">
        <thead>
          <tr>
            <th style="text-align:left;padding:6px;">Loan</th>
            <th style="text-align:left;padding:6px;">Rate</th>
            <th style="text-align:left;padding:6px;">Purchase Date</th>
            <th style="text-align:right;padding:6px;">Purchase Price</th>
          </tr>
        </thead>
        <tbody>
  `;

  sorted.forEach(l => {
    html += `
      <tr>
        <td style="padding:6px;">${l.loanName}</td>
        <td style="padding:6px;">${(l.nominalRate * 100).toFixed(2)}%</td>
        <td style="padding:6px;">${l.purchaseDate}</td>
        <td style="padding:6px;text-align:right;">$${l.purchasePrice.toLocaleString()}</td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
    </div>
  `;

  return html;
}


/* ============================================================
   INIT PAGE
   ============================================================ */

async function initPage() {
  await loadLoans();
  rebuildLoansWithAmort();
  computeKpis();

  renderKpiTiles();
  renderLoanTiles();
  wireKpiClicks();
}

initPage();

</script>
</body>
</html>
