<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Loan Portfolio â€” Amortization Schedules</title>

<!-- ================================
     FONTS + RESET
================================ -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: "Inter", sans-serif;
  background: #f0f4f8;
  color: #111;
}

/* =============================================
   PAGE CONTAINER + HEADER
============================================= */

.page {
  width: 100%;
  min-height: 100vh;
  background: linear-gradient(to bottom, #e8f0f9 0%, #f7fafc 180px, #f0f4f8 100%);
  padding: 20px 26px 40px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 14px;
}

.page-title {
  font-size: 25px;
  font-weight: 700;
  margin-bottom: 4px;
}

.page-subtitle {
  font-size: 14px;
  color: #4b5563;
  margin-bottom: 10px;
}

/* =============================================
   KPI CARDS
============================================= */

.kpi-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 30px;
}

.kpi-card {
  background: #ffffff;
  border-radius: 14px;
  padding: 18px 20px;
  box-shadow: 0px 2px 8px rgba(0,0,0,0.06);
}

.kpi-card-title {
  font-size: 13px;
  color: #6b7280;
  margin-bottom: 6px;
}

.kpi-card-value {
  font-size: 22px;
  font-weight: 700;
}

/* =============================================
   LOAN TILE GRID
============================================= */

.loans-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 18px;
}

.loan-tile {
  background: #fff;
  border-radius: 14px;
  padding: 18px 20px;
  box-shadow: 0px 2px 8px rgba(0,0,0,0.08);
  cursor: pointer;
  transition: transform 0.05s ease-in-out;
}

.loan-tile:hover {
  transform: scale(1.01);
}

.loan-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 3px;
}

.loan-sub {
  font-size: 13px;
  color: #555;
}

.loan-mini-chart {
  width: 100%;
  height: 100px;
  margin-top: 8px;
}

/* =============================================
   DRAWER (matches static amort drawer)
============================================= */

.drawer {
  position: fixed;
  top: 0;
  right: -100%;
  width: 620px;
  height: 100vh;
  background: #ffffff;
  box-shadow: -4px 0 16px rgba(0,0,0,0.15);
  transition: right 0.35s ease;
  overflow-y: auto;
  z-index: 9999;
  padding: 26px;
}

.drawer.open {
  right: 0;
}

.drawer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.drawer-title {
  font-size: 20px;
  font-weight: 700;
}

.drawer-close {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  font-size: 18px;
  font-weight: 700;
  background: #f3f4f6;
}

.drawer-subtitle {
  font-size: 14px;
  color: #6b7280;
  margin-bottom: 18px;
}

.drawer-kpi-row {
  display: flex;
  gap: 14px;
  margin-bottom: 20px;
}

.drawer-kpi {
  flex: 1;
  background: #f9fafb;
  border-radius: 10px;
  padding: 14px 16px;
}

.drawer-kpi-title {
  font-size: 12px;
  color: #6b7280;
  margin-bottom: 6px;
}

.drawer-kpi-value {
  font-size: 20px;
  font-weight: 700;
}

.drawer-chart {
  width: 100%;
  height: 260px;
  margin-bottom: 20px;
}

.drawer-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 40px;
}

.drawer-table th {
  background: #f1f5f9;
  text-align: left;
  padding: 10px;
  font-size: 13px;
}

.drawer-table td {
  padding: 9px 10px;
  border-bottom: 1px solid #e5e7eb;
  font-size: 13px;
}

</style>
</head>
<body>

<div class="page">

  <!-- ============================
       PAGE HEADER
  ============================= -->
  <div class="page-header">
    <div>
      <div class="page-title">Loan Portfolio â€“ Amortization Schedules</div>
      <div class="page-subtitle">Click on the loan below to see & export the amortization schedule.</div>
    </div>
    <div class="user-section">
      <span style="margin-right:8px; color:#374151;">Name: Jeff Customer</span>
      <button class="dark-toggle">ðŸŒ™</button>
    </div>
  </div>

  <div id="currentMonthLabel" style="font-size:14px; color:#374151; margin-bottom:16px;">
    Current Month: --
  </div>

  <!-- ============================
       KPI ROW
  ============================= -->
  <div class="kpi-row">
    <div class="kpi-card" id="kpi-invested">
      <div class="kpi-card-title">Total Invested</div>
      <div class="kpi-card-value">$0</div>
    </div>

    <div class="kpi-card" id="kpi-portval">
      <div class="kpi-card-title">Portfolio Value</div>
      <div class="kpi-card-value">$0</div>
    </div>

    <div class="kpi-card" id="kpi-income">
      <div class="kpi-card-title">Next Month Expected Income</div>
      <div class="kpi-card-value">$0</div>
    </div>

    <div class="kpi-card" id="kpi-yield">
      <div class="kpi-card-title">Annualized Yield</div>
      <div class="kpi-card-value">0.00%</div>
    </div>
  </div>

  <!-- ============================
       LOAN TILE GRID
  ============================= -->
  <div class="loans-grid" id="loansGrid"></div>

</div>

<!-- ============================
     UNIQUE DRAWER
============================= -->
<div class="drawer" id="drawer">

  <div class="drawer-header">
    <div class="drawer-title" id="drawerTitle">Loan</div>
    <button class="drawer-close" onclick="closeDrawer()">Ã—</button>
  </div>

  <div class="drawer-subtitle" id="drawerSub"></div>

  <div class="drawer-kpi-row">
    <div class="drawer-kpi">
      <div class="drawer-kpi-title">Purchase Price</div>
      <div class="drawer-kpi-value" id="drawerPurchasePrice">$0</div>
    </div>

    <div class="drawer-kpi">
      <div class="drawer-kpi-title">Interest Rate</div>
      <div class="drawer-kpi-value" id="drawerRate">0%</div>
    </div>
  </div>

  <canvas class="drawer-chart" id="drawerChart"></canvas>

  <table class="drawer-table" id="drawerTable">
    <thead>
      <tr>
        <th>Month</th>
        <th>Payment</th>
        <th>Principal</th>
        <th>Interest</th>
        <th>Balance</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<!-- PARTS 2 & 3 scripts go here -->
<script>
/* ============================================================
   GLOBAL STATE
============================================================ */

let loans = [];
let currentLoan = null;
let drawer = null;

/* ============================================================
   API LOADER  â€” Same backend as earnings page
============================================================ */

async function loadLoans() {
  try {
    const res = await fetch("https://loan-dashboard-api.jeff-263.workers.dev/loans");
    if (!res.ok) throw new Error("Backend returned status " + res.status);

    const data = await res.json();
    loans = (data.loans || []).map(l => ({ ...l }));

  } catch (err) {
    console.error("Failed loading loans:", err);
    loans = [];
  }
}

/* ============================================================
   AMORTIZATION SCHEDULE CALCULATOR
   This mirrors your existing amort pages' math
============================================================ */

function buildAmortSchedule(loan) {
  const schedule = [];

  const rate = loan.rate || 0;
  const monthlyRate = rate / 12;
  const n = (loan.termYears || 0) * 12;
  const purchase = loan.purchasePrice || 0;

  if (n === 0 || rate === 0) return [];

  // Standard amort payment formula
  const payment = purchase * (monthlyRate / (1 - Math.pow(1 + monthlyRate, -n)));

  let balance = purchase;

  for (let i = 0; i < n; i++) {
    const interest = balance * monthlyRate;
    const principal = payment - interest;
    balance = Math.max(0, balance - principal);

    schedule.push({
      monthIndex: i,
      payment,
      principal,
      interest,
      balance
    });
  }

  return schedule;
}

/* ============================================================
   KPI CALCULATIONS  â€” MATCH STATIC AMORT PAGE
============================================================ */

function computeKpis() {
  const invested = loans.reduce((sum, l) => sum + (l.purchasePrice || 0), 0);

  // portfolio value = sum of outstanding balances at current month
  let maxMonths = 0;
  loans.forEach(l => {
    maxMonths = Math.max(maxMonths, l.amort?.schedule?.length || 0);
  });

  const portValue = loans.reduce((sum, l) => {
    if (!l.amort || !l.amort.schedule.length) return sum;
    const idx = Math.min(maxMonths - 1, l.amort.schedule.length - 1);
    return sum + l.amort.schedule[idx].balance;
  }, 0);

  // next month income = sum of next month's interest
  const nextMonthIncome = loans.reduce((sum, l) => {
    if (!l.amort || !l.amort.schedule.length) return sum;
    const next = Math.min(1, l.amort.schedule.length - 1);
    return sum + l.amort.schedule[next].interest;
  }, 0);

  // annualized yield
  const annualYield = invested > 0 ? (nextMonthIncome * 12 / invested) * 100 : 0;

  return {
    invested,
    portValue,
    nextMonthIncome,
    annualYield
  };
}

/* ============================================================
   UI â€” Populate KPI Cards
============================================================ */

function renderKpis() {
  const kpis = computeKpis();

  document.querySelector("#kpi-invested .kpi-card-value").textContent =
    "$" + kpis.invested.toLocaleString();

  document.querySelector("#kpi-portval .kpi-card-value").textContent =
    "$" + Math.round(kpis.portValue).toLocaleString();

  document.querySelector("#kpi-income .kpi-card-value").textContent =
    "$" + kpis.nextMonthIncome.toFixed(2);

  document.querySelector("#kpi-yield .kpi-card-value").textContent =
    kpis.annualYield.toFixed(2) + "%";
}

/* ============================================================
   UI â€” Render Loan Tiles
============================================================ */

function renderLoanTiles() {
  const grid = document.getElementById("loansGrid");
  grid.innerHTML = "";

  loans.forEach((loan, idx) => {
    const div = document.createElement("div");
    div.className = "loan-tile";
    div.dataset.index = idx;

    div.innerHTML = `
      <div class="loan-title">Loan ${loan.id || idx + 1}</div>
      <div class="loan-sub">
        $${(loan.purchasePrice || 0).toLocaleString()}<br>
        Term: ${loan.termYears || "--"}y   Grace: ${loan.graceYears || "--"}y
      </div>
      <canvas class="loan-mini-chart" id="miniChart-${idx}"></canvas>
    `;

    div.addEventListener("click", () => openDrawer(idx));
    grid.appendChild(div);
  });
}

/* ============================================================
   DRAWER â€” OPEN/CLOSE
============================================================ */

function openDrawer(index) {
  currentLoan = loans[index];
  if (!currentLoan) return;

  drawer = document.getElementById("drawer");

  document.getElementById("drawerTitle").textContent =
    `Loan ${currentLoan.id || index + 1} â€” ${currentLoan.school || ""}`;

  document.getElementById("drawerSub").textContent =
    `Purchased ${currentLoan.purchaseDate || ""}`;

  document.getElementById("drawerPurchasePrice").textContent =
    "$" + (currentLoan.purchasePrice || 0).toLocaleString();

  document.getElementById("drawerRate").textContent =
    ((currentLoan.rate || 0) * 100).toFixed(2) + "%";

  drawer.classList.add("open");

  drawLoanChart(currentLoan);
  fillLoanTable(currentLoan);
}

function closeDrawer() {
  if (!drawer) drawer = document.getElementById("drawer");
  drawer.classList.remove("open");
}

document.addEventListener("keydown", e => {
  if (e.key === "Escape") closeDrawer();
});

/* ============================================================
   HELPER â€” Build schedules into each loan BEFORE rendering
============================================================ */

function attachAllSchedules() {
  loans.forEach(l => {
    if (!l.amort) l.amort = {};
    l.amort.schedule = buildAmortSchedule(l);
  });
}

/* ============================================================
   INIT SEQUENCE
============================================================ */

async function initPage() {
  await loadLoans();
  attachAllSchedules();

  renderKpis();
  renderLoanTiles();
}

window.addEventListener("DOMContentLoaded", initPage);
</script>
<script>
/* ============================================================
   PART 3 â€” MINI CHARTS (Loan Tiles)
   Matches static amort page: simple line of loan balance
============================================================ */

function drawMiniCharts() {
  loans.forEach((loan, idx) => {
    const canvas = document.getElementById(`miniChart-${idx}`);
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    const schedule = loan.amort?.schedule || [];
    if (!schedule.length) return;

    const w = canvas.width = canvas.clientWidth;
    const h = canvas.height = canvas.clientHeight;

    const balances = schedule.map(r => r.balance);
    const maxBal = Math.max(...balances);
    const minBal = Math.min(...balances);

    ctx.clearRect(0, 0, w, h);

    ctx.strokeStyle = "#0ea5e9";
    ctx.lineWidth = 2;
    ctx.beginPath();

    schedule.forEach((r, i) => {
      const x = (i / (schedule.length - 1)) * (w - 4) + 2;
      const y = h - ((r.balance - minBal) / (maxBal - minBal)) * (h - 4) - 2;

      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });

    ctx.stroke();
  });
}

/* ============================================================
   MAIN DRAWER AMORTIZATION CHART
   Matches static amort chart style
============================================================ */

function drawLoanChart(loan) {
  const canvas = document.getElementById("drawerChart");
  const ctx = canvas.getContext("2d");

  const schedule = loan.amort?.schedule || [];
  if (!schedule.length) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    return;
  }

  // Set canvas size
  const w = canvas.width = canvas.clientWidth;
  const h = canvas.height = canvas.clientHeight;

  ctx.clearRect(0, 0, w, h);

  // Extract series
  const balances = schedule.map(r => r.balance);
  const principals = schedule.map(r => r.principal);
  const interests = schedule.map(r => r.interest);

  const maxBal = Math.max(...balances);

  function yScale(value) {
    return h - (value / maxBal) * (h - 20) - 10;
  }

  // ================================
  // Draw BALANCE line
  // ================================
  ctx.strokeStyle = "#2563eb";   // blue
  ctx.lineWidth = 2;
  ctx.beginPath();

  schedule.forEach((r, i) => {
    const x = (i / (schedule.length - 1)) * (w - 40) + 20;
    const y = yScale(r.balance);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // ================================
  // Draw TODAY vertical line
  // ================================
  const todayX = (1 / (schedule.length - 1)) * (w - 40) + 20; // month 1 marker
  ctx.strokeStyle = "#9ca3af";
  ctx.setLineDash([4, 4]);
  ctx.beginPath();
  ctx.moveTo(todayX, 0);
  ctx.lineTo(todayX, h);
  ctx.stroke();
  ctx.setLineDash([]);
}

/* ============================================================
   DRAWER TABLE POPULATION
============================================================ */

function fillLoanTable(loan) {
  const tbody = document.querySelector("#drawerTable tbody");
  tbody.innerHTML = "";

  if (!loan?.amort?.schedule?.length) return;

  loan.amort.schedule.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.monthIndex + 1}</td>
      <td>$${r.payment.toFixed(2)}</td>
      <td>$${r.principal.toFixed(2)}</td>
      <td>$${r.interest.toFixed(2)}</td>
      <td>$${r.balance.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ============================================================
   OPTIONAL â€” EXPORT CSV (only works if you add a button)
============================================================ */

function exportLoanCsv(loan) {
  const header = "Month,Payment,Principal,Interest,Balance\n";
  const body = loan.amort.schedule
    .map(r => `${r.monthIndex + 1},${r.payment.toFixed(2)},${r.principal.toFixed(2)},${r.interest.toFixed(2)},${r.balance.toFixed(2)}`)
    .join("\n");

  const blob = new Blob([header + body], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `loan-${loan.id || "amort"}.csv`;
  a.click();

  URL.revokeObjectURL(url);
}

/* ============================================================
   FINAL INIT HOOKS â€” Run charts after tiles render
============================================================ */

window.addEventListener("load", () => {
  setTimeout(drawMiniCharts, 150); // allow tiles to size
});
</script>
</body>
</html>
