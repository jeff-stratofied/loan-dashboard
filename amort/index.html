<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Loan Portfolio â€” Amortization Schedules</title>

<!-- ========================================
     GOOGLE FONTS
========================================= -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>

/* ========================================
     DARK MODE ROOT VARIABLES
     â€” matches earnings page exactly
========================================= */

:root {
  --bg: #f0f4f8;
  --text: #111827;
  --card: #ffffff;
  --card-border: #e5e7eb;
  --muted: #6b7280;
  --accent: #2563eb;
  --accent-light: #dbeafe;
  --chart-balance: #2563eb;
  --chart-principal: #10b981;
  --chart-interest: #7c3aed;
  --drawer-bg: #ffffff;

  /* transitions */
  --theme-transition: background 0.3s ease, color 0.3s ease;
}

:root[data-theme='dark'] {
  --bg: #0f172a;
  --text: #f8fafc;
  --card: #1e293b;
  --card-border: #334155;
  --muted: #94a3b8;
  --accent: #38bdf8;
  --accent-light: #0f172a;
  --drawer-bg: #1e293b;
  --chart-balance: #38bdf8;
  --chart-principal: #34d399;
  --chart-interest: #c084fc;
}

/* ========================================
     GLOBAL PAGE LAYOUT
========================================= */

body {
  margin: 0;
  font-family: "Inter", sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: var(--theme-transition);
}

.page {
  width: 100%;
  min-height: 100vh;
  padding: 24px 28px 40px;
  background: linear-gradient(
    to bottom,
    #e8f0f9 0%,
    #f7fafc 180px,
    var(--bg) 100%
  );
}

/* ========================================
     HEADER
========================================= */

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 18px;
}

.header-left h1 {
  font-size: 26px;
  font-weight: 700;
  margin: 0;
}

.header-left .subtitle {
  font-size: 14px;
  color: var(--muted);
  margin-top: 4px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Night mode button like earnings page */
#themeToggle {
  cursor: pointer;
  font-size: 20px;
  padding: 6px 10px;
  border-radius: 8px;
  background: var(--card);
  border: 1px solid var(--card-border);
  transition: var(--theme-transition);
  color: var(--text);
}

#currentDateLabel {
  font-size: 15px;
  color: var(--muted);
  margin-bottom: 20px;
}

/* ========================================
     KPI CARDS (matches static amort)
========================================= */

.kpi-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 18px;
  margin-bottom: 32px;
}

.kpi-card {
  background: var(--card);
  border-radius: 14px;
  border: 1px solid var(--card-border);
  padding: 18px 22px;
  box-shadow: 0px 2px 8px rgba(0,0,0,0.06);
  transition: var(--theme-transition);
  cursor: pointer;
}

.kpi-card:hover {
  transform: translateY(-2px);
}

.kpi-title {
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 8px;
}

.kpi-value {
  font-size: 23px;
  font-weight: 700;
}

/* ========================================
     LOAN TILE GRID
========================================= */

.loans-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 22px;
}

.loan-tile {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: 14px;
  padding: 20px;
  box-shadow: 0px 2px 8px rgba(0,0,0,0.08);
  cursor: pointer;
  transition: var(--theme-transition), transform 0.12s ease;
}

.loan-tile:hover {
  transform: scale(1.015);
}

.loan-title {
  font-size: 17px;
  font-weight: 600;
}

.loan-sub {
  font-size: 13px;
  color: var(--muted);
  margin-top: 3px;
}

/* Mini chart canvas */
.loan-mini-chart {
  width: 100%;
  height: 105px;
  margin-top: 10px;
  display: block;
}

/* ========================================
     DRAWER BASE STRUCTURE
========================================= */

.drawer {
  position: fixed;
  top: 0;
  right: -660px;
  width: 660px;
  height: 100vh;
  background: var(--drawer-bg);
  border-left: 1px solid var(--card-border);
  box-shadow: -4px 0 18px rgba(0,0,0,0.14);
  transition: right 0.35s ease, var(--theme-transition);
  overflow-y: auto;
  z-index: 9999;
  padding: 28px;
  display: flex;
  flex-direction: column;
}

.drawer.open {
  right: 0;
}

.drawer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.drawer-title {
  font-size: 22px;
  font-weight: 700;
}

.drawer-close {
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--card-border);
  width: 34px;
  height: 34px;
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
}

/* Subheader below title */
#drawerSub {
  font-size: 14px;
  color: var(--muted);
  margin-top: 8px;
  margin-bottom: 18px;
}

/* KPI boxes inside drawer */
.drawer-kpi-row {
  display: flex;
  gap: 14px;
  margin-bottom: 22px;
}

.drawer-kpi {
  flex: 1;
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: 10px;
  padding: 13px 14px;
}

.drawer-kpi-title {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
}

.drawer-kpi-value {
  font-size: 19px;
  font-weight: 700;
  color: var(--text);
}

/* Drawer chart (big amort chart or KPI chart) */
#drawerChart {
  width: 100%;
  height: 260px;
  margin-bottom: 22px;
}

/* Drawer table â€” amort schedule */
.drawer-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  margin-bottom: 50px;
}

.drawer-table th {
  background: var(--accent-light);
  color: var(--text);
  padding: 10px 12px;
  font-size: 13px;
  border-bottom: 1px solid var(--card-border);
}

.drawer-table td {
  padding: 9px 12px;
  font-size: 13px;
  border-bottom: 1px solid var(--card-border);
}

/* End Part 1A */
/* ========================================
   ADDITIONAL DRAWER ELEMENTS
   (ROI-to-Date, KPI Drawer placeholders)
========================================= */

.drawer-section-title {
  font-size: 16px;
  font-weight: 600;
  margin: 20px 0 10px;
  color: var(--text);
}

/* KPI drawer table */
.kpi-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  margin-bottom: 40px;
}

.kpi-table th {
  text-align: left;
  padding: 8px 10px;
  background: var(--accent-light);
  border-bottom: 1px solid var(--card-border);
  font-size: 13px;
  color: var(--text);
}

.kpi-table td {
  padding: 8px 10px;
  font-size: 13px;
  border-bottom: 1px solid var(--card-border);
}

/* End drawer CSS */
</style>
</head>

<body>

<div class="page">

  <!-- ========================================
       PAGE HEADER
  ========================================= -->
  <div class="page-header">
    <div class="header-left">
      <h1>Loan Portfolio â€” Amortization Schedules</h1>
      <div class="subtitle">Dynamic amortization engine with full KPI & drawer features</div>
    </div>

    <div class="header-right">
      <button id="themeToggle">ðŸŒ™</button>
    </div>
  </div>

  <!-- ========================================
       CURRENT DATE LABEL
  ========================================= -->
  <div id="currentDateLabel">Current Date: --</div>

  <!-- ========================================
       KPI ROW
  ========================================= -->
  <div class="kpi-row">

    <div class="kpi-card" data-kpi="invested">
      <div class="kpi-title">Total Invested</div>
      <div class="kpi-value" id="kpiInvested">$0</div>
    </div>

    <div class="kpi-card" data-kpi="portval">
      <div class="kpi-title">Portfolio Value</div>
      <div class="kpi-value" id="kpiPortVal">$0</div>
    </div>

    <div class="kpi-card" data-kpi="income">
      <div class="kpi-title">Next Month Expected Income</div>
      <div class="kpi-value" id="kpiIncome">$0</div>
    </div>

    <div class="kpi-card" data-kpi="yield">
      <div class="kpi-title">Annualized Yield</div>
      <div class="kpi-value" id="kpiYield">0.00%</div>
    </div>

  </div>

  <!-- ========================================
       LOAN GRID
  ========================================= -->
  <div id="loansGrid" class="loans-grid"></div>

</div> <!-- END PAGE -->

<!-- ========================================
     UNIQUE SHARED DRAWER
========================================= -->
<div class="drawer" id="drawer">

  <!-- Drawer Header -->
  <div class="drawer-header">
    <div class="drawer-title" id="drawerTitle">Loan</div>
    <button class="drawer-close" onclick="closeDrawer()">Ã—</button>
  </div>

  <div id="drawerSub"></div>

  <!-- Drawer KPI Row (per-loan or KPI mode) -->
  <div class="drawer-kpi-row">
    <div class="drawer-kpi">
      <div class="drawer-kpi-title">Purchase Price</div>
      <div class="drawer-kpi-value" id="drawerPurchasePrice">$0</div>
    </div>

    <div class="drawer-kpi">
      <div class="drawer-kpi-title">Interest Rate</div>
      <div class="drawer-kpi-value" id="drawerRate">0%</div>
    </div>
  </div>

  <!-- ROI-to-Date Box -->
  <div class="drawer-kpi-row">
    <div class="drawer-kpi">
      <div class="drawer-kpi-title">ROI-to-Date</div>
      <div class="drawer-kpi-value" id="drawerROI">0.00%</div>
    </div>

    <div class="drawer-kpi">
      <div class="drawer-kpi-title">Interest Earned</div>
      <div class="drawer-kpi-value" id="drawerInterestEarned">$0</div>
    </div>
  </div>

  <!-- KPI Drawer-Specific Content -->
  <div id="kpiDrawerContent"></div>

  <!-- Drawer Chart -->
  <canvas id="drawerChart"></canvas>

  <!-- Drawer Amortization Table -->
  <table class="drawer-table" id="drawerTable">
    <thead>
      <tr>
        <th>Month</th>
        <th>Payment</th>
        <th>Principal</th>
        <th>Interest</th>
        <th>Balance</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div> <!-- END DRAWER -->

<!-- Placeholder for all JS (Part 2 & 3) -->
<script>
/* PART 2 & 3 scripts will be inserted here */
</script>

</body>
</html>
<script>
/* ============================================================
   PART 2A â€” CORE HELPERS, DARK MODE, API LOADER
============================================================ */

/* -------------------------------
   Dark Mode Toggle (Earnings Style)
-------------------------------- */
const root = document.documentElement;
const themeToggle = document.getElementById("themeToggle");

function setTheme(mode) {
  root.setAttribute("data-theme", mode);
  try { localStorage.setItem("amortTheme", mode); } catch(e){}
}

const stored = (() => {
  try { return localStorage.getItem("amortTheme"); } catch(e){ return null; }
})();

if (stored === "dark" || (!stored && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
  setTheme("dark");
  themeToggle.textContent = "â˜€ï¸";
} else {
  setTheme("light");
  themeToggle.textContent = "ðŸŒ™";
}

themeToggle.addEventListener("click", () => {
  const current = root.getAttribute("data-theme") === "dark" ? "dark" : "light";
  setTheme(current === "dark" ? "light" : "dark");
  themeToggle.textContent = current === "dark" ? "ðŸŒ™" : "â˜€ï¸";
});


/* -------------------------------
   GLOBAL VARIABLES
-------------------------------- */
let loans = [];                 // raw API data
let amortLoans = [];            // loans with amort schedules
let today = new Date();         // used for date index calculations

document.getElementById("currentDateLabel").textContent =
  "Current Date: " + today.toLocaleDateString();

/* -------------------------------
   DATE â†’ MONTH INDEX
-------------------------------- */
function monthDiff(d1, d2) {
  return (
    (d2.getFullYear() - d1.getFullYear()) * 12 +
    (d2.getMonth() - d1.getMonth())
  );
}

/* -------------------------------
   API LOADER
-------------------------------- */
async function loadLoans() {
  try {
    const res = await fetch("https://loan-dashboard-api.jeff-263.workers.dev/loans");
    if (!res.ok) throw new Error("Bad API response");

    const raw = await res.json();

    // Normalize YOUR API fields â†’ amort engine fields
    loans = (raw.loans || []).map(l => ({
      id: l.loanId,
      loanName: l.loanName,
      school: l.school,
      loanStartDate: l.loanStartDate,
      purchaseDate: l.purchaseDate,
      origLoanAmount: Number(l.origLoanAmt),
      purchasePrice: Number(l.purchasePrice),
      rate: Number(l.rate),
      termYears: Number(l.termYears),
      graceYears: Number(l.graceYears)
    }));

  } catch (err) {
    console.error("Failed loading loans:", err);
    alert("Error loading loans from API.");
    loans = [];
  }
}


/* ============================================================
   AMORTIZATION ENGINE HELPERS
============================================================ */

/*
  Build amort schedule:
  - interest = balance * rate/12
  - payment determined by full term
  - grace period:  interest accrues but no payment
*/
function buildAmortSchedule(loan) {
  const purchaseDate = new Date(loan.purchaseDate);
  const loanStartDate = new Date(loan.loanStartDate);

  const n = loan.termYears * 12;
  const r = loan.rate / 12;

  const payment = r === 0
    ? loan.origLoanAmount / n
    : loan.origLoanAmount * (r / (1 - Math.pow(1 + r, -n)));

  let balance = loan.origLoanAmount;
  let schedule = [];

  const graceMonths = Math.round(loan.graceYears * 12);
  const totalMonths = n + graceMonths;

  for (let m = 0; m <= totalMonths; m++) {
    let interest = balance * r;
    let principalPaid = 0;
    let actualPayment = 0;

    if (m >= graceMonths) {
      actualPayment = payment;
      principalPaid = Math.max(0, payment - interest);
      balance = Math.max(0, balance - principalPaid);
    } else {
      // During grace: interest accrues
      balance += interest;
    }

    schedule.push({
      monthIndex: m,
      payment: actualPayment,
      principalPaid,
      interest,
      balance
    });
  }

  // ROI + cumulative fields
  let cumInterest = 0;
  let cumPrincipal = 0;
  schedule = schedule.map((r) => {
    cumInterest += r.interest;
    cumPrincipal += r.principalPaid;

    return {
      ...r,
      cumInterest,
      cumPrincipal
    };
  });

  return {
    payment,
    schedule
  };
}

/* Build amortLoans array with per-loan today index */
function buildAllAmort() {
  amortLoans = loans.map(l => {
    const amort = buildAmortSchedule(l);

    const todayIdx = monthDiff(new Date(l.purchaseDate), today);
    const clampedIdx = Math.max(0, Math.min(todayIdx, amort.schedule.length - 1));

    return {
      ...l,
      amort,
      todayIndex: clampedIdx,
      current: amort.schedule[clampedIdx]
    };
  });
}

</script>
<script>
/* ============================================================
   PART 2B â€” LOAN TILE RENDERING, KPI ENGINE, DRAWER LOGIC
============================================================ */

/* -------------------------------
   Render Loan Tiles (Grid)
-------------------------------- */
function renderLoanTiles() {
  const grid = document.getElementById("loansGrid");
  grid.innerHTML = "";

  amortLoans.forEach(loan => {
    const div = document.createElement("div");
    div.className = "loan-tile";
    div.dataset.id = loan.id;

    div.innerHTML = `
      <div class="loan-title">${loan.loanName}</div>
      <div class="loan-sub">${loan.school}</div>
      <canvas class="loan-mini-chart" id="mini-${loan.id}"></canvas>
    `;

    div.addEventListener("click", () => openLoanDrawer(loan.id));
    grid.appendChild(div);

    drawMiniChart(loan);
  });
}


/* -------------------------------
   MINI CHART (Simple Line)
-------------------------------- */
function drawMiniChart(loan) {
  const canvas = document.getElementById(`mini-${loan.id}`);
  if (!canvas) return;
  const ctx = canvas.getContext("2d");

  const sched = loan.amort.schedule;
  const values = sched.map(r => r.balance);

  const W = canvas.width = canvas.clientWidth;
  const H = canvas.height = canvas.clientHeight;

  const maxV = Math.max(...values);
  const minV = Math.min(...values);

  ctx.clearRect(0,0,W,H);
  ctx.lineWidth = 2;
  ctx.strokeStyle = "var(--chart-balance)";
  ctx.beginPath();

  values.forEach((v,i) => {
    const x = (i / (values.length - 1)) * W;
    const y = H - ((v - minV) / (maxV - minV)) * H;
    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  });
  ctx.stroke();

  // Vertical today line
  const t = loan.todayIndex;
  const tx = (t / (values.length - 1)) * W;
  ctx.strokeStyle = "var(--muted)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(tx, 0);
  ctx.lineTo(tx, H);
  ctx.stroke();
}


/* ============================================================
   KPI ENGINE
============================================================ */

function computeKpis() {
  const totalInvested = amortLoans.reduce((s,l) => s + l.purchasePrice, 0);

  const portfolioValue = amortLoans.reduce((s,l) => {
    return s + l.current.balance + l.current.cumPrincipal + l.current.cumInterest;
  }, 0);

  // Expected Income = next month's payment sum
  const nextMonthIncome = amortLoans.reduce((s,l) => {
    const idx = Math.min(l.todayIndex + 1, l.amort.schedule.length - 1);
    return s + l.amort.schedule[idx].payment;
  }, 0);

  // Annualized Yield
  const totalInterestEarned = amortLoans.reduce((s,l) => s + l.current.cumInterest, 0);
  const yieldAnnual =
    totalInvested === 0 ? 0 :
    (totalInterestEarned / totalInvested) * (12 /  (monthDiff(new Date(amortLoans[0].purchaseDate), today)+1));

  return {
    totalInvested,
    portfolioValue,
    nextMonthIncome,
    yieldAnnual
  };
}


/* -------------------------------
   Render KPI Tiles
-------------------------------- */
function renderKpiTiles() {
  const k = computeKpis();

  document.getElementById("kpiInvested").textContent =
    "$" + k.totalInvested.toLocaleString();

  document.getElementById("kpiPortVal").textContent =
    "$" + k.portfolioValue.toLocaleString();

  document.getElementById("kpiIncome").textContent =
    "$" + k.nextMonthIncome.toFixed(2);

  document.getElementById("kpiYield").textContent =
    (k.yieldAnnual * 100).toFixed(2) + "%";
}


/* ============================================================
   DRAWER LOGIC (Loan + KPI)
============================================================ */

let drawerMode = "loan"; // or "kpi"
let activeLoan = null;

function closeDrawer() {
  document.getElementById("drawer").classList.remove("open");
}

document.addEventListener("keydown", e => {
  if (e.key === "Escape") closeDrawer();
});


/* -------------------------------
   Open Loan Drawer
-------------------------------- */
function openLoanDrawer(id) {
  const loan = amortLoans.find(l => l.id == id);
  if (!loan) return;

  drawerMode = "loan";
  activeLoan = loan;

  const d = document.getElementById("drawer");
  d.classList.add("open");

  document.getElementById("drawerTitle").textContent = loan.loanName;
  document.getElementById("drawerSub").textContent = loan.school;

  document.getElementById("drawerPurchasePrice").textContent =
    "$" + loan.purchasePrice.toLocaleString();

  document.getElementById("drawerRate").textContent =
    (loan.rate * 100).toFixed(2) + "%";

  document.getElementById("kpiDrawerContent").innerHTML = "";

  // ROI-to-Date
  const invested = loan.purchasePrice;
  const gained = loan.current.cumInterest;
  const roi = invested === 0 ? 0 : (gained / invested);

  document.getElementById("drawerROI").textContent =
    (roi * 100).toFixed(2) + "%";

  document.getElementById("drawerInterestEarned").textContent =
    "$" + gained.toFixed(2);

  // Draw chart + table
  drawDrawerLoanChart(loan);
  populateAmortTable(loan);
}


/* ============================================================
   KPI DRAWER (4 modes)
============================================================ */

document.querySelectorAll(".kpi-card").forEach(card => {
  card.addEventListener("click", () => openKpiDrawer(card.dataset.kpi));
});

function openKpiDrawer(type) {
  drawerMode = "kpi";
  activeLoan = null;

  const d = document.getElementById("drawer");
  d.classList.add("open");

  // Reset loan-only areas
  document.getElementById("drawerSub").textContent = "";
  document.getElementById("drawerPurchasePrice").textContent = "--";
  document.getElementById("drawerRate").textContent = "--";
  document.getElementById("drawerROI").textContent = "--";
  document.getElementById("drawerInterestEarned").textContent = "--";

  const k = computeKpis();
  const content = document.getElementById("kpiDrawerContent");
  content.innerHTML = "";

  if (type === "invested") {
    document.getElementById("drawerTitle").textContent = "Total Invested";
    content.innerHTML = `
      <div class="drawer-section-title">Portfolio Total</div>
      <p style="font-size:20px;font-weight:700;">$${k.totalInvested.toLocaleString()}</p>`;
    drawKpiInvestedChart();
  }

  if (type === "portval") {
    document.getElementById("drawerTitle").textContent = "Portfolio Value";
    content.innerHTML = `
      <div class="drawer-section-title">Current Portfolio Value</div>
      <p style="font-size:20px;font-weight:700;">$${k.portfolioValue.toLocaleString()}</p>`;
    drawKpiPortfolioChart();
  }

  if (type === "income") {
    document.getElementById("drawerTitle").textContent = "Expected Income";
    content.innerHTML = `
      <div class="drawer-section-title">Next Month Total Income</div>
      <p style="font-size:20px;font-weight:700;">$${k.nextMonthIncome.toFixed(2)}</p>`;
    drawKpiIncomeChart();
  }

  if (type === "yield") {
    document.getElementById("drawerTitle").textContent = "Annualized Yield";
    content.innerHTML = `
      <div class="drawer-section-title">Yield Calculation</div>
      <p style="font-size:20px;font-weight:700;">${(k.yieldAnnual*100).toFixed(2)}%</p>`;
    drawKpiYieldChart();
  }

  // Remove loan amort table for KPI mode
  document.querySelector("#drawerTable tbody").innerHTML = "";
}
</script>
<script>
/* ============================================================
   PART 3A â€” DRAWER CHARTS (Loan + KPI)
============================================================ */

/* Canvas helper */
function createHiDPICanvas(canvas) {
  const ctx = canvas.getContext("2d");
  const ratio = window.devicePixelRatio || 1;
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  canvas.width = w * ratio;
  canvas.height = h * ratio;
  ctx.scale(ratio, ratio);
  return ctx;
}

/* ============================================================
   LOAN DRAWER CHART
   (Balance, Cumulative Principal, Cumulative Interest)
============================================================ */
function drawDrawerLoanChart(loan) {
  const canvas = document.getElementById("drawerChart");
  const ctx = createHiDPICanvas(canvas);

  const sched = loan.amort.schedule;
  const months = sched.length - 1;
  const W = canvas.clientWidth;
  const H = canvas.clientHeight;

  ctx.clearRect(0,0,W,H);

  // Extract series
  const bal = sched.map(r => r.balance);
  const cp  = sched.map(r => r.cumPrincipal);
  const ci  = sched.map(r => r.cumInterest);

  const maxV = Math.max(
    Math.max(...bal),
    Math.max(...cp),
    Math.max(...ci)
  );
  const minV = 0;

  /* Scaling */
  function yScale(v) {
    return H - (v - minV) / (maxV - minV) * (H - 20) - 10;
  }
  function xScale(i) {
    return (i / months) * (W - 20) + 10;
  }

  // Draw grid lines
  ctx.strokeStyle = "var(--card-border)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  for (let i = 0; i <= 4; i++) {
    const y = (H/5)*i;
    ctx.moveTo(0, y);
    ctx.lineTo(W, y);
  }
  ctx.stroke();

  /* Line drawer */
  function drawLine(arr, color) {
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    arr.forEach((v,i) => {
      const x = xScale(i);
      const y = yScale(v);
      i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    });
    ctx.stroke();
  }

  // Draw all three
  drawLine(bal, "var(--chart-balance)");
  drawLine(cp,  "var(--chart-principal)");
  drawLine(ci,  "var(--chart-interest)");

  // Vertical today line
  const t = loan.todayIndex;
  const tx = xScale(t);
  ctx.strokeStyle = "var(--muted)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(tx, 0);
  ctx.lineTo(tx, H);
  ctx.stroke();
}


/* ============================================================
   KPI DRAWER CHARTS (simple clean style)
============================================================ */

/* Generic simple line chart */
function drawSimpleLineChart(values, color) {
  const canvas = document.getElementById("drawerChart");
  const ctx = createHiDPICanvas(canvas);

  const W = canvas.clientWidth;
  const H = canvas.clientHeight;

  ctx.clearRect(0,0,W,H);

  const maxV = Math.max(...values);
  const minV = Math.min(...values);

  function x(i){ return (i/(values.length-1)) * (W-20) + 10; }
  function y(v){ return H - ((v-minV)/(maxV-minV)) * (H-20) - 10; }

  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.beginPath();

  values.forEach((v,i)=>{
    const px = x(i);
    const py = y(v);
    i===0 ? ctx.moveTo(px,py) : ctx.lineTo(px,py);
  });
  ctx.stroke();
}

/* Generic simple bar chart */
function drawSimpleBarChart(values, color) {
  const canvas = document.getElementById("drawerChart");
  const ctx = createHiDPICanvas(canvas);

  const W = canvas.clientWidth;
  const H = canvas.clientHeight;

  ctx.clearRect(0,0,W,H);

  const maxV = Math.max(...values);
  const barW = (W - 40) / values.length;

  values.forEach((v,i)=>{
    const x = 20 + i*barW;
    const h = (v/maxV) * (H-20);
    ctx.fillStyle = color;
    ctx.fillRect(x, H-h, barW*0.8, h);
  });
}


/* ============================================================
   KPI CHART IMPLEMENTATIONS
============================================================ */

/* ---- 1. Total Invested ---- */
function drawKpiInvestedChart() {
  // Invested is static, chart it as a flat line for clarity
  const k = computeKpis();
  drawSimpleLineChart(Array(12).fill(k.totalInvested), "var(--chart-balance)");
}

/* ---- 2. Portfolio Value ---- */
function drawKpiPortfolioChart() {
  const months = Math.max(...amortLoans.map(l => l.amort.schedule.length));
  const values = [];

  for (let m = 0; m < months; m++) {
    let val = 0;
    amortLoans.forEach(l => {
      if (m < l.amort.schedule.length) {
        const r = l.amort.schedule[m];
        val += r.balance + r.cumPrincipal + r.cumInterest;
      }
    });
    values.push(val);
  }

  drawSimpleLineChart(values, "var(--chart-balance)");
}

/* ---- 3. Expected Income (Next-Month Sum) ---- */
function drawKpiIncomeChart() {
  const months = Math.max(...amortLoans.map(l => l.amort.schedule.length));
  const values = [];

  for (let m = 0; m < months; m++) {
    let pay = 0;
    amortLoans.forEach(l => {
      if (m < l.amort.schedule.length) {
        pay += l.amort.schedule[m].payment;
      }
    });
    values.push(pay);
  }

  drawSimpleBarChart(values, "var(--chart-principal)");
}

/* ---- 4. Yield ---- */
function drawKpiYieldChart() {
  const months = Math.max(...amortLoans.map(l => l.amort.schedule.length));
  const values = [];

  for (let m = 0; m < months; m++) {
    let totalInvested = amortLoans.reduce((s,l)=>s + l.purchasePrice,0);
    let intEarned = 0;

    amortLoans.forEach(l => {
      if (m < l.amort.schedule.length) {
        intEarned += l.amort.schedule[m].cumInterest;
      }
    });

    values.push(totalInvested===0?0:(intEarned/totalInvested));
  }

  drawSimpleLineChart(values.map(v=>v*100), "var(--chart-interest)");
}
</script>
<script>
/* ============================================================
   PART 3B â€” AMORT TABLE, CSV EXPORT, INIT PAGE
============================================================ */

/* -------------------------------
   Populate Amortization Table
-------------------------------- */
function populateAmortTable(loan) {
  const tbody = document.querySelector("#drawerTable tbody");
  tbody.innerHTML = "";

  loan.amort.schedule.forEach((r) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.monthIndex}</td>
      <td>$${r.payment.toFixed(2)}</td>
      <td>$${r.principalPaid.toFixed(2)}</td>
      <td>$${r.interest.toFixed(2)}</td>
      <td>$${r.balance.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });
}


/* ============================================================
   CSV EXPORT (Optional, Simple & Clean)
============================================================ */
function amortToCSV(loan) {
  const rows = [
    ["Month","Payment","Principal","Interest","Balance"]
  ];

  loan.amort.schedule.forEach(r => {
    rows.push([
      r.monthIndex,
      r.payment.toFixed(2),
      r.principalPaid.toFixed(2),
      r.interest.toFixed(2),
      r.balance.toFixed(2)
    ]);
  });

  return rows.map(r => r.join(",")).join("\n");
}

function exportActiveLoanCSV() {
  if (!activeLoan) {
    alert("Open a loan drawer first.");
    return;
  }

  const csv = amortToCSV(activeLoan);
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `${activeLoan.loanName}-amort.csv`;
  a.click();

  URL.revokeObjectURL(url);
}


/* ============================================================
   RESET DRAWER ON MODE SWITCH
============================================================ */
function clearDrawerChart() {
  const canvas = document.getElementById("drawerChart");
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);
}


/* ============================================================
   INIT PAGE
============================================================ */
async function initPage() {
  await loadLoans();
  buildAllAmort();
  renderLoanTiles();
  renderKpiTiles();

  // Drawer charts resize on window resize
  window.addEventListener("resize", () => {
    if (drawerMode === "loan" && activeLoan) {
      drawDrawerLoanChart(activeLoan);
    }
    if (drawerMode === "kpi") {
      // re-run the active KPI chart function
      const openType = document.getElementById("drawerTitle").textContent;
      if (openType === "Total Invested") drawKpiInvestedChart();
      if (openType === "Portfolio Value") drawKpiPortfolioChart();
      if (openType === "Expected Income") drawKpiIncomeChart();
      if (openType === "Annualized Yield") drawKpiYieldChart();
    }
  });
}

// Start app
initPage();

</script>
