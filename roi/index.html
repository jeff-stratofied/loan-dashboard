<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio ‚Äî ROI</title>

  <!-- ====================================
       Styles (organized, with dark mode)
       ==================================== -->
  <style>
  
:root {
  --bg:#f8fafc;
  --surface:#f1f5f9;
  --card:#ffffff;
  --border:#e2e8f0;
  --text:#0f172a;
  --muted:#64748b;

  --brand:#0ea5e9;
  --accent:#7c3aed;

  --shadow:0 12px 30px rgba(15,23,42,0.06);

  --page-gradient: linear-gradient(180deg, var(--surface), var(--bg));

  --chart-bg:linear-gradient(180deg,#ffffff,#fcfeff);
  --grad-top:#f1f5f9;
  --grad-bottom:#ffffff;

  --tooltip-bg:#0f172a;
  --tooltip-text:#f8fafc;

  --table-header:var(--surface);
  --table-border:rgba(148,163,184,0.35);
}

html {
  color-scheme: light;
}

html[data-theme="dark"] {
   color-scheme: dark; 
  --bg:#0f172a;
  --surface:#1e293b;
  --card:#1e293b;
  --border:#334155;
  --text:#f1f5f9;
  --muted:#94a3b8;

  --brand:#38bdf8;
  --accent:#c4b5fd;

  --grad-top:#1e293b;
  --grad-bottom:#0f172a;

  --shadow:rgba(0,0,0,0.45);

  --chart-bg:linear-gradient(180deg,#1e293b,#0f172a);

  --tooltip-bg:#0f172a;
  --tooltip-text:#f1f5f9;

  --table-header:#1e293b;
  --table-border:#334155;
}


.info-hover {
  display: inline-block;
  margin-left: 6px;
  font-size: 11px;
  cursor: help;
  color: var(--muted);
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 1px 5px;
  border-radius: 50%;
  line-height: 14px;
  text-align: center;
  transition: background-color .2s ease, color .2s ease, border-color .2s ease;
}

.info-hover:hover {
  color: var(--text);
  border-color: var(--text);
}

    
    /* Smooth theme transitions (copied from amortization page) */
    html, body,
    .app,
    header,
    .kpi, .tile,
    .drawer, .drawer-head, .drawer-body, .drawer-footer,
    .info-card, .drawer-chart,
    table, thead th, td,
    .tooltip,
    .theme-icon,
    svg text {
      transition:
    background-color .25s ease,
    color .25s ease,
    border-color .25s ease,
    box-shadow .25s ease,
    fill .25s ease;
    }

html,body{
  height:100%;
  margin:0;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  color:var(--text);
  -webkit-font-smoothing: antialiased;
}

.loan-filters {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: nowrap;
  justify-content: space-between;

  margin: 0 0 14px;   /* üîë MATCH AMORT SPACING */
}

.loan-filters > * {
  flex-shrink: 0;
}

    .loan-filters {
  font-weight: 500;
}


    /* Match Amort filter select styling */
.loan-filters select {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  font-size: 13px;
  font-weight: 500; /* üîë remove bold look */
}


  /* Compact view toggle */
.compact-toggle {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--muted);
  cursor: pointer;
  user-select: none;
}

/* =========================================
   Compact / Table toggle checkbox (Amort)
   ========================================= */
.compact-toggle input[type="checkbox"] {
  accent-color: var(--brand);
  color-scheme: light;   /* üîë forces white checkmark */
  cursor: pointer;
}


    
    .compact-toggle span {
  font-weight: 500;   /* match Amort */
}

    
/* Force layout to match Amort: body does NOT scroll */
html, body {
  height: 100%;
  overflow: hidden;
}

/* ROI matches Earnings:
   Page does NOT scroll; grid owns scrolling */
.app {
  height: 100%;
  overflow: hidden;
  background: var(--surface);
}

#app,
.app {
  background: var(--surface);
}



    
body{
  background: linear-gradient(180deg, var(--grad-top) 0%, var(--grad-bottom) 100%);
  background-color: var(--bg);
  transition: background-color .25s ease, color .25s ease;
}

/* Dark mode gradient (match Amort exactly) */
html[data-theme="dark"] body {
  background: linear-gradient(180deg,#0b1224 0%, #0f172a 100%);
}

    .app{
      max-width:1200px;
      margin:20px auto 0 auto;
      padding:16px 16px 0 16px;
    }

    /* Match amort layout */
    body > .app {
       background: transparent;
      padding-top: 16px;
      margin-top: 0;
    }


    header {
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:8px;   /* match amort */
      padding:0;           /* remove invisible offset */
    }

    .header-top{display:flex;align-items:center;justify-content:space-between}
    .header-controls {
      display:flex;
      gap:10px;
      align-items:center;
    }

/* =========================================
   Contextual Back Navigation (Reporting ‚Üí UI)
   ========================================= */

.back-row {
  margin-bottom: 6px;
}

.back-link {
  appearance: none;
  background: none;
  border: none;
  padding: 0;

  font-size: 13px;
  font-weight: 500;
  color: var(--muted);
  cursor: pointer;

  display: inline-flex;
  align-items: center;
  gap: 4px;

  transition: color 0.15s ease, transform 0.15s ease;
}

.back-link:hover {
  color: var(--brand);
  transform: translateX(-2px);
}

.back-link:focus-visible {
  outline: 2px solid var(--brand);
  outline-offset: 2px;
  border-radius: 4px;
}

/* Hidden unless explicitly enabled */
#backToHoldingsRow {
  display: none;
}

    
    h1{ font-size:20px; margin:0 }
    p.lead{ margin:0; color:var(--muted); font-size:13px }
    .current-date{ font-size:13px; color:var(--muted); margin-top:4px }
    

    
    /* =========================
       Buttons (unified with Amort Page)
       ========================= */
    .actions { display:flex; gap:8px; align-items:center }
    .btn{ padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:transparent; cursor:pointer; font-weight:600; color:var(--text); transition:background .2s ease, color .2s ease, border-color .2s ease }
    .btn.primary{
    background:var(--brand);
    color:white;
    border:none;
    box-shadow:var(--shadow);
  }

    .btn.secondary{ background:var(--surface); color:var(--text); }
    .close-btn{ background:var(--surface); border:1px solid var(--border); padding:8px; border-radius:8px; cursor:pointer; }
    .btn:hover, .close-btn:hover{ border-color:rgba(15,23,42,0.14); }

    /* =========================
       KPI row + tiles (unified hover)
       ========================= */
     .kpis {
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
      margin:14px 0 18px;
    }

  .kpi{
    background:var(--card);
    padding:12px;
    border-radius:10px;
    box-shadow:var(--shadow);
    border:1px solid var(--border);
    cursor:pointer;
    transition: transform .18s, box-shadow .18s,
              background-color .25s ease, color .25s ease,
              border-color .25s ease;
    }
  .kpi:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }

    /* KPI drawer table row hover (match Earnings) */
    #drawerExtra table tbody tr:hover {
      background: rgba(148, 163, 184, 0.12); /* same subtle gray */
    }


  .kpi h3 { margin:0; font-size:12px; color:var(--muted); }
  .kpi p  { margin:8px 0 0; font-size:18px; font-weight:700; }


/* ROI matches Earnings:
   Loan grid is the ONLY scroll container */
.grid {
  display: grid;
  grid-template-columns: repeat(2,1fr);
  grid-auto-rows: min-content;
  gap: 12px;

  height: calc(100vh - 320px);
  overflow-y: auto;
  overflow-x: hidden;

  padding-right: 6px;
}


    /* =========================
   Compact loan tiles
   ========================= */
.grid.compact .tile {
  min-height: 64px;           /* ~¬Ω current height */
  padding: 8px 10px;
}

.grid.compact .tile-left {
  padding-right: 0;
}

.grid.compact .loan-sub,
.grid.compact .loan-meta {
  display: none;              /* hide details */
}

.grid.compact .chart-wrap svg {
  display: none;              /* hide sparkline */
}

.grid.compact .chart-wrap {
  width: auto;
}

.grid.compact .mini-label {
  margin: 0;
  font-weight: 700;
  font-size: 13px;
}
.grid.compact .loan-name {
  font-size: 13px;
}

    
  
    @media(max-width:900px){ .grid{ grid-template-columns:1fr; height:auto } .kpis{ grid-template-columns:repeat(2,1fr) } }

    /* =========================================
   Loan event badges (ROI tiles)
   ========================================= */
.loan-badges {
  display: flex;
  gap: 6px;
  margin-top: 6px;
  flex-wrap: wrap;
}

.loan-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 6px;
  font-size: 11px;
  font-weight: 600;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
}

.loan-badge.default {
  background: rgba(239, 68, 68, 0.15);
  color: #b91c1c;
  border-color: rgba(239, 68, 68, 0.35);
}

.loan-badge.deferral {
  background: rgba(234, 179, 8, 0.18);
  color: #92400e;
  border-color: rgba(234, 179, 8, 0.35);
}

.loan-badge.prepayment {
  background: rgba(34, 197, 94, 0.18);
  color: #166534;
  border-color: rgba(34, 197, 94, 0.35);
}


.badge-tooltip {
  position: absolute;
  background: var(--tooltip-bg);
  color: var(--tooltip-text);
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 12px;
  line-height: 1.3;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s ease;
  z-index: 2000;  
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transform: translateY(-8px);
}

    
.badge-tooltip.visible {
  opacity: 1;
}

    
/* MATCH AMORT TILE HOVER BEHAVIOR */
.tile {
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  border-radius:12px;
  background:var(--card);
  min-height:110px;
  cursor:pointer;
  overflow:hidden;
  border:1px solid var(--border);
  transition: transform .18s ease, box-shadow .18s ease, background-color .25s ease, color .25s ease, border-color .25s ease;
}

.tile:hover {
  transform: translateY(-6px);
  box-shadow: var(--shadow);
}

    .tile-left{ flex:1; padding-right:10px }
    .loan-name{ font-weight:700; font-size:14px }
    .loan-sub{ font-size:12px; color:var(--muted); margin-top:6px }
    .loan-meta{ display:flex; gap:8px; font-size:12px; color:var(--muted); margin-top:8px }

    .chart-wrap{ width:170px; flex-shrink:0; display:flex; flex-direction:column; align-items:flex-end }
    .mini-label{ font-size:12px; color:var(--muted); margin-bottom:6px }
    svg.sparkline{ width:170px; height:48px; display:block }

/* ============================================
   DRAWER (copied from amort, widened for ROI)
   ============================================ */
.drawer{
  position:fixed;
  right:0;
  top:0;
  height:100vh;
  max-width:760px;
  width:760px;
  background:var(--card);
  border-left:1px solid var(--border);
  box-shadow:-28px 0 80px var(--drawer-shadow);
  transform:translateX(110%);
  transition:transform .28s cubic-bezier(.2,.9,.3,1),
             background-color .25s ease, color .25s ease,
             border-color .25s ease, box-shadow .25s ease;
  display:flex;
  flex-direction:column;
  z-index:120;
}
.drawer.open{ transform:translateX(0); }

.drawer-head{
  padding:20px;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:8px;
  background:var(--card);   /* MATCH AMORT */
  border-bottom:1px solid var(--border);
}

.drawer-body,
#drawerBody{
  flex: 1 1 auto;
  overflow-y: auto;
  overflow-x: hidden !important;
  padding: 0 20px 20px;   /* KEY: no top padding */
  display: flex;
  flex-direction: column;
  gap: 20px;
}


.drawer-footer{
  padding:20px;
  border-top:1px solid var(--border);
  background:var(--surface);
}

.drawer-footer .actions{
  justify-content:flex-start;
}

/* Chart box */
.drawer-chart{
  height:260px;
  background:var(--chart-bg);
  border-radius:8px;
  border:1px solid rgba(15,23,42,0.06);
  display:block;
  position:relative;
  padding:8px;
  margin-bottom:12px;
  box-shadow:0 6px 18px rgba(15,23,42,0.06);
}

/* Legend same as amort */
.legend{
  display:flex;
  gap:10px;
  align-items:center;
  font-size:12px;
  margin-top:6px;
}

/* Dark theme behavior */
html[data-theme="dark"] .drawer{
  background:var(--drawer-bg);
  border-left:1px solid var(--border);
  box-shadow:-28px 0 80px var(--drawer-shadow);
}
html[data-theme="dark"] .drawer-chart{
  border-color:var(--border);
}

    .drawer h2 {
  margin: 0 0 6px;
  font-size: 20px;
  font-weight: 600;
}

.drawer .muted {
  font-size: 13px;
  margin-bottom: 10px;
  line-height: 1.25;
}


    /* Drawer info row */
    .drawer-info-row { display:flex; gap:12px; margin-bottom:8px; align-items:center }
    .info-card{ flex:1; background:var(--bg); padding:12px; border-radius:8px; display:flex; flex-direction:column; justify-content:center; min-height:56px; border:1px solid var(--border) }
    .info-card.small{ width:160px; align-items:flex-end }
    .muted-small{ font-size:12px; color:var(--muted); margin-bottom:6px }
    .main-val{ font-weight:800; font-size:18px }

    .amort-wrap{ border:1px solid var(--border); border-radius:8px; padding:8px; max-height:40vh; overflow:auto; background:var(--card) }
    table{ width:100%; border-collapse:collapse; font-size:13px; background:var(--card); }
    thead th{ position:sticky; top:0; background:var(--table-header); padding:8px; text-align:left; color:var(--muted); font-weight:700; border-bottom:1px solid var(--table-border) }
    td{ padding:8px; border-bottom:1px dashed var(--table-border); text-align:right }
    td:first-child, th:first-child{ text-align:left }

/* =========================================
   ROI table event highlights (MATCH AMORT)
   ========================================= */
tr.event-prepayment td {
  background: rgba(34, 197, 94, 0.16);
}

tr.event-deferral td {
  background: rgba(234, 179, 8, 0.20);
}

tr.event-default td {
  background: rgba(239, 68, 68, 0.20);
  font-weight: 600;
}

    
  .tooltip{
    position:fixed;
    pointer-events:none;
    background:var(--tooltip-bg);
    color:var(--tooltip-text);
    padding:6px 8px;
    border-radius:6px;
    font-size:12px;
    transform:translate(-50%,-120%);
    box-shadow:0 6px 18px rgba(2,6,23,0.2);
    display:none;
    z-index:9999;
    line-height:1.12;
    border:1px solid rgba(148,163,184,0.3);
    transition:background-color .25s ease, color .25s ease,
             border-color .25s ease, box-shadow .25s ease;
    }

    .small{ font-size:12px; color:var(--muted) }

    /* tiny responsive tweaks */
    @media(max-width:760px){
      .drawer{ width:100%; min-width:0; }
      .kpis{ grid-template-columns:repeat(2,1fr) }
    }

    /* Theme toggle icon */
  .theme-icon {
    width:38px;
    height:38px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:12px;
    border:1px solid var(--border);
    background:var(--card);
    color:var(--text);
    cursor:pointer;
    font-size:16px;
    transition:background .2s ease, color .2s ease, 
             border-color .2s ease, transform .15s ease;
    box-shadow:0 8px 18px rgba(15,23,42,0.06);
    }
  .theme-icon:hover{
    transform:translateY(-1px);
    border-color:rgba(15,23,42,0.14);
    }

        /* ============================================================
   EMBED MODE ‚Äî UNIFIED DRAWER LAYOUT (ALIGN ALL IFRAMES)
   ============================================================ */

.embed-mode .drawer-head {
  padding: 20px !important;
  min-height: 64px;
  border-bottom: 1px solid var(--border);
  background: var(--card);
}

/* Chart: same height everywhere */
.embed-mode .drawer-chart {
  height: 220px !important;
  margin-bottom: 12px !important;
}

/* Stat boxes row */
.embed-mode .stat-boxes,
.embed-mode .drawer-info-row {
  margin-bottom: 12px !important;
  min-height: 56px;
}
 
/* Drawer body spacing */
.embed-mode .drawer-body {
  gap: 12px !important;
  padding-left: 16px !important;
  padding-right: 16px !important;
}

/* Table container */
.embed-mode .amort-wrap {
  max-height: 40vh !important;
}

    /* ============================================================
   EMBED MODE ‚Äî ALIGN CHART START TO EARNINGS
   ============================================================ */

/* Remove any spacer before the chart */
.embed-mode .drawer-body {
  padding-top: 0 !important;
}

/* Kill gap stacking before first block */
.embed-mode .drawer-body > * {
  margin-top: 0 !important;
}

/* Remove legend completely from flow */
.embed-mode .legend,
.embed-mode #drawerLegend {
  display: none !important;
  height: 0 !important;
  margin: 0 !important;
}

    /* Chart must behave like earnings */
.embed-mode .drawer-chart {
  display: block !important;
  padding: 8px !important;
  margin-top: 0 !important;
}

    /* Ensure chart is always first */
.embed-mode .drawer-chart {
  order: 0;
}

.embed-mode .drawer-info-row,
.embed-mode .stat-boxes,
.embed-mode #drawerExtra {
  order: 1;
}

    /* ============================================================
   EMBED MODE ‚Äî UNIFIED LAYOUT (ALIGN WITH EARNINGS & AMORT)
   ============================================================ */

.embed-mode .drawer-head {
  padding: 20px !important;
  min-height: 64px !important;
  border-bottom: 1px solid var(--border) !important;
  background: var(--card) !important;
  flex-shrink: 0 !important;
}

.embed-mode .drawer-body {
  padding: 0 20px 20px !important;
  display: flex !important;
  flex-direction: column !important;
  gap: 20px !important;
  flex: 1 1 auto !important;
  overflow-y: auto !important;
}

.embed-mode .drawer-chart {
  height: 240px !important;
  margin: 0 !important;
  padding: 8px !important;
  order: 0 !important;
  background: var(--chart-bg) !important;
}

.embed-mode .drawer-info-row {
  margin: 0 !important;
  min-height: 56px !important;
  order: 1 !important;
}

.embed-mode .legend {
  display: none !important;
}

.embed-mode .drawer-footer {
  display: none !important;
}

.embed-mode .drawer-body > * {
  margin-top: 0 !important;
}


.badge-tooltip {
  position: fixed !important;  /* Change from absolute to fixed to avoid clipping */
  z-index: 10000 !important;   /* Higher than .drawer (120) and other elements */
  transform: none !important;  /* Remove translateY; we'll handle in JS */
  white-space: pre-wrap;       /* Allow wrapping if text is long */
}

.badge-tooltip.visible {
  opacity: 1 !important;
}

    #feedback-btn {
  position: fixed;
  bottom: 18px;
  right: 18px;
  z-index: 9999;

  width: 44px;
  height: 44px;
  border-radius: 999px;

  background: var(--card);
  border: 1px solid var(--border);
  color: var(--text);

  box-shadow: var(--shadow);
  cursor: pointer;
  font-size: 20px;
}


    
    /* ROI iframe: grid must size naturally below KPIs */
.embed-mode .grid {
  height: auto !important;
  max-height: none !important;
  flex: 1 1 auto;
}

    
    .embed-mode .grid {
  overflow-y: auto;
}

    /* üîë ROI iframe MUST allow page scroll */
.embed-mode html,
.embed-mode body {
  overflow: auto !important;
  height: auto !important;
}

.embed-mode .grid {
  height: auto !important;
  max-height: none !important;
  overflow-y: visible !important;
}

/* ============================================================
   EMBED MODE ‚Äî KPI + DRAWER STACK (CANONICAL)
   ============================================================ */

/* KPIs must be visible and above drawer */
.embed-mode .kpis {
  display: grid !important;
  order: 0 !important;
  margin-top: 8px !important;
  margin-bottom: 12px !important;
  flex-shrink: 0;
  position: relative;
  z-index: 1;
}

/* Drawer follows KPIs and re-enters document flow */
.embed-mode .drawer {
  order: 1 !important;

  position: relative !important;
  top: auto !important;
  right: auto !important;
  left: auto !important;

  width: 100% !important;
  max-width: none !important;

  height: auto !important;
  min-height: 0 !important;
  max-height: none !important;

  transform: none !important;
}

/* App becomes vertical stack that sizes to content */
.embed-mode .app {
  display: flex !important;
  flex-direction: column !important;

  height: auto !important;
  min-height: 0 !important;
  overflow: visible !important;
}

    
/* Hide entire header in embed mode to remove filters, title, and date */
.embed-mode header {
  display: none !important;
}

.loan-table-wrap {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: var(--shadow);

  padding: 8px 8px 0 8px;
  margin-bottom: 12px;

  max-height: calc(100vh - 320px); /* SAME logic as grid */
  overflow-y: auto;
  overflow-x: auto;
}


#loanTable {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

#loanTable th {
  cursor: pointer;
  user-select: none;
  position: sticky;
  top: 0;
  background: var(--table-header);
}

#loanTable th::after {
  content: " ‚Üï";
  opacity: 0.35;
  font-size: 11px;
}

    #loanTable th[data-sort="asc"]::after { content: " ‚Üë"; opacity: 0.75; }
#loanTable th[data-sort="desc"]::after { content: " ‚Üì"; opacity: 0.75; }

    
#loanTable td,
#loanTable th {
  padding: 8px;
  border-bottom: 1px solid var(--border);
}

/* =========================================
   Loan table row hover (MATCH AMORT)
   ========================================= */
#loanTable tbody tr.row-hover {
  background: rgba(148, 163, 184, 0.12);
}
#loanTable tbody tr {
  cursor: pointer;
}
    
.table-actions {
  display: flex;
  gap: 6px;
}

/* =================================================
   FORCE checkbox checkmark to match AMORT (ROI FIX)
   ================================================= */
.compact-toggle input[type="checkbox"] {
  accent-color: var(--brand);
  color-scheme: light !important;  /* üîë override html[data-theme] */
}

    
#feedback-btn:hover {
  transform: scale(1.05);
}

    
  </style>
</head>
<body>
  <div class="app" role="main">

      <!-- Header here -->
  <header>
      <!-- Contextual back navigation -->
  <div class="back-row" id="backToHoldingsRow">
    <button class="back-link" id="backToHoldingsBtn" type="button">
      ‚Üê Back to My Holdings
    </button>
  </div>

    <div class="header-top">
      <div>
        <h1>Loan Portfolio ‚Äî ROI</h1>
       <p class="lead">
    ROI to Date = (Loan Value Today ‚Äì Purchase Price) / Purchase Price
    <span class="info-hover" title="ROI to Date measures your current return up to the current month. It includes all principal and interest already received, minus fees, plus the Mark-to-Market discounted value (95%) of the outstanding loan balance.">‚ìò</span>
    </p>

    <p class="lead">
    Projected ROI = (Final Loan Value ‚Äì Purchase Price) / Purchase Price
    <span class="info-hover" title="Projected ROI measures the total return expected if the loan performs as scheduled through maturity. It uses the full amortization schedule of principal, interest, and fees.">‚ìò</span>
    </p>
      </div>
  
      <div class="header-controls">
        <div style="font-size:13px;color:var(--muted)">
          Name: <strong id="currentUserLabel" style="color:var(--brand)"></strong>
        </div>
        <button id="themeToggle" class="theme-icon" title="Toggle dark mode">üåô</button>
      </div>
    </div>

    <div class="current-date" id="currentDateLabel">
      Current Date: <span id="currentDate"></span>
    </div>
  </header>



    <!-- KPI Row -->
   <section class="kpis" id="kpis"></section>
  
  <!-- Loan Filters -->
<section class="loan-filters" id="loanFilters">
  <select id="filterName">
    <option value="">All loan names</option>
  </select>

  <select id="filterSchool">
    <option value="">All schools</option>
  </select>

  <select id="filterRate">
    <option value="">All interest rates</option>
    <option value="low">Below 5%</option>
    <option value="mid">5% ‚Äì 8%</option>
    <option value="high">Above 8%</option>
  </select>

  <!-- üîΩ ADD SORT HERE -->
  <select id="sortLoans">
    <option value="purchase_asc">Purchase date ‚Üë</option>
    <option value="purchase_desc">Purchase date ‚Üì</option>
    <option value="start_asc">Loan start date ‚Üë</option>
    <option value="start_desc">Loan start date ‚Üì</option>
    <option value="amount_asc">Orig amount ‚Üë</option>
    <option value="amount_desc">Orig amount ‚Üì</option>
    <option value="rate_asc">Interest rate ‚Üë</option>
    <option value="rate_desc">Interest rate ‚Üì</option>
  </select>

<label class="compact-toggle">
  <input type="checkbox" id="toggleCompact" />
  <span>Compact</span>
</label>
  
  <button class="btn secondary" id="resetFilters">Reset filters</button>

<label class="compact-toggle">
  <input type="checkbox" id="toggleTableView" />
  <span>Table View</span>
</label>

<div class="table-actions">
  <button class="btn" id="downloadAllCsvBtn">Download CSV</button>
  <button class="btn" id="copyAllCsvBtn">Copy CSV</button>
  <button class="btn" id="printAllBtn">Print</button>
</div>
  
</section>

  
  <!-- Loan grid -->
  <section class="grid" id="loanGrid"></section>


    <section id="loanTableWrap" class="loan-table-wrap" hidden>
  <table id="loanTable">
    <thead>
      <tr>
        <!-- üîë ROI instead of Balance -->
        <th data-key="loanId">ID</th>
        <th data-key="loanName">Loan Name</th>
        <th data-key="school">School</th>
        <th data-key="loanStartDate">Loan Start</th>
        <th data-key="purchaseDate">Purchase Date</th>
        <th data-key="principal">Orig Amt</th>
        <th data-key="purchasePrice">Purchase Price</th>
        <th data-key="nominalRate">Rate</th>
        <th data-key="termYears">Term</th>
        <th data-key="graceYears">Grace</th>
        <th data-key="roiToDate">ROI</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

  
    <!-- Drawer -->
   <aside id="drawer" class="drawer" aria-hidden="true">

  
   <div class="drawer-head">
  <div>
    <h2 id="drawerTitle"></h2>
    <div class="muted" id="drawerSub"></div>
  </div>

  <div style="display:flex;gap:8px;align-items:center">
    <button class="btn" id="downloadCsvBtn">Download CSV</button>
    <button class="close-btn" id="closeBtn">‚úï</button>
  </div>
</div>

  

  <div id="drawerBody" class="drawer-body">

    <!-- Chart container (matches amort exactly) -->
    <div class="drawer-chart">
      <div id="drawerChartArea" style="width:100%;height:100%;"></div>
    </div>
    <div class="legend" id="drawerLegend" style="display:none"></div>

   <!-- Correct Primary / Secondary cards block (matches amort exactly) -->
<div style="display:flex; gap:10px; margin-bottom:12px;">

  <div style="
    flex:1;
    background:var(--surface);
    padding:10px;
    border-radius:8px;
    border:1px solid var(--border);
  ">
    <div class="muted-small" id="drawerPrimaryTitle"></div>
    <div class="main-val" id="drawerPrimary"></div>
  </div>

  <div style="
    width:120px;
    background:var(--surface);
    padding:10px;
    border-radius:8px;
    border:1px solid var(--border);
  ">
    <div class="muted-small" id="drawerSecondaryTitle"></div>
    <div class="main-val" id="drawerSecondary"></div>
  </div>

</div>

    <!-- For KPI drawers or custom loan content -->
    <div id="drawerExtra"></div>

    <!-- The ROI table wrapper -->
    <div id="drawerAmortContainer">

      <div class="amort-wrap" id="amortWrap">
        <table>
          <thead>
            <tr>
              <th>Month</th>
              <th>Balance</th>
              <th>Loan Value</th>
              <th>ROI</th>
            </tr>
          </thead>
          <tbody id="amortBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <div class="drawer-footer">
    <div class="actions">
      <button class="btn" id="printBtn">Print</button>
      <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
    </div>
  </div>

</aside>


  <div id="tooltip" class="tooltip" role="status" aria-live="polite"></div>

  <!-- ====================================
       Script (organized with sections)
       ==================================== -->
  <script type="module">
    import { buildAmortSchedule } from "../js/loanEngine.js?v=dev";
    import { buildProjectedRoiTimeline } from "../js/roiEngine.js?v=dev";


window.__closeDrawerTimer = null;

const PAGE_CONTEXT = (() => {
  const p = new URLSearchParams(window.location.search);
  return {
    isEmbed: p.get("embed") === "true",
    open: p.get("open"),
    fromReporting: p.get("from") === "reporting"
  };
})();

    // üîí EMBED MODE OVERRIDES ‚Äî MATCH AMORT
if (PAGE_CONTEXT.isEmbed) {
  // Table view is a full-page feature ONLY
  localStorage.removeItem("roiTableView");

  const toggle = document.getElementById("toggleTableView");
  if (toggle) toggle.checked = false;
}

    
  const PAGE_USER =
  new URLSearchParams(window.location.search).get("user") || "jeff";

    // =========================================
// Back to My Holdings (Reporting context)
// =========================================
const params = new URLSearchParams(window.location.search);
const cameFromReporting = params.get("from") === "reporting";

const backRow = document.getElementById("backToHoldingsRow");
const backBtn = document.getElementById("backToHoldingsBtn");

if (cameFromReporting && backRow && backBtn) {
  backRow.style.display = "block";

  backBtn.addEventListener("click", () => {
    window.location.href =
      `/loan-dashboard/reporting?user=${PAGE_USER}`;
  });
}


    const USER_LABELS = {
  jeff: "Jeff Customer",
  nick: "Nick Lender",
  john: "John Investor"
};

    function formatMonthYear(date) {
      return date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "short"
      });
    }

function formatCurrency(val) {
  return Number(val ?? 0).toLocaleString("en-US", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

function parseISODateLocal(iso) {
  if (!iso) return null;
  const [y, m, d] = iso.split("-").map(Number);
  return new Date(y, m - 1, d);
}


function monthAnchor(date) {
  return new Date(date.getFullYear(), date.getMonth(), 1);
}

function buildGlobalDatesFromLoans(loans) {
  const dates = new Set();

  loans.forEach(loan => {
    if (!Array.isArray(loan.roiSeries)) return;

    loan.roiSeries.forEach(p => {
      if (p.date instanceof Date && !isNaN(+p.date)) {
        dates.add(p.date.getTime());
      }
    });
  });

  return Array.from(dates)
    .sort((a, b) => a - b)
    .map(ms => new Date(ms));
}

    
function createBadgeTooltip(badge, text) {
  const tooltip = document.createElement('div');
  tooltip.className = 'badge-tooltip';
  tooltip.textContent = text;
  document.body.appendChild(tooltip);  // Append to body to escape clipping

  badge.addEventListener('mouseenter', (e) => {
    const badgeRect = badge.getBoundingClientRect();
    const tooltipRect = tooltip.getBoundingClientRect();
    const margin = 8;  // Space above badge

    // Position above the badge, centered horizontally
    let left = badgeRect.left + (badgeRect.width / 2) - (tooltipRect.width / 2);
    let top = badgeRect.top - tooltipRect.height - margin;

    // Clamp to viewport (prevent off-screen)
    left = Math.max(0, Math.min(left, window.innerWidth - tooltipRect.width));
    top = Math.max(0, top);  // Don't go above top edge

    tooltip.style.left = `${left}px`;
    tooltip.style.top = `${top}px`;
    tooltip.classList.add('visible');
  });

  badge.addEventListener('mouseleave', () => {
    tooltip.classList.remove('visible');
  });

  // Clean up on removal (optional, but good practice)
  badge.addEventListener('remove', () => tooltip.remove());
}

 
  function getLoanMaturityFromAmort(loan) {
  if (!loan.amort || !loan.amort.schedule || !loan.amort.schedule.length) {
    return null;
  }

  const lastRow = loan.amort.schedule[loan.amort.schedule.length - 1];
  return lastRow.loanDate ? new Date(lastRow.loanDate) : null;
}

    
    function monthDiff(d1, d2) {
      return (d2.getFullYear() - d1.getFullYear()) * 12 +
             (d2.getMonth() - d1.getMonth());
    }


function getLoanEventBadges(loan) {
  const badges = [];
  if (!Array.isArray(loan.events) || loan.events.length === 0) return badges;

  const types = new Set(loan.events.map(e => e.type));

  if (types.has("prepayment")) {
    badges.push({
      type: "prepayment",
      label: "üí∞ Prepay"
    });
  }

  if (types.has("deferral")) {
    badges.push({
      type: "deferral",
      label: "‚è∏ Deferral"
    });
  }

  if (types.has("default")) {
    badges.push({
      type: "default",
      label: "‚ö†Ô∏è Default"
    });
  }

  return badges;
}

// ----------------------------------
// Badge tooltip text (ROI tiles)
// ----------------------------------
function getBadgeTooltipText(loan, badgeType) {
  if (!Array.isArray(loan.events)) return "";

  const event = loan.events.find(e => e.type === badgeType);
  if (!event) return "";

  // PREPAYMENT
  if (badgeType === "prepayment") {
    const amt =
      event.amount != null
        ? `$${formatCurrency(event.amount)}`
        : "$0";

    const d = parseISODateLocal(event.date);
    const dateLabel = d ? formatMonthYear(d) : "";

    return `Prepayment: ${amt} ¬∑ ${dateLabel}`;
  }

  // DEFERRAL
  if (badgeType === "deferral") {
    const start = parseISODateLocal(event.startDate || event.date);
    const months =
      event.months ?? event.durationMonths ?? 0;

    return `Deferral: ${start ? formatMonthYear(start) : ""} ¬∑ ${months} Months`;
  }

  // DEFAULT
  if (badgeType === "default") {
    const d = parseISODateLocal(event.date);
    const recovered =
      event.recoveredAmount != null
        ? `$${formatCurrency(event.recoveredAmount)}`
        : "$0";

    return `Default: ${d ? formatMonthYear(d) : ""} ¬∑ Recovered Amount ${recovered}`;
  }

  return "";
}

    
function getEventRowClass(loan, row) {  
  if (!row) return "";

  // ----------------------------------
  // DEFERRAL ‚Äî authoritative from engine
  // ----------------------------------
  if (row.isOwned && row.isDeferred === true) {
    return "event-deferral";
  }

  // ----------------------------------
  // DEFAULT ‚Äî authoritative terminal row
  // ----------------------------------
  if (row.isTerminal === true) {
    return "event-default";
  }

// ----------------------------------
// PREPAYMENT (month-based, non-terminal)
// ----------------------------------
if (Array.isArray(loan.events)) {
  const rowDate = row.loanDate;
  if (!rowDate) return "";

  const rowKey = rowDate.getFullYear() * 12 + rowDate.getMonth();

  for (const e of loan.events) {
    if (e.type !== "prepayment" || !e.date) continue;

    const dLocal = parseISODateLocal(e.date);
    if (!dLocal || isNaN(+dLocal)) continue;

    const eventKey =
      dLocal.getFullYear() * 12 + dLocal.getMonth();

    if (rowKey === eventKey) {
      return "event-prepayment";
    }
  }
}



  return "";
}


    // ----------------------------
    // Bind current user label
    // ----------------------------
    document.getElementById("currentUserLabel").textContent =
      USER_LABELS[PAGE_USER] || "Unknown User";
        
    /* -------------------------
       Settings & data
       ------------------------- */
// Dynamic loans loaded from backend
let loans = [];
let allLoans = [];        // üîë ADD THIS
let currentLoans = [];

let TABLE_SORT = { key: null, dir: 1 };
let currentMode = "kpi";   // üîë ROI defaults to KPI mode
let currentLoan = null;   // üîë active loan for drawer
let filteredLoans = [];
let DATA_READY = false;

    // =====================================================
// Loan Table ‚Äî Sorted view (MATCH AMORT)
// =====================================================
function getLoansForTableView() {
  if (!TABLE_SORT.key) return currentLoans;

  const { key, dir } = TABLE_SORT;
  return currentLoans
    .slice()
    .sort((a, b) => dir * compareForKey(a, b, key));
}

    function compareForKey(a, b, key) {
  const va = a?.[key];
  const vb = b?.[key];

  // dates
  if (key === "loanStartDate" || key === "purchaseDate") {
    const da = va ? new Date(va).getTime() : 0;
    const db = vb ? new Date(vb).getTime() : 0;
    return da - db;
  }

  // strings
  if (typeof va === "string" || typeof vb === "string") {
    return String(va ?? "").localeCompare(String(vb ?? ""), undefined, { numeric: true, sensitivity: "base" });
  }

  // numbers (incl balance)
  return (Number(va) || 0) - (Number(vb) || 0);
}

function openLoanDrawerSafe(loan) {

  currentMode = "loan";
  currentLoan = loan;

  openDrawerForLoan(loan);
}

// =====================================================
// KPI DRAWER RENDERER ‚Äî ROI (MISSING, REQUIRED)
// =====================================================
function renderKpiDrawer(kpiId) {
  const kpis = computeKPIs(allLoans);

  drawerTitle.textContent = "";
  drawerSub.textContent = "";

  drawerLegend.style.display = "none";
  drawerAmortContainer.style.display = "none";

  // Clear chart + extra
  drawerChartArea.innerHTML = "";
  drawerExtra.innerHTML = "";

  // -------------------------
  // KPI SWITCH
  // -------------------------
  if (kpiId === "kpi1") {
    drawerTitle.textContent = "Weighted ROI to Date";
    drawerPrimaryTitle.textContent = "ROI to Date";
    drawerPrimary.textContent =
      (kpis.weightedROI * 100).toFixed(2) + "%";

    drawerSecondaryTitle.textContent = "As of";
    drawerSecondary.textContent =
      formatMonthYear(KPI_CURRENT_MONTH);
  }

  else if (kpiId === "kpi2") {
    drawerTitle.textContent = "Projected Portfolio ROI";
    drawerPrimaryTitle.textContent = "Projected ROI";
    drawerPrimary.textContent =
      (kpis.projectedWeightedROI * 100).toFixed(2) + "%";

    drawerSecondaryTitle.textContent = "Lifetime";
    drawerSecondary.textContent = "All Loans";
  }

// =====================================================
// KPI2 ‚Äî Projected Portfolio ROI chart (FIX COLORS)
// =====================================================

// 1) Build deterministic color map
const colorMap = buildKpiColorMap(allLoans);

// 2) Build per-loan series WITH color
const loanSeriesList = allLoans.map(l => ({
  id: l.id,
  color: colorMap[l.id],   // üîë THIS IS THE FIX
  data: l.roiSeries.map(p => ({
    x: p.date,
    y: p.roi
  }))
}));

// 3) Build weighted portfolio series
const weightedSeries = buildProjectedRoiTimeline(allLoans);

// 4) Shared date axis
const dates = buildGlobalDatesFromLoans(allLoans);

// 5) Render chart
createMultiSeriesChart(
  drawerChartArea,
  loanSeriesList,
  weightedSeries,
  { dates }
);

    
  else if (kpiId === "kpi3") {
    drawerTitle.textContent = "Capital Recovered";
    drawerPrimaryTitle.textContent = "Recovered";
    drawerPrimary.textContent =
      "$" + formatCurrency(kpis.capitalRecoveredAmount);

    drawerSecondaryTitle.textContent = "Recovery %";
    drawerSecondary.textContent =
      (kpis.capitalRecoveryPct * 100).toFixed(1) + "%";
  }

  else {
    console.warn("Unknown KPI:", kpiId);
  }
}


    
 // =====================================================
// KPI DRAWER OPEN ‚Äî ROI (REQUIRED FOR EMBED)
// =====================================================
function openRoiKpiDrawer(kpiId) {
  currentMode = "kpi";
  currentLoan = null;

  // Hide loan-only UI
  drawerAmortContainer.style.display = "none";
  drawerLegend.style.display = "none";
  drawerExtra.innerHTML = "";

  // Delegate to existing KPI renderer
  renderKpiDrawer(kpiId);

  drawer.classList.add("open");
  drawer.setAttribute("aria-hidden", "false");
  drawer.scrollTop = 0;
}

/* ============================
   KPI deep-link router (ROI)
   ============================ */
function openRoiKpiFromUrl(kpiOverride = null) {

  console.log(
    "%c[ROUTER ENTER]",
    "color:#3b82f6;font-weight:bold",
    {
      kpiOverride,
      urlOpen: new URLSearchParams(window.location.search).get("open"),
      currentMode
    }
  );

  let kpi =
    kpiOverride ??
    new URLSearchParams(window.location.search).get("open");

  if (!kpi) return;

  // =====================================================
  // üîë FIX: normalize legacy KPI ids (reporting iframe)
  // =====================================================
  const KPI_ALIAS_MAP = {
    kpi1: "tpv",
    kpi2: "rates",
    kpi3: "capitalRecovery",
    kpi4: "spread"
  };

  if (KPI_ALIAS_MAP[kpi]) {
    console.log(
      `%c[KPI ALIAS] ${kpi} ‚Üí ${KPI_ALIAS_MAP[kpi]}`,
      "color:#22c55e;font-weight:bold"
    );
    kpi = KPI_ALIAS_MAP[kpi];
  }

  currentMode = "kpi";
  currentLoan = null;

  drawer.classList.remove("loan-mode");
  drawerAmortContainer.style.display = "none";
  drawerLegend.style.display = "none";
  drawerExtra.innerHTML = "";

  switch (kpi) {
    case "tpv":
      console.log("%c[ROUTER ‚Üí TPV]", "color:#eab308;font-weight:bold");
      renderTPVDrawer();
      break;
    case "rates":
      console.log("%c[ROUTER ‚Üí Rates]", "color:#eab308;font-weight:bold");
      renderRatesDrawer();
      break;
    case "capitalRecovery":
      console.log("%c[ROUTER ‚Üí CapRecov]", "color:#eab308;font-weight:bold");
      renderCapitalRecoveryDrawer();
      break;
    case "spread":
      console.log("%c[ROUTER ‚Üí spread]", "color:#eab308;font-weight:bold");
      renderROISpreadDrawer();
      break;
    default:
      console.warn("Unknown ROI KPI:", kpi);
      return;
  }

  drawer.classList.add("open");
  drawer.setAttribute("aria-hidden", "false");

  // üîë FORCE VISIBILITY (ROI KPI FIX)
  if (!PAGE_CONTEXT.isEmbed) {
    forceDrawerVisible();
  }

  drawer.scrollTop = 0;

  requestAnimationFrame(() => {
    console.log(
      "[POST-FORCE]",
      getComputedStyle(drawer).transform
    );
  });
}



    
async function loadLoans() {
  const res = await fetch("https://loan-dashboard-api.jeff-263.workers.dev/loans");
  const data = await res.json();

  loans = (data.loans || []).map(l => {
    const purchasePrice = Number(l.purchasePrice ?? 0);

    return {
      ...l,
      id: l.loanId,
      name: l.loanName ?? `Loan ${l.loanId}`,
      school: l.school ?? "",
      loanStartDate: l.loanStartDate || "",
      termYears: Number(l.termYears ?? 0),
      graceYears: Number(l.graceYears ?? 0),
      purchasePrice,
      originalLoanAmount: purchasePrice,   // üîë FIX
      nominalRate: Number(l.nominalRate ?? 0),
      upfrontFee: Number(l.upfrontFee ?? 150),
      monthlyFeeStart: Number(l.monthlyFeeStart ?? 9),
    };
  });
}


function openDrawerForLoan(loan){
  
  currentMode = 'loan';
  currentLoan = loan;
  drawerAmortContainer.style.display = '';
  drawer.classList.add('loan-mode');
  // --- loan drawer heading (match earnings structure) ---
  drawerTitle.textContent = loan.name || ("Loan " + loan.id);
  drawerSub.innerHTML = `
    ${loan.school || "No school"}<br>
    Purchased ${loan.purchaseDate}
‚Ä¢ Orig Loan Amt $${Number(
  loan.originalLoanAmount ||
  loan.origLoanAmount ||
  loan.loanAmount ||
  0
).toLocaleString()}

    ‚Ä¢ Loan Purchase Price $${Number(loan.purchasePrice || 0).toLocaleString()}
  `;
  drawerPrimaryTitle.textContent = 'Orig Loan Amount';
drawerPrimary.textContent =
  '$' + Number(loan.originalLoanAmount || 0).toLocaleString();

  drawerSecondaryTitle.textContent = 'Nominal Rate';
  drawerSecondary.textContent = (loan.nominalRate * 100).toFixed(2) + '%';
  drawerExtra.innerHTML = '';
  drawerLegend.style.display = 'none';
  drawerLegend.innerHTML = '';
  // --------------------------------------------------
  // ROI LINE CHART (use canonical date)
  // --------------------------------------------------
  const series = loan.roiSeries.map(s => ({
    x: formatMonthYear(s.date), // ‚úÖ displayDate-derived
    y: s.roi,
    date: s.date
  }));
  window.createLineChart(drawerChartArea, series, {

    color: '#0ea5e9',
    loanStartDate: loan.loanStartDate,
    tickEvery: 12,
    labelFn: (pt) =>
  `${formatMonthYear(pt.date)} ‚Ä¢ ROI ${(pt.y * 100).toFixed(2)}%`

  });
  // --------------------------------------------------
  // ROI-BY-MONTH TABLE (use displayDate)
  // --------------------------------------------------
drawerAmortContainer.innerHTML = `
  <h3 style="margin-top:8px">ROI by Month</h3>
  <div class="amort-wrap">
    <table>
      <thead>
        <tr>
          <th>Month</th>
          <th style="text-align:right">Balance</th>
          <th style="text-align:right">Loan Value</th>
          <th style="text-align:right">ROI</th>
        </tr>
      </thead>
      <tbody id="roiBody"></tbody>
    </table>
  </div>
`;
  const roiBody = document.getElementById('roiBody');
  roiBody.innerHTML = '';
loan.roiSeries.forEach(s => {
  const cs =
  loan.cumSchedule.find(r => {
    if (!r.loanDate || !s.date) return false;
    return (
      r.loanDate.getFullYear() === s.date.getFullYear() &&
      r.loanDate.getMonth() === s.date.getMonth()
    );
  }) || {};

  const tr = document.createElement('tr');
  
  // Shade deferral months
  if (cs.isDeferred) {
    tr.style.background = 'rgba(234,179,8,0.08)';
  }
  
const rowClass = getEventRowClass(loan, cs || s);

  if (rowClass) tr.classList.add(rowClass);
  const monthLabel =
    cs.displayDate instanceof Date
      ? formatMonthYear(cs.displayDate)
      : '';
  tr.innerHTML = `
    <td style="text-align:left">${monthLabel}</td>
    <td style="text-align:right">$${formatCurrency(cs.balance)}</td>
    <td style="text-align:right">$${formatCurrency(s.loanValue)}</td>
    <td style="text-align:right">${((s.roi || 0) * 100).toFixed(2)}%</td>
  `;
  roiBody.appendChild(tr);
});
  drawer.classList.add('open');
  drawer.setAttribute('aria-hidden', 'false');
  drawer.scrollTop = 0;

}


/* ============================================================
   0. IMPORTS & PAGE CONTEXT
   - ES module imports
   - URL params, embed/reporting context
   - Back-navigation wiring
   ============================================================ */

console.log(
  "%c[DRAWER COUNT]",
  "color:#0ea5e9;font-weight:bold",
  document.querySelectorAll("#drawer").length
);


/* ============================================================
   1. GLOBAL CONSTANTS & CONFIGURATION
   - Static labels
   - Color palettes
   - Magic numbers / defaults
   - No runtime logic
   ============================================================ */

      const TODAY = new Date();
const KPI_CURRENT_MONTH = new Date(
  TODAY.getFullYear(),
  TODAY.getMonth(),
  1
);


    

/* ============================================================
   2. PURE UTILITY FUNCTIONS (NO STATE, NO DOM)
   - Formatting helpers
   - Date helpers
   - Comparators
   - Math utilities
   ============================================================ */

function getCurrentOwnedRoiEntry(loan) {
  // ‚úÖ anchor to the app‚Äôs ‚Äúcurrent month‚Äù, not wall-clock
  const asOf = new Date(KPI_CURRENT_MONTH);
  asOf.setMonth(asOf.getMonth() + 1);
  asOf.setDate(0); // last day of KPI month
  asOf.setHours(23, 59, 59, 999);

  const ownedEntries = (loan.roiSeries || []).filter(r => r?.date && r.date <= asOf);
  if (!ownedEntries.length) return { roi: 0, loanValue: loan.purchasePrice };
  return ownedEntries[ownedEntries.length - 1];
}

    function getOwnedRoiSeries(loan) {
  if (!Array.isArray(loan.roiSeries)) return [];

  // Full lifetime series (DO NOT truncate)
  return loan.roiSeries
    .filter(p => p?.date instanceof Date && !isNaN(+p.date))
    .sort((a, b) => a.date - b.date);
}


      function getRoiEntryAsOfMonth(loan, monthDate) {
  if (!Array.isArray(loan.roiSeries)) {
    return { roi: 0, loanValue: loan.purchasePrice };
  }

  const eligible = loan.roiSeries.filter(
    r => r.date && r.date <= monthDate
  );

  if (!eligible.length) {
    return { roi: 0, loanValue: loan.purchasePrice };
  }

  return eligible[eligible.length - 1];
}


    function getLastOwnedRoiEntry(loan){
      if (!loan.roiSeries || !loan.roiSeries.length) return { roi: 0, loanValue: loan.purchasePrice };
      return loan.roiSeries[loan.roiSeries.length - 1];
    }

function getOwnedRoiSeriesFromAmort(loan) {
  if (!Array.isArray(loan.cumSchedule)) return [];

  return loan.cumSchedule
    .filter(r => r.isOwned && r.loanDate instanceof Date)
    .map(r => {
      const realized = (r.cumPrincipal + r.cumInterest) - (r.cumFees || 0);
      const unrealized = (r.balance || 0) * 0.95;
      const loanValue = realized + unrealized;

      return {
        date: r.loanDate,
        roi: (loanValue - loan.purchasePrice) / loan.purchasePrice,
        loanValue
      };
    });
}



    
    

/* ============================================================
   3. LOAN DOMAIN LOGIC (PURE, DATA ‚Üí DATA)
   ============================================================ */

/* ------------------------------------------------------------
   3.1 Loan Event & Badge Logic
   - Event interpretation
   - Badge derivation
   - Row classification
   ------------------------------------------------------------ */


/* ------------------------------------------------------------
   3.2 Loan Amortization & Ownership Logic
   - Amort schedule slicing
   - Ownership month calculation
   - Terminal row handling
   ------------------------------------------------------------ */


/* ------------------------------------------------------------
   3.3 Loan ROI Computation
   - Amort ‚Üí ownership ‚Üí cumulative ‚Üí ROI series
   - Per-loan derived fields
   - NO DOM, NO GLOBAL MUTATION
   ------------------------------------------------------------ */



/* ============================================================
   4. KPI COMPUTATION (PORTFOLIO LEVEL, PURE)
   - Weighted ROI
   - Projected ROI
   - Capital recovery
   ============================================================ */

function computeWeightedRoiAsOfMonth(loans, monthDate) {
  const total = loans.reduce((s, l) => s + l.purchasePrice, 0);

  if (!total) return 0;

  return loans.reduce((sum, loan) => {
    const entry = getRoiEntryAsOfMonth(loan, monthDate);
    return sum + loan.purchasePrice * (entry.roi || 0);
  }, 0) / total;
}

      
function computeKPIs(list) {
  const total = list.reduce((s, l) => s + l.purchasePrice, 0);

  // -------------------------------------
  // Weighted ROI to Date (unchanged)
  // -------------------------------------
  const weightedROI =
  computeWeightedRoiAsOfMonth(list, KPI_CURRENT_MONTH);



  // -------------------------------------
  // Projected Weighted ROI (unchanged)
  // -------------------------------------
  const projectedWeightedROI =
    list.reduce(
      (s, l) =>
        s +
        l.purchasePrice *
          ((l.roiSeries[l.roiSeries.length - 1] || {}).roi || 0),
      0
    ) / Math.max(1, total);

    // -------------------------------------
    // Capital Recovery (TO TODAY, FIXED)
    // -------------------------------------
    const TODAY = new Date();
    TODAY.setHours(23, 59, 59, 999);
    
    let recoveredPrincipalTotal = 0;
    let investedPrincipalTotal = 0;
    
    list.forEach(l => {
      if (!l.amort || !l.amort.schedule) return;
    
      // ‚úÖ only owned rows through TODAY
      const recovered = l.amort.schedule
        .filter(r => r.isOwned && r.loanDate && r.loanDate <= TODAY)
        .reduce((s, r) => s + (r.principalPaid || 0), 0);
    
      recoveredPrincipalTotal += recovered;
      investedPrincipalTotal += (l.purchasePrice || 0);
    });
    
    const capitalRecoveryPct =
      investedPrincipalTotal > 0
        ? recoveredPrincipalTotal / investedPrincipalTotal
        : 0;

    
        return {
      total,
      weightedROI,
      projectedWeightedROI,
      capitalRecoveredAmount: recoveredPrincipalTotal,
      capitalRecoveryPct
    };

}


    

/* ============================================================
   5. GLOBAL APP STATE (DECLARATIONS ONLY)
   - loans
   - allLoans
   - currentLoans
   - filteredLoans
   - view + sort state
   ============================================================ */



/* ============================================================
   6. DATA LOADING & NORMALIZATION
   - Backend fetch
   - Base loan normalization
   - No amort / ROI here
   ============================================================ */



/* ============================================================
   7. DATA DERIVATION PIPELINE
   - Build amort schedules
   - Compute ROI series
   - Populate allLoans / currentLoans / filteredLoans
   ============================================================ */

function deriveLoansWithAmortAndRoi(formattedLoans) {
  return formattedLoans.map(l => {
    
const rawAmort = buildAmortSchedule(l);

// ----------------------------------
// Respect terminal rows from engine
// ----------------------------------
const amortSchedule = (() => {
  const out = [];
  for (const r of rawAmort) {
    out.push(r);
    if (r.isTerminal === true) break; // üîí STOP at default
  }
  return out;
})();


      // Attach ownership flags
      const purchase = new Date(l.purchaseDate);
      const scheduleWithOwnership = amortSchedule.map(r => ({
        ...r,
        isOwned: r.loanDate >= purchase,
        ownershipMonthIndex: r.loanDate >= purchase
          ? monthDiff(purchase, r.loanDate) + 1
        : 0,
      ownershipDate: r.loanDate >= purchase ? r.loanDate : null
    }));
        
let cumP = 0;
let cumI = 0;
let cumFees = 0;
        
const cumSchedule = scheduleWithOwnership
  .filter(r => r.isOwned)
  .reduce((rows, r) => {
    cumP += r.principalPaid;
    cumI += r.interest;
    const feeThisMonth = Number(r.feeThisMonth ?? 0);
    cumFees += feeThisMonth;

    rows.push({
      ...r,
      cumPrincipal: +cumP.toFixed(2),
      cumInterest: +cumI.toFixed(2),
      cumFees: +cumFees.toFixed(2)
    });

    // üîí HARD STOP at terminal row
    if (r.isTerminal === true) {
      return rows;
    }

    return rows;
  }, []);


    // Compute proper ROI timeline using correct amort + fees
    const purchasePrice = Number(l.purchasePrice ?? 0);
    const roiSeries = cumSchedule
      .filter(r => r.isOwned)
.map(r => {
  const realized = (r.cumPrincipal + r.cumInterest) - r.cumFees;
  const unrealized = r.balance * 0.95;
  const loanValue = realized + unrealized;
  const roi = (loanValue - purchasePrice) / purchasePrice;
return {
  month: r.ownershipMonthIndex,
  // ‚úÖ ALWAYS real schedule date (exists for full lifetime)
  date: r.loanDate,
  // optional: keep displayDate around if you need it for labels
  displayDate: r.displayDate,
  roi,
  loanValue,
  cumFees: r.cumFees,
  realized,
  remainingBalance: r.balance,
  unrealized,
  isTerminal: r.isTerminal === true
};

});

    // Return updated loan object
    return {
    ...l,
    amort: { schedule: amortSchedule },
    scheduleWithOwnership,
    cumSchedule,
    balanceAtPurchase: amortSchedule.find(r => r.loanDate >= purchase)?.balance ?? 0,
    roiSeries
  };
});  
  }



    

/* ============================================================
   8. KPI COLOR & VISUAL MAPPING
   - Deterministic color assignment
   ============================================================ */

function buildKpiColorMap(loans) {
  const colorMap = {};

  // 1) Hand-picked, visually maximized contrast palette
  const BASE_DISTINCT_COLORS = [
    '#2563eb', // blue
    '#dc2626', // red
    '#16a34a', // green
    '#7c3aed', // purple
    '#ea580c', // orange
    '#0891b2', // cyan
    '#ca8a04', // amber
    '#be185d', // rose
    '#15803d', // dark green
    '#1d4ed8', // deep blue
    '#9333ea', // violet
    '#b91c1c'  // dark red
  ];

  // 2) Fallback generator ONLY if loans exceed base palette
  function generateExtraColors(n) {
    const colors = [];
    for (let i = 0; i < n; i++) {
      const hue = (i * 137.508) % 360;
      colors.push(`hsl(${hue.toFixed(0)} 80% 55%)`);
    }
    return colors;
  }

  // 3) Stable ordering (important!)
  const sortedLoansForColors = loans
    .slice()
    .sort((a, b) => (a.id ?? a.loanId) - (b.id ?? b.loanId));

  // 4) Build final palette
  const extraNeeded = Math.max(
    0,
    sortedLoansForColors.length - BASE_DISTINCT_COLORS.length
  );
  const palette =
    BASE_DISTINCT_COLORS.concat(generateExtraColors(extraNeeded));

  // 5) Assign colors deterministically
  sortedLoansForColors.forEach((loan, i) => {
    const id = loan.id ?? loan.loanId;
    colorMap[id] = palette[i];
  });

  return colorMap;
}


function createMiniSparkline(svg, series, opts = {}) {
  const svgNS = "http://www.w3.org/2000/svg";

  const w = 170;
  const h = 48;
  const pad = 4;

  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.setAttribute("width", w);
  svg.setAttribute("height", h);
  svg.innerHTML = "";

  const data = series.filter(p => p?.date instanceof Date);
  if (!data.length) return;

  const ys = data.map(d => d.y);
  const minY = Math.min(...ys);
  const maxY = Math.max(...ys);
  const rangeY = Math.max(1e-6, maxY - minY);

  const minDate = data[0].date;
  const maxDate = data[data.length - 1].date;
  const dateSpan = Math.max(1, maxDate - minDate);

  const xForDate = d =>
    pad + ((d - minDate) / dateSpan) * (w - pad * 2);

  const yForVal = v =>
    pad + (h - pad * 2) - ((v - minY) / rangeY) * (h - pad * 2);

  // ---- ROI curve ----
  let path = "";
  data.forEach((p, i) => {
    const x = xForDate(p.date);
    const y = yForVal(p.y);
    path += i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`;
  });

  const line = document.createElementNS(svgNS, "path");
  line.setAttribute("d", path);
  line.setAttribute("fill", "none");
  line.setAttribute("stroke", opts.color || "#0ea5e9");
  line.setAttribute("stroke-width", "2");
  svg.appendChild(line);

  // ---- Today line (per-loan, per-tile) ----
  const today = opts.todayDate instanceof Date ? opts.todayDate : new Date();
  if (today >= minDate && today <= maxDate) {
    const x = xForDate(today);
    const v = document.createElementNS(svgNS, "line");
    v.setAttribute("x1", x);
    v.setAttribute("x2", x);
    v.setAttribute("y1", pad);
    v.setAttribute("y2", h - pad);
    v.setAttribute("stroke", "#111827");
    v.setAttribute("stroke-dasharray", "3 3");
    v.setAttribute("stroke-opacity", "0.6");
    svg.appendChild(v);
  }

  // ---- Hover (MATCH OLD TILE BEHAVIOR) ----
  const tooltip = document.getElementById("tooltip");

  const vLine = document.createElementNS(svgNS, "line");
  vLine.setAttribute("stroke", "#111827");
  vLine.setAttribute("stroke-dasharray", "3 3");
  vLine.setAttribute("stroke-opacity", "0.6");
  svg.appendChild(vLine);

  const dot = document.createElementNS(svgNS, "circle");
  dot.setAttribute("r", 3.5);
  dot.setAttribute("fill", opts.color || "#0ea5e9");
  dot.style.display = "none";
  svg.appendChild(dot);

  svg.addEventListener("mousemove", (ev) => {
    const rect = svg.getBoundingClientRect();
    const x = ev.clientX - rect.left;

    let nearest = data[0];
    let best = Infinity;

    data.forEach(p => {
      const dx = Math.abs(xForDate(p.date) - x);
      if (dx < best) {
        best = dx;
        nearest = p;
      }
    });

    const cx = xForDate(nearest.date);
    const cy = yForVal(nearest.y);

    vLine.setAttribute("x1", cx);
    vLine.setAttribute("x2", cx);
    vLine.setAttribute("y1", pad);
    vLine.setAttribute("y2", h - pad);

    dot.setAttribute("cx", cx);
    dot.setAttribute("cy", cy);
    dot.style.display = "block";

    tooltip.style.display = "block";
    tooltip.style.left = (rect.left + cx) + "px";
    tooltip.style.top = (rect.top + cy - 28) + "px";
    tooltip.innerHTML =
      `${formatMonthYear(nearest.date)} ‚Ä¢ ROI ${(nearest.y * 100).toFixed(2)}%`;
  });

  svg.addEventListener("mouseleave", () => {
    vLine.setAttribute("x1", -9999);
    vLine.setAttribute("x2", -9999);
    dot.style.display = "none";
    tooltip.style.display = "none";
  });

  
}

/* ============================================================
   Multi-Series ROI Chart (Aligned by Purchase Date, Smoothed)
   ============================================================ */

function createMultiSeriesChart(containerEl, loanSeriesList, weightedSeries, opts = {}) {
  containerEl.innerHTML = "";
  const svgNS = "http://www.w3.org/2000/svg";
    // -----------------------------------
  // Path refs (REQUIRED)
  // -----------------------------------
  const loanPaths = [];
  let weightedPath = null;


  const rect = containerEl.getBoundingClientRect();
  const w = Math.max(360, rect.width || 700);
  const h = opts.h || (isEmbed ? 240 : 260);
  const pad = opts.pad || (isEmbed ? 20 : 48);

  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");
  svg.style.display = "block";

  // -------------------------
  // Build a unified date axis
  // -------------------------
  const globalDates = opts.dates || [];

  
  if (!globalDates.length) {
    containerEl.appendChild(svg);
    return;
  }

  const ms0 = globalDates[0].getTime();
  const ms1 = globalDates[globalDates.length - 1].getTime();
  const msRange = ms1 - ms0 || 1;

  const dateToX = (d) => {
    const ratio = (d.getTime() - ms0) / msRange;
    return pad + ratio * (w - pad * 2);
  };

  // -------------------------
  // Y scale (shared)
  // -------------------------
  let ys = [];

  if (!opts.hideWeighted && Array.isArray(weightedSeries)) {
    weightedSeries.forEach(p => ys.push(p.y));
  }

  loanSeriesList.forEach(ls =>
    ls.data.forEach(p => ys.push(p.y))
  );

  const minY = Math.min(...ys);
  const maxY = Math.max(...ys);
  const rangeY = maxY - minY || 1;

  const yScale = (yVal) =>
    pad + (h - pad * 2) - ((yVal - minY) / rangeY) * (h - pad * 2);

  // -----------------------------------
  // Grid + Y labels
  // -----------------------------------
  const steps = 4;
  for (let i = 0; i <= steps; i++) {
    const y = pad + (i / steps) * (h - pad * 2);

    const grid = document.createElementNS(svgNS, "line");
    grid.setAttribute("x1", pad);
    grid.setAttribute("x2", w - pad);
    grid.setAttribute("y1", y);
    grid.setAttribute("y2", y);
    grid.setAttribute("stroke", "var(--border)");
    grid.setAttribute("stroke-opacity", "0.16");
    svg.appendChild(grid);

    const val = maxY - (i / steps) * rangeY;
    const label = document.createElementNS(svgNS, "text");
    label.setAttribute("x", pad - 4);
    label.setAttribute("y", y);
    label.setAttribute("text-anchor", "end");
    label.setAttribute("dominant-baseline", "middle");
    label.setAttribute("font-size", "10");
    label.setAttribute("fill", "var(--muted)");
    label.textContent = (val * 100).toFixed(1) + "%";
    svg.appendChild(label);
  }

function smoothPathFromPointsCubic(points, isTruncated = false) {
  if (points.length < 2) return "";

  let d = `M ${points[0][0]} ${points[0][1]}`;

  for (let i = 1; i < points.length; i++) {
    const [x0, y0] = points[i - 1];
    const [x1, y1] = points[i];
    d += ` Q ${x0} ${y0}, ${(x0 + x1) / 2} ${(y0 + y1) / 2}`;
  }

  // üö´ DO NOT extend defaulted / truncated series
  if (!isTruncated) {
    d += ` T ${points.at(-1)[0]} ${points.at(-1)[1]}`;
  }

  return d;
}



// -----------------------------------
// Loan lines (ALWAYS draw)
// -----------------------------------
loanSeriesList.forEach(ls => {
  const pts = ls.data
    .filter(p => p.y != null)
    .map(p => [dateToX(p.date), yScale(p.y)]);

  if (!pts.length) return;

  // ‚úÖ ADD THIS LINE
  const isTruncated = ls.data.length < globalDates.length;

  // ‚úÖ CHANGE THIS LINE
  const pathD = smoothPathFromPointsCubic(pts, isTruncated);

  const path = document.createElementNS(svgNS, "path");
  path.setAttribute("d", pathD);
  path.setAttribute("fill", "none");
  path.setAttribute("stroke", ls.color || "#888");
  path.setAttribute("stroke-width", "1.2");
  path.setAttribute("stroke-opacity", "0.9");
  path.dataset.type = "loan";
  path.dataset.loanId = String(ls.id);
  svg.appendChild(path);
  loanPaths.push(path);
});



  // -----------------------------------
  // Weighted line (OPTIONAL)
  // -----------------------------------
  if (!opts.hideWeighted && Array.isArray(weightedSeries) && weightedSeries.length) {
    const pts = weightedSeries.map(p => [dateToX(p.date), yScale(p.y)]);
    const path = document.createElementNS(svgNS, "path");
    path.setAttribute("d", smoothPathFromPointsCubic(pts));
    path.setAttribute("fill", "none");
    path.setAttribute("stroke", opts.weightedColor || "#000");
    path.setAttribute("stroke-width", opts.weightedWidth || "2.6");
    path.dataset.type = "weighted";
    path.dataset.role = "weighted-line"; 
    path.style.pointerEvents = "none"; 
    weightedPath = path;
    svg.appendChild(path);
  }

  // -----------------------------------
  // TODAY vertical reference line
  // -----------------------------------
  const today = new Date();
  let todayIdx = -1;
  globalDates.forEach((d, i) => {
    if (d <= today) todayIdx = i;
  });

  if (todayIdx >= 0) {
    const todayX = dateToX(globalDates[todayIdx]);
    const todayLine = document.createElementNS(svgNS, "line");
    todayLine.setAttribute("x1", todayX);
    todayLine.setAttribute("x2", todayX);
    todayLine.setAttribute("y1", pad);
    todayLine.setAttribute("y2", h - pad);
    todayLine.setAttribute("stroke", "#111827");
    todayLine.setAttribute("stroke-dasharray", "4 4");
    todayLine.setAttribute("stroke-opacity", "0.55");
    svg.appendChild(todayLine);
  }

  // -----------------------------------
  // X-axis
  // -----------------------------------
  const axis = document.createElementNS(svgNS, "g");
  const tickSpacing = opts.tickSpacingX || 24;

  globalDates.forEach((d, i) => {
    if (i % tickSpacing !== 0) return;
    const t = document.createElementNS(svgNS, "text");
    t.setAttribute("x", dateToX(d));
    t.setAttribute("y", h - 4);
    t.setAttribute("text-anchor", "middle");
    t.setAttribute("font-size", "10");
    t.setAttribute("fill", "var(--muted)");
    t.textContent = formatMonthYear(d);
    axis.appendChild(t);
  });

// -----------------------------------
// Hover dimming helpers (EXACT)
// -----------------------------------
function dimWeightedLine() {
  if (!weightedPath) return;
  weightedPath.setAttribute("stroke-opacity", "0.15");
}

function restoreWeightedLine() {
  if (!weightedPath) return;
  weightedPath.setAttribute("stroke-opacity", "0.9");
}

window.__roiChartFocusLoan = function (loanId) {
  loanPaths.forEach(p => {
    const active = p.dataset.loanId === String(loanId);
    p.setAttribute("stroke-opacity", active ? "1" : "0.15");
    p.setAttribute("stroke-width", active ? "2.6" : "1.2");
  });
  dimWeightedLine();
};

window.__roiChartClearFocus = function () {
  loanPaths.forEach(p => {
    p.setAttribute("stroke-opacity", "0.9");
    p.setAttribute("stroke-width", "1.2");
  });
  restoreWeightedLine();
};


  
// -----------------------------------
// Hover interaction (REFINED)
// -----------------------------------
const tooltip = document.getElementById("tooltip");

const vLine = document.createElementNS(svgNS, "line");
vLine.setAttribute("stroke", "#111827");
vLine.setAttribute("stroke-dasharray", "3 4");
vLine.setAttribute("stroke-opacity", "0.6");
svg.appendChild(vLine);

svg.addEventListener("mousemove", ev => {
  const rect = svg.getBoundingClientRect();
  const svgX = ev.clientX - rect.left;

  // snap to nearest date index
  let idx = Math.round(
    ((svgX - pad) / (w - pad * 2)) * (globalDates.length - 1)
  );
  idx = Math.max(0, Math.min(globalDates.length - 1, idx));

  const date = globalDates[idx];
  const x = dateToX(date);

  // vertical hover line
  vLine.setAttribute("x1", x);
  vLine.setAttribute("x2", x);
  vLine.setAttribute("y1", pad);
  vLine.setAttribute("y2", h - pad);

  // -------------------------
  // Build tooltip content
  // -------------------------
  let html = `
    <div style="font-weight:700;margin-bottom:6px">
      ${formatMonthYear(date)}
    </div>
  `;

  // weighted series
const weightedAtDate =
  computeWeightedRoiAsOfMonth(currentLoans, date);

html += `
  <div style="margin-bottom:6px">
    <span style="font-weight:600">Weighted:</span>
    ${(weightedAtDate * 100).toFixed(2)}%
  </div>
`;

  // per-loan series (SQUARE swatches)
loanSeriesList.forEach(ls => {
  // find last owned point at or before hovered date
  const pt = ls.data
    .filter(p => p.date && p.date <= date && p.y != null)
    .slice(-1)[0];

  // üö´ not owned yet ‚Üí do not show
  if (!pt) return;

  html += `
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:2px">
      <span style="
        width:10px;
        height:10px;
        background:${ls.color || "#888"};
        display:inline-block;
        flex-shrink:0;
      "></span>
      <span>${(pt.y * 100).toFixed(2)}%</span>
    </div>
  `;
});


  tooltip.innerHTML = html;
  tooltip.style.display = "block";

  // -------------------------
  // Cursor-based smart positioning (FIXED)
  // -------------------------
  const ttRect = tooltip.getBoundingClientRect();
  const margin = 12;

  // start from cursor position
  let left = ev.clientX + 14;
  let top  = ev.clientY + 14;

  // flip horizontally if overflowing right edge
  if (left + ttRect.width > window.innerWidth - margin) {
    left = ev.clientX - ttRect.width - 14;
  }

  // flip vertically if overflowing bottom edge
  if (top + ttRect.height > window.innerHeight - margin) {
    top = ev.clientY - ttRect.height - 14;
  }

  // final clamp (safety)
  left = Math.max(margin, Math.min(left, window.innerWidth - ttRect.width - margin));
  top  = Math.max(margin, Math.min(top, window.innerHeight - ttRect.height - margin));

  tooltip.style.left = `${left}px`;
  tooltip.style.top  = `${top}px`;

});

svg.addEventListener("mouseleave", () => {
  tooltip.style.display = "none";
  vLine.setAttribute("x1", -9999);
  vLine.setAttribute("x2", -9999);
});

  svg.appendChild(axis);
  containerEl.appendChild(svg);
}
    

/* ============================================================
   9. FILTER, SORT & VIEW-STATE LOGIC
   - Filter evaluation
   - Sorting logic
   - View mode state
   - NO rendering
   ============================================================ */

    function sortLoansForUI(loans, sortVal) {
  if (!sortVal) return loans;

  const [field, dir] = sortVal.split("_");
  const sign = dir === "desc" ? -1 : 1;

  return loans.slice().sort((a, b) => {
    switch (field) {
      case "purchase":
        return sign * (
          new Date(a.purchaseDate).getTime() -
          new Date(b.purchaseDate).getTime()
        );

      case "start":
        return sign * (
          new Date(a.loanStartDate).getTime() -
          new Date(b.loanStartDate).getTime()
        );

      case "amount":
        return sign * (
          (a.originalLoanAmount || a.loanAmount || 0) -
          (b.originalLoanAmount || b.loanAmount || 0)
        );

      case "rate":
        return sign * (
          (a.nominalRate || 0) -
          (b.nominalRate || 0)
        );

      default:
        return 0;
    }
  });
}

    
function applyLoanFilters() {
  if (!Array.isArray(allLoans) || !allLoans.length) {
    console.warn("applyLoanFilters called before loans initialized");
    return;
  }

  const nameVal   = document.getElementById("filterName")?.value || "";
  const schoolVal = document.getElementById("filterSchool")?.value || "";
  const rateVal   = document.getElementById("filterRate")?.value || "";
  const sortVal   = document.getElementById("sortLoans")?.value || "";

  // -------------------------
  // FILTER
  // -------------------------
  filteredLoans = allLoans.filter(loan => {
    if (nameVal && !loan.name.toLowerCase().includes(nameVal.toLowerCase())) {
      return false;
    }

    if (schoolVal && loan.school !== schoolVal) {
      return false;
    }

    if (rateVal === "low"  && loan.nominalRate >= 0.05) return false;
    if (rateVal === "mid"  && (loan.nominalRate < 0.05 || loan.nominalRate > 0.08)) return false;
    if (rateVal === "high" && loan.nominalRate <= 0.08) return false;

    return true;
  });

  // -------------------------
  // SORT (tiles + table)
  // -------------------------
  currentLoans = sortLoansForUI(filteredLoans, sortVal);

  // üîë Sync dropdown sort ‚Üí table sort state
  if (sortVal) {
    const [field, dir] = sortVal.split("_");

    const keyMap = {
      purchase: "purchaseDate",
      start: "loanStartDate",
      amount: "originalLoanAmount",
      rate: "nominalRate"
    };

    TABLE_SORT.key = keyMap[field] || null;
    TABLE_SORT.dir = dir === "desc" ? -1 : 1;
  }

  // -------------------------
  // RENDER
  // -------------------------
// üîë EMBED MODE NEVER SHOWS TABLE OR GRID
if (PAGE_CONTEXT.isEmbed) {
  return; // iframe only renders KPI drawer
}

if (document.getElementById("toggleTableView")?.checked) {
  renderLoanTableROI();
} else {
  renderLoanGrid(currentLoans);
}

} // ‚úÖ ADD THIS LINE ‚Äî closes applyLoanFilters()



function populateLoanFilters(loans) {

  const schoolSel = document.getElementById("filterSchool");
  const nameSel   = document.getElementById("filterName");

  if (!schoolSel || !nameSel) return;

  // Reset (keep first "All" option)
  schoolSel.length = 1;
  nameSel.length = 1;

  const schools = new Set();
  const names   = new Set();

  loans.forEach(l => {
    if (l.school) schools.add(l.school);
    if (l.name)   names.add(l.name);
  });

  [...schools].sort().forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    schoolSel.appendChild(opt);
  });

  [...names].sort().forEach(n => {
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = n;
    nameSel.appendChild(opt);
  });
}

    
// =====================================================
// FILTER UI EVENT WIRING (ROI PAGE)
// =====================================================
["filterName", "filterSchool", "filterRate", "sortLoans"].forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener("change", applyLoanFilters);
});

document.getElementById("resetFilters")?.addEventListener("click", () => {
  document.getElementById("filterName").value = "";
  document.getElementById("filterSchool").value = "";
  document.getElementById("filterRate").value = "";
  document.getElementById("sortLoans").value = "purchase_asc";
  applyLoanFilters();
});

// =====================================================
// TABLE VIEW TOGGLE ‚Äî SINGLE SOURCE OF TRUTH
// =====================================================
document.getElementById("toggleTableView")?.addEventListener("change", (e) => {
  localStorage.setItem(
    "roiTableView",
    e.target.checked ? "1" : "0"
  );
  applyLoanFilters();
});



    /* -------------------------
       Small chart utilities (line & bar with hover)
       ------------------------- */
window.createLineChart = function createLineChart(containerEl, series, opts = {}) {
  containerEl.innerHTML = '';
  const svgNS = "http://www.w3.org/2000/svg";

  const rect = containerEl.getBoundingClientRect();
  const w = Math.max(360, rect.width || 600);
  const h = opts.h || 260;
  const pad = opts.pad || 48;

  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");
  svg.style.display = "block";

  const data = series.filter(d => d?.date instanceof Date);
  if (!data.length) return;

  // ----------------------------
  // Y SCALE
  // ----------------------------
  const ys = data.map(d => d.y);
  const minY = Math.min(...ys);
  const maxY = Math.max(...ys);
  const rangeY = Math.max(1e-6, maxY - minY);

  // ----------------------------
  // X SCALE (DATE-BASED)
  // ----------------------------
  const minDate = data[0].date;
  const maxDate = data[data.length - 1].date;
  const dateSpan = Math.max(1, maxDate - minDate);

  const xForDate = d =>
    pad + ((d - minDate) / dateSpan) * (w - pad * 2);

  const yForVal = v =>
    pad +
    (h - pad * 2) -
    ((v - minY) / rangeY) * (h - pad * 2);

  const toXY = d => [xForDate(d.date), yForVal(d.y)];

  // ----------------------------
  // GRID
  // ----------------------------
  for (let i = 0; i <= 4; i++) {
    const y = pad + i * ((h - pad * 2) / 4);
    const line = document.createElementNS(svgNS, 'line');
    line.setAttribute('x1', pad);
    line.setAttribute('x2', w - pad);
    line.setAttribute('y1', y);
    line.setAttribute('y2', y);
    line.setAttribute('stroke', '#eef2f7');
    svg.appendChild(line);
  }

  // ----------------------------
  // AXES
  // ----------------------------
 
  // ----------------------------
// Y AXIS LABELS (MATCH PORTFOLIO)
// ----------------------------
for (let i = 0; i <= 4; i++) {
  const t = i / 4;
  const yVal = minY + (1 - t) * rangeY;
  const y = pad + t * (h - pad * 2);

  const label = document.createElementNS(svgNS, 'text');
  label.setAttribute('x', pad - 12);
  label.setAttribute('y', y + 4);
  label.setAttribute('text-anchor', 'end');
  label.setAttribute('font-size', '12');
  label.setAttribute('font-weight', '500');
  label.setAttribute('fill', '#64748b'); // üîë muted gray
  label.textContent = `${(yVal * 100).toFixed(1)}%`;
  svg.appendChild(label);
}

// ----------------------------
// X AXIS LABELS (MATCH PORTFOLIO)
// ----------------------------
const tickEvery = opts.tickEvery || 12;

data.forEach((p, i) => {
  if (i % tickEvery !== 0 && i !== data.length - 1) return;

  const x = xForDate(p.date);

  const label = document.createElementNS(svgNS, 'text');
  label.setAttribute('x', x);
  label.setAttribute('y', h - pad + 22);
  label.setAttribute('text-anchor', 'middle');
  label.setAttribute('font-size', '12');
  label.setAttribute('font-weight', '500');
  label.setAttribute('fill', '#64748b'); // üîë muted gray
  label.textContent = formatMonthYear(p.date);
  svg.appendChild(label);
});

  // ----------------------------
  // LINE PATH
  // ----------------------------
  let path = '';
  data.forEach((p, i) => {
    const [x, y] = toXY(p);
    path += (i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
  });

  const linePath = document.createElementNS(svgNS, 'path');
  linePath.setAttribute('d', path);
  linePath.setAttribute('fill', 'none');
  linePath.setAttribute('stroke', opts.color || '#0ea5e9');
  linePath.setAttribute('stroke-width', '2');
  svg.appendChild(linePath);

  // ----------------------------
  // TODAY LINE
  // ----------------------------
  const today = opts.todayDate instanceof Date ? opts.todayDate : new Date();
  if (today >= minDate && today <= maxDate) {
    const x = xForDate(today);
    const todayLine = document.createElementNS(svgNS, 'line');
    todayLine.setAttribute('x1', x);
    todayLine.setAttribute('x2', x);
    todayLine.setAttribute('y1', pad);
    todayLine.setAttribute('y2', h - pad);
    todayLine.setAttribute('stroke', '#111827');
    todayLine.setAttribute('stroke-dasharray', '3 3');
    todayLine.setAttribute('stroke-opacity', '0.6');
    svg.appendChild(todayLine);
  }

  // ----------------------------
  // HOVER
  // ----------------------------
  const vLine = document.createElementNS(svgNS, 'line');
  vLine.setAttribute('stroke', '#111827');
  vLine.setAttribute('stroke-dasharray', '3 4');
  vLine.setAttribute('stroke-opacity', '0.6');
  svg.appendChild(vLine);

  const hoverG = document.createElementNS(svgNS, 'g');
  svg.appendChild(hoverG);

  svg.addEventListener('mousemove', ev => {
    const rect = svg.getBoundingClientRect();
    const x = ev.clientX - rect.left;

    let nearest = data[0];
    let best = Infinity;

    data.forEach(p => {
      const dx = Math.abs(xForDate(p.date) - x);
      if (dx < best) {
        best = dx;
        nearest = p;
      }
    });

    const [cx, cy] = toXY(nearest);

    vLine.setAttribute('x1', cx);
    vLine.setAttribute('x2', cx);
    vLine.setAttribute('y1', pad);
    vLine.setAttribute('y2', h - pad);

    hoverG.innerHTML = '';
    const c = document.createElementNS(svgNS, 'circle');
    c.setAttribute('cx', cx);
    c.setAttribute('cy', cy);
    c.setAttribute('r', 4);
    c.setAttribute('fill', opts.color || '#0ea5e9');
    hoverG.appendChild(c);

    tooltip.style.display = 'block';
    tooltip.style.left = (rect.left + cx) + 'px';
    tooltip.style.top = (rect.top + cy - 28) + 'px';
    tooltip.innerHTML =
      opts.labelFn
        ? opts.labelFn(nearest)
        : `${formatMonthYear(nearest.date)} ‚Ä¢ ${(nearest.y * 100).toFixed(2)}%`;
  });

  svg.addEventListener('mouseleave', () => {
    hoverG.innerHTML = '';
    tooltip.style.display = 'none';
    vLine.setAttribute('x1', -9999);
    vLine.setAttribute('x2', -9999);
  });

  containerEl.appendChild(svg);
  return svg;
};


    

/* ============================================================
   10. RENDERING ‚Äî LOAN LISTS
   - Loan tiles
   - Loan table
   - Row / tile interactions
   ============================================================ */
function renderLoanTableROI(list = currentLoans) {
  const tableWrap = document.getElementById("loanTableWrap");
  const table = document.getElementById("loanTable");
  const tbody = table?.querySelector("tbody");
  const grid = document.getElementById("loanGrid");

  if (!tableWrap || !tbody) {
    console.warn("renderLoanTableROI: table elements missing");
    return;
  }

  // =====================================================
  // VIEW TOGGLE (SINGLE SOURCE OF TRUTH)
  // =====================================================
  tableWrap.hidden = false;
  tableWrap.style.display = "block";
  if (grid) grid.style.display = "none";

  // =====================================================
  // RESET TABLE
  // =====================================================
  tbody.innerHTML = "";

  // =====================================================
  // ROWS
  // =====================================================
  list.forEach(loan => {
    const tr = document.createElement("tr");
    tr.dataset.loanId = loan.id;

    tr.innerHTML = `
      <td>${loan.id}</td>
      <td>${loan.name}</td>
      <td>${loan.school || ""}</td>
      <td>${loan.loanStartDate || ""}</td>
      <td>${loan.purchaseDate || ""}</td>
      <td>$${Number(loan.originalLoanAmount || 0).toLocaleString()}</td>
      <td>$${Number(loan.purchasePrice || 0).toLocaleString()}</td>
      <td>${((loan.nominalRate || 0) * 100).toFixed(2)}%</td>
      <td>${loan.termYears ?? ""}</td>
      <td>${loan.graceYears ?? ""}</td>
      <td>${((getCurrentOwnedRoiEntry(loan)?.roi || 0) * 100).toFixed(2)}%</td>
    `;

    // =====================================================
    // HOVER (MATCH AMORT)
    // =====================================================
    tr.addEventListener("mouseenter", () => {
      tr.classList.add("row-hover");
    });

    tr.addEventListener("mouseleave", () => {
      tr.classList.remove("row-hover");
    });

    // =====================================================
    // CLICK ‚Üí OPEN LOAN DRAWER
    // =====================================================
    tr.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation(); // üîë prevents global close handler
      openLoanDrawerSafe(loan);
    });

    tbody.appendChild(tr);
  });
}
    
    
function renderLoanGrid(loans) {
const tableWrap = document.getElementById("loanTableWrap");
if (tableWrap) {
  tableWrap.hidden = true;
  tableWrap.style.display = "none";
}
  
const grid = document.getElementById("loanGrid");
const wrap = document.getElementById("loanTableWrap");

if (!grid) return;

// üîë canonical visibility reset
if (wrap) wrap.style.display = "none";
grid.style.display = "grid";



  // üîë HARD RESET ‚Äî prevents duplicate tiles
  grid.innerHTML = "";


  if (!Array.isArray(loans) || !loans.length) return;

  loans.forEach(loan => {
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.dataset.renderId = window.__gridRenderCount;

    tile.innerHTML = `
  <div class="tile-left">
    <div class="loan-name">${loan.name}</div>

    ${
      getLoanEventBadges(loan).length
        ? `<div class="loan-badges">
            ${getLoanEventBadges(loan)
              .map(
                b =>
                  `<span class="loan-badge ${b.type}">${b.label}</span>`
              )
              .join("")}
          </div>`
        : ""
    }

    <div class="loan-sub">
      ${loan.school || ""}
    </div>

    <div class="loan-meta">
      <span>${(loan.nominalRate * 100).toFixed(2)}%</span>
      <span>¬∑</span>
      <span>${loan.termYears} yrs</span>
      <span>¬∑</span>
      <span>
        Matures: ${
          getLoanMaturityFromAmort(loan)
            ? formatMonthYear(getLoanMaturityFromAmort(loan))
            : "‚Äî"
        }
      </span>
    </div>

    <div class="loan-meta">
      Loan ${loan.id}
    </div>
  </div>

  <div class="chart-wrap">
    <div class="mini-label">
  ROI ${((getCurrentOwnedRoiEntry(loan)?.roi || 0) * 100).toFixed(2)}%
</div>

    <svg class="sparkline"></svg>
  </div>
`;

// üîë Attach loan badge hover tooltips (canonical copy)
tile.querySelectorAll(".loan-badge").forEach(badgeEl => {
  const type =
    badgeEl.classList.contains("prepayment") ? "prepayment" :
    badgeEl.classList.contains("deferral") ? "deferral" :
    badgeEl.classList.contains("default") ? "default" :
    null;

  if (!type) return;

  const tooltipText = getBadgeTooltipText(loan, type);
  if (tooltipText) {
    createBadgeTooltip(badgeEl, tooltipText);
  }
});



    tile.addEventListener("click", () => openLoanDrawerSafe(loan));

    const svg = tile.querySelector("svg.sparkline");
    const series = getOwnedRoiSeries(loan).map(p => ({
      date: p.date,
      y: p.roi
    }));

    createMiniSparkline(svg, series, {
      color: window.KPI_COLOR_MAP?.[loan.id],
      todayDate: KPI_CURRENT_MONTH
    });

    grid.appendChild(tile);
  });
}





 function renderLoanTableFromState() {
  const tbody = document.querySelector("#loanTable tbody");
  if (!tbody) return;

  tbody.innerHTML = "";

  const rows = getLoansForTableView();

  rows.forEach(loan => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${loan.id ?? ""}</td>
      <td>${loan.name ?? ""}</td>
      <td>${loan.school ?? ""}</td>
      <td>${loan.loanStartDate ?? ""}</td>
      <td>${loan.purchaseDate ?? ""}</td>
      <td>$${formatCurrency(loan.originalLoanAmount || loan.principal)}</td>
      <td>$${formatCurrency(loan.purchasePrice)}</td>
      <td>${(loan.nominalRate * 100).toFixed(2)}%</td>
      <td>${loan.termYears ?? ""}</td>
      <td>${loan.graceYears ?? ""}</td>
      <td>${((getCurrentOwnedRoiEntry(loan)?.roi || 0) * 100).toFixed(2)}%</td>
    `;

    tr.addEventListener("click", () => {
      openLoanDrawerSafe(loan);
    });

    tr.addEventListener("mouseenter", () => {
      tr.classList.add("row-hover");
    });
    tr.addEventListener("mouseleave", () => {
      tr.classList.remove("row-hover");
    });

    tbody.appendChild(tr);
  });
}
   

    

/* ============================================================
   11. RENDERING ‚Äî KPIs & CHARTS
   - KPI tiles
   - Line charts
   - Multi-series charts
   ============================================================ */



    


/* ============================================================
   12. DRAWER LOGIC (LOAN & KPI)
   - Drawer open/close
   - Loan drawer rendering
   - KPI drawer rendering
   ============================================================ */



/* ============================================================
   13. GLOBAL EVENT WIRING
   - Filter change handlers
   - Sort handlers
   - Toggle buttons
   - Print / CSV / actions
   ============================================================ */

    document.getElementById("closeBtn")
  .addEventListener("click", closeDrawer);

    document.addEventListener("click", (e) => {
  if (!drawer.classList.contains("open")) return;

  const clickedInsideDrawer = drawer.contains(e.target);
  const clickedKpi = e.target.closest(".kpi");
  const clickedTile = e.target.closest(".tile");

  if (!clickedInsideDrawer && !clickedKpi && !clickedTile) {
    closeDrawer();
  }
});

// =====================================================
// KPI CLICK HANDLERS ‚Äî ROI (REQUIRED)
// =====================================================
document.querySelectorAll(".kpi").forEach(kpi => {
  kpi.addEventListener("click", (e) => {
    e.stopPropagation(); // üîë prevent outside-close

    const key = kpi.dataset.kpi;
    console.log("[KPI CLICK]", key);

    switch (key) {
      case "tpv":
        renderTPVDrawer();
        break;
      case "rates":
        renderRatesDrawer();
        break;
      case "capitalRecovery":
        renderCapitalRecoveryDrawer();
        break;
      case "spread":
        renderROISpreadDrawer();
        break;
      default:
        console.warn("Unknown KPI:", key);
        return;
    }

    drawer.classList.add("open");
    drawer.setAttribute("aria-hidden", "false");

    if (!PAGE_CONTEXT.isEmbed) {
      forceDrawerVisible();
    }

    drawer.scrollTop = 0;
  });
});



/* ============================================================
   14. initROI() ‚Äî APPLICATION ORCHESTRATION
   - Order of operations only
   - No helpers defined here
   ============================================================ */

  
    
async function initROI() {

  const formatLoanLabel = (loan) =>
    `Loan ${loan.id} ‚Äî ${loan.name} (${loan.school})`;

  // --------------------------------------------------
  // FILTER TO CURRENT USER ‚Äî SINGLE SOURCE OF TRUTH
  // --------------------------------------------------
  const userLoans = loans
    .map(l => ({
      ...l,
      user: l.user ?? "jeff",
      visible: l.visible !== false
    }))
    .filter(l => l.user === PAGE_USER && l.visible === true);

  // --------------------------------------------------
  // Normalize numeric fields (ONLY user loans)
  // --------------------------------------------------
  const formattedLoans = userLoans.map(l => ({
    ...l,
    purchasePrice: Number(l.purchasePrice ?? 0),
    nominalRate: Number(l.rate ?? l.nominalRate ?? 0)
  }));

  // --------------------------------------------------
  // Derive amort + ROI (DATA CREATION POINT)
  // --------------------------------------------------
  const loansWithAmort = deriveLoansWithAmortAndRoi(formattedLoans);

  allLoans = loansWithAmort;        // üîë master list
  currentLoans = loansWithAmort;
  filteredLoans = loansWithAmort.slice();

  // --------------------------------------------------
  // KPI color map (must exist before drawers open)
  // --------------------------------------------------
  window.KPI_COLOR_MAP = buildKpiColorMap(currentLoans);

  // --------------------------------------------------
  // Compute KPIs
  // --------------------------------------------------
  const kpis = computeKPIs(currentLoans);

  // --------------------------------------------------
  // Initial render (grid / table via filters)
  // --------------------------------------------------
  applyLoanFilters();

  // --------------------------------------------------
  // UI: Render KPI tiles
  // --------------------------------------------------
  const kpisEl = document.getElementById("kpis");
  kpisEl.innerHTML = `
    <div class="kpi" data-kpi="tpv">
      <h3>Weighted ROI to Current Month</h3>
      <p id="wroi">${(kpis.weightedROI * 100).toFixed(2)}%</p>
    </div>

    <div class="kpi" data-kpi="rates">
      <h3>Projected Weighted ROI</h3>
      <p id="wproj">${(kpis.projectedWeightedROI * 100).toFixed(2)}%</p>
    </div>

    <div class="kpi" data-kpi="capitalRecovery">
      <h3>Capital Recovered</h3>
      <p>${(kpis.capitalRecoveryPct * 100).toFixed(2)}%</p>
    </div>

    <div class="kpi" data-kpi="spread">
      <h3>ROI Spread</h3>
      <p id="roiSpread"></p>
    </div>
  `;

  // --------------------------------------------------
  // KPI tile click (FULL ROI PAGE ONLY)
  // --------------------------------------------------
  document.querySelectorAll("#kpis .kpi").forEach(tile => {
    tile.addEventListener("click", e => {
      e.preventDefault();

      const kpi = tile.dataset.kpi;
      if (!kpi) return;

      if (!PAGE_CONTEXT.isEmbed) {
        openRoiKpiFromUrl(kpi);
      }
    });
  });

  // --------------------------------------------------
  // KPI tile click (IFRAME ‚Üí redirect to full ROI)
  // --------------------------------------------------
  if (PAGE_CONTEXT.isEmbed) {
    document.querySelectorAll("#kpis .kpi").forEach(tile => {
      tile.addEventListener(
        "click",
        e => {
          e.preventDefault();
          e.stopImmediatePropagation();

          const openKey = tile.dataset.kpi;
          if (!openKey) return;

          const url = new URL(
            window.location.origin + "/loan-dashboard/roi"
          );
          url.searchParams.set("user", PAGE_USER);
          url.searchParams.set("open", openKey);
          url.searchParams.set("from", "reporting");

          window.top.location.href = url.toString();
        },
        true
      );
    });
  }

  // --------------------------------------------------
  // KPI4 ‚Äî ROI Spread (SAFE)
  // --------------------------------------------------
  const roiValues = currentLoans.map(l => {
    const e = getCurrentOwnedRoiEntry(l);
    return e?.roi ?? 0;
  });

  const minROI = Math.min(...roiValues);
  const maxROI = Math.max(...roiValues);
  const roiSpread = maxROI - minROI;

  const spreadEl = document.getElementById("roiSpread");
  if (spreadEl) {
    spreadEl.textContent = (roiSpread * 100).toFixed(2) + "%";
  }

  // --------------------------------------------------
  // Populate filter dropdowns
  // --------------------------------------------------
  const nameSelect = document.getElementById("filterName");
  const schoolSelect = document.getElementById("filterSchool");

  const uniqueNames = [
    ...new Set(currentLoans.map(l => l.name).filter(Boolean))
  ];
  const uniqueSchools = [
    ...new Set(currentLoans.map(l => l.school).filter(Boolean))
  ];

  uniqueNames.forEach(n => {
    const opt = document.createElement("option");
    opt.value = n.toLowerCase();
    opt.textContent = n;
    nameSelect.appendChild(opt);
  });

  uniqueSchools.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.toLowerCase();
    opt.textContent = s;
    schoolSelect.appendChild(opt);
  });

  // --------------------------------------------------
  // Filters / sorting
  // --------------------------------------------------
  document.getElementById("filterName")
    .addEventListener("change", applyLoanFilters);
  document.getElementById("filterSchool")
    .addEventListener("change", applyLoanFilters);
  document.getElementById("filterRate")
    .addEventListener("change", applyLoanFilters);

  document.getElementById("resetFilters")
    .addEventListener("click", () => {
      document.getElementById("filterName").value = "";
      document.getElementById("filterSchool").value = "";
      document.getElementById("filterRate").value = "";
      applyLoanFilters();
    });

  // --------------------------------------------------
  // Compact view toggle (FULL PAGE ONLY)
  // --------------------------------------------------
  if (!PAGE_CONTEXT.isEmbed) {
    const compactToggle = document.getElementById("toggleCompact");
    const loanGrid = document.getElementById("loanGrid");

    if (compactToggle && loanGrid) {
      const savedCompact = localStorage.getItem("loanGridCompact");
      if (savedCompact !== null) {
        compactToggle.checked = savedCompact === "true";
      }

      loanGrid.classList.toggle("compact", compactToggle.checked);

      compactToggle.addEventListener("change", () => {
        loanGrid.classList.toggle("compact", compactToggle.checked);
        localStorage.setItem(
          "loanGridCompact",
          compactToggle.checked
        );
      });
    }
  }

  // --------------------------------------------------
  // Table view toggle (FULL PAGE ONLY)
  // --------------------------------------------------
  const tableToggle = document.getElementById("toggleTableView");
  if (tableToggle) {
    tableToggle.checked =
      localStorage.getItem("roiTableView") === "1";

    tableToggle.addEventListener("change", e => {
      localStorage.setItem(
        "roiTableView",
        e.target.checked ? "1" : "0"
      );
      applyLoanFilters();
    });
  }

  // ==================================================
  // FINAL STEP ‚Äî mark ready & open KPI (iframe-safe)
  // ==================================================
  DATA_READY = true;

  if (PAGE_CONTEXT.open) {
    requestAnimationFrame(() => {
      console.log("[INIT ROI] opening KPI from URL");
      openRoiKpiFromUrl();
    });
  }
}



// =====================================================
// TABLE VIEW TOGGLE ‚Äî PERSISTENT (MATCH COMPACT)
// =====================================================
document.getElementById("toggleTableView")?.addEventListener("change", (e) => {
  localStorage.setItem(
    "roiTableView",
    e.target.checked ? "1" : "0"
  );
  applyLoanFilters();
});


      
    /* -------------------------
       Drawer helpers & openers
       ------------------------- */
    const drawer = document.getElementById('drawer');
    const drawerTitle = document.getElementById('drawerTitle');
    const drawerSub = document.getElementById('drawerSub');
    const drawerPrimaryTitle = document.getElementById('drawerPrimaryTitle');
    const drawerPrimary = document.getElementById('drawerPrimary');
    const drawerSecondaryTitle = document.getElementById('drawerSecondaryTitle');
    const drawerSecondary = document.getElementById('drawerSecondary');
    const drawerChartArea = document.getElementById('drawerChartArea');
    const drawerLegend = document.getElementById('drawerLegend');
    const drawerExtra = document.getElementById('drawerExtra');
    const drawerAmortContainer = document.getElementById('drawerAmortContainer');

    document.getElementById('closeBtn').addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

    /* delete
    function closeDrawer(){ 
  drawer.classList.remove('open'); 
  drawer.setAttribute('aria-hidden','true'); 
  tooltip.style.display = 'none'; 
  currentLoan = null; 
  currentMode = "kpi";   // reset to default, not null
}
delet */

function forceDrawerVisible() {
  drawer.style.transform = "translateX(0)";
  drawer.style.right = "0";
}

    function closeDrawer() {
  // Clear state
  currentLoan = null;
  currentMode = null;

  // Remove open state
  drawer.classList.remove("open", "loan-mode");
  drawer.setAttribute("aria-hidden", "true");

  // üîë UNDO forceDrawerVisible
  drawer.style.transform = "";
  drawer.style.right = "";

  // Optional cleanup
  drawerExtra.innerHTML = "";
  drawerLegend.style.display = "none";
  drawerAmortContainer.style.display = "none";

  // Clear URL param if present
  const url = new URL(window.location);
  url.searchParams.delete("open");
  window.history.replaceState({}, "", url);
}

    
function populateROILoanTable(){
  const tbody = document.querySelector("#roiLoansTable tbody");
  if(!tbody) return;

  tbody.innerHTML = allLoans.map(l => {
    const roiEntry = getCurrentOwnedRoiEntry(l);

    let matStr = '';
    try {
      const pd = new Date(l.purchaseDate);
      const months = Math.round((l.termYears + l.graceYears) * 12);
      pd.setMonth(pd.getMonth() + months);
      matStr = pd.toISOString().slice(0,10);
    } catch(e) {
      matStr = '';
    }

    const roiPct = (roiEntry.roi || 0) * 100;
    const id = l.id ?? l.loanId;
    const color = window.KPI_COLOR_MAP?.[id] || '#64748b';

    // ‚úÖ ADD data-loan-id HERE
    return `<tr data-loan-id="${id}">
      <td style="text-align:left;">
        <span style="
          display:inline-block;
          width:10px;
          height:10px;
          background:${color};
          border-radius:2px;
          margin-right:8px;
          vertical-align:middle;
        "></span>
        <strong>${l.name}</strong>
        <div style="font-size:12px;color:var(--muted)">${l.school || ""}</div>
      </td>
      <td style="text-align:left;">${l.purchaseDate}</td>
      <td style="text-align:left;">${matStr}</td>
      <td style="text-align:right;color:${color};font-weight:700">
        ${roiPct.toFixed(2)}%
      </td>
    </tr>`;
  }).join('');
    
      const chartSvg = drawerChartArea.querySelector("svg");
      if (!chartSvg) return;
    
      const table = document.getElementById("roiLoansTable");
      if (!table) return;
    
      const loanPaths = Array.from(
        chartSvg.querySelectorAll('path[data-type="loan"]')
      );

      table.querySelectorAll("tbody tr").forEach(row => {
        const rowLoanId = row.dataset.loanId;
        if (!rowLoanId) return;
    
    row.addEventListener("mouseenter", () => {
      loanPaths.forEach(p => {
        const isTarget = p.dataset.loanId === rowLoanId;
    
        p.setAttribute("stroke-opacity", isTarget ? "1" : "0.15");
        p.setAttribute("stroke-width", "1.2"); // KEEP ALL LINES SAME WIDTH
      });
    });
    
    row.addEventListener("mouseleave", () => {
      loanPaths.forEach(p => {
        p.setAttribute("stroke-opacity", "0.9");
        p.setAttribute("stroke-width", "1.2");
      });
    });
   });
 }

function populateProjectedROILoanTable(){
  const tbody = document.querySelector("#roiProjectedLoansTable tbody");
  if(!tbody) return;

  tbody.innerHTML = allLoans.map(l => {
    const roiEntry = getLastOwnedRoiEntry(l);

    let matStr = '';
    try {
      const pd = new Date(l.purchaseDate);
      const months = Math.round((l.termYears + l.graceYears) * 12);
      pd.setMonth(pd.getMonth() + months);
      matStr = pd.toISOString().slice(0,10);
    } catch(e) {
      matStr = '';
    }

    const roiPct = (roiEntry.roi || 0) * 100;
    const id = l.id ?? l.loanId;
    const color = window.KPI_COLOR_MAP?.[id] || '#64748b';

    return `<tr data-loan-id="${id}">
      <td style="text-align:left;">
        <span style="
          display:inline-block;
          width:10px;
          height:10px;
          background:${color};
          border-radius:2px;
          margin-right:8px;
          vertical-align:middle;
        "></span>
        <strong>${l.name}</strong>
        <div style="font-size:12px;color:var(--muted)">${l.school || ""}</div>
      </td>
      <td style="text-align:left;">${l.purchaseDate}</td>
      <td style="text-align:left;">${matStr}</td>
      <td style="text-align:right;color:${color};font-weight:700">
        ${roiPct.toFixed(2)}%
      </td>
    </tr>`;
  }).join('');

  // ---------- hover logic ----------
  // Ensure we bind to the MOST RECENT chart SVG
  const svgs = drawerChartArea.querySelectorAll("svg");
  if (!svgs.length) return;
  const chartSvg = svgs[svgs.length - 1];


  const table = document.getElementById("roiProjectedLoansTable");
  if (!table) return;

  const loanPaths = Array.from(
    chartSvg.querySelectorAll('path[data-type="loan"]')
  );
  const weightedPath = chartSvg.querySelector('path[data-type="weighted"]');

  table.querySelectorAll("tbody tr").forEach(row => {
    const rowLoanId = row.dataset.loanId;
    if (!rowLoanId) return;

    row.addEventListener("mouseenter", () => {
      loanPaths.forEach(p => {
        if (p.dataset.loanId === rowLoanId) {
          p.setAttribute("stroke-opacity", "1");
          p.setAttribute("stroke-width", "3");
        } else {
          p.setAttribute("stroke-opacity", "0.15");
          p.setAttribute("stroke-width", "1");
        }
      });

      // weighted projected line stays neutral
      if (weightedPath) {
        weightedPath.setAttribute("stroke-opacity", "1");
      }
    });

    row.addEventListener("mouseleave", () => {
      loanPaths.forEach(p => {
        p.setAttribute("stroke-opacity", "0.9");
        p.setAttribute("stroke-width", "1.2");
      });

      if (weightedPath) {
        weightedPath.setAttribute("stroke-opacity", "1");
      }
    });
  });
}




    /* ============================================
   HISTORICAL ROI TIMELINE ENGINE
   Builds a unified date-based ROI timeline
   For all loans, from earliest purchase ‚Üí today
   ============================================ */

function buildHistoricalRoiTimeline(loans) {
  const today = new Date();

  // ---- 1. Determine global timeline ----
  const earliestPurchase = loans.reduce((earliest, l) => {
    const d = new Date(l.purchaseDate);
    return d < earliest ? d : earliest;
  }, new Date(loans[0].purchaseDate));

  // Build monthly date list from earliest ‚Üí today
  const dates = [];
  const cursor = new Date(earliestPurchase);
  while (cursor <= today) {
    dates.push(new Date(cursor));
    cursor.setMonth(cursor.getMonth() + 1);
  }

  // ---- 2. Align each loan ROI onto the global date timeline ----
  const perLoanSeries = loans.map((loan, idx) => {
    const purchase = new Date(loan.purchaseDate);
    const id = loan.id ?? loan.loanId;
    const color = window.KPI_COLOR_MAP?.[id] || '#64748b';


    // Map ownershipDate -> ROI for quick lookup
    const roiMap = {};
    loan.cumSchedule.forEach(row => {

  if (!row.isOwned) return;

  const rowDate = row.displayDate || row.loanDate;
  if (!rowDate) return;

  const realized = (row.cumPrincipal + row.cumInterest) - row.cumFees;
  const unrealized = row.balance * 0.95;
  const loanValue = realized + unrealized;

  const roi = (loanValue - loan.purchasePrice) / loan.purchasePrice;

  // Month-safe key (NO UTC rollover)
  const key =
    rowDate.getFullYear() + "-" +
    String(rowDate.getMonth() + 1).padStart(2, "0");

  roiMap[key] = roi;
});



   // Build calendar-aligned ROI (null before purchase)
    // Initialize to the ROI of the first owned month to avoid a spike
    const roiKeys = Object.keys(roiMap).sort();
    let lastKnownROI = roiKeys.length ? roiMap[roiKeys[0]] : 0;
    
    const data = dates.map(date => {
      if (date < purchase) {
      return { date, y: null };
      }

    const key = date.toISOString().slice(0, 7);

    if (key in roiMap) {
    lastKnownROI = roiMap[key];
    }

    // forward-fill ROI after purchase
    return { date, y: lastKnownROI };
    });

    const displayName = loan.name || loan.loanName || `Loan ${id}`;
    
    return {
      id,
      name: displayName,
      color,
      data
    };
  });

  // ---- 3. Build weighted ROI series ----
  const totalInvested = loans.reduce((s, l) => s + l.purchasePrice, 0);

  const weightedSeries = dates.map((date, i) => {
    let weightedSum = 0;

    loans.forEach((loan, idx) => {
      const roi = perLoanSeries[idx].data[i].y;
      if (roi != null) {
        weightedSum += roi * loan.purchasePrice;
      }
    });

    const weightedRoi = weightedSum / totalInvested;

    return { date, y: weightedRoi };
  });

  return {
    dates,
    perLoanSeries,
    weightedSeries,
    earliestDate: earliestPurchase
  };
}

/* ==========================================================
   DATE-ALIGNED CHART ENGINE HELPERS
   ========================================================== */

// Convert YYYY-MM-DD to Date objects
function toDate(d) {
  return (d instanceof Date) ? d : new Date(d);
}



// Simple catmull-rom smoothing
function smoothPath(points) {
  if (points.length < 3) {
    return `M${points.map(p => `${p.x},${p.y}`).join(" L")}`;
  }
  let d = `M${points[0].x},${points[0].y}`;
  for (let i = 1; i < points.length - 2; i++) {
    const xc = (points[i].x + points[i + 1].x) / 2;
    const yc = (points[i].y + points[i + 1].y) / 2;
    d += ` Q ${points[i].x},${points[i].y} ${xc},${yc}`;
  }
  const n = points.length;
  d += ` T ${points[n - 1].x},${points[n - 1].y}`;
  return d;
}


      
    /* -------------------------
       KPI drawer renderers
       ------------------------- */
      
/* ============================================================
   TPV Drawer ‚Äî Weighted ROI To Date
   Using the same stable timeline engine as Projected ROI
   ============================================================ */
function renderTPVDrawer() {

console.log("%c[RENDER TPV DRAWER]", "color:#ec4899;font-weight:bold");
  
  currentMode = 'kpi';
  currentLoan = null;

  drawer.classList.remove('loan-mode');


  // Reset drawer
  drawerAmortContainer.style.display = 'none';
  drawerLegend.style.display = 'none';
  drawerChartArea.innerHTML = '';
  drawerExtra.innerHTML = '';

  drawerTitle.textContent = "Weighted ROI to Date";
  drawerSub.textContent = "Current Portfolio Snapshot";

  // ===============================
  // 1. Compute weighted ROI to date
  // ===============================
  const totalInv = allLoans.reduce((s,l)=> s + l.purchasePrice, 0);

  let weightedROI = 0;
  allLoans.forEach(l => {
    const last = getCurrentOwnedRoiEntry(l); // TODAY'S ROI ENTRY
    weightedROI += l.purchasePrice * (last.roi || 0);
  });
  weightedROI = weightedROI / Math.max(1, totalInv);

  drawerPrimaryTitle.textContent = "Weighted ROI to Date";
  drawerPrimary.textContent = (weightedROI * 100).toFixed(2) + "%";

  // ===============================
  // 2. Compute portfolio value today
  // ===============================
  let portfolioValue = 0;
  allLoans.forEach(l => {
    const last = getCurrentOwnedRoiEntry(l);
    portfolioValue += last.loanValue || 0;
  });

  drawerSecondaryTitle.textContent = "Portfolio Value";
  drawerSecondary.textContent = "$" + portfolioValue.toLocaleString();

  // ===============================
  // 3. Build TIMELINE using the
  //    existing stable Projected ROI engine
  //    BUT using today's ROI values
  // ===============================
  const timeline = buildHistoricalRoiTimeline(allLoans);

  // ===============================
  // 4. Render multi-series chart
  // ===============================
 const globalDates = buildGlobalDatesFromLoans(currentLoans);
  
  createMultiSeriesChart(
    drawerChartArea,
    timeline.perLoanSeries,
    timeline.weightedSeries,
    {
      weightedColor: "#000",
      weightedWidth: 2.6,
      dates: timeline.dates,
      tickSpacingX: 3   // label every other month
    }
  );


  // ===============================
  // 5. ROI-to-Date Table
  // ===============================
  drawerExtra.innerHTML = `
    <div style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">ROI to Date ‚Äî All Loans</h3>
      <div style="
        max-height:300px;
        overflow:auto;
        border:1px solid var(--border);
        border-radius:8px;
        padding:6px;
        background:var(--card);
      ">
        <table id="roiLoansTable" class="roi-table" style="width:100%;font-size:13px;">
          <thead>
            <tr>
              <th style="text-align:left;">Loan</th>
              <th style="text-align:left;">Purchase Date</th>
              <th style="text-align:left;">Maturity Date</th>
              <th style="text-align:right;">ROI to Date</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  `;

  populateROILoanTable();  // already implemented

  // ===============================
  // 6. Open drawer
  // ===============================
  drawer.classList.add('open');
  drawer.setAttribute('aria-hidden','false');
  drawer.scrollTop = 0;
}

      /* ============================================================
   PROJECTED ROI TIMELINE ENGINE
   Extends to each loan's maturity (NOT to today's date)
   ============================================================ */

  /* move to roiEngine
    function buildProjectedRoiTimeline(loans) {
  // ---- 1. Determine global start (earliest purchase) ----
  const earliestPurchase = loans.reduce((earliest, l) => {
    const d = new Date(l.purchaseDate);
    return d < earliest ? d : earliest;
  }, new Date(loans[0].purchaseDate));

  // ---- 2. Determine global end (latest maturity date) ----
  const latestMaturity = loans.reduce((latest, l) => {
    const mat = new Date(l.purchaseDate);
    mat.setMonth(mat.getMonth() + Math.round((l.termYears + l.graceYears) * 12));
    return mat > latest ? mat : latest;
  }, new Date(earliestPurchase));

  // ---- 3. Build monthly date list earliest ‚Üí latest maturity ----
  const dates = [];
  const cursor = new Date(earliestPurchase);
  while (cursor <= latestMaturity) {
    dates.push(new Date(cursor));
    cursor.setMonth(cursor.getMonth() + 1);
  }

  // ---- 4. Align per-loan ROI series ----
  const perLoanSeries = loans.map((loan, idx) => {
    const purchase = new Date(loan.purchaseDate);
const roiMap = {};

loan.cumSchedule.forEach(row => {
  if (!row.isOwned) return;

  const realized = (row.cumPrincipal + row.cumInterest) - row.cumFees;
  const unrealized = row.balance * 0.95;
  const loanValue = realized + unrealized;

  const roi = (loanValue - loan.purchasePrice) / loan.purchasePrice;

  const key = row.loanDate.toISOString().slice(0, 7);
  roiMap[key] = roi;
});



    // Determine the very first ROI value for this loan
const roiKeys = Object.keys(roiMap).sort();
const firstRoiValue = roiKeys.length ? roiMap[roiKeys[0]] : 0;

let lastKnownROI = firstRoiValue;   // <-- FIX: start correctly

const data = dates.map(date => {
  if (date < purchase) return { date, y: null };

  const key = date.toISOString().slice(0,7);
  if (roiMap[key] != null) {
    lastKnownROI = roiMap[key];
  }

  return { date, y: lastKnownROI };
});


    const loanId = loan.id ?? loan.loanId ?? idx;

    return {
      id: loanId,
      name: loan.name || `Loan ${loanId}`,
      color: window.KPI_COLOR_MAP?.[loanId] || loanColors[idx % loanColors.length],
      data
    };

  });

  // ---- 5. Weighted ROI series ----
  const totalInvested = loans.reduce((s,l)=> s + l.purchasePrice, 0);

  const weightedSeries = dates.map((date, i) => {
    let weightedSum = 0;
    loans.forEach((loan, idx) => {
      const roi = perLoanSeries[idx].data[i].y;
      if (roi != null) {
        weightedSum += roi * loan.purchasePrice;
      }
    });
    return { date, y: weightedSum / totalInvested };
  });

  return {
    dates,
    perLoanSeries,
    weightedSeries
  };
}
move to roiEngione */

function renderRatesDrawer() {

  if (
    !Array.isArray(allLoans) ||
    allLoans.length === 0 ||
    allLoans.some(l => !l || !l.purchaseDate)
  ) {
    console.warn("[Rates Drawer] aborted ‚Äî loans not ready");
    return;
  }
  
  console.log(
    "%c[RENDER RATES DRAWER]",
    "color:#ec4899;font-weight:bold"
  );

  currentMode = "kpi";
  currentLoan = null;

  drawer.classList.remove("loan-mode");

  drawerAmortContainer.style.display = "none";
  drawerLegend.style.display = "none";
  drawerChartArea.innerHTML = "";
  drawerExtra.innerHTML = "";

  drawerTitle.textContent = "Projected Weighted ROI";
  drawerSub.textContent = "Projection to Maturity";

  // =====================================================
  // 1. Compute projected weighted ROI (headline KPI)
  // =====================================================
  const totalInv = allLoans.reduce(
    (s, l) => s + (l.purchasePrice || 0),
    0
  );

  let projWeightedROI = 0;

  allLoans.forEach(l => {
    const last = getLastOwnedRoiEntry(l);
    if (!last) return;
    projWeightedROI += l.purchasePrice * (last.roi || 0);
  });

  projWeightedROI =
    projWeightedROI / Math.max(1, totalInv);

  drawerPrimaryTitle.textContent = "Projected Weighted ROI";
  drawerPrimary.textContent =
    (projWeightedROI * 100).toFixed(2) + "%";

  // =====================================================
  // 2. Compute projected portfolio value
  // =====================================================
  let projPortfolioValue = 0;

  allLoans.forEach(l => {
    const last = getLastOwnedRoiEntry(l);
    if (!last) return;
    projPortfolioValue += last.loanValue || 0;
  });

  drawerSecondaryTitle.textContent =
    "Projected Portfolio Value";
  drawerSecondary.textContent =
    "$" + projPortfolioValue.toLocaleString();

  // =====================================================
  // 3. Build ROI timeline (PORTFOLIO LEVEL)
  // =====================================================
  const timeline = buildProjectedRoiTimeline(allLoans);

  // üîí Guard: never partially render KPI drawer
  if (
    !timeline ||
    !timeline.dates?.length ||
    !timeline.perLoanSeries?.length
  ) {
    drawerChartArea.innerHTML =
      `<div class="muted">No projected ROI data available</div>`;
    drawerExtra.innerHTML = "";
    drawer.classList.add("open");
    drawer.setAttribute("aria-hidden", "false");
    return;
  }

  // =====================================================
  // 4. Render multi-series chart
  // =====================================================
  createMultiSeriesChart(
    drawerChartArea,
    timeline.perLoanSeries,
    timeline.weightedSeries,
    {
      weightedColor: "#000",
      weightedWidth: 2.6,
      dates: timeline.dates
    }
  );

  // =====================================================
  // 5. Table: Projected ROI per loan
  // =====================================================
  drawerExtra.innerHTML = `
    <div style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">
        Projected ROI at Maturity ‚Äî All Loans
      </h3>
      <div style="
        max-height:300px;
        overflow:auto;
        border:1px solid var(--border);
        border-radius:8px;
        padding:6px;
        background:var(--card);
      ">
        <table
          id="roiProjectedLoansTable"
          class="roi-table"
          style="width:100%;font-size:13px;"
        >
          <thead>
            <tr>
              <th style="text-align:left;">Loan</th>
              <th style="text-align:left;">Purchase Date</th>
              <th style="text-align:left;">Maturity Date</th>
              <th style="text-align:right;">Projected ROI</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  `;

  populateProjectedROILoanTable();

  // =====================================================
  // 6. Open drawer
  // =====================================================
  drawer.classList.add("open");
  drawer.setAttribute("aria-hidden", "false");
  drawer.scrollTop = 0;
}


// ============================================================
// KPI4 ‚Äî ROI SPREAD DRAWER
// ============================================================
function renderROISpreadDrawer() {
  currentMode = 'kpi';
  currentLoan = null;
  drawer.classList.remove('loan-mode');

  drawerAmortContainer.style.display = 'none';
  drawerLegend.style.display = 'none';
  drawerChartArea.innerHTML = '';
  drawerExtra.innerHTML = '';

  drawerTitle.textContent = "ROI Spread";
  drawerSub.textContent = "Best vs Worst Performing Loans";

  // -------------------------------
  // Compute spread stats
  // -------------------------------
  const rows = allLoans.map(l => {
    const e = getCurrentOwnedRoiEntry(l);
    return {
      id: l.id,
      name: l.name,
      school: l.school,
      roi: e?.roi ?? 0,
      color: window.KPI_COLOR_MAP?.[l.id] || '#64748b'
    };
  });

  rows.sort((a, b) => b.roi - a.roi);

  const best = rows[0];
  const worst = rows[rows.length - 1];
  const spread = best.roi - worst.roi;

  drawerPrimaryTitle.textContent = "ROI Spread";
  drawerPrimary.textContent = (spread * 100).toFixed(2) + "%";

  drawerSecondaryTitle.textContent = "Loans";
  drawerSecondary.textContent = rows.length;

  // -------------------------------
  // Chart for Spread Drawer (multi-series)
  // -------------------------------
 const timeline = buildHistoricalRoiTimeline(allLoans);

const globalDates = buildGlobalDatesFromLoans(currentLoans);
  
createMultiSeriesChart(
  drawerChartArea,
  timeline.perLoanSeries,
  null, // ‚õî NO weighted line
  {
    dates: timeline.dates,
    tickSpacingX: 3,     // SAME as Weighted ROI to Date
    hideWeighted: true
  }
);


  // -------------------------------
  // Table
  // -------------------------------
drawerExtra.innerHTML = `
  <div style="margin-top:12px">
    <h3 style="margin:0 0 8px 0">ROI by Loan</h3>
    <div style="
      max-height:320px;
      overflow:auto;
      border:1px solid var(--border);
      border-radius:8px;
      padding:6px;
      background:var(--card);
    ">
      <table id="roiLoansTable" class="roi-table" style="width:100%;font-size:13px;">
        <thead>
          <tr>
            <th style="text-align:left">Loan</th>
            <th style="text-align:left">Purchase Date</th>
            <th style="text-align:left">Maturity Date</th>
            <th style="text-align:right">ROI to Date</th>
            <th style="text-align:right">Œî vs Best</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => {
            const loan = allLoans.find(l => l.id === r.id);
            if (!loan) return '';

            let maturity = '';
            try {
              const d = new Date(loan.purchaseDate);
              const months = Math.round((loan.termYears + loan.graceYears) * 12);
              d.setMonth(d.getMonth() + months);
              maturity = d.toISOString().slice(0,10);
            } catch {}

            return `
              <tr data-loan-id="${r.id}">
                <td style="text-align:left;">
                  <span style="
                    display:inline-block;
                    width:10px;
                    height:10px;
                    background:${r.color};
                    border-radius:2px;
                    margin-right:8px;
                    vertical-align:middle;
                  "></span>
                  <strong>${r.name}</strong>
                  <div style="font-size:12px;color:var(--muted)">
                    ${r.school || ""}
                  </div>
                </td>
                <td style="text-align:left;">
                  ${loan.purchaseDate || ""}
                </td>
                <td style="text-align:left;">
                  ${maturity}
                </td>
                <td style="text-align:right;color:${r.color};font-weight:700">
                  ${(r.roi * 100).toFixed(2)}%
                </td>
                <td style="text-align:right;color:var(--muted)">
                  ${((r.roi - best.roi) * 100).toFixed(2)}%
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  </div>
`;

  // -----------------------------------------
  // ROI Spread table row ‚Üí chart hover binding
  // -----------------------------------------
  const chartSvg = drawerChartArea.querySelector("svg");
  if (chartSvg) {
    const loanPaths = Array.from(
      chartSvg.querySelectorAll('path[data-type="loan"]')
    );
  
    const table = document.getElementById("roiLoansTable");
    if (table) {
      table.querySelectorAll("tbody tr").forEach(row => {
        const rowLoanId = row.dataset.loanId;
        if (!rowLoanId) return;
  
        row.addEventListener("mouseenter", () => {
          loanPaths.forEach(p => {
            const isTarget = p.dataset.loanId === rowLoanId;
            p.setAttribute("stroke-opacity", isTarget ? "1" : "0.15");
            p.setAttribute("stroke-width", isTarget ? "2.6" : "1.2");
          });
        });
  
        row.addEventListener("mouseleave", () => {
          loanPaths.forEach(p => {
            p.setAttribute("stroke-opacity", "0.9");
            p.setAttribute("stroke-width", "1.2");
          });
        });
      });
    }
  }


  drawer.classList.add('open');
  drawer.setAttribute('aria-hidden','false');
  drawer.scrollTop = 0;

}

function renderCapitalRecoveryDrawer() {

console.log("%c[RENDER CAPITAL RECOVERY DRAWER]", "color:#ec4899;font-weight:bold");
  
  currentMode = 'kpi';
  currentLoan = null;

  // -----------------------------
  // Open + reset drawer
  // -----------------------------
  drawer.classList.add('open');
  drawer.setAttribute('aria-hidden', 'false');
  drawer.classList.remove('loan-mode');

  drawerAmortContainer.style.display = 'none';
  drawerLegend.style.display = 'none';
  drawerChartArea.innerHTML = '';
  drawerExtra.innerHTML = '';

  drawerTitle.textContent = "Capital Recovery Over Time";
  drawerSub.textContent =
    "Cumulative principal returned as a percentage of purchase price (through today).";

  const TODAY = new Date();
  TODAY.setHours(23, 59, 59, 999);

  // --------------------------------------------------
  // Build per-loan recovery series (MONTHLY, TO TODAY)
  // --------------------------------------------------
  const loanSeriesList = [];
  const monthMap = new Map(); // key = YYYY-MM ‚Üí Date(1st)

  function monthKey(d) {
    return `${d.getFullYear()}-${d.getMonth()}`;
  }

  function monthStart(d) {
    return new Date(d.getFullYear(), d.getMonth(), 1);
  }

  currentLoans.forEach(l => {
    if (!l.amort || !l.amort.schedule) return;

    let cumPrincipal = 0;
    const monthly = new Map();

    l.amort.schedule
      .filter(r => r.isOwned && r.loanDate && r.loanDate <= TODAY)
      .forEach(r => {
        const m = monthStart(r.loanDate);
        const k = monthKey(m);

        cumPrincipal += r.principalPaid || 0;

        const pct =
          l.purchasePrice > 0 ? cumPrincipal / l.purchasePrice : 0;

        monthly.set(k, { date: m, y: pct });
        monthMap.set(k, m);
      });

    loanSeriesList.push({
      id: l.id,
      name: l.name,
      color: window.KPI_COLOR_MAP?.[l.id] || '#64748b',
      data: Array.from(monthly.values())
    });
  });

  // --------------------------------------------------
  // Unified MONTHLY date axis (clean)
  // --------------------------------------------------
  const globalDates = Array.from(monthMap.values()).sort(
    (a, b) => a - b
  );

  // --------------------------------------------------
  // Portfolio cumulative line (MONTHLY)
  // --------------------------------------------------
  const totalInvested = currentLoans.reduce(
    (s, l) => s + (l.purchasePrice || 0),
    0
  );

  let cumPortfolioRecovered = 0;

  const portfolioSeries = globalDates.map(d => {
    let monthRecovered = 0;

    currentLoans.forEach(l => {
      l.amort?.schedule
        ?.filter(
          r =>
            r.isOwned &&
            r.loanDate &&
            r.loanDate <= TODAY &&
            r.loanDate.getFullYear() === d.getFullYear() &&
            r.loanDate.getMonth() === d.getMonth()
        )
        .forEach(r => {
          monthRecovered += r.principalPaid || 0;
        });
    });

    cumPortfolioRecovered += monthRecovered;

    return {
      date: d,
      y: totalInvested > 0 ? cumPortfolioRecovered / totalInvested : 0
    };
  });

  // --------------------------------------------------
  // Dynamic x-axis spacing (‚âà 6‚Äì8 labels max)
  // --------------------------------------------------
  const tickSpacingX = Math.max(
    1,
    Math.round(globalDates.length / 7)
  );

  // --------------------------------------------------
  // Render chart (CLEAN X-AXIS)
  // --------------------------------------------------
  
  createMultiSeriesChart(
    document.getElementById('drawerChartArea'),
    loanSeriesList,
    portfolioSeries,
    {
      dates: globalDates,
      weightedColor: '#111827',
      weightedWidth: 3,
      tickSpacingX
    }
  );

  // --------------------------------------------------
  // Metrics
  // --------------------------------------------------
  drawerPrimaryTitle.textContent = "Capital Recovered";
  drawerPrimary.textContent =
    "$" + (kpis.capitalRecoveredAmount || 0).toLocaleString();

  drawerSecondaryTitle.textContent = "% Recovered";
  drawerSecondary.textContent =
    ((kpis.capitalRecoveryPct || 0) * 100).toFixed(2) + "%";

  // --------------------------------------------------
  // Table (unchanged)
  // --------------------------------------------------
  let html = `
    <div class="amort-wrap">
      <table class="kpi-table" id="capitalRecoveryTable">
        <thead>
          <tr>
            <th>Loan</th>
            <th>Cap Recovered</th>
            <th>% Recovered</th>
            <th>Remaining</th>
          </tr>
        </thead>
        <tbody>
  `;

  currentLoans.forEach(l => {
    if (!l.amort || !l.amort.schedule) return;

    const recovered = l.amort.schedule
      .filter(r => r.isOwned && r.loanDate && r.loanDate <= TODAY)
      .reduce((s, r) => s + (r.principalPaid || 0), 0);

    const pct = l.purchasePrice > 0 ? recovered / l.purchasePrice : 0;
    const remaining =
      Math.max(0, (l.balanceAtPurchase || 0) - recovered);

    const color = window.KPI_COLOR_MAP?.[l.id] || '#64748b';

    html += `
      <tr data-loan-id="${l.id}">
        <td>
          <div style="display:flex;gap:8px;align-items:center">
            <span style="width:10px;height:10px;border-radius:2px;background:${color}"></span>
            <div>
              <div style="font-weight:500">${l.name}</div>
              <div style="font-size:11px;color:#64748b">${l.school || ''}</div>
            </div>
          </div>
        </td>
        <td style="color:${color};font-weight:600">$${recovered.toLocaleString()}</td>
        <td>${(pct * 100).toFixed(2)}%</td>
        <td>$${remaining.toLocaleString()}</td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
    </div>
  `;

  drawerExtra.innerHTML = html;

const table = document.getElementById("capitalRecoveryTable");
if (table) {
  table.querySelectorAll("tbody tr").forEach(row => {
    const loanId = row.dataset.loanId;
    if (!loanId) return;

    row.addEventListener("mouseenter", () => {
      if (window.__roiChartFocusLoan) {
        window.__roiChartFocusLoan(loanId);
      }
    });

    row.addEventListener("mouseleave", () => {
      if (window.__roiChartClearFocus) {
        window.__roiChartClearFocus();
      }
    });
  });
}


}

// ----------------------------------
// Embed auto-open handling (KPI2)
// ----------------------------------
const urlParams = new URLSearchParams(window.location.search);
const EMBED_MODE = urlParams.get("embed") === "true";
const OPEN_TARGET = urlParams.get("open");

requestAnimationFrame(() => {
  if (OPEN_TARGET === "kpi2" || OPEN_TARGET === "projectedROI") {
    if (typeof renderRatesDrawer === "function") {
      renderRatesDrawer();
    }
  }
});


// ----------------------------------
// Embed click-through to full ROI
// ----------------------------------
if (EMBED_MODE) {
  document.addEventListener(
    "click",
    (e) => {
      // Allow normal interaction
      if (e.target.closest("button, select, a, input, textarea")) return;

      const user = PAGE_USER || "jeff";
      window.top.location.href =
        `/loan-dashboard/roi/index.html?user=${user}&from=reporting&open=kpi2`;
    },
    { passive: true }
  );
}

/* from GROK */
// Apply embed mode layout
if (EMBED_MODE) {
  document.body.classList.add('embed-mode'); // Trigger CSS (optional, but keep for any other styles)

  // Hide header to remove title, subhead, and theme toggle (matches Earnings/Amort)
  const header = document.querySelector('header');
  if (header) header.style.display = 'none';

  // Hide filters specifically (since they appear after KPIs)
  const filters = document.querySelector('.loan-filters');
  if (filters) filters.style.display = 'none';

  // Force drawer visibility and positioning
  const drawer = document.querySelector('.drawer');
  if (drawer) {
      drawer.style.display = 'flex';
      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden', 'false');

      // Move drawer below KPIs (append to .app)
      const app = document.querySelector('.app');
      const kpis = document.querySelector('.kpis');
      if (app && kpis) {
          app.appendChild(drawer); // Reposition drawer as last child
      }
  }

// Enable full iframe scrolling (override root hidden overflow)
document.documentElement.style.overflow = 'auto';
document.documentElement.style.height = 'auto';
document.body.style.overflow = 'auto';
document.body.style.height = 'auto';
  
  // Hide feedback button if present (matches Earnings/Amort)
  const feedbackBtn = document.getElementById('feedback-btn');
  if (feedbackBtn) feedbackBtn.style.display = 'none';

  // Ensure auto-open works in embed
  requestAnimationFrame(() => {
      if (OPEN_TARGET === "kpi2" || OPEN_TARGET === "projectedROI") {
          renderRatesDrawer(); // Open KPI2 drawer (as existing)
      }
  });
}

      
    /* -------------------------
       KPI wiring & interactions
       ------------------------- */
    document.querySelectorAll('.kpi').forEach(k=>{ k.addEventListener('click', ev=>{ ev.stopPropagation(); const key=k.getAttribute('data-kpi'); if(key==='spread') renderROISpreadDrawer(); if(key==='tpv') renderTPVDrawer(); if(key==='rates') renderRatesDrawer(); if(key==='capitalRecovery') renderCapitalRecoveryDrawer(); }); });

    /* -------------------------
       CSV / clipboard / download / print
       ------------------------- */
    function copyPortfolioCSV(){ let rows=[['Loan','Purchase Date','Amount','Rate']]; allLoans.forEach(l=>rows.push([formatLoanLabel(l),l.purchaseDate,l.purchasePrice,(l.nominalRate*100).toFixed(2)+'%'])); const csv=rows.map(r=>r.join(',')).join('\n'); navigator.clipboard.writeText(csv); alert('CSV copied to clipboard'); }
    function amortToCSV(loan){ const rows=[['Month','Payment','Principal','Interest','Balance']]; loan.amort.schedule.forEach(r=>rows.push([r.monthIndex,r.payment.toFixed(2),r.principalPaid.toFixed(2),r.interest.toFixed(2),r.balance.toFixed(2)])); return rows.map(r=>r.join(',')).join('\n'); }
    document.getElementById('copyCsvBtn')?.addEventListener('click', async ()=>{ if(currentMode!=='loan' || !currentLoan) return alert('Open an individual loan drawer to copy CSV'); const csv=amortToCSV(currentLoan); try{ await navigator.clipboard.writeText(csv); alert('CSV copied to clipboard'); }catch(e){ alert('Copy failed ‚Äî browser denied clipboard access'); } });
    document.getElementById('downloadCsvBtn')?.addEventListener('click', ()=>{ if(currentMode==='loan' && currentLoan){ const csv=amortToCSV(currentLoan); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='loan-'+currentLoan.id+'-amort.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); } else alert('Download CSV is supported for individual loan drawers only.'); });
    document.getElementById('printBtn')?.addEventListener('click', ()=>window.print());

    /* -------------------------
       Close drawer on outside click; hide tooltip on scroll
       ------------------------- */
   document.addEventListener("click", function (e) {
  if (!drawer.classList.contains("open")) return;

  const clickedInsideDrawer = drawer.contains(e.target);
  const clickedTile = !!e.target.closest(".tile");
const clickedKpi  = !!e.target.closest(".kpi");

  const clickedTableRow = !!e.target.closest("#loanTable tr");

if (
  !clickedInsideDrawer &&
  !clickedTile &&
  !clickedTableRow &&
  !clickedKpi
) {
  closeDrawer();
}

});

    document.querySelector('.grid').addEventListener('scroll', ()=>{ tooltip.style.display='none'; });

    /* -------------------------
       End
       ------------------------- */

// ======================================================
// EMBED MODE ‚Äî OVERRIDE KPI2 DRAWER BUTTON BEHAVIOR + LAYOUT
// ======================================================
const _embedParams = new URLSearchParams(window.location.search);
const _IS_EMBED = _embedParams.get("embed") === "true";
const _OPEN_TARGET = _embedParams.get("open"); // Parse open param here

if (_IS_EMBED) {
  const user = PAGE_USER || "jeff";
  const targetUrl =
    `/loan-dashboard/roi/index.html?user=${user}&from=reporting&open=kpi2`;

  function redirectToFullROI(e) {
    e.preventDefault();
    e.stopImmediatePropagation();
    window.top.location.href = targetUrl;
  }

  // --- Redirect buttons ---
  ["closeBtn", "downloadCsvBtn", "printBtn", "copyCsvBtn"].forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.addEventListener("click", redirectToFullROI, true);
  });

  // Hide header (title, subhead, theme toggle)
  const header = document.querySelector('header');
  if (header) header.style.display = 'none';

  // Hide filters
  const filters = document.querySelector('.loan-filters');
  if (filters) filters.style.display = 'none';

  // Optional: Hide grid/tiles for cleaner embed
  const grid = document.querySelector('.grid');
  if (grid) grid.style.display = 'none';

  // Force drawer ready
  const drawer = document.querySelector('.drawer');
  if (drawer) {
    drawer.style.display = 'flex';
    drawer.classList.add('open');
    drawer.setAttribute('aria-hidden', 'false');

    const app = document.querySelector('.app');
    if (app) app.appendChild(drawer);
  }

  // Hide feedback
  const feedbackBtn = document.getElementById('feedback-btn');
  if (feedbackBtn) feedbackBtn.style.display = 'none';

/* delete
  // Restore auto-open KPI2 drawer (runs after initROI/loans)
  if (_OPEN_TARGET === "kpi2" || _OPEN_TARGET === "projectedROI") {
    // Slight delay ensures initROI() has run and drawer is ready
    setTimeout(() => {
      renderRatesDrawer();
    }, 100);
  }
delete */

  // Enable full iframe scrolling (override root hidden overflow, matches Earnings/Amort)
  document.documentElement.style.overflow = 'auto';
  document.documentElement.style.height = 'auto';
  document.body.style.overflow = 'auto';
  document.body.style.height = 'auto';

  // Allow drawer to expand fully (no internal scrollbar)
  const drawerBody = document.querySelector('.drawer-body');
  if (drawerBody) {
    drawerBody.style.overflow = 'visible'; // No internal scroll; full height
  }
}

/*    delete 
// üîë Open KPI drawer from ?open=
// ‚ùó DO NOT override loan drawer
if (currentMode !== "loan") {
  openRoiKpiFromUrl();
}
delete */


// =====================================================
// Loan Table ‚Äî Column Header Sorting (MATCH AMORT)
// =====================================================
document.querySelectorAll("#loanTable th").forEach(th => {
  th.addEventListener("click", () => {
    const key = th.dataset.key;
    if (!key) return;

    if (TABLE_SORT.key === key) {
      TABLE_SORT.dir *= -1;
    } else {
      TABLE_SORT.key = key;
      TABLE_SORT.dir = 1;
    }

    // Update header sort indicators
    document
      .querySelectorAll("#loanTable th")
      .forEach(h => h.removeAttribute("data-sort"));

    th.setAttribute(
      "data-sort",
      TABLE_SORT.dir === 1 ? "asc" : "desc"
    );

    // Re-render table using sorted loans
    renderLoanTableROI(getLoansForTableView());
  });
});


    document.addEventListener("DOMContentLoaded", async () => {
      await loadLoans();

// =========================================
// DERIVE + INITIALIZE FILTER STATE (REQUIRED)
// =========================================
const derivedLoans = deriveLoansWithAmortAndRoi(loans);

// üîë SOURCE OF TRUTH
allLoans = derivedLoans;
currentLoans = derivedLoans;
filteredLoans = derivedLoans;

// üîë Populate filter dropdowns from real data
populateLoanFilters(allLoans);



// =========================================
// INITIAL RENDER ‚Äî EMBED SAFE
// =========================================
if (PAGE_CONTEXT.isEmbed) {
  // iframe shows ONLY KPIs + drawer
  document.getElementById("loanGrid")?.remove();
  document.getElementById("loanTableWrap")?.remove();
} else if (localStorage.getItem("roiTableView") === "1") {
  document.getElementById("toggleTableView").checked = true;
  renderLoanTableROI();
} else {
  renderLoanGrid(currentLoans);
}


// =====================================================
// EMBED MODE ‚Äî FORCE KPI DRAWER (MATCH AMORT)
// Must run ONCE, after initial render
// =====================================================
const params = new URLSearchParams(window.location.search);

if (params.get("embed") === "true" && params.get("open")) {
  // Table view is FULL-PAGE ONLY ‚Äî never iframe
  localStorage.removeItem("roiTableView");

  const tableToggle = document.getElementById("toggleTableView");
  if (tableToggle) tableToggle.checked = false;

  // Open exactly one KPI drawer
  openRoiKpiDrawer(params.get("open"));
}

      
      document.getElementById("currentDate").textContent =
  formatMonthYear(new Date());

      initROI();
    });

    
    // theme toggle
window.addEventListener("DOMContentLoaded", () => {
  const toggle = document.getElementById("themeToggle");
  if (!toggle) return;

  const applyTheme = (theme) => {
    document.documentElement.setAttribute("data-theme", theme);
    document.body.classList.toggle("dark", theme === "dark");
    localStorage.setItem("theme", theme);
    toggle.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
    toggle.setAttribute("aria-label", theme === "dark" ? "Switch to light mode" : "Switch to dark mode");
    toggle.setAttribute("title", theme === "dark" ? "Switch to light mode" : "Switch to dark mode");
  };

  const saved = localStorage.getItem("theme");
  const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
  applyTheme(saved || (prefersDark ? "dark" : "light"));

  toggle.addEventListener("click", () => {
    const nextTheme = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
    applyTheme(nextTheme);
  });
});

</script>

<script src="/loan-dashboard/js/feedback.js"></script>

    
</body>
</html>

<script>

const isEmbed = new URLSearchParams(window.location.search).get('embed') === 'true';

</script>
