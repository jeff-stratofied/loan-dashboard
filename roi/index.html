<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio â€” Rebuilt Dashboard</title>

  <!-- ====================================
       Styles (organized, with dark mode)
       ==================================== -->
  <style>

    :root {
      --bg-light: #f8fafc;
      --bg-dark: #0b1220;
      --surface-light: #f1f5f9;
      --surface-dark: #071829;
      --card-light: #ffffff;
      --card-dark: #071022;
      --border-light: rgba(15,23,42,0.07);
      --border-dark: #334155;
      --text-light: #0f172a;
      --text-dark: #e6eef8;
      --muted-light: #64748b;
      --muted-dark: #9aa6b2;
      --brand-light: #0ea5e9;
      --brand-dark: #38bdf8;
      --accent-light: #7c3aed;
      --accent-dark: #c4b5fd;
      --shadow-light: 0 12px 30px rgba(15,23,42,0.06);
      --shadow-dark: 0 12px 30px rgba(2,6,23,0.6);
      --chart-bg-light: linear-gradient(180deg, #ffffff, #fcfeff);
      --chart-bg-dark: linear-gradient(180deg, rgba(56,189,248,0.12), rgba(124,58,237,0.16));
      --table-header-light: #ffffff;
      --table-header-dark: #0f172a;
      --table-border-light: rgba(15,23,42,0.07);
      --table-border-dark: rgba(148,163,184,0.5);
      --tooltip-bg-light: var(--text-light);
      --tooltip-bg-dark: #0b1220;
      --tooltip-text-light: #ffffff;
      --tooltip-text-dark: var(--text-dark);
      --kpi-hover: translateY(-6px);
    }

    html[data-theme="light"] {
      --bg: var(--bg-light);
      --surface: var(--surface-light);
      --card: var(--card-light);
      --border: var(--border-light);
      --text: var(--text-light);
      --muted: var(--muted-light);
      --brand: var(--brand-light);
      --accent: var(--accent-light);
      --shadow: var(--shadow-light);
      --chart-bg: var(--chart-bg-light);
      --table-header: var(--table-header-light);
      --table-border: var(--table-border-light);
      --tooltip-bg: var(--tooltip-bg-light);
      --tooltip-text: var(--tooltip-text-light);
    }

    html[data-theme="dark"] {
      --bg: var(--bg-dark);
      --surface: var(--surface-dark);
      --card: var(--card-dark);
      --border: var(--border-dark);
      --text: var(--text-dark);
      --muted: var(--muted-dark);
      --brand: var(--brand-dark);
      --accent: var(--accent-dark);
      --shadow: var(--shadow-dark);
      --chart-bg: var(--chart-bg-dark);
      --table-header: var(--table-header-dark);
      --table-border: var(--table-border-dark);
      --tooltip-bg: var(--tooltip-bg-dark);
      --tooltip-text: var(--tooltip-text-dark);
    }
/* Smooth theme transitions (copied from amortization page) */
html, body,
.app,
header,
.kpi, .tile,
.drawer, .drawer-head, .drawer-body, .drawer-footer,
.info-card, .drawer-chart,
table, thead th, td,
.tooltip,
.theme-icon,
svg text {
  transition:
    background-color .25s ease,
    color .25s ease,
    border-color .25s ease,
    box-shadow .25s ease,
    fill .25s ease;
}


    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--text);background-color:var(--bg)}
    body{background:linear-gradient(180deg,var(--surface) 0%, var(--card) 100%); -webkit-font-smoothing:antialiased}
    .app{max-width:1200px;margin:20px auto;padding:16px}
    header{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
    .header-top{display:flex;align-items:center;justify-content:space-between}
    h1{ font-size:20px; margin:0 }
    p.lead{ margin:0; color:var(--muted); font-size:13px }
    .current-date{ font-size:13px; color:var(--muted); margin-top:4px }

    /* =========================
       Buttons (unified with Amort Page)
       ========================= */
    .actions { display:flex; gap:8px; align-items:center }
    .btn{ padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:transparent; cursor:pointer; font-weight:600; color:var(--text); transition:background .2s ease, color .2s ease, border-color .2s ease }
    .btn.primary{ background:linear-gradient(90deg,var(--brand),var(--accent)); color:white; border:none; box-shadow: var(--shadow) }
    .btn.secondary{ background:var(--surface); color:var(--text); }
    .close-btn{ background:var(--surface); border:1px solid var(--border); padding:8px; border-radius:8px; cursor:pointer; }
    .btn:hover, .close-btn:hover{ border-color:rgba(15,23,42,0.14); }

    /* =========================
       KPI row + tiles (unified hover)
       ========================= */
    .kpis{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:14px 0 18px }
    .kpi{ background:var(--card); padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(16,24,40,0.04); border:1px solid var(--border); cursor:pointer; transition: transform .18s ease, box-shadow .18s ease; display:flex;flex-direction:column;justify-content:center }
    .kpi:hover, .tile:hover{ transform: var(--kpi-hover); box-shadow:var(--shadow) }
    .kpi h3{ margin:0; font-size:12px; color:var(--muted) }
    .kpi p{ margin:8px 0 0; font-size:18px; font-weight:700 }

    .grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; height:calc(100vh - 320px); overflow:auto; padding-right:6px }
    @media(max-width:900px){ .grid{ grid-template-columns:1fr; height:auto } .kpis{ grid-template-columns:repeat(2,1fr) } }

    .tile{ display:flex; align-items:center; justify-content:space-between; padding:12px; border-radius:12px; background:var(--card); min-height:110px; cursor:pointer; overflow:hidden; transition: transform .18s ease, box-shadow .18s ease; border:1px solid var(--border) }
    .tile-left{ flex:1; padding-right:10px }
    .loan-name{ font-weight:700; font-size:14px }
    .loan-sub{ font-size:12px; color:var(--muted); margin-top:6px }
    .loan-meta{ display:flex; gap:8px; font-size:12px; color:var(--muted); margin-top:8px }

    .chart-wrap{ width:170px; flex-shrink:0; display:flex; flex-direction:column; align-items:flex-end }
    .mini-label{ font-size:12px; color:var(--muted); margin-bottom:6px }
    svg.sparkline{ width:170px; height:48px; display:block }

    /* =========================
       Drawer (with opening animation)
       ========================= */
    .drawer{
      position:fixed; right:0; top:0; height:100vh; max-width:1000px; width:760px; background:var(--card);
      box-shadow:-28px 0 80px rgba(2,6,23,0.14); transform:translateX(110%); transition: transform .32s cubic-bezier(.2,.9,.3,1), opacity .24s ease;
      z-index:120; opacity:0; display:flex; flex-direction:column; overflow:hidden;
      padding:0; border-left:1px solid var(--border);
    }
    .drawer.open{ transform:translateX(0); opacity:1; animation: drawerIn .28s cubic-bezier(.2,.9,.3,1); }
    @keyframes drawerIn { from { transform: translateX(30%); opacity:0 } to { transform: translateX(0); opacity:1 } }

    .drawer-head{ display:flex; align-items:start; justify-content:space-between; gap:8px; padding:20px; flex-shrink:0; border-bottom:1px solid var(--border); background:var(--surface); }
    .drawer-body{ flex:1 1 auto; overflow-y:auto; overflow-x:hidden; padding:0 20px 20px; }
    .drawer-footer{ padding:12px 20px 20px; flex-shrink:0; padding-left: 20px; border-top:1px solid var(--border); background:var(--surface); }
    .drawer-footer .actions{ justify-content:flex-start; }
    .drawer, #drawerBody, .drawer-body { overflow-x: hidden; }
    .drawer-chart { width:100%; height:260px; background: var(--chart-bg); border-radius:8px; border:1px solid var(--border); margin-bottom:8px; padding:0; position:relative; display:block }

    html[data-theme="dark"] .drawer-chart {
      border-color: rgba(148,163,184,0.25);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    /* Drawer info row */
    .drawer-info-row { display:flex; gap:12px; margin-bottom:8px; align-items:center }
    .info-card{ flex:1; background:var(--bg); padding:12px; border-radius:8px; display:flex; flex-direction:column; justify-content:center; min-height:56px; border:1px solid var(--border) }
    .info-card.small{ width:160px; align-items:flex-end }
    .muted-small{ font-size:12px; color:var(--muted); margin-bottom:6px }
    .main-val{ font-weight:800; font-size:18px }

    .amort-wrap{ border:1px solid var(--border); border-radius:8px; padding:8px; max-height:40vh; overflow:auto; background:var(--card) }
    table{ width:100%; border-collapse:collapse; font-size:13px; background:var(--card); }
    thead th{ position:sticky; top:0; background:var(--table-header); padding:8px; text-align:left; color:var(--muted); font-weight:700; border-bottom:1px solid var(--table-border) }
    td{ padding:8px; border-bottom:1px dashed var(--table-border); text-align:right }
    td:first-child, th:first-child{ text-align:left }

    .tooltip{ position:fixed; pointer-events:none; background:var(--tooltip-bg); color:var(--tooltip-text); padding:6px 8px; border-radius:6px; font-size:12px; transform:translate(-50%,-120%); box-shadow:0 6px 18px rgba(2,6,23,0.2); display:none; z-index:9999; line-height:1.12 }
    .small{ font-size:12px; color:var(--muted) }

    /* tiny responsive tweaks */
    @media(max-width:760px){
      .drawer{ width:100%; min-width:0; }
      .kpis{ grid-template-columns:repeat(2,1fr) }
    }

    /* Theme toggle icon */
    .theme-icon { width:38px; height:38px; display:flex; align-items:center; justify-content:center; border-radius:12px; border:1px solid var(--border); background:var(--surface); color:var(--text); cursor:pointer; font-size:16px; transition:background .2s ease, color .2s ease, border-color .2s ease, transform .15s ease; box-shadow:0 8px 18px rgba(15,23,42,0.06); }
    .theme-icon:hover{ transform:translateY(-1px); border-color:rgba(15,23,42,0.14); }

  </style>
</head>
<body>
  <div class="app" role="main">

      <!-- Header here -->
    <header>
  <div class="header-top">

    <div>
      <h1>Loan Portfolio â€” ROI</h1>
      <p class="lead">Unified design, dark mode, animations, KPI drawers with primary/secondary cards.</p>

      <div class="current-date" style="margin-top:4px;">
        <div class="current-date">Current Date: <span id="currentDate"></span></div>
      </div>
    </div>

    <!-- User + Toggle aligned to the right -->
    <div style="display:flex; gap:10px; align-items:center;">
      <div style="font-size:13px; color:var(--muted)">
        User: <strong style="color:var(--brand)">Jeff L Customer</strong>
      </div>
      <button id="themeToggle" class="theme-icon" aria-label="Toggle dark mode" title="Toggle dark mode">ðŸŒ™</button>
    </div>

  </div>
</header>

    <!-- KPI Row -->
    <section class="kpis" id="kpis"></section>

    <!-- Loan grid -->
    <section class="grid" id="loanGrid" aria-live="polite"></section>
  </div>

  <!-- Drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="drawerTitle">Drawer</h2>
        <div class="muted" id="drawerSub">details</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
        <button class="close-btn" id="closeBtn" aria-label="Close drawer">âœ•</button>
      </div>
    </div>

    <div class="drawer-body" id="drawerBody">
      <div class="drawer-info-row">
        <div class="info-card" id="drawerPrimaryCard">
          <div class="muted-small" id="drawerPrimaryTitle">Primary</div>
          <div id="drawerPrimary" class="main-val"></div>
        </div>
        <div class="info-card small" id="drawerSecondaryCard">
          <div class="muted-small" id="drawerSecondaryTitle">Secondary</div>
          <div id="drawerSecondary" class="main-val small"></div>
        </div>
      </div>

      <div class="drawer-chart" id="drawerChartArea"></div>
      <div class="legend" id="drawerLegend" style="display:none"></div>
      <div id="drawerExtra">
<table id="roiLoansTable" class="roi-table"><thead><tr><th>Loan</th><th>ROI to Date</th></tr></thead><tbody></tbody></table>
</div>

      <div style="margin-top:12px" id="drawerAmortContainer"></div>
    </div>

    <div class="drawer-footer">
      <div class="actions">
        <button class="btn" id="printBtn">Print</button>
        <button class="btn primary" id="copyCsvBtn">Copy CSV</button>
      </div>
    </div>
  </aside>

  <div id="tooltip" class="tooltip" role="status" aria-live="polite"></div>

  <!-- ====================================
       Script (organized with sections)
       ==================================== -->
  <script type="module">


    /* -------------------------
   Imports
    ------------------------- */
    import { loadLoans } from "../js/loadLoans.js";
   
    import {
      addMonths,
      monthDiff,
      formatDate,
      formatMonthYear,
      buildAmortSchedule,
      attachSchedules,
      buildPortfolioViews
    } from "/loan-dashboard/js/loanEngine.js";
    import { createLineChart } from "/loan-dashboard/js/chartEngine.js";

    /* -------------------------
       Settings & data
       ------------------------- */
    const TODAY = new Date();
    const nextMonthDate = new Date(TODAY.getFullYear(), TODAY.getMonth() + 1, 1);
    // Dynamic loans loaded from backend
    let loans = [];
    let loansWithAmort = [];
    let portfolio = {};
    let roiStartDate = new Date();

    function prepareLoanData(loadedLoans) {
      loans = loadedLoans;
      loansWithAmort = attachSchedules(loans);
      portfolio = buildPortfolioViews(loansWithAmort);

      loansWithAmort = (portfolio.loans || loansWithAmort).map(l => ({
        ...l,
        roiSeries: l.roiSeries || [],
        cumSchedule: l.cumSchedule || [],
        miniPts: l.miniPts || [],
        balanceAtPurchase: l.balanceAtPurchase ?? 0
      }));
      roiStartDate = computeEarliestDate(portfolio.roiSeries || {});
    }

    function computeEarliestDate(seriesMap){
      const timestamps = Object.values(seriesMap || {}).flatMap(arr =>
        arr.map(p => new Date(p.date).getTime()).filter(t => !Number.isNaN(t))
      );
      return timestamps.length ? new Date(Math.min(...timestamps)) : new Date();
    }

    async function initROI(loadedLoans) {
      prepareLoanData(loadedLoans);
      const formatLoanLabel = (loan) => `Loan ${loan.id} â€” ${loan.name} (${loan.school})`;

      const roiSeries = portfolio.roiSeries;
      const roiKpis   = portfolio.roiKpis;

    /* -------------------------
       KPI computations
       ------------------------- */
    function getCurrentOwnedRoiEntry(loan){
      const today = new Date();
      const ownedEntries = loan.roiSeries.filter(r => r.ownershipDate && r.ownershipDate <= today);
      if (!ownedEntries.length) return { roi: 0, loanValue: loan.purchasePrice };
      return ownedEntries[ownedEntries.length - 1];
    }

    function getLastOwnedRoiEntry(loan){
      if (!loan.roiSeries || !loan.roiSeries.length) return { roi: 0, loanValue: loan.purchasePrice };
      return loan.roiSeries[loan.roiSeries.length - 1];
    }

    const kpis = roiKpis || { weightedROI: 0, projectedWeightedROI: 0, avgRate: 0, total: 0 };

// --- Multi-series chart (loan lines + weighted line) ---
function createMultiSeriesChart(containerEl, loanSeriesList, weightedSeries, opts = {}) {
  containerEl.innerHTML = '';
  const svgNS = "http://www.w3.org/2000/svg";
  const rect = containerEl.getBoundingClientRect();
  const w = Math.max(360, rect.width || 700);
  const h = opts.h || 260;
  const pad = opts.pad || 28;
  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");
  svg.style.display = "block";

  // compute domain
  const xCount = Math.max(1, weightedSeries.length);
  let ys = [];
  weightedSeries.forEach(d=>ys.push(d.y));
  loanSeriesList.forEach(ls => ls.data.forEach(d=>ys.push(d.y)));
  const minY = Math.min(...ys);
  const maxY = Math.max(...ys);
  const rangeY = Math.max(1e-6, maxY - minY);
  const stepX = (w - pad*2) / Math.max(1, xCount - 1);
  const xForMonth = month => pad + (Math.min(Math.max(month, 1), xCount) - 1) * stepX;
  function toXY(pt, i){ const x = pad + (i)*stepX; const y = pad + (h - pad*2) - ((pt.y - minY)/rangeY)*(h - pad*2); return [x,y]; }

  // grid
  for(let gy=0; gy<5; gy++){ const y = pad + gy*((h-pad*2)/4); const line = document.createElementNS(svgNS,'line'); line.setAttribute('x1',pad); line.setAttribute('x2',w-pad); line.setAttribute('y1',y); line.setAttribute('y2',y); line.setAttribute('stroke','var(--border)'); line.setAttribute('stroke-opacity','0.16'); svg.appendChild(line); }

  // draw loan lines (thin)
  loanSeriesList.forEach(ls => {
    if(!ls.data || !ls.data.length) return;
    let dStr = '';
    ls.data.forEach((pt,i)=>{ const [x,y] = toXY(pt,i); dStr += (i===0?('M '+x+' '+y):(' L '+x+' '+y)); });
    const path = document.createElementNS(svgNS,'path');
    path.setAttribute('d', dStr);
    path.setAttribute('fill','none');
    path.setAttribute('stroke', ls.color || '#888');
    path.setAttribute('stroke-width', '1.2');
    path.setAttribute('stroke-opacity', '0.95');
    svg.appendChild(path);
    // attach dataset name for legend toggling
    path.dataset.name = ls.name || '';
  });

  // weighted line (on top)
  if(weightedSeries && weightedSeries.length){
    let dW = '';
    weightedSeries.forEach((pt,i)=>{ const [x,y] = toXY(pt,i); dW += (i===0?('M '+x+' '+y):(' L '+x+' '+y)); });
    const wPath = document.createElementNS(svgNS,'path');
    wPath.setAttribute('d', dW);
    wPath.setAttribute('fill','none');
    wPath.setAttribute('stroke', opts.weightedColor || '#000');
    wPath.setAttribute('stroke-width', opts.weightedWidth || '2.6');
    wPath.setAttribute('stroke-linejoin','round');
    wPath.setAttribute('stroke-linecap','round');
    svg.appendChild(wPath);
    wPath.dataset.name = 'Weighted ROI';
  }

  if (opts.startDate && weightedSeries && weightedSeries.length) {
    const today = new Date();
    const diffMonthsFromStart = monthDiff(new Date(opts.startDate), today);
    const cx = xForMonth(diffMonthsFromStart);
    const curLine = document.createElementNS(svgNS,'line');
    curLine.setAttribute('x1', cx);
    curLine.setAttribute('x2', cx);
    curLine.setAttribute('y1', pad);
    curLine.setAttribute('y2', h - pad);
    curLine.setAttribute('stroke', '#111827');
    curLine.setAttribute('stroke-dasharray', '3 3');
    curLine.setAttribute('stroke-opacity', '0.6');
    svg.appendChild(curLine);
  }

  // vertical marker + hover circle
  const vLine = document.createElementNS(svgNS,'line');
  vLine.setAttribute('stroke','var(--text)');
  vLine.setAttribute('stroke-dasharray','3 4');
  vLine.setAttribute('stroke-opacity','0.6');
  svg.appendChild(vLine);
  const hoverG = document.createElementNS(svgNS,'g');
  hoverG.setAttribute('class','hover');
  svg.appendChild(hoverG);

  // tooltip element (global)
  const tooltipEl = document.getElementById('tooltip');

  svg.addEventListener('mousemove', function(ev){
    const rectBox = svg.getBoundingClientRect();
    const svgX = ev.clientX - rectBox.left;
    let idx = Math.round((svgX - pad)/stepX);
    idx = Math.max(0, Math.min(xCount-1, idx));
    const pt = weightedSeries[idx] || weightedSeries[weightedSeries.length-1];
    const [cx, cy] = toXY(pt, idx);

    vLine.setAttribute('x1', cx);
    vLine.setAttribute('x2', cx);
    vLine.setAttribute('y1', pad);
    vLine.setAttribute('y2', h - pad);

    hoverG.innerHTML = '';
    const c = document.createElementNS(svgNS,'circle');
    c.setAttribute('cx', cx);
    c.setAttribute('cy', cy);
    c.setAttribute('r', 4.5);
    c.setAttribute('fill', opts.weightedColor || '#000');
    c.setAttribute('stroke', 'var(--card)');
    c.setAttribute('stroke-width', '1');
    hoverG.appendChild(c);

    // show only weighted ROI in tooltip
    if(tooltipEl){
      tooltipEl.style.display='block';
      tooltipEl.style.left = (rectBox.left + cx) + 'px';
      tooltipEl.style.top = (rectBox.top + cy - 28) + 'px';
      const pct = (pt.y * 100).toFixed(2);
      tooltipEl.innerHTML = `Date: ${pt.x} â€¢ Weighted ROI ${pct}%`;
    }
  });

  svg.addEventListener('mouseleave', function(){
    hoverG.innerHTML = '';
    if(tooltipEl) tooltipEl.style.display='none';
  });

  containerEl.appendChild(svg);
  return svg;
}


function createBarChart(containerEl, keys, values, opts = {}) {
  containerEl.innerHTML = '';

  const svgNS = "http://www.w3.org/2000/svg";
  const rect = containerEl.getBoundingClientRect();
  const w = Math.max(360, rect.width || 600);
  const h = opts.h || 260;

  const padL = opts.padL || 55;
  const padR = opts.padR || 20;
  const padT = opts.padT || 25;
  const padB = opts.padB || 55;

  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");
  svg.style.display = "block";

  const maxValue = Math.max(...values, 1);
  const barW = (w - padL - padR) / Math.max(1, keys.length);

  const yIsCount = !!opts.yIsCount;
  const colors = opts.colors || null;

  // --- GRID LINES + Y LABELS ---
  for (let i = 0; i <= 5; i++) {
    const y = padT + (h - padT - padB) * (i / 5);

    const line = document.createElementNS(svgNS, "line");
    line.setAttribute("x1", padL);
    line.setAttribute("x2", w - padR);
    line.setAttribute("y1", y);
    line.setAttribute("y2", y);
    line.setAttribute("stroke", "var(--border)");
    line.setAttribute("stroke-opacity", "0.35");
    svg.appendChild(line);

    const value = maxValue * (1 - i / 5);
    const lbl = document.createElementNS(svgNS, "text");
    lbl.textContent = yIsCount ? String(Math.round(value)) : ("$" + Math.round(value).toLocaleString());
    lbl.setAttribute("x", padL - 10);
    lbl.setAttribute("y", y + 4);
    lbl.setAttribute("font-size", "11");
    lbl.setAttribute("fill", "var(--text)");
    lbl.setAttribute("text-anchor", "end");
    svg.appendChild(lbl);
  }

  // --- HOVER GROUP (created now, appended later so it stays on TOP) ---
  const hoverG = document.createElementNS(svgNS, "g");
  hoverG.setAttribute("class", "hover");

  // --- DRAW BARS ---
  keys.forEach((k, i) => {
    const amount = values[i];

    const x = padL + i * barW;
    const barH = (amount / maxValue) * (h - padT - padB);
    const y = h - padB - barH;

    const bar = document.createElementNS(svgNS, "rect");
    bar.setAttribute("x", x + 6);
    bar.setAttribute("y", y);
    bar.setAttribute("width", barW - 12);
    bar.setAttribute("height", barH);
    bar.setAttribute("rx", 4);
    const fillColor = colors ? colors[i % colors.length] : (opts.color || "#0ea5e9");
    bar.setAttribute("fill", fillColor);
    bar.setAttribute("data-idx", i);
    bar.classList.add(opts.barClass || "bar");
    bar.style.cursor = "pointer";

    // --- UNIFIED HOVER TOOLTIP ---
    bar.addEventListener("mousemove", (ev) => {
      const rectSvg = svg.getBoundingClientRect();
      const cx = ev.clientX - rectSvg.left;
      const cy = ev.clientY - rectSvg.top;

      hoverG.innerHTML = "";

      // black floating tooltip box above bar
      const tipBg = document.createElementNS(svgNS, "rect");
      tipBg.setAttribute("x", cx - 45);
      tipBg.setAttribute("y", cy - 38);
      tipBg.setAttribute("width", 90);
      tipBg.setAttribute("height", 26);
      tipBg.setAttribute("rx", 6);
      tipBg.setAttribute("fill", "black");
      tipBg.setAttribute("opacity", "0.85");

      const tipTxt = document.createElementNS(svgNS, "text");
      tipTxt.textContent = yIsCount ? (amount + " loans") : ("$" + amount.toLocaleString());
      tipTxt.setAttribute("x", cx);
      tipTxt.setAttribute("y", cy - 21);
      tipTxt.setAttribute("font-size", "12");
      tipTxt.setAttribute("font-weight", "600");
      tipTxt.setAttribute("fill", "white");
      tipTxt.setAttribute("text-anchor", "middle");

      hoverG.appendChild(tipBg);
      hoverG.appendChild(tipTxt);
    });

    bar.addEventListener("mouseleave", () => {
      hoverG.innerHTML = "";
    });

    svg.appendChild(bar);

    // X axis labels
    const lbl = document.createElementNS(svgNS, "text");
    lbl.textContent = k;
    lbl.setAttribute("x", x + barW / 2);
    lbl.setAttribute("y", h - padB + 22);
    lbl.setAttribute("font-size", "11");
    lbl.setAttribute("fill", "var(--text)");
    lbl.setAttribute("text-anchor", "middle");
    svg.appendChild(lbl);
  });

  // --- ADD HOVER GROUP LAST (IMPORTANT: fixes tooltip behind bars) ---
  svg.appendChild(hoverG);

  containerEl.appendChild(svg);
  return svg;
}

function createHistogram(containerEl, values, bins=6, opts={}) {
      containerEl.innerHTML=''; const minV=Math.min(...values); const maxV=Math.max(...values); const range=Math.max(1e-6,maxV-minV); const binSize=range/bins; const counts=new Array(bins).fill(0); values.forEach(v=>{ let idx=Math.floor((v-minV)/binSize); if(idx===bins) idx=bins-1; counts[idx]++; }); const labels=counts.map((_,i)=>{ const a=minV+i*binSize; const b=a+binSize; return `${(a*100).toFixed(1)}â€“${(b*100).toFixed(1)}%`; }); return createBarChart(containerEl, labels, counts, opts); }

    /* -------------------------
       UI: Render KPI tiles
       ------------------------- */
    const kpisEl = document.getElementById('kpis');
    kpisEl.innerHTML = `
      <div class="kpi" data-kpi="tpv"><h3>Weighted ROI to Date</h3><p id="wroi">${(kpis.weightedROI*100).toFixed(2)}%</p></div>
      <div class="kpi" data-kpi="rates"><h3>Projected Weighted ROI</h3><p id="wproj">${(kpis.projectedWeightedROI*100).toFixed(2)}%</p></div>
      <div class="kpi" data-kpi="payments"><h3>Avg Rate</h3><p>${(kpis.avgRate*100).toFixed(2)}%</p></div>
      <div class="kpi" data-kpi="distribution"><h3>Total Loans</h3><p>${loansWithAmort.length}</p></div>
    `;

    /* -------------------------
       Render loan tiles + mini charts
       ------------------------- */
    const grid = document.getElementById('loanGrid');
    const tooltip = document.getElementById('tooltip');

    loansWithAmort.forEach((loan, idx) => {
      const currentRoiEntry = getCurrentOwnedRoiEntry(loan);
      const tile = document.createElement('div'); tile.className='tile'; tile.setAttribute('tabindex','0');
      tile.innerHTML = `
        <div class="tile-left">
          <div class="loan-name">${formatLoanLabel(loan)}</div>
          <div class="loan-sub">$${loan.purchasePrice.toLocaleString()}</div>
          <div class="loan-meta"><div>Term: ${loan.termYears}y</div><div>Grace: ${loan.graceYears}y</div></div>
        </div>
        <div class="chart-wrap">
          <div class="mini-label">
  ROI ${(currentRoiEntry.roi * 100).toFixed(2)}%
</div>
          <div class="sparkline" style="width:170px;height:48px;" data-idx="${idx}" aria-hidden="true"></div>
        </div>
      `;
      tile.addEventListener('click', e=>{ e.stopPropagation(); openDrawerForLoan(loan); });
      tile.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openDrawerForLoan(loan); } });
      grid.appendChild(tile);

      const chartContainer = tile.querySelector('.sparkline');
      const loanStartDate = new Date(loan.loanStartDate);
      const series = roiSeries[loan.id] || [];
      createLineChart({
        container: chartContainer,
        width: 170,
        height: 48,
        pad: 6,
        labels: series.map(p => formatMonthYear(p.date)),
        values: series.map(p => p.roi * 100),
        todayLineDate: TODAY,
        nextMonthLineDate: nextMonthDate,
        dateToMonthIndex: date => monthDiff(loanStartDate, date)
      });
    });

    /* -------------------------
       Drawer helpers & openers
       ------------------------- */
    const drawer = document.getElementById('drawer');
    const drawerTitle = document.getElementById('drawerTitle');
    const drawerSub = document.getElementById('drawerSub');
    const drawerPrimaryTitle = document.getElementById('drawerPrimaryTitle');
    const drawerPrimary = document.getElementById('drawerPrimary');
    const drawerSecondaryTitle = document.getElementById('drawerSecondaryTitle');
    const drawerSecondary = document.getElementById('drawerSecondary');
    const drawerChartArea = document.getElementById('drawerChartArea');
    const drawerLegend = document.getElementById('drawerLegend');
    const drawerExtra = document.getElementById('drawerExtra');
    const drawerAmortContainer = document.getElementById('drawerAmortContainer');

    document.getElementById('closeBtn').addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

    function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); tooltip.style.display='none'; currentLoan=null; currentMode=null; }

    let currentLoan=null, currentMode=null;

    
function populateROILoanTable(){
  const tbody = document.querySelector("#roiLoansTable tbody");
  if(!tbody) return;
  const palette = ['#e11d48','#f97316','#f59e0b','#eab308','#84cc16','#10b981','#06b6d4','#3b82f6','#6366f1','#8b5cf6'];
  tbody.innerHTML = loansWithAmort.map(l => {
    const roiEntry = getCurrentOwnedRoiEntry(l);
    let matStr = '';
    try {
      const pd = new Date(l.purchaseDate);
      const months = Math.round((l.termYears + l.graceYears) * 12);
      pd.setMonth(pd.getMonth() + months);
      matStr = pd.toISOString().slice(0,10);
    } catch(e) {
      matStr = '';
    }
    const roiPct = (roiEntry.roi || 0) * 100;
    const color = palette[(l.id-1) % palette.length];
    return `<tr>
      <td style="text-align:left;"><span style="display:inline-block;width:10px;height:10px;background:${color};border-radius:2px;margin-right:8px;vertical-align:middle;"></span>${formatLoanLabel(l)}</td>
      <td style="text-align:left;">${l.purchaseDate}</td>
      <td style="text-align:left;">${matStr}</td>
      <td style="text-align:right;color:${color};font-weight:700">${roiPct.toFixed(2)}%</td>
    </tr>`;
  }).join('');
}


function openDrawerForLoan(loan){
      currentMode='loan'; currentLoan=loan;
      drawerTitle.textContent =
        `Loan ${loan.id} â€” ${loan.name} (${loan.school || "No school"})`;
      drawerSub.textContent = 'Purchased: ' + loan.purchaseDate + ' â€¢ Balance at Purchase: $' + loan.balanceAtPurchase.toLocaleString();
      drawerPrimaryTitle.textContent = 'Purchase Price'; drawerPrimary.textContent = '$' + loan.purchasePrice.toLocaleString();
      drawerSecondaryTitle.textContent = 'Nominal Rate'; drawerSecondary.textContent = (loan.nominalRate*100).toFixed(2)+'%';
      drawerExtra.innerHTML=''; drawerLegend.style.display='flex'; drawerLegend.innerHTML = '<div class=\"item\"><span class=\"sw\" style=\"background:#0f172a\"></span>Balance</div><div class=\"item\"><span class=\"sw\" style=\"background:#0ea5e9\"></span>ROI</div>';

      const series = roiSeries[loan.id] || [];
      createLineChart({
        container: drawerChartArea,
        labels: series.map(p => formatMonthYear(p.date)),
        values: series.map(p => p.roi * 100),
        todayLineDate: TODAY,
        nextMonthLineDate: nextMonthDate,
        dateToMonthIndex: date => monthDiff(roiStartDate, date)
      });

      // ROI-by-month table (replaces amort table)
      drawerAmortContainer.innerHTML = '<h3 style="margin-top:8px">ROI by Month</h3><div class="amort-wrap"><table><thead><tr><th>Month</th><th style="text-align:right">Balance</th><th style="text-align:right">Cum Interest</th><th style="text-align:right">Cum Payments</th><th style="text-align:right">Cum Fees</th><th style="text-align:right">Loan Value</th><th style="text-align:right">ROI</th></tr></thead><tbody id="roiBody"></tbody></table></div>';
      const roiBody = document.getElementById('roiBody');
      roiBody.innerHTML = '';
      // build rows using cumSchedule and roiSeries, accounting for amortization fees
      loan.roiSeries.forEach(s => {
        const month = s.month;
        const cs = loan.cumSchedule.find(r => r.ownershipMonthIndex === month) || {};
        const balance = (cs.balance !== undefined) ? cs.balance : '';
        const cumInterest = (cs.cumInterest !== undefined) ? cs.cumInterest : '';
        const cumPayments = (cs.cumTotal !== undefined) ? cs.cumTotal : '';
        const cumFees = s.cumFees ?? 0;
        const loanValueAdj = s.loanValue ?? 0;
        const roiAdj = s.roi || 0;
        const tr = document.createElement('tr');
        const loanDate = cs.loanDate ? formatDate(cs.loanDate) : '';
        tr.innerHTML = `<td style="text-align:left">${loanDate}</td><td style="text-align:right">$${Number(balance).toFixed(2)}</td><td style="text-align:right">$${Number(cumInterest).toFixed(2)}</td><td style="text-align:right">$${Number(cumPayments).toFixed(2)}</td><td style="text-align:right">$${Number(cumFees).toFixed(2)}</td><td style="text-align:right">$${Number(loanValueAdj).toFixed(2)}</td><td style="text-align:right">${(roiAdj*100).toFixed(2)}%</td>`;
        roiBody.appendChild(tr);
      });

      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); drawer.scrollTop=0;
    }

    /* -------------------------
       KPI drawer renderers
       ------------------------- */
    function getMonthlyTotals(list){ const totals={}; list.forEach(l=>{ const d=new Date(l.purchaseDate); const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; totals[key]=(totals[key]||0)+l.purchasePrice; }); return totals; }

    function renderDistributionDrawer(){
      currentMode='kpi'; currentLoan=null;
      drawerAmortContainer.innerHTML = '';
      drawerTitle.textContent='Total Loans'; drawerSub.textContent='Loan Purchase Amounts Per Month';
      const totalsObj=getMonthlyTotals(loansWithAmort); const keys=Object.keys(totalsObj).sort(); const values=keys.map(k=>totalsObj[k]); const totalInv=values.reduce((a,b)=>a+b,0);
      drawerPrimaryTitle.textContent='Total Invested'; drawerPrimary.textContent='$'+totalInv.toLocaleString();
      drawerSecondaryTitle.textContent = 'Current Portfolio Value';

const portfolioValue = loansWithAmort.reduce((sum, l) => {
  const row = getCurrentOwnedRoiEntry(l);
  return sum + (row.loanValue || l.purchasePrice);
}, 0);

drawerSecondary.textContent = '$' + portfolioValue.toLocaleString();

      createBarChart(drawerChartArea, keys, values, { color:'#0ea5e9' });
      drawerExtra.innerHTML = `<h3 style="margin-top:12px;margin-bottom:8px">Loans</h3><div style="border:1px solid rgba(15,23,42,0.06);border-radius:8px;max-height:260px;overflow:auto;background:var(--card);padding:6px;"><table style="width:100%;font-size:13px"><thead><tr><th style="text-align:left">Loan</th><th style="text-align:left">Purchase</th><th>Amount</th><th>Rate</th></tr></thead><tbody>${loansWithAmort.map(l=>`<tr><td style="text-align:left">${formatLoanLabel(l)}</td><td>${l.purchaseDate}</td><td>$${l.purchasePrice.toLocaleString()}</td><td>${(l.nominalRate*100).toFixed(2)}%</td></tr>`).join('')}</tbody></table></div>`;
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
    }

    function renderTPVDrawer(){
      currentMode='kpi'; currentLoan=null;
      drawerAmortContainer.innerHTML = '';
      drawerTitle.textContent='Portfolio â€” Weighted ROI (To Date)'; drawerSub.textContent='Snapshot';
      const today = new Date();
      const monthsMax = Math.max(...loansWithAmort.map(l=>l.roiSeries.length));
      const ownedUpTo = Math.max(...loansWithAmort.map(l=>l.roiSeries.filter(r=>r.ownershipDate && r.ownershipDate <= today).length), 0);
      const upTo = Math.max(1, Math.min(monthsMax, Math.max(ownedUpTo, 0)));
      const weightedSeries = [];
      for(let m=1;m<=upTo;m++){
        let totalInvested=0, weightedSum=0;
        let labelDate=null;
        loansWithAmort.forEach(l=>{
          const entry=l.roiSeries.find(r=>r.month===m);
          if(entry){
            weightedSum += l.purchasePrice*entry.roi;
            totalInvested += l.purchasePrice;
            if(!labelDate && entry.ownershipDate) labelDate = entry.ownershipDate;
          }
        });
        const label = labelDate ? formatMonthYear(labelDate) : `M${m}`;
        weightedSeries.push({x: label, y: totalInvested?weightedSum/totalInvested:0});
      }
      const lastOwnedWeighted = weightedSeries[weightedSeries.length - 1] || { y: 0 };
      drawerPrimaryTitle.textContent='Weighted ROI to Date'; drawerPrimary.textContent=((lastOwnedWeighted.y || 0)*100).toFixed(2)+'%';
      const portfolioValue = loansWithAmort.reduce((s,l)=>{ const row=getCurrentOwnedRoiEntry(l); return s + (row.loanValue||l.purchasePrice); },0);
      drawerSecondaryTitle.textContent='Portfolio Value'; drawerSecondary.textContent='$'+portfolioValue.toLocaleString();
      
      // build loan series and weighted series for multi-chart
      (function(){
        const startTimes = loansWithAmort.map(l => new Date(l.loanStartDate).getTime()).filter(t => !Number.isNaN(t));
        const earliestStart = startTimes.length ? new Date(Math.min(...startTimes)) : new Date();
        const palette = ['#e11d48','#f97316','#f59e0b','#eab308','#84cc16','#10b981','#06b6d4','#3b82f6','#6366f1','#8b5cf6'];
        const loanSeriesList = loansWithAmort.map((l, idx) => {
          const pts = [];
          for(let m=1;m<=upTo;m++){ const e = l.roiSeries.find(r=>r.month===m); const label = e?.ownershipDate ? formatMonthYear(e.ownershipDate) : `M${m}`; pts.push({x: label, y: e ? e.roi : 0, ownershipDate: e?.ownershipDate}); }
          return { name: formatLoanLabel(l), color: palette[(l.id-1) % palette.length], data: pts };
        });
        createMultiSeriesChart(drawerChartArea, loanSeriesList, weightedSeries, { weightedColor: '#000', weightedWidth: 2.6, startDate: earliestStart });
        // build legend (click to toggle visibility)
        drawerLegend.style.display='flex'; drawerLegend.innerHTML = '';
        const wk = document.createElement('div'); wk.className='legend-item'; wk.style.marginRight='12px'; wk.innerHTML = '<span style="display:inline-block;width:12px;height:12px;background:#000;margin-right:8px;border-radius:2px;"></span><span style="font-weight:700">Weighted ROI</span>';
        drawerLegend.appendChild(wk);
        loanSeriesList.forEach((ls, i) => {
          const loan = loansWithAmort[i];
          const it = document.createElement('div'); it.className='legend-item'; it.style.marginRight='8px'; it.style.cursor='pointer';
          it.innerHTML = `<span style="display:inline-block;width:10px;height:10px;background:${ls.color};margin-right:6px;border-radius:2px;vertical-align:middle;"></span><span style="font-size:13px">${formatLoanLabel(loan)}</span>`;
          drawerLegend.appendChild(it);
        });
      })();

      drawerExtra.innerHTML = `
        <div style="margin-top:12px">
          <h3 style="margin:0 0 8px 0">ROI to Date â€” All Loans</h3>
          <div style="max-height:300px;overflow:auto;border:1px solid var(--border);border-radius:8px;padding:6px;background:var(--card);">
            <table id="roiLoansTable" style="width:100%;font-size:13px;">
              <thead>
                <tr>
                  <th style="text-align:left;">Loan</th>
                  <th style="text-align:left;">Purchase Date</th>
                  <th style="text-align:left;">Maturity Date</th>
                  <th style="text-align:right;">ROI to Date</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      `;
      populateROILoanTable();
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
}

    function renderRatesDrawer(){
  currentMode='kpi'; currentLoan=null;
  drawerAmortContainer.innerHTML='';
  drawerTitle.textContent='Projected Weighted ROI'; 
  drawerSub.textContent='Projection to maturity';

  // Compute projected weighted ROI & portfolio value
  const projectedSeries = [];
  const monthsMax = Math.max(...loansWithAmort.map(l=>l.roiSeries.length));
  for(let m=1;m<=monthsMax;m++){
    let total=0, weighted=0;
    let labelDate=null;
    loansWithAmort.forEach(l=>{
      const e=l.roiSeries.find(r=>r.month===m);
      if(e){
        weighted += l.purchasePrice*e.roi; total += l.purchasePrice;
        if(!labelDate && e.ownershipDate) labelDate = e.ownershipDate;
      }
    });
    const label = labelDate ? formatMonthYear(labelDate) : `M${m}`;
    projectedSeries.push({x:label,y: total?weighted/total:0});
  }

  const projectedPortfolioValue = loansWithAmort.reduce((s,l)=>{
      const last=getLastOwnedRoiEntry(l);
      return s + (last.loanValue||l.purchasePrice);
  },0);

  drawerPrimaryTitle.textContent='Projected Weighted ROI';
  drawerPrimary.textContent=(kpis.projectedWeightedROI*100).toFixed(2)+'%';
  drawerSecondaryTitle.textContent='Projected Portfolio Value';
  drawerSecondary.textContent='$'+projectedPortfolioValue.toLocaleString();

  // Build loan-level series
  const palette = ['#e11d48','#f97316','#f59e0b','#eab308','#84cc16','#10b981',
                   '#06b6d4','#3b82f6','#6366f1','#8b5cf6'];
  const loanSeriesList = loansWithAmort.map(l=>{
    const pts = l.roiSeries.map(p=>({x: formatMonthYear(p.ownershipDate), y:p.roi, ownershipDate: p.ownershipDate}));
    return {name:formatLoanLabel(l), color:palette[(l.id-1)%palette.length], data:pts};
  });
  const startTimes = loansWithAmort.map(l => new Date(l.loanStartDate).getTime()).filter(t => !Number.isNaN(t));
  const earliestStart = startTimes.length ? new Date(Math.min(...startTimes)) : new Date();

  // Render chart
  createMultiSeriesChart(
    drawerChartArea,
    loanSeriesList,
    projectedSeries,
    {weightedColor:'#000', weightedWidth:2.8, startDate: earliestStart}
  );

  // Build table
  drawerExtra.innerHTML = `
    <div style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Projected ROI at Maturity â€” All Loans</h3>
      <div style="max-height:300px;overflow:auto;
          border:1px solid var(--border);border-radius:8px;
          padding:6px;background:var(--card);">
        <table style="width:100%;font-size:13px;">
          <thead>
            <tr>
              <th style="text-align:left;">Loan</th>
              <th style="text-align:left;">Purchase Date</th>
              <th style="text-align:left;">Maturity Date</th>
              <th style="text-align:right;">Projected ROI</th>
            </tr>
          </thead>
          <tbody id="projTableBody"></tbody>
        </table>
      </div>
    </div>
  `;

  const tbody = document.getElementById('projTableBody');
  tbody.innerHTML='';

  loansWithAmort.forEach(l=>{
    const last = getLastOwnedRoiEntry(l);
    let matStr='';
    try{
      const pd=new Date(l.purchaseDate);
      const months=Math.round((l.termYears+l.graceYears)*12);
      pd.setMonth(pd.getMonth()+months);
      matStr=pd.toISOString().slice(0,10);
    }catch(e){}

    const roiPct=(last.roi*100).toFixed(2)+'%';
    const color=palette[(l.id-1)%palette.length];

    const row = `
      <tr>
        <td style="text-align:left;">
          <span style="display:inline-block;width:10px;height:10px;
            background:${color};border-radius:2px;margin-right:8px;
            vertical-align:middle;"></span>
          ${formatLoanLabel(l)}
        </td>
        <td style="text-align:left;">${l.purchaseDate}</td>
        <td style="text-align:left;">${matStr}</td>
        <td style="text-align:right;color:${color};font-weight:700;">
          ${roiPct}
        </td>
      </tr>`;
    tbody.insertAdjacentHTML('beforeend', row);
  });

  drawerLegend.style.display='none';
  drawer.classList.add('open'); 
  drawer.setAttribute('aria-hidden','false');
}


function renderPaymentsDrawer() {
  currentMode = 'kpi';
  currentLoan = null;
  drawerBalanceAtPurchase.textContent = '';

  drawerTitle.textContent = 'Total Expected Payments (monthly)';
  drawerSub.textContent = 'Sum of scheduled payments across loans';

  drawerPrimaryTitle.textContent = 'Monthly Income';
  drawerSecondaryTitle.textContent = 'Total Invested';
  drawerSecondary.textContent = `$${kpis.total.toLocaleString()}`;

  drawerAmortContainer.style.display = 'none';
  drawerExtra.innerHTML = '';
  drawerChartArea.innerHTML = '';
  drawerLegend.style.display = 'none';

  // -----------------------------
  // FIX 1: Align portfolio timeline
  // -----------------------------
  const earliestStart = new Date(
    Math.min(...loansWithAmort.map(l => new Date(l.purchaseDate)))
  );

  // Build months up to max schedule length
  const maxMonths = Math.max(...loansWithAmort.map(l => l.amort.schedule.length));

  const monthLabels = [];
  const payments = [];

  for (let m = 1; m <= maxMonths; m++) {
    // build actual calendar month label
    const dt = new Date(earliestStart);
    dt.setMonth(dt.getMonth() + (m - 1));
    monthLabels.push(
      dt.toLocaleDateString("en-US", { year: "numeric", month: "short" })
    );

    // -----------------------------
    // FIX 2: Correct portfolio payments:
    // only include payments AFTER the loan is owned
    // -----------------------------
    let sum = 0;
    loansWithAmort.forEach(l => {
      const row = l.amort.schedule.find(s => s.monthIndex === m);
      if (row && row.isOwned) sum += row.payment;
    });

    payments.push(sum);
  }

  // -----------------------------
  // Draw line chart
  // -----------------------------
  const svgNS = 'http://www.w3.org/2000/svg';
  const w = 780, h = 220, pad = 30;
  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("width", w);
  svg.setAttribute("height", h);
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);

  const maxY = Math.max(...payments);
  const minY = 0;
  const rangeY = maxY - minY || 1;

  const stepX = (w - pad * 2) / Math.max(1, payments.length - 1);

  let d = "";
  payments.forEach((p, i) => {
    const x = pad + i * stepX;
    const y = pad + (h - pad * 2) - ((p - minY) / rangeY) * (h - pad * 2);
    d += (i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
  });

  const path = document.createElementNS(svgNS, "path");
  path.setAttribute("d", d);
  path.setAttribute("stroke", "#ef4444");
  path.setAttribute("stroke-width", "2.5");
  path.setAttribute("fill", "none");
  svg.appendChild(path);

  // -----------------------------
  // FIX 3: Proper hover and labels alignment
  // -----------------------------
  payments.forEach((p, i) => {
    const x = pad + i * stepX;

    const text = document.createElementNS(svgNS, 'text');
    text.setAttribute('x', x);
    text.setAttribute('y', h - pad + 14);
    text.setAttribute('font-size', '11');
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('fill', '#475569');
    text.textContent = monthLabels[i];
    svg.appendChild(text);

    const hit = document.createElementNS(svgNS, "rect");
    hit.setAttribute("x", x - stepX * 0.5);
    hit.setAttribute("y", pad);
    hit.setAttribute("width", stepX);
    hit.setAttribute("height", h - pad * 2);
    hit.setAttribute("fill", "transparent");

    hit.addEventListener("mousemove", ev => {
      tooltip.style.display = "block";
      tooltip.style.left = ev.clientX + "px";
      tooltip.style.top = (ev.clientY - 12) + "px";
      tooltip.innerHTML = `${monthLabels[i]} â€¢ $${Math.round(p).toLocaleString()}`;
    });
    hit.addEventListener("mouseleave", () => tooltip.style.display = "none");

    svg.appendChild(hit);
  });

  drawerChartArea.appendChild(svg);
}
    /* -------------------------
       KPI wiring & interactions
       ------------------------- */
    document.querySelectorAll('.kpi').forEach(k=>{ k.addEventListener('click', ev=>{ ev.stopPropagation(); const key=k.getAttribute('data-kpi'); if(key==='distribution') renderDistributionDrawer(); if(key==='tpv') renderTPVDrawer(); if(key==='rates') renderRatesDrawer(); if(key==='payments') renderPaymentsDrawer(); }); });

    /* -------------------------
       CSV / clipboard / download / print
       ------------------------- */
    function copyPortfolioCSV(){ let rows=[['Loan','Purchase Date','Amount','Rate']]; loansWithAmort.forEach(l=>rows.push([formatLoanLabel(l),l.purchaseDate,l.purchasePrice,(l.nominalRate*100).toFixed(2)+'%'])); const csv=rows.map(r=>r.join(',')).join('\n'); navigator.clipboard.writeText(csv); alert('CSV copied to clipboard'); }
    function amortToCSV(loan){ const rows=[['Month','Payment','Principal','Interest','Balance']]; loan.amort.schedule.forEach(r=>rows.push([r.monthIndex,r.payment.toFixed(2),r.principalPaid.toFixed(2),r.interest.toFixed(2),r.balance.toFixed(2)])); return rows.map(r=>r.join(',')).join('\n'); }
    document.getElementById('copyCsvBtn')?.addEventListener('click', async ()=>{ if(currentMode!=='loan' || !currentLoan) return alert('Open an individual loan drawer to copy CSV'); const csv=amortToCSV(currentLoan); try{ await navigator.clipboard.writeText(csv); alert('CSV copied to clipboard'); }catch(e){ alert('Copy failed â€” browser denied clipboard access'); } });
    document.getElementById('downloadCsvBtn')?.addEventListener('click', ()=>{ if(currentMode==='loan' && currentLoan){ const csv=amortToCSV(currentLoan); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='loan-'+currentLoan.id+'-amort.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); } else alert('Download CSV is supported for individual loan drawers only.'); });
    document.getElementById('printBtn')?.addEventListener('click', ()=>window.print());

    /* -------------------------
       Close drawer on outside click; hide tooltip on scroll
       ------------------------- */
    document.addEventListener('click', function(e){ if(!drawer.classList.contains('open')) return; const clickedInside=drawer.contains(e.target); const clickedTile=!!e.target.closest('.tile'); if(!clickedInside && !clickedTile) closeDrawer(); });
    document.querySelector('.grid').addEventListener('scroll', ()=>{ tooltip.style.display='none'; });

    /* -------------------------
       End
       ------------------------- */



    } // END initROI()

    document.addEventListener("DOMContentLoaded", async () => {
      const loadedLoans = await loadLoans();

      if (!loadedLoans.length) {
        console.error("No loan data loaded");
        return;
      }

      document.getElementById("currentDate").textContent = formatDate(new Date());
      initROI(loadedLoans);
    });

    // theme toggle
window.addEventListener("DOMContentLoaded", () => {
  const toggle = document.getElementById("themeToggle");
  if (!toggle) return;

  const applyTheme = (theme) => {
    document.documentElement.setAttribute("data-theme", theme);
    document.body.classList.toggle("dark", theme === "dark");
    localStorage.setItem("theme", theme);
    toggle.textContent = theme === "dark" ? "â˜€ï¸" : "ðŸŒ™";
    toggle.setAttribute("aria-label", theme === "dark" ? "Switch to light mode" : "Switch to dark mode");
    toggle.setAttribute("title", theme === "dark" ? "Switch to light mode" : "Switch to dark mode");
  };

  const saved = localStorage.getItem("theme");
  const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
  applyTheme(saved || (prefersDark ? "dark" : "light"));

  toggle.addEventListener("click", () => {
    const nextTheme = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
    applyTheme(nextTheme);
  });
});

</script>

<div id="chartTooltip"
     style="position:fixed;display:none;
            background:var(--card);
            padding:6px 10px;
            border-radius:6px;
            font-size:12px;
            box-shadow:0 2px 6px rgba(0,0,0,0.2);
            pointer-events:none;
            z-index:9999;">
</div>

<script>
  window.chartTooltip = document.getElementById("chartTooltip");
</script>
</body>
</html>

<!-- Added customTooltip function -->
<script>
function customTooltip(context) {
    let tooltipEl = document.getElementById('chartjs-tooltip');
    if (!tooltipEl) {
        tooltipEl = document.createElement('div');
        tooltipEl.id = 'chartjs-tooltip';
        tooltipEl.style.position = 'absolute';
        tooltipEl.style.background = 'rgba(0,0,0,0.85)';
        tooltipEl.style.color = 'var(--card)';
        tooltipEl.style.padding = '8px 12px';
        tooltipEl.style.borderRadius = '6px';
        tooltipEl.style.pointerEvents = 'none';
        tooltipEl.style.transition = '0.1s ease';
        tooltipEl.style.zIndex = '9999';
        document.body.appendChild(tooltipEl);
    }
    const tooltip = context.tooltip;
    if (tooltip.opacity === 0) {
        tooltipEl.style.opacity = 0;
        return;
    }
    tooltipEl.style.opacity = 1;
    tooltipEl.innerHTML = `<div style="font-weight:600;font-size:13px;">${tooltip.dataPoints[0].formattedValue}</div>`;
    const { offsetLeft, offsetTop } = context.chart.canvas;
    tooltipEl.style.left = offsetLeft + tooltip.caretX + 15 + 'px';
    tooltipEl.style.top = offsetTop + tooltip.caretY + 'px';
}
</script>
